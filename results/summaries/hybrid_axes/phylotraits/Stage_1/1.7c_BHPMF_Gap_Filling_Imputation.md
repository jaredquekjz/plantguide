# Stage 1.7c — BHPMF Gap-Filling and Imputation

**BHPMF imputation pipeline with anti-leakage design and XGBoost-aligned metrics**

**Date:** 2025-10-27
**Purpose:** BHPMF-based trait imputation for comparison with XGBoost
**Dependencies:** 1.7a Imputation Dataset Preparation, 1.7b XGBoost Experiments

---

## 1. Methodology Overview

### 1.1 Anti-Leakage Design

**BHPMF dataset structure (171 columns):**
- 2 IDs: `wfo_taxon_id`, `wfo_accepted_name`
- 6 log traits: `logLA`, `logNmass`, `logSLA`, `logH`, `logSM`, `logLDMC`
- 2 hierarchy: `Genus`, `Family`
- 5 EIVE: `EIVEres-L`, `EIVEres-T`, `EIVEres-M`, `EIVEres-N`, `EIVEres-R`
- 156 environmental: WorldClim + SoilGrids + Agroclim q50 features

**Critical: No raw traits included to prevent cross-validation leakage**

### 1.2 Alignment with XGBoost

**Both pipelines use identical flow:**
```
Input: log-transformed traits (logLA, logNmass, etc.)
↓
Imputation: Predict on log scale
↓
Metrics: Compute on log scale (R², RMSE, RMSE/SD)
↓
Interpretability: Back-transform for percentage metrics (MdAPE, tolerance bands)
```

### 1.3 BHPMF Requirements

**Taxonomic hierarchy (Schrodt et al. 2015):**
- Uses Genus and Family as categorical variables
- BHPMF converts strings to factor indices internally
- Does NOT use phylogenetic trees (that's for XGBoost eigenvectors only)

**WFO taxonomy coverage:**
- 11,679/11,680 species (99.99%)
- 3,077 unique genera
- 328 unique families

### 1.4 Balanced Chunking

**Critical for BHPMF stability:**
- Random shuffling prevents empty columns (BHPMF fails on empty columns)
- 6 chunks × 1,946-1,947 species each
- Balanced trait observations across chunks (CV < 4%)

---

## 2. Dataset Preparation

### 2.1 Create Anti-Leakage BHPMF Dataset

**Command:**
```bash
conda run -n AI python src/Stage_1/create_bhpmf_canonical_input.py \
  --traits=model_data/inputs/traits_model_ready_20251022_shortlist.csv \
  --env=model_data/inputs/env_features_shortlist_20251025_complete_q50_xgb.csv \
  --output=model_data/inputs/trait_imputation_input_canonical_20251025_merged.csv
```

**Output:**
```
✓ Created anti-leakage BHPMF dataset
  Species: 11,680
  Columns: 171 (2 IDs + 6 log + 2 hierarchy + 5 EIVE + 156 env)

Log trait coverage:
  logLA:     6,266 obs (53.6%)
  logNmass:  5,081 obs (43.5%)
  logSLA:    6,866 obs (58.8%)
  logH:     11,227 obs (96.1%)
  logSM:     9,584 obs (82.0%)
  logLDMC:   3,576 obs (30.6%)

Taxonomic hierarchy (WFO):
  Genus:  11,679 valid (99.99%), 3,077 unique
  Family: 11,679 valid (99.99%), 328 unique

EIVE coverage:
  EIVEres-L: 6,113 obs (52.3%)
  EIVEres-T: 6,113 obs (52.3%)
  EIVEres-M: 6,113 obs (52.3%)
  EIVEres-N: 6,113 obs (52.3%)
  EIVEres-R: 6,113 obs (52.3%)

Environmental: 156 q50 features, 100% coverage

✓ Anti-leakage verified: No raw traits present
✓ Saved: model_data/inputs/trait_imputation_input_canonical_20251025_merged.csv
```

**Script:** `src/Stage_1/create_bhpmf_canonical_input.py`

### 2.2 Verify Dataset Structure

**Command:**
```bash
conda run -n AI python src/Stage_1/verification/verify_bhpmf_dataset.py \
  --input=model_data/inputs/trait_imputation_input_canonical_20251025_merged.csv
```

**Verification checks:**
1. Correct dimensions (11,680 × 171)
2. Log traits present (logLA, logNmass, etc.)
3. No raw traits (anti-leakage)
4. WFO taxonomy coverage (Genus/Family)
5. EIVE coverage (~52%)
6. Environmental features (156 q50)

---

## 3. Balanced Chunks Creation

### 3.1 Create 6 Balanced Chunks

**Command:**
```bash
conda run -n AI python src/Stage_1/create_balanced_chunks.py \
  --input=model_data/inputs/trait_imputation_input_canonical_20251025_merged.csv \
  --output_dir=model_data/inputs/bhpmf_chunks_balanced_20251027 \
  --n_chunks=6 \
  --seed=20251027
```

**Output:**
```
✓ Created 6 balanced chunks in model_data/inputs/bhpmf_chunks_balanced_20251027/
  - bhpmf_input_chunk001_20251027.csv (1,947 species)
  - bhpmf_input_chunk002_20251027.csv (1,947 species)
  - bhpmf_input_chunk003_20251027.csv (1,947 species)
  - bhpmf_input_chunk004_20251027.csv (1,947 species)
  - bhpmf_input_chunk005_20251027.csv (1,946 species)
  - bhpmf_input_chunk006_20251027.csv (1,946 species)

✓ All chunks validated (no empty columns)
✓ Balanced trait distribution (CV < 4%)
✓ Random shuffle with seed=20251027 ensures reproducibility
```

**Script:** `src/Stage_1/create_balanced_chunks.py`

### 3.2 Verify Chunks

**Command:**
```bash
conda run -n AI python src/Stage_1/verification/verify_bhpmf_chunks.py \
  --chunks_dir=model_data/inputs/bhpmf_chunks_balanced_20251027
```

**Verification checks:**
1. Identical structure across chunks (171 columns)
2. No empty columns (CRITICAL for BHPMF)
3. Balanced trait observations (CV < 10%)
4. Anti-leakage design (no raw traits)
5. Taxonomic hierarchy completeness (>99%)

---

## 4. BHPMF Cross-Validation

### 4.1 CV Dataset Preparation

**Date:** 2025-10-27
**Status:** ✓ Completed

**Command:**
```bash
conda run -n AI python src/Stage_1/build_bhpmf_10fold_cv_datasets.py \
  --chunk_dir=model_data/inputs/bhpmf_chunks_balanced_20251027 \
  --output_dir=model_data/inputs/bhpmf_cv_masked_20251027 \
  --schedule_dir=model_data/inputs/bhpmf_cv_schedules_20251027 \
  --n_folds=10 \
  --seed=20251027
```

**Output:**
```
✓ Created 360 masked datasets
✓ Masked chunks: model_data/inputs/bhpmf_cv_masked_20251027/
✓ Schedules: model_data/inputs/bhpmf_cv_schedules_20251027/
```

**Methodology:**
- Uses `sklearn.model_selection.KFold(n_splits=10, shuffle=True, random_state=20251027)`
- Cell-level masking: 10% of observed values per fold
- 6 chunks × 6 traits × 10 folds = 360 masked datasets
- Cell-level holdout (not species-level): Tests imputation using partial observations

### 4.2 Run BHPMF CV

**Date:** 2025-10-27
**Runtime:** 57 minutes (360 runs)
**Status:** ✓ Completed (360/360 successful)

**Command:**
```bash
nohup bash src/Stage_1/run_bhpmf_10fold_canonical_cv.sh --clean \
  > logs/bhpmf_cv_nohup_20251027.log 2>&1 &
```

**BHPMF parameters:**
```
used_levels = 0          # genus + species
prediction_level = 2     # species
num_samples = 1000       # MCMC samples
burn = 100              # burn-in
gaps = 2                # gap-filling mode
num_latent = 10         # latent factors
tuning = false          # no hyperparameter tuning
```

**R script:** `src/Stage_1/bhpmf_impute_traits.R`
- Anti-leakage mode: Log traits only (no raw traits)
- Uses WFO Genus/Family hierarchy (3,077 genera, 328 families)
- Includes 156 environmental q50 features
- Includes 5 EIVE indicators (52% coverage)
- Runtime: ~10 seconds per fold

**Output:** 360 imputed datasets in `model_data/outputs/bhpmf_cv_20251027/`

### 4.3 Collect CV Predictions

**Date:** 2025-10-27
**Status:** ✓ Completed

**Command:**
```bash
conda run -n AI python src/Stage_1/collect_bhpmf_cv_predictions_anti_leakage.py \
  --schedule_dir=model_data/inputs/bhpmf_cv_schedules_20251027 \
  --predictions_dir=model_data/outputs/bhpmf_cv_20251027 \
  --output_csv=model_data/outputs/bhpmf_cv_predictions_20251027.csv
```

**Output:**
```
✓ Collected 34,422 predictions
  Schedule files processed: 360
  Missing prediction files: 0

Predictions per trait:
  logLA       :  5,232 predictions
  logNmass    :  4,085 predictions
  logSLA      :  5,524 predictions
  logH        :  9,009 predictions
  logSM       :  7,696 predictions
  logLDMC     :  2,876 predictions
```

**Script:** `src/Stage_1/collect_bhpmf_cv_predictions_anti_leakage.py`
**Output file:** `model_data/outputs/bhpmf_cv_predictions_20251027.csv`

---

## 5. BHPMF CV Results

### 5.1 Performance Metrics

**Date:** 2025-10-27
**Dataset:** 11,680 species (anti-leakage mode)
**CV method:** 10-fold sklearn KFold
**Total predictions:** 34,422 test observations

**Metrics on log scale:**

| Trait | R² | RMSE | RMSE/SD | n_test |
|-------|-----|------|---------|--------|
| **plant_height_m** | **0.359** | **1.479** | **0.80** | 9,009 |
| **sla_mm2_mg** | **0.285** | **0.588** | **0.85** | 5,524 |
| **leaf_area_mm2** | 0.200 | 1.896 | 0.89 | 5,232 |
| **nmass_mg_g** | 0.171 | 0.411 | 0.91 | 4,085 |
| **seed_mass_mg** | 0.145 | 3.006 | 0.92 | 7,696 |
| **ldmc_frac** | -6.019 | 1.548 | 2.65 | 2,876 |

**Interpretability metrics (back-transformed to raw scale):**

| Trait | MdAPE | ±10% | ±25% | ±50% | IQR |
|-------|-------|------|------|------|-----|
| **plant_height_m** | 79.4% | 6% | 15% | 31% | 149.5% |
| **sla_mm2_mg** | 35.4% | 15% | 38% | 66% | 44.1% |
| **leaf_area_mm2** | 85.2% | 4% | 11% | 23% | 235.8% |
| **nmass_mg_g** | 27.1% | 19% | 47% | 78% | 33.3% |
| **seed_mass_mg** | 93.9% | 4% | 9% | 19% | 333.3% |
| **ldmc_frac** | 82.1% | 5% | 13% | 27% | 155.8% |

**Notes:**
- **Best performing trait:** plant_height_m (R² = 0.36, lowest RMSE/SD = 0.80)
- **Moderate performance:** sla_mm2_mg (R² = 0.28)
- **Poor performance:** ldmc_frac (R² = -6.02, predictions worse than mean baseline)
- **Tolerance bands:** Percentage of predictions within ±X% error bounds
- **IQR:** Interquartile range of absolute percentage errors

### 5.2 Key Observations

**Trait-specific performance:**

1. **Plant height (logH):** Best predictive performance
   - Highest R² (0.36) and lowest relative error (RMSE/SD = 0.80)
   - Highest coverage (9,009 observations, 77% of species)
   - 15% of predictions within ±25% tolerance

2. **SLA (logSLA):** Moderate performance
   - R² = 0.28, moderate relative error (RMSE/SD = 0.85)
   - Good coverage (5,524 observations, 47% of species)
   - 38% of predictions within ±25% tolerance

3. **Leaf area (logLA) and Nmass (logNmass):** Weak performance
   - Low R² (0.20 and 0.17)
   - High relative errors (RMSE/SD ≈ 0.90)
   - Large percentage errors (MdAPE > 27%)

4. **Seed mass (logSM):** Weak performance
   - Very low R² (0.15)
   - Very high absolute errors (RMSE = 3.01)
   - Extremely high MdAPE (93.9%)

5. **LDMC (logLDMC):** Catastrophic failure
   - Negative R² (-6.02) indicates predictions worse than mean baseline
   - Very high relative error (RMSE/SD = 2.65)
   - Lowest coverage (2,876 observations, 25% of species)

**Overall assessment:**
- BHPMF shows limited predictive ability for most traits
- Performance degrades with increasing trait complexity and skewness
- Best suited for plant height (highly heritable, less skewed)
- Anti-leakage design working correctly (no raw trait leakage detected)

---

## 6. Verification Checklist

### 6.1 Pre-Flight Checks

**Dataset structure:**
```bash
conda run -n AI python -c "
import pandas as pd
df = pd.read_csv('model_data/inputs/trait_imputation_input_canonical_20251025_merged.csv')
assert df.shape == (11680, 171), f'Wrong dimensions: {df.shape}'
log_traits = ['logLA', 'logNmass', 'logSLA', 'logH', 'logSM', 'logLDMC']
for trait in log_traits:
    assert trait in df.columns, f'Missing log trait: {trait}'
assert 'Genus' in df.columns and 'Family' in df.columns, 'Missing hierarchy'
env_cols = [c for c in df.columns if c.endswith('_q50')]
assert len(env_cols) == 156, f'Wrong env count: {len(env_cols)}'
print('✓ Dataset structure verified')
"
```

**Chunks balance:**
```bash
conda run -n AI python src/Stage_1/verification/verify_bhpmf_chunks.py \
  --chunks_dir=model_data/inputs/bhpmf_chunks_balanced_20251027
```

**Expected:** All checks pass, no empty columns, CV < 10%

### 6.2 Post-Run Validation

**Predictions completeness:**
```bash
conda run -n AI python -c "
import pandas as pd
preds = pd.read_csv('model_data/outputs/bhpmf_cv_predictions_20251027.csv')
print(f'✓ Total predictions: {len(preds):,}')
print(f'  Traits: {sorted(preds[\"trait\"].unique())}')
print(f'  Chunks: {sorted(preds[\"chunk\"].unique())}')
print(f'  Splits: {sorted(preds[\"split\"].unique())}')
expected_runs = 6 * 10  # 6 chunks × 10 folds
assert len(preds.groupby(['trait', 'chunk', 'split'])) <= 6 * expected_runs, 'Too many runs'
print('✓ Predictions structure validated')
"
```

**Metrics sanity checks:**
```bash
conda run -n AI python -c "
import pandas as pd
metrics = pd.read_csv('results/experiments/bhpmf_vs_xgboost_comparison_20251027.csv')
print('✓ Metrics loaded')
for method in ['BHPMF', 'XGBoost']:
    subset = metrics[metrics['method'] == method]
    print(f'\n{method}:')
    for _, row in subset.iterrows():
        print(f\"  {row['trait']:20s}: R²={row['r2']:7.4f}, RMSE={row['rmse_transformed']:7.4f}\")
    # Sanity checks
    assert (subset['r2'] >= -1).all() and (subset['r2'] <= 1).all(), f'{method}: R² out of bounds'
    assert (subset['rmse_transformed'] > 0).all(), f'{method}: RMSE must be positive'
print('✓ Metrics sanity checks passed')
"
```

---

## 7. Key Implementation Details

### 7.1 Anti-Leakage Transformation

**BHPMF workflow (aligned with XGBoost):**
```
Input traits:     logLA, logNmass, logSLA, logH, logSM, logLDMC
                  (already log-transformed)
                  ↓
BHPMF imputation: Predicts on log scale
                  ↓
CV evaluation:    Metrics computed on log scale (R², RMSE)
                  ↓
Interpretability: Back-transform for percentage metrics (MdAPE, tolerance)
```

**Critical: No double-logging**
- Dataset contains log traits (not raw traits)
- BHPMF predicts log values directly
- Metrics script uses `--bhpmf_already_logged` to prevent re-logging

### 7.2 Taxonomic Hierarchy

**BHPMF uses Genus/Family as categorical variables:**
```r
# From phylo_impute_traits_bhpmf.R
hierarchy <- data.frame(
  Genus = factor(dt$Genus),
  Family = factor(dt$Family)
)
```

**WFO taxonomy extraction:**
```python
# From create_bhpmf_canonical_input.py
wfo = pd.read_csv('data/classification.csv', sep='\t', encoding='latin-1',
                  usecols=['taxonID', 'genus', 'family'])
df = df.merge(wfo[['taxonID', 'genus', 'family']],
              left_on='wfo_taxon_id', right_on='taxonID', how='left')
df['Genus'] = df['genus'].fillna('Unknown')
df['Family'] = df['family'].fillna('Unknown')
```

**Result:** 11,679/11,680 species (99.99%) with valid taxonomy

### 7.3 Cell-Level Cross-Validation

**Methodology:**
- BHPMF uses cell-level CV (masks individual trait-species pairs)
- When imputing trait X for species S, BHPMF can use:
  - Other observed traits (Y, Z) from species S
  - Environmental features
  - Genus/Family hierarchical structure
  - EIVE indicators

**Not species-level CV:**
- Species-level would test on completely unseen species
- Cell-level tests imputation ability using partial observations
- Both BHPMF and XGBoost use cell-level CV for fair comparison

### 7.4 Balanced Chunking Algorithm

**Problem:** BHPMF fails on empty columns

**Solution:**
```python
# From create_balanced_chunks.py
np.random.seed(args.seed)
shuffled_df = df.sample(frac=1.0, random_state=args.seed).reset_index(drop=True)

# Split into equal chunks
chunk_size = len(shuffled_df) // args.n_chunks
remainder = len(shuffled_df) % args.n_chunks

# Distribute remainder to first chunks
for i in range(1, args.n_chunks + 1):
    current_size = chunk_size + (1 if i <= remainder else 0)
    chunk_df = shuffled_df.iloc[start_idx:start_idx+current_size]
    # Verify no empty columns before saving
```

**Result:** All chunks have balanced trait coverage, no empty columns

---

## 8. Scripts Reference

| Script | Purpose | Location |
|--------|---------|----------|
| `create_bhpmf_canonical_input.py` | Create anti-leakage BHPMF dataset | `src/Stage_1/` |
| `create_balanced_chunks.py` | Create 6 balanced chunks | `src/Stage_1/` |
| `verify_bhpmf_dataset.py` | Verify dataset structure | `src/Stage_1/verification/` |
| `verify_bhpmf_chunks.py` | Verify chunks balance | `src/Stage_1/verification/` |
| `build_bhpmf_10fold_cv_datasets.py` | Generate CV masked datasets | `src/Stage_1/` |
| `run_bhpmf_10fold_canonical_cv.sh` | Bash wrapper for CV execution | `src/Stage_1/` |
| `bhpmf_impute_traits.R` | Core BHPMF imputation (anti-leakage) | `src/Stage_1/` |
| `collect_bhpmf_cv_predictions_anti_leakage.py` | Collect predictions from CV runs | `src/Stage_1/` |

---

## 9. File Locations

| File Type | Path | Description |
|-----------|------|-------------|
| **Input dataset** | `model_data/inputs/trait_imputation_input_canonical_20251025_merged.csv` | 11,680 sp × 171 cols |
| **Balanced chunks** | `model_data/inputs/bhpmf_chunks_balanced_20251027/` | 6 chunks × ~1,947 sp |
| **CV masked datasets** | `model_data/inputs/bhpmf_cv_masked_20251027/` | 360 masked datasets |
| **CV schedules** | `model_data/inputs/bhpmf_cv_schedules_20251027/` | 360 schedule files |
| **CV outputs** | `model_data/outputs/bhpmf_cv_20251027/` | 360 BHPMF outputs |
| **Aggregated predictions** | `model_data/outputs/bhpmf_cv_predictions_20251027.csv` | 34,422 predictions |

---

## 10. Notes

**Design principles:**
- **Anti-leakage:** Log traits only, no raw traits
- **Cell-level CV:** Same methodology as XGBoost (10-fold sklearn KFold)
- **Balanced chunks:** Random shuffling prevents empty columns
- **Taxonomic hierarchy:** WFO Genus/Family (99.99% coverage)

**BHPMF feature set (171 features):**
- 6 log traits: logLA, logNmass, logSLA, logH, logSM, logLDMC
- 2 hierarchy: Genus, Family (categorical)
- 5 EIVE: Ecological indicators (52% coverage)
- 156 environmental: WorldClim + SoilGrids + Agroclim q50 features
- 2 IDs: wfo_taxon_id, wfo_accepted_name

**Computational constraints:**
- Chunking: ~1,947 species per chunk (memory limit)
- Runtime: ~10 seconds per CV fold
- Total CV time: ~60 minutes for 360 runs

**Performance characteristics:**
- Best trait: plant_height_m (R² = 0.36)
- Moderate: sla_mm2_mg (R² = 0.28)
- Poor: Most other traits (R² < 0.20)
- Failure: ldmc_frac (R² = -6.02, worse than baseline)

---

**Status:** ✓ Complete (2025-10-27)

**Completed steps:**
1. ✓ Dataset preparation (anti-leakage design)
2. ✓ Balanced chunks creation (6 chunks)
3. ✓ CV dataset generation (360 masked datasets)
4. ✓ BHPMF CV execution (360/360 successful)
5. ✓ Predictions collection (34,422 test observations)
6. ✓ Metrics computation (comprehensive evaluation)
