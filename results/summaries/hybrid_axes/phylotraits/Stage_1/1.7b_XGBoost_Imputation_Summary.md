# Stage 1 — XGBoost-Based Imputation (mixgb Pilot)

Date: 2025-10-22  
Maintainer: Stage 1 modelling support

---

## 1. Objective
- Evaluate multiple imputation driven by `mixgb` (XGBoost + predictive mean matching) on the 1 084-species modelling roster.
- Assemble a clean feature matrix that retains categorical traits, phylogenetic predictors, and the WorldClim/SoilGrids/AgroClim median summaries used in Stage 2.
- Compare mixgb’s log-space CV errors with the established BHPMF run (same roster, environmental medians enabled).

## 2. Input datasets
| Dataset | Path | Notes |
| --- | --- | --- |
| Modelling shortlist (ge ≥30) | `data/stage1/stage1_modelling_shortlist_with_gbif_ge30.parquet` | Defines the 1 084 species |
| Pre-BHPMF trait table | `model_data/inputs/traits_model_ready_20251022.parquet` | Numeric traits before gap filling |
| Categorical descriptors (TRY) | `data/stage1/stage1_union_canonical.parquet` | `try_woodiness`, `try_growth_form`, etc. |
| Phylogenetic predictors | `model_data/outputs/p_phylo_ge30_20251021.parquet` | `p_phylo_T/M/L/N/R` |
| Climate/soil medians | `model_data/inputs/env_features_ge30_20251022_means.csv` | Only `_q50` features kept |

## 3. Feature table construction
```bash
# Build modelling feature matrix (1084 × 164)
conda run -n AI --no-capture-output python - <<'PY'
import pandas as pd
from pathlib import Path
root = Path('model_data/inputs')
roster = pd.read_parquet('data/stage1/stage1_modelling_shortlist_with_gbif_ge30.parquet', columns=['wfo_taxon_id']).astype({'wfo_taxon_id': str})
traits = pd.read_parquet('model_data/inputs/traits_model_ready_20251022.parquet')[['wfo_taxon_id','wfo_scientific_name','leaf_area_mm2','try_nmass','ldmc_frac','lma_g_m2','plant_height_m','seed_mass_mg','leaf_area_source','nmass_source','ldmc_source','lma_source','height_source','seed_mass_source']]
cat_df = pd.read_parquet('data/stage1/stage1_union_canonical.parquet', columns=['wfo_id','try_woodiness','try_growth_form','try_habitat_adaptation','try_succulence','try_parasitism','try_carnivory','try_leaf_type']).rename(columns={'wfo_id':'wfo_taxon_id'}).drop_duplicates('wfo_taxon_id')
phylo = pd.read_parquet('model_data/outputs/p_phylo_ge30_20251021.parquet')
env = pd.read_csv('model_data/inputs/env_features_ge30_20251022_means.csv').drop(columns=[c for c in ['species','wfo_accepted_name'] if c in env.columns])
merged = roster.merge(traits, on='wfo_taxon_id', how='left')\
                 .merge(cat_df, on='wfo_taxon_id', how='left')\
                 .merge(phylo, on='wfo_taxon_id', how='left')\
                 .merge(env, on='wfo_taxon_id', how='left')
merged = merged.rename(columns={'try_nmass':'nmass_mg_g'})
out_base = root/'mixgb'/'mixgb_input_20251022'
out_base.parent.mkdir(parents=True, exist_ok=True)
merged.to_parquet(out_base.with_suffix('.parquet'), index=False)
merged.to_csv(out_base.with_suffix('.csv'), index=False)
PY
```

## 4. mixgb imputation run
```bash
export R_LIBS_USER="/home/olier/R/x86_64-pc-linux-gnu-library/4.4"
conda run -n AI Rscript model_data/inputs/mixgb/run_mixgb.R
```
- Script `run_mixgb.R` (in `model_data/inputs/mixgb/`) fits mixgb 10 times (Type 2 PMM, pmm.k=4, 300 rounds).
- Outputs:
  - `mixgb_imputed_20251022_m{1..10}.csv/parquet`
  - `mixgb_imputed_20251022_mean.csv/parquet`
  - `mixgb_warnings.txt` (XGBoost API deprecation messages)

## 5. Cross-validation (mixgb)
```bash
export R_LIBS_USER="/home/olier/R/x86_64-pc-linux-gnu-library/4.4"
conda run -n AI Rscript model_data/inputs/mixgb/mixgb_cv_eval.R
```
- 5-fold CV on observed entries (log or logit transform, matching BHPMF diagnostics).
- Result file: `model_data/inputs/mixgb/mixgb_cv_rmse.csv`.

## 6. mixgb vs BHPMF accuracy
| Trait | BHPMF log-RMSE (env means) | mixgb log-RMSE | Δ = mixgb − BHPMF |
| --- | --- | --- | --- |
| Leaf area (mm²) | 1.625 | 2.060 | +0.435 |
| Nmass (mg g⁻¹) | 0.316 | 0.328 | +0.012 |
| LMA (g m⁻²) | 0.324 | 0.406 | +0.082 |
| Plant height (m) | 0.813 | 1.019 | +0.206 |
| Diaspore mass (mg) | 1.783 | 2.666 | +0.883 |
| LDMC | 0.292 | 0.403 | +0.111 |

**Conclusion**: mixgb produces stable fills but yields higher log-space RMSE than BHPMF across all six modelling traits. Scripts, feature tables, and comparison outputs reside under `model_data/inputs/mixgb/`.

---

## Verification Checklist
- [ ] `mixgb_input_20251022.{csv,parquet}` has **1 084 × 164** with the expected columns (six targets, categorical predictors, `p_phylo_*`, `_q50` climate/soil means).
- [ ] `run_mixgb.R` created all ten imputed datasets, the mean-table, and `mixgb_warnings.txt`.
- [ ] `mixgb_cv_eval.R` produced `mixgb_cv_rmse.csv` with five folds per trait and the log-RMSE values above.
- [ ] BHPMF diagnostics present at `model_data/outputs/diag_bhpmf_ge30_20251022_env_means/` (coverage report, mean/SD tables).
- [ ] `mixgb_vs_bhpmf_rmse_comparison.csv` summarises the ΔRMSE values (>0 ⇒ mixgb worse) and `top_diff_<trait>.csv` highlight the largest discrepancies.
