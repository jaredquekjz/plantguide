# Stage 1.9 — Phylogenetic Predictors (Canonical)

**Date:** 2025-10-29
**Status:** Canonical reproduction documentation aligned with Stage 2 usage

---

## Overview

This stage calculates phylogenetic predictors (p_phylo) for TWO modeling contexts used in Stage 2:

1. **Tier 1 (1,084 species):** For hyperparameter tuning - phylo calculated on 1,075-species tree
2. **Tier 2 (~6,200 per axis):** For production CV - phylo calculated on axis-specific ~5,400-species trees

**Formula (Shipley):**
```
w_ij = 1 / d_ij²     (phylogenetic distance weighting)
p_ik = sum(w_ij * E_j) / sum(w_ij)  (leave-one-out weighted average)
```

**Parameters:**
- `x_exp=2`: Weight inversely proportional to phylogenetic distance squared
- `k_trunc=0`: No truncation (use all neighbors)
- Leave-one-out: Each species' predictor excludes its own value

**Reference:** Bill Shipley, "Using a weighted phylogenetic distance as an additional predictor of EIVE"

---

## 1. Tier 1 Phylo Predictors (1,084 Species)

**Purpose:** Phylogenetic predictors for Tier 1 hyperparameter tuning

### 1.1 Inputs

**Species roster:**
```
model_data/inputs/modelling_master_1084_20251029.csv
```
- 1,084 species with GBIF ≥30 occurrences
- Selected for robust environmental data extraction

**EIVE residuals:**
```
model_data/inputs/eive_residuals_by_wfo.csv
```
- 12,879 species with aggregated EIVE residuals (EIVEres-L/T/M/N/R)

**Phylogenetic tree:**
```
data/phylogeny/mixgb_tree_11676_species_20251027.nwk
```
- 10,977 unique tips
- Tree tip format: `wfo-ID|Species_name` (e.g., `wfo-0000058494|Zinnia_elegans`)

### 1.2 Build Script

**Script:** `src/Stage_1/build_tier1_phylo_predictors.R`

**Steps:**
1. Load 1,084-species roster
2. Prune full tree to species with observed EIVE (→ 1,075 species remain)
3. Calculate phylogenetic distance matrix
4. For each EIVE axis (L,T,M,N,R):
   - Apply Shipley leave-one-out weighted averaging
   - Generate p_phylo_{AXIS} for 1,084 species (9 species without EIVE get NA)

**Execution:**
```bash
env R_LIBS_USER="/home/olier/ellenberg/.Rlib" \
  /usr/bin/Rscript src/Stage_1/build_tier1_phylo_predictors.R
```

### 1.3 Output

**File:**
```
model_data/outputs/p_phylo_1084_tier1_20251029.csv
```

**Columns:**
- wfo_taxon_id
- p_phylo_L, p_phylo_T, p_phylo_M, p_phylo_N, p_phylo_R

**Coverage:** 1,075 / 1,084 species (99.2%)

**Usage:** Merged into Tier 1 feature tables by Stage 2 (see `src/Stage_2/build_tier1_features.py`)

---

## 2. Tier 2 Phylo Predictors (~6,200 Species Per Axis)

**Purpose:** Context-matched phylogenetic predictors for Tier 2 production CV

### 2.1 Why Context-Matched?

**Problem:** Using phylo calculated on the full 10,977-species tree causes predictor collapse in CV models trained on ~6,200 species subsets.

**Solution:** Calculate phylo predictors within each axis's training context:
- Prune tree to ONLY species with observed EIVE for this axis
- Calculate phylo predictors on this pruned tree
- Result: phylo predictors match the phylogenetic context of the training data

### 2.2 Inputs

**Per-axis feature tables (with species rosters):**
```
model_data/inputs/stage2_features/L_features_11680_20251029.csv  (6,165 with observed L)
model_data/inputs/stage2_features/T_features_11680_20251029.csv  (6,220 with observed T)
model_data/inputs/stage2_features/M_features_11680_20251029.csv  (6,245 with observed M)
model_data/inputs/stage2_features/N_features_11680_20251029.csv  (6,000 with observed N)
model_data/inputs/stage2_features/R_features_11680_20251029.csv  (6,063 with observed R)
```

**EIVE residuals:**
```
model_data/inputs/eive_residuals_by_wfo.csv
```

**Phylogenetic tree:**
```
data/phylogeny/mixgb_tree_11676_species_20251027.nwk
```

### 2.3 Build Script

**Script:** `src/Stage_2/calculate_tier2_cv_phylo.R`

**Steps (per axis):**
1. Load axis feature table → identify species with observed EIVE
2. Prune full tree to these species (→ ~5,400-species tree per axis)
3. Calculate phylogenetic distance matrix
4. Apply Shipley leave-one-out weighted averaging
5. Generate p_phylo_{AXIS} for this axis's species

**Execution:**
```bash
env R_LIBS_USER="/home/olier/ellenberg/.Rlib" \
  /usr/bin/Rscript src/Stage_2/calculate_tier2_cv_phylo.R
```

### 2.4 Outputs

**Files:**
```
model_data/outputs/p_phylo_tier2_cv/p_phylo_L_tier2_cv_20251029.csv  (6,165 species)
model_data/outputs/p_phylo_tier2_cv/p_phylo_T_tier2_cv_20251029.csv  (6,220 species)
model_data/outputs/p_phylo_tier2_cv/p_phylo_M_tier2_cv_20251029.csv  (6,245 species)
model_data/outputs/p_phylo_tier2_cv/p_phylo_N_tier2_cv_20251029.csv  (6,000 species)
model_data/outputs/p_phylo_tier2_cv/p_phylo_R_tier2_cv_20251029.csv  (6,063 species)
```

**Columns (per file):**
- wfo_taxon_id
- p_phylo_{AXIS}

**Coverage:** ~87% per axis (phylo calculated for species in the pruned tree)

**Usage:** Merged into Tier 2 feature tables by `src/Stage_2/update_tier2_features_with_cv_phylo.py`

---

## 3. Usage in Stage 2

### Tier 1 (Hyperparameter Tuning)

**Input:** `model_data/inputs/stage2_features/L_features_1084_tier1_20251029.csv` (and T/M/N/R)
**Phylo:** From 1,075-species tree (p_phylo_1084_tier1_20251029.csv)
**Models:** `model_data/outputs/stage2_xgb/{L,T,M,N,R}_1084_tier1_20251029/`
**Performance:** Phylo ranks #1-6 across axes (restored from collapse)

### Tier 2 (Production CV)

**Input:** `model_data/inputs/stage2_features/L_features_11680_corrected_20251029.csv` (and T/M/N/R)
**Phylo:** From axis-specific ~5,400-species trees (p_phylo_{L,T,M,N,R}_tier2_cv_20251029.csv)
**Models:** Will be trained with canonical datasets
**Expected:** Phylo ranks #1-6 (context-matched predictors)

---

## 4. Key Results

**Context-matching restored phylo predictor importance:**

| Axis | Before (Wrong Context) | After (Context-Matched) | Restoration |
|------|----------------------|------------------------|-------------|
| M | #45 | #1 | ✓ |
| L | #149 | #2 | ✓ |
| N | #96 | #2 | ✓ |
| R | #75 | #6 | ✓ |
| T | #87 | #19 | ✓ |

**Lesson:** Phylogenetic predictors MUST be calculated within the same phylogenetic context as the training data for CV models.

---

## 5. Files Summary

| File | Species | Tree | Use |
|------|---------|------|-----|
| `p_phylo_1084_tier1_20251029.csv` | 1,084 | 1,075 tips | Tier 1 tuning |
| `p_phylo_L_tier2_cv_20251029.csv` | 6,165 | ~5,400 tips | Tier 2 L-axis |
| `p_phylo_T_tier2_cv_20251029.csv` | 6,220 | ~5,400 tips | Tier 2 T-axis |
| `p_phylo_M_tier2_cv_20251029.csv` | 6,245 | ~5,400 tips | Tier 2 M-axis |
| `p_phylo_N_tier2_cv_20251029.csv` | 6,000 | ~5,400 tips | Tier 2 N-axis |
| `p_phylo_R_tier2_cv_20251029.csv` | 6,063 | ~5,400 tips | Tier 2 R-axis |

---

## 6. Related Documentation

- **Context mismatch issue:** `RESOLUTION_phylo_context_issue_20251029.md` (Tier 1)
- **Tier 2 resolution:** `Stage_2/RESOLUTION_phylo_context_tier2_20251029.md`
- **Master table build:** `1.10_Modelling_Master_Table.md`
- **Stage 2 usage:** `Stage_2/2.0_Modelling_Overview.md`

---

**Status:** Canonical phylo predictors calculated and integrated into Stage 2 modeling
