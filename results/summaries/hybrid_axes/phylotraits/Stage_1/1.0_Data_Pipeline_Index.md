# Stage 1 — Data Pipeline Index

Date: 2025-10-21  
Maintainer: Stage 1 data engineering

This index stitches together every **current** Stage 1 summary (legacy notes live under `Stage_1/legacy/`). Use it as the master map when you need to regenerate artefacts, rerun QA, or explain the provenance of the modelling inputs.

---

## 1. End-to-end Flow

```mermaid
flowchart LR
    raw_sources([Raw Sources\nGBIF · TRY · AusTraits · WFO · Agroclim · SoilGrids]) --> wfo_norm
    wfo_norm[1.1 WFO Normalisation\n1.1_WFO_Normalisation_Verification.md] --> dataset_build
    dataset_build[1.2/1.3 Shortlisting\n1.2_Dataset_Construction.md · 1.3_Shortlisting_Verification.md] --> env_sampling
    env_sampling[1.4–1.6 Environmental Workflow\n1.4_Data_Extraction.md · 1.5_Climate_Soil_Agroclim_Workflows.md · 1.6_Environmental_Verification.md] --> trait_prep
    trait_prep[1.7 Trait Aggregation & Imputation\n1.7_Trait_Modelling_Prep.md] --> outputs
    outputs[[Stage 1 Outputs\nmodel_data/inputs/* · data/stage1/*]] --> encyclo
    env_sampling --> photos[1.8 Media QA\n1.8_iNaturalist_Photo_QA.md]
    outputs --> encyclo[Modelling + Encyclopedia Pipelines]
```

---

## 2. Pipeline Checkpoints

| Step | Summary | What it covers | Key artefacts |
|------|---------|----------------|---------------|
| WFO normalisation & merges | `1.1_WFO_Normalisation_Verification.md` | Cross-dataset WFO reconciliation, synonym audits, legacy ID tracking | `data/stage1/master_taxa_union.parquet` |
| Shortlisting & dataset stats | `1.2_Dataset_Construction.md` · `1.3_Shortlisting_Verification.md` | Rules for shortlist tiers (master, ≥30 GBIF, modelling 1 273/1 084) and QA queries | `data/stage1/stage1_shortlist_with_gbif*.parquet` |
| Environmental sampling | `1.4_Data_Extraction.md` (historical steps) · `1.5_Climate_Soil_Agroclim_Workflows.md` | `sample_env_terra.R` usage, aggregation commands, quantiles | `data/stage1/{worldclim,soilgrids,agroclime}_*.parquet` |
| Environmental QA | `1.6_Environmental_Verification.md` | Checklist outputs, null sweeps, join rehearsals | Logs in `logs/stage1_environment/<date>/` |
| Trait aggregation & imputation | `1.7_Trait_Modelling_Prep.md` | TRY/AusTraits merges, BHPMF reruns, coverage deltas | `model_data/inputs/traits_model_ready_*` · BHPMF diagnostics |
| Media QA | `1.8_iNaturalist_Photo_QA.md` | vetted photo workflow, iNaturalist download QA | `logs/stage1_media/*` |

---

## 3. Quick Reference — Commands

| Task | Command (2025-10-21 rerun) |
|------|---------------------------|
| Rebuild environmental summaries | `conda run -n AI --no-capture-output python scripts/aggregate_stage1_env_summaries.py worldclim soilgrids agroclime` |
| Regenerate quantiles | DuckDB helper in `1.5_Climate_Soil_Agroclim_Workflows.md` (loops over datasets) |
| Rebuild trait tables + modelling shortlist | `conda run -n AI --no-capture-output python scripts/rebuild_stage1_trait_tables.py --stamp <YYYYMMDD>` |
| Run BHPMF on modelling shortlist | `R_LIBS_USER=/home/olier/ellenberg/.Rlib Rscript src/Stage_2_Data_Processing/phylo_impute_traits_bhpmf.R --input_csv=..._modelling_shortlist_<stamp>.csv ...` |
| Archive QA evidence | `logs/stage1_environment/<date>/qa_report.md` · `logs/stage1_modelling_prep/<date>/qa_report.md` |

---

## 4. When to Visit Which File

- **Need shortlist thresholds or GBIF coverage numbers?** → `1.2_Dataset_Construction.md`  
- **Re-running environmental QA?** → `1.6_Environmental_Verification.md` (and update the QA log)  
- **Preparing modelling inputs / trait provenance?** → `1.7_Trait_Modelling_Prep.md`  
- **Explaining WFO merge decisions?** → `1.1_WFO_Normalisation_Verification.md`  
- **Media assets for the encyclopedia?** → `1.8_iNaturalist_Photo_QA.md`

Keep this index aligned with any new summaries or major pipeline changes. If a document moves to `legacy/`, update the mermaid diagram and table accordingly so readers always land on the canonical guidance.

---

## 5. Final Stage 1 Datasets

| Use case | Dataset | Notes |
|----------|---------|-------|
| Encyclopedia / Stage 1 shortlist (11 680 species) | `model_data/inputs/traits_model_ready_20251021_rerun_shortlist.parquet` | BHPMF-imputed trait table filtered to the ≥30-occurrence shortlist; retains provenance columns (`ldmc_source`, etc.). |
| Modelling roster (1 084 species, ≥30 georeferenced occurrences) | `model_data/inputs/traits_model_ready_20251021_rerun_ge30.parquet` | Trait table restricted to `stage1_modelling_shortlist_with_gbif_ge30.parquet`; ready for design matrix assembly. |
| BHPMF numeric output (1 273 species before ge30 filter) | `model_data/outputs/trait_imputation_bhpmf_modelling_shortlist_20251021_rerun.parquet` | Direct BHPMF means/SDs + imputation flags; useful for auditing fills or expanding beyond the ge30 filter. |
