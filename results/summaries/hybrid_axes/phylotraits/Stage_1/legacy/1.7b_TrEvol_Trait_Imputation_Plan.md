# Stage 1 — TrEvol Trait Imputation Plan (Draft)

Date: 2025-10-22  
Maintainer: Stage 1 modelling support  
Scope: Planning document for integrating TrEvol-based diagnostics and imputation alongside BHPMF.

---

## 1. Objective
- Evaluate the TrEvol framework as a complementary trait-imputation pipeline that can ingest phylogeny, trait co-structure, and environmental covariates.
- Phase the work so we can quickly benchmark TrEvol’s `imputeTraits()` output against the existing BHPMF artefacts, while keeping a roadmap for the richer tri-response variance diagnostics.
- **Execution note:** For the current sprint we will **run the BHPMF residual prototype (Section 4) and the TrEvol `imputeTraits()` workflow (Section 5)**. The tri-response diagnostics in Section 2 remain scoped but unexecuted until we schedule the deeper variance partition.

---

## 2. Tri-Response Diagnostics (Deferred)
Goal: quantify how each environmental driver partitions trait variance/covariance into phylogenetic vs non-phylogenetic components before building the imputer.

1. **Input curation**
   - Use the Stage 1 modelling roster (1 084 species, `ge30`) with raw traits in natural units plus log/logit transforms already stored in `trait_imputation_input_modelling_ge30_20251022.csv`.
   - Key environmental columns: start with the median (`*_q50`) suite from `env_features_ge30_20251022_means.csv`. Prioritise a small candidate set (e.g. `wc2_1_30s_bio_1_q50`, `bio_12_q50`, representative soil and agro medians) to keep runtimes manageable.
   - Ensure the phylogeny used in Stage 1/Stage 2 (2025-10-21 update) is pruned to the modelling roster; tip labels must match the species column exactly.

2. **Per-environment runs**
   - For each chosen environmental predictor, call:
     ```r
     variance_covariance_results <- computeVarianceCovariancePartition(
       traits = c("Leaf area (mm2)", "Nmass (mg/g)", "LMA (g/m2)",
                  "Plant height (m)", "Diaspore mass (mg)", "LDMC"),
       environmental_variable = "ENV_COLUMN",
       dataset = trait_table,
       terminal_taxa = "wfo_accepted_name",
       phylogeny = modelling_tree,
       model_specifications = defineModelsSpecifications(
         number_iterations = 150000,
         burning_iterations = 5000,
         thinning_iterations = 50
       ),
       show_relative_variance = TRUE,
       verbose = TRUE
     )
     ```
   - Archive each variance/covariance output to `model_data/outputs/trevol/variance_partition_ENV_COLUMN.rds` plus a CSV export for quick inspection.
   - Capture convergence diagnostics (effective sample sizes, trace plots). If any model fails to converge, relax priors or increase iterations.

3. **Synthesis (future task)**
   - Collate per-environment summaries into a comparison table highlighting which drivers show significant phylogenetic-environmental variance.
   - Use these insights to prioritise predictors in the imputation stage or derive composite environmental indices if signals are redundant.

*Status:* Deferred. Leave placeholders in the QA tracker; no computation performed in this iteration.

---

## 3. TrEvol Random-Forest Imputation (Planned for Immediate Execution)
Goal: generate environment-aware imputed traits using TrEvol’s `imputeTraits()` and benchmark against BHPMF.

1. **Package readiness**
   - Installed from GitHub (`pablosanchezmart/TrEvol`, commit 72e267a) into the shared R library `/home/olier/ellenberg/.Rlib`. Dependencies (`MCMCglmm`, `ggtree`, `missForest`, etc.) tested with `library(TrEvol); packageVersion("TrEvol")`.
   - Repro command (conda environment `AI`):
     ```bash
     R_LIBS_USER="/home/olier/ellenberg/.Rlib" \
       conda run -n AI Rscript -e 'library(TrEvol); print(packageVersion("TrEvol"))'
     ```

2. **Data assembly**
   - Base trait table: `model_data/inputs/trait_imputation_input_modelling_ge30_20251022.csv`.
   - Environment predictors: `env_features_ge30_20251022_means.csv`. Retain all 140+ `_q50` medians for the RF screen; the function will down-select automatically.
   - Phylogeny: `data/phylogeny/eive_try_tree_20251021.nwk`, pruned to 1 084 modelling species.
   - Pre-run checks:
     - Confirm absence of all-null columns (`python` QA already archived in Section 3.3 of `1.7_Trait_Aggregation_Imputation_Verification.md`).
     - Validate positive-only traits and LDMC bounds before imputation (reuse the existing sanity assertions).

3. **Call structure**
   - Core invocation (to be executed now):
     ```r
     library(TrEvol)
     trait_data <- read.csv("model_data/inputs/trait_imputation_input_modelling_ge30_20251022.csv")
     env_data <- read.csv("model_data/inputs/env_features_ge30_20251022_means.csv")

     merged <- trait_data |>
       dplyr::inner_join(env_data, by = "wfo_accepted_name")

     modelling_tree <- ape::read.tree("data/phylogeny/eive_try_tree_20251021.nwk")

     imputed <- imputeTraits(
       variables_to_impute = c("Leaf area (mm2)", "Nmass (mg/g)", "LMA (g/m2)",
                               "Plant height (m)", "Diaspore mass (mg)", "LDMC"),
       dataset = merged,
       terminal_taxa = "wfo_accepted_name",
       phylogeny = modelling_tree,
       predictors = setdiff(names(env_data), "wfo_accepted_name"),
       number_iterations = 5,      # repeat RF with 5 seeds
       number_clusters = 4,        # adjust to available CPU cores
       proportion_NAs = 0.2        # internal masking for diagnostics
     )
     ```
   - Outputs:
     - Imputed trait averages per round: `imputed$round3$ximp`.
     - Predictive performance metrics: `imputed$round3$predictivePerformance`.
     - Write each iteration and the pooled mean to `model_data/outputs/trevol/imputeTraits_ge30_env_round{1..5}.csv` plus an aggregate mean/parquet.

4. **Hold-out evaluation**
   - Use the `proportion_NAs` splits TrEvol generates to compute RMSE/MAE in natural units and log-space; compare with the existing BHPMF metrics table (`bhpmf_ge30_20251022_env_vs_base_metrics*.csv`).
   - If TrEvol does not expose fold identifiers, capture them manually by storing the indices of artificially masked observations (`imputed$round3$maskedRows`).
   - Summarise results in `model_data/outputs/trevol/trevol_vs_bhpmf_metrics.csv` with columns: trait, metric, TrEvol value, BHPMF value, delta.

5. **Runtime tracking**
  - Record wall-clock per iteration (wrap the call in `system.time`) and note resource usage (CPU cores, memory). Keep a concise log under `model_data/outputs/trevol/logs/`.
  - If `proportion_NAs` is set to 0 for the production fill, re-run once more without artificial masking and save the final imputed table as `trait_imputation_trevol_ge30_20251022_env.csv`.

---

## 4. BHPMF Cross-validated Residual Extension (aHPMF Roadmap)

Goal: Reproduce the aHPMF residual correction described by Schrodt et al. (2015) by synthesising leave-one-out predictions from the current species-level BHPMF pipeline.

1. **Construct the masking schedule**  
   - Enumerate every `(species, trait)` measurement in `model_data/inputs/trait_imputation_input_shortlist_20251021.csv`.  
   - Chunk the list into ≤ 250 entries and drop each chunk as `model_data/inputs/bhpmf_cv_chunks_<STAMP>/chunkNNN.csv` for reproducible runs.

2. **Generate leave-one-out predictions**  
   - For each chunk, clone the shortlist BHPMF input, set the scheduled cells to `NA`, and run `src/Stage_1/run_bhpmf_chunk.sh` with the same environment matrix (`env_features_shortlist_20251022_all_q50.csv`).  
   - Extract the predicted values for the masked cells from `bhpmf_mean.tsv` and append them to `model_data/outputs/bhpmf_cv_predictions_<STAMP>.csv` (`species_key`, `trait`, `y_obs`, `y_pred_cv`).

3. **Derive residuals**  
   - Compute transform-space residuals (`log` or `logit`) for each recorded prediction; aggregate to `model_data/outputs/bhpmf_cv_residuals_<STAMP>.parquet` alongside the per-species environment medians.

4. **Fit residual regressions**  
   - Run `scripts/run_ahpmf_residuals.py` on the aggregated residual table with ridge regression (5-fold CV over `α ∈ 10^{-3..3}`) and the `_q50` climate/soil medians as predictors.  
   - Store fitted metrics in `model_data/outputs/bhpmf_ahpmf_metrics_<STAMP>.csv` and predicted residuals (`..._residual_hat_<STAMP>.csv`).

5. **Produce adjusted predictions**  
   - Apply the predicted residuals to the full BHPMF environment-aware outputs (`trait_imputation_bhpmf_shortlist_20251022_env_all.*` and the ge30 subset) in transform space, back-transform to raw units, and emit `..._ahpmf.csv`.  
   - Preserve measured values by overwriting adjusted cells with the original observations.

6. **QA and integration**  
   - Re-run positivity/LDMC bounds (Section 3.5 of `1.7_Trait_Aggregation_Imputation_Verification.md`), compare factor-of-two coverage before/after adjustment, and commit the results to the verification doc.  
   - Extend `rebuild_stage1_trait_tables.py` so Stage 2 can opt into the `_ahpmf` columns, and record in CLM/XGBoost manifests which trait flavour is in play.

---

## 5. Comparison & Reporting (Immediate)
- Build a tidy summary (R script) that:
  - Joins TrEvol imputed means with observed trait values for species that have measurements.
  - Computes error metrics identical to the BHPMF QA (RMSE, MAE, log RMSE, bias).
  - Produces residual plots and predicted vs observed scatter plots for each trait.
- Store the notebook or script under `notebooks/stage1/trevol_imputation_qc_<STAMP>.Rmd`.
- Update `results/summaries/hybrid_axes/phylotraits/Stage_1/1.7_Trait_Aggregation_Imputation_Verification.md` with the headline comparison once metrics are available.

---

## 6. Future Enhancements (Post-Comparison)
- Resume the tri-response runs (Section 2) to interpret environmental signals in detail; recycle the same R scaffolding once `imputeTraits` benchmarking is complete.

- Expand to the full shortlist (11 680 species) using the balanced chunk inputs:
  - Replicate the `imputeTraits` call per chunk or adapt the helper to stream species batches (ensure column coverage).
  - Compare shortlist-level coverage and accuracy with the BHPMF environment-aware chunks (already stitched).
- Explore hybrid strategies if TrEvol excels for specific traits (e.g., foliar N) while BHPMF remains stronger elsewhere.
- Consider wrapping the TrEvol workflow in a Makefile target to match the existing Stage 1 reproducibility pattern.

---

## 7. Open Questions
- Will we rescale environmental predictors (z-scores) prior to passing them to TrEvol, or rely on the internal correlation filter?
- How many phylogenetic axes should we retain? Default auto-selection uses eigenvalues >1 %; we may tighten/loosen this once we inspect performance.
- Do we need to harmonise uncertainty estimates (TrEvol vs BHPMF posterior SDs) before Stage 2 modelling can consume the outputs?

---

## 8. Attempt Log — 2025-10-22
- **Sanitised build script:** Added `scripts/run_trevol_impute_ge30_env_means.R` to automate dataset preparation (drop non-numeric env columns, normalise names, attach `animal` labels) and to call `imputeTraits` with configurable iterations/cluster counts.
- **Phylogeny checks:** Confirmed the 2025-10-21 tree covers all 1 084 modelling species; node labels removed to avoid `inverseA` conflicts.
- **Run outcome:** Every TrEvol launch aborted during `computeVarianceCovariancePartition`:
  - Early attempts failed on categorical predictors (`species`, `Genus`, `Family`); these have been excluded.
  - Latest run dies with `NA/NaN/Inf in 'y'` once the tri-response models reach a remaining predictor, implying at least one numeric column still introduces invalid values post-sanitisation.
- **Outputs:** No TrEvol imputed tables were generated; BHPMF artefacts remain the only fills on disk (`model_data/outputs/trevol/` currently empty).
- **Next diagnostic (pending):** Isolate the offending predictor(s) by iteratively filtering the `_q50` suite (likely AgroClim metrics) and rerun the script under a short timeout before attempting a full production run.

Work paused here pending that diagnostic pass.

---

## 9. Attempt Log — 2025-10-23
- **Code inspection:** Dumped the lazily-loaded `imputeTraits()` and `computeVarianceCovariancePartition()` bodies to clarify prerequisites. Key requirements: add a `taxon`/`animal` column that mirrors the `terminal_taxa`, normalise column names via `make.names()`, and expect TrEvol to append `Phylo_axis_*` coordinates from the supplied phylogeny (default keeps axes with >1 % eigenvalue weight). `imputeTraits()` also auto-triggers a full pairwise `computeVarianceCovariancePartition()` over `variables_to_impute ∪ predictors`, so the predictor list must stay compact to keep MCMCglmm workloads tractable.
- **30 s smoke test (success):** With `timeout 30s env R_LIBS_USER=... Rscript` and a 200-species slice, a single-trait run (`variables_to_impute = "Leaf area (mm2)"`, predictors = `wc2_1_30s_bio_1_q50`) finished in ~5 s and returned a full `round1–round3` result set. This confirms the Stage 1 modelling tables, environment medians, and the 2025-10-21 phylogeny are structurally compatible once columns are sanitised.
- **Multi-trait probe (failure reproduced quickly):** Extending the same harness to all six traits with two climate predictors (`wc2_1_30s_bio_1_q50`, `wc2_1_30s_bio_12_q50`) consistently aborts inside `TrEvol:::randomForestImpute()` after the `Diaspore mass` pass. Tracing shows the offending call receives a 200×17 matrix (`Diaspore.mass..mg.` + 16 `Phylo_axis_*` columns, zero missing in the predictors) yet `randomForest::predict()` raises `number of variables in newdata does not match that in the training data`. The mismatch appears during the second imputation round, implying an upstream missForest bug when previously-imputed traits enter the predictor set.
- **Implication:** Data conditioning is no longer the blocker—the remaining issue is TrEvol’s internal RF wrapper. Two straightforward workarounds surfaced from the traces: *(a)* loop over traits and call `imputeTraits()` one variable at a time (each succeeds under 30 s), or *(b)* pre-compute and pass trimmed `variance_results`/`correlation_results` so TrEvol skips the multi-trait missForest cycle. Option *(a)* is ready to script with the current inputs; option *(b)* needs extra tooling to curate the correlation tables without exploding the MCMC workload.

---

**Next Action:** Implement the per-trait TrEvol driver (option *(a)*) with the established 30 s pre-flight checks, archive each trait’s `round3` outputs under `model_data/outputs/trevol/`, and document the aggregate comparison versus BHPMF once all six traits complete. Revisit the bundled multi-trait workflow only after dissecting the `randomForestImpute()` column-mismatch in a dedicated branch.***
