# Stage 1 — Modelling Master Table

Date: 2025-10-22  
Maintainer: Stage 1 modelling support

---

## 1. Purpose
- Assemble the **1084-species modelling shortlist** into a single, analysis-ready table containing:
  - BHPMF-imputed traits + source flags.
  - Phylogenetic predictors (`p_phylo_T/M/L/N/R`).
  - WorldClim, SoilGrids and AgroClim quantile summaries (q05/q50/q95/IQR).
- Run a final integrity sweep so modelling can proceed with full confidence in coverage and provenance.

### Inputs
- Traits + phylogeny: `model_data/inputs/traits_model_ready_20251022_ge30_phylo.parquet`
- Climate & soil quantiles:
  - `model_data/inputs/worldclim_species_quantiles.parquet`
  - `model_data/inputs/soilgrids_species_quantiles.parquet`
  - `model_data/inputs/agroclime_species_quantiles.parquet`

### Outputs
- Final modelling table:
  - `model_data/inputs/modelling_master_20251022.parquet`
  - `model_data/inputs/modelling_master_20251022.csv`
- QA log: `logs/stage1_modelling_prep/20251022/modelling_master_qa.md`
- Trait note: `sla_mm2_mg` now prefers direct SLA measurements (TRY/AusTraits), falls back to AusTraits conversions, then derives from LMA when necessary; provenance recorded in `sla_source`.

---

## 2. Step-by-step Commands

### 2.1 Merge traits, phylogeny, and environmental quantiles
```bash
conda run -n AI --no-capture-output python - <<'PY'
import pandas as pd

traits = pd.read_parquet("model_data/inputs/traits_model_ready_20251022_ge30_phylo.parquet")
worldclim = pd.read_parquet("model_data/inputs/worldclim_species_quantiles.parquet")
soilgrids = pd.read_parquet("model_data/inputs/soilgrids_species_quantiles.parquet")
agroclim = pd.read_parquet("model_data/inputs/agroclime_species_quantiles.parquet")

merged = traits.merge(worldclim, on="wfo_taxon_id", how="left", validate="one_to_one")
merged = merged.merge(soilgrids, on="wfo_taxon_id", how="left", validate="one_to_one")
merged = merged.merge(agroclim, on="wfo_taxon_id", how="left", validate="one_to_one")

merged.to_parquet("model_data/inputs/modelling_master_20251022.parquet", index=False)
merged.to_csv("model_data/inputs/modelling_master_20251022.csv", index=False)

print("Merged shape:", merged.shape)
print("WorldClim rows lacking all metrics:", merged.filter(regex="^wc2_1_30s").isna().all(axis=1).sum())
print("SoilGrids rows lacking all metrics:", merged.filter(regex="^(phh2o|soc|bulk|cfvo|cec|nitrogen|clay|sand|silt)").isna().all(axis=1).sum())
print("AgroClim rows lacking all metrics:", merged.filter(regex="^(BEDD|CDD|GDD|GSL|FROSTD|PREC|PET|VAP|RAD|SPP)").isna().all(axis=1).sum())
PY
```

### 2.2 Summarise completeness and anomalies
```bash
conda run -n AI --no-capture-output python - <<'PY'
import pandas as pd
from pathlib import Path

df = pd.read_parquet("model_data/inputs/modelling_master_20251022.parquet")

summary = {
    "rows": len(df),
    "unique_wfo": df["wfo_taxon_id"].nunique(),
    "trait_coverage": {c: int(df[c].notna().sum()) for c in [
        "leaf_area_mm2","try_nmass","ldmc_frac","lma_g_m2","sla_mm2_mg","seed_mass_mg","plant_height_m"
    ]},
    "phylo_coverage": {c: int(df[c].notna().sum()) for c in ["p_phylo_T","p_phylo_M","p_phylo_L","p_phylo_N","p_phylo_R"]},
}

wc_cols = [c for c in df.columns if c.startswith("wc2_1_30s")]
soil_cols = [c for c in df.columns if c.startswith(("phh2o","soc","bulk","cfvo","cec","nitrogen","clay","sand","silt"))]
ag_cols = [c for c in df.columns if c.split("_", 1)[0] in {"BEDD","CDD","GDD","GSL","FROSTD","PREC","PET","VAP","RAD","SPP"}]

summary["worldclim_min_non_null"] = int(min(df[c].notna().sum() for c in wc_cols))
summary["soil_min_non_null"] = int(min(df[c].notna().sum() for c in soil_cols))
summary["agroclim_min_non_null"] = int(min(df[c].notna().sum() for c in ag_cols))

zero_worldclim = [c for c in wc_cols if df[c].notna().sum() == 0]
partial_soil = {c: int(df[c].notna().sum()) for c in soil_cols if df[c].notna().sum() < len(df)}

out = Path("logs/stage1_modelling_prep/20251022/modelling_master_qa.md")
out.parent.mkdir(parents=True, exist_ok=True)
out.write_text(\"\"\"# Modelling Master QA — 2025-10-22

- Rows: {rows}
- Unique WFO concepts: {unique_wfo}
- Core trait coverage (non-null counts): {trait_coverage}
- Phylogenetic coverage: {phylo_coverage}
- WorldClim columns: {wc_count} (minimum non-null {worldclim_min_non_null})
  - Columns with zero coverage: {zero_worldclim}
- SoilGrids columns: {soil_count} (minimum non-null {soil_min_non_null})
  - Partial coverage columns: {partial_soil}
- AgroClim columns: {ag_count} (minimum non-null {agroclim_min_non_null})
\"\"\".format(
    rows=summary["rows"],
    unique_wfo=summary["unique_wfo"],
    trait_coverage=summary["trait_coverage"],
    phylo_coverage=summary["phylo_coverage"],
    wc_count=len(wc_cols),
    worldclim_min_non_null=summary["worldclim_min_non_null"],
    zero_worldclim=zero_worldclim,
    soil_count=len(soil_cols),
    soil_min_non_null=summary["soil_min_non_null"],
    partial_soil=partial_soil,
    ag_count=len(ag_cols),
    agroclim_min_non_null=summary["agroclim_min_non_null"],
))
PY
```

---

## 3. Verification Findings (2025-10-22)
- **Row & key integrity**: 1084 rows with 1084 unique `wfo_taxon_id`; no duplicates introduced during joins.
- **Traits & phylogeny**: Core trait metrics remain positive and within bounds; canonical `sla_mm2_mg` covers 1 083 species with provenance in `sla_source` (1 081 direct measurements, 2 derived from LMA). `p_phylo_T/M/L/N/R` fully populated (1084 each).
- **WorldClim**: 176 columns joined successfully. Driest-quarter (`bio17`) quantiles continue to return NAs owing to sparse GBIF sampling; flagged for future data refresh.
- **SoilGrids**: 144 columns, minimum coverage 1080/1084. Gaps persist only in `nitrogen_60_100cm_{q05,q50,q95,iqr}` where the source tiles lack data.
- **AgroClim**: 24 columns, full coverage across all species.
- **Output artefacts**: Parquet/CSV pairs written for the master table and QA notes; the additional `sla_source` column exposes the measurement/derivation lineage used downstream.

Residual anomalies (bio17 / deep-soil nitrogen) trace back to source availability and do not block modelling; they are documented in the QA log. Trait sanity checks confirm `lma_g_m2`, `seed_mass_mg`, `plant_height_m` > 0, `ldmc_frac` ∈ (0, 1), and canonical SLA coverage now spans all 1 084 species following the priority merge (`sla_source` details each lineage).
