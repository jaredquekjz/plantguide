# Stage 1 — Modelling Master Table

Date: 2025-10-22  
Maintainer: Stage 1 modelling support

---

## 1. Purpose
- Assemble the **1084-species modelling shortlist** into a single, analysis-ready table containing:
  - BHPMF-imputed traits + source flags.
  - Phylogenetic predictors (`p_phylo_T/M/L/N/R`).
  - WorldClim, SoilGrids and AgroClim quantile summaries (q05/q50/q95/IQR).
- Run a final integrity sweep so modelling can proceed with full confidence in coverage and provenance.

### Inputs
- Traits + phylogeny: `model_data/inputs/traits_model_ready_20251022_ge30_phylo.parquet`
- Climate & soil quantiles:
  - `model_data/inputs/worldclim_species_quantiles.parquet`
  - `model_data/inputs/soilgrids_species_quantiles.parquet`
  - `model_data/inputs/agroclime_species_quantiles.parquet`

### Outputs
- Final modelling table:
  - `model_data/inputs/modelling_master_20251022.parquet`
  - `model_data/inputs/modelling_master_20251022.csv`
- QA log: `logs/stage1_modelling_prep/20251022/modelling_master_qa.md`
- Trait note: `sla_mm2_mg` now prefers direct SLA measurements (TRY/AusTraits), falls back to AusTraits conversions, then derives from LMA when necessary; provenance recorded in `sla_source`.

---

## 2. Step-by-step Commands

### 2.1 Merge traits, phylogeny, and environmental quantiles
```bash
conda run -n AI --no-capture-output python - <<'PY'
import pandas as pd

traits = pd.read_parquet("model_data/inputs/traits_model_ready_20251022_ge30_phylo.parquet")
worldclim = pd.read_parquet("model_data/inputs/worldclim_species_quantiles.parquet")
soilgrids = pd.read_parquet("model_data/inputs/soilgrids_species_quantiles.parquet")
agroclim = pd.read_parquet("model_data/inputs/agroclime_species_quantiles.parquet")

merged = traits.merge(worldclim, on="wfo_taxon_id", how="left", validate="one_to_one")
merged = merged.merge(soilgrids, on="wfo_taxon_id", how="left", validate="one_to_one")
merged = merged.merge(agroclim, on="wfo_taxon_id", how="left", validate="one_to_one")

merged.to_parquet("model_data/inputs/modelling_master_20251022.parquet", index=False)
merged.to_csv("model_data/inputs/modelling_master_20251022.csv", index=False)

print("Merged shape:", merged.shape)
print("WorldClim rows lacking all metrics:", merged.filter(regex="^wc2_1_30s").isna().all(axis=1).sum())
print("SoilGrids rows lacking all metrics:", merged.filter(regex="^(phh2o|soc|bulk|cfvo|cec|nitrogen|clay|sand|silt)").isna().all(axis=1).sum())
print("AgroClim rows lacking all metrics:", merged.filter(regex="^(BEDD|CDD|GDD|GSL|FROSTD|PREC|PET|VAP|RAD|SPP)").isna().all(axis=1).sum())
PY
```

### 2.2 Summarise completeness and anomalies
```bash
conda run -n AI --no-capture-output python - <<'PY'
import pandas as pd
from pathlib import Path

df = pd.read_parquet("model_data/inputs/modelling_master_20251022.parquet")

summary = {
    "rows": len(df),
    "unique_wfo": df["wfo_taxon_id"].nunique(),
    "trait_coverage": {c: int(df[c].notna().sum()) for c in [
        "leaf_area_mm2","try_nmass","ldmc_frac","lma_g_m2","sla_mm2_mg","seed_mass_mg","plant_height_m"
    ]},
    "phylo_coverage": {c: int(df[c].notna().sum()) for c in ["p_phylo_T","p_phylo_M","p_phylo_L","p_phylo_N","p_phylo_R"]},
}

wc_cols = [c for c in df.columns if c.startswith("wc2_1_30s")]
soil_cols = [c for c in df.columns if c.startswith(("phh2o","soc","bulk","cfvo","cec","nitrogen","clay","sand","silt"))]
ag_cols = [c for c in df.columns if c.split("_", 1)[0] in {"BEDD","CDD","GDD","GSL","FROSTD","PREC","PET","VAP","RAD","SPP"}]

summary["worldclim_min_non_null"] = int(min(df[c].notna().sum() for c in wc_cols))
summary["soil_min_non_null"] = int(min(df[c].notna().sum() for c in soil_cols))
summary["agroclim_min_non_null"] = int(min(df[c].notna().sum() for c in ag_cols))

zero_worldclim = [c for c in wc_cols if df[c].notna().sum() == 0]
partial_soil = {c: int(df[c].notna().sum()) for c in soil_cols if df[c].notna().sum() < len(df)}

out = Path("logs/stage1_modelling_prep/20251022/modelling_master_qa.md")
out.parent.mkdir(parents=True, exist_ok=True)
out.write_text(\"\"\"# Modelling Master QA — 2025-10-22

- Rows: {rows}
- Unique WFO concepts: {unique_wfo}
- Core trait coverage (non-null counts): {trait_coverage}
- Phylogenetic coverage: {phylo_coverage}
- WorldClim columns: {wc_count} (minimum non-null {worldclim_min_non_null})
  - Columns with zero coverage: {zero_worldclim}
- SoilGrids columns: {soil_count} (minimum non-null {soil_min_non_null})
  - Partial coverage columns: {partial_soil}
- AgroClim columns: {ag_count} (minimum non-null {agroclim_min_non_null})
\"\"\".format(
    rows=summary["rows"],
    unique_wfo=summary["unique_wfo"],
    trait_coverage=summary["trait_coverage"],
    phylo_coverage=summary["phylo_coverage"],
    wc_count=len(wc_cols),
    worldclim_min_non_null=summary["worldclim_min_non_null"],
    zero_worldclim=zero_worldclim,
    soil_count=len(soil_cols),
    soil_min_non_null=summary["soil_min_non_null"],
    partial_soil=partial_soil,
    ag_count=len(ag_cols),
    agroclim_min_non_null=summary["agroclim_min_non_null"],
))
PY
```

---

## 3. Verification Findings (2025-10-22)
- **Row & key integrity**: 1084 rows with 1084 unique `wfo_taxon_id`; no duplicates introduced during joins.
- **Traits & phylogeny**: Core trait metrics remain positive and within bounds; canonical `sla_mm2_mg` covers 1 083 species with provenance in `sla_source` (1 081 direct measurements, 2 derived from LMA). `p_phylo_T/M/L/N/R` fully populated (1084 each).
- **WorldClim**: 176 columns joined successfully. Driest-quarter (`bio17`) quantiles continue to return NAs owing to sparse GBIF sampling; flagged for future data refresh.
- **SoilGrids**: 144 columns, minimum coverage 1080/1084. Gaps persist only in `nitrogen_60_100cm_{q05,q50,q95,iqr}` where the source tiles lack data.
- **AgroClim**: 24 columns, full coverage across all species.
- **Output artefacts**: Parquet/CSV pairs written for the master table and QA notes; the additional `sla_source` column exposes the measurement/derivation lineage used downstream.

Residual anomalies (bio17 / deep-soil nitrogen) trace back to source availability and do not block modelling; they are documented in the QA log. Trait sanity checks confirm `lma_g_m2`, `seed_mass_mg`, `plant_height_m` > 0, `ldmc_frac` ∈ (0, 1), and canonical SLA coverage now spans all 1 084 species following the priority merge (`sla_source` details each lineage).

---

## 4. Stage 2 Experimental Configurations (q50-only)

**Date:** 2025-10-24
**Motivation:** Stage 1 XGBoost experiments (Perm7) showed that full environmental quantiles (q05/q50/q95/iqr) **degrade trait imputation performance by 55-58%** compared to median-only (q50). To test if this finding generalizes to Stage 2 EIVE axis prediction, we create two experimental configurations using **q50 environmental features only**.

### Configuration Comparison

| Config | EIVE Features | Phylo Features | Environmental | Purpose |
|--------|---------------|----------------|---------------|---------|
| **Full Quantiles (original)** | ✅ p_phylo_T/M/L/N/R | ✅ phylo_depth, etc. | q05/q50/q95/iqr (176+144+24 cols) | Original Stage 2 baseline |
| **Config A (q50 + EIVE)** | ✅ p_phylo_T/M/L/N/R | ✅ phylo_depth, etc. | **q50 only** (~43+36+24 cols) | Test q50 sufficiency WITH ecological predictors |
| **Config B (q50, no EIVE)** | ❌ No EIVE | ❌ No phylo codes | **q50 only** (~43+36+24 cols) | Test q50 sufficiency WITHOUT ecological predictors |

### Dataset Specifications

#### Config A: With EIVE/Phylo (q50 only)
- **Output:** `model_data/inputs/modelling_master_q50_with_eive_20251024.{parquet,csv}`
- **Features:**
  - Target traits: 7 (leaf_area_mm2, try_nmass, ldmc_frac, lma_g_m2, sla_mm2_mg, seed_mass_mg, plant_height_m)
  - Log transforms: 7 (logLA, logH, logSM, logLDMC, logNmass, logLMA, logSLA)
  - EIVE predictors: 5 (p_phylo_T, p_phylo_M, p_phylo_L, p_phylo_N, p_phylo_R)
  - Phylogenetic: ~5 (phylo_depth, phylo_terminal, genus_code, family_code, phylo_proxy_fallback)
  - Environmental (q50 only): ~103 columns
    - WorldClim: 43 (bio_1 to bio_19, elev, srad, vapr, wind - q50 only)
    - SoilGrids: 36 (7 variables × 6 depths - q50 only)
    - AgroClim: 24 (all variables - q50 only)
  - Provenance: 7 (*_source columns)
  - Taxonomy: 3 (wfo_taxon_id, wfo_scientific_name, species_normalized)
- **Expected columns:** ~137

#### Config B: Without EIVE/Phylo (q50 only)
- **Output:** `model_data/inputs/modelling_master_q50_no_eive_20251024.{parquet,csv}`
- **Features:**
  - Same as Config A EXCEPT:
    - ❌ Remove p_phylo_T/M/L/N/R (5 columns)
    - ❌ Remove phylo codes (genus_code, family_code, phylo_proxy_fallback: 3 columns)
    - ✅ Keep phylo_depth, phylo_terminal (may have signal independent of EIVE)
- **Expected columns:** ~129

### Construction Commands

See `scripts/build_stage2_q50_configs.py` for dataset assembly.

```bash
conda run -n AI python scripts/build_stage2_q50_configs.py \
  --input_traits model_data/inputs/traits_model_ready_20251022_ge30_phylo.parquet \
  --input_worldclim model_data/inputs/worldclim_species_quantiles.parquet \
  --input_soilgrids model_data/inputs/soilgrids_species_quantiles.parquet \
  --input_agroclim model_data/inputs/agroclime_species_quantiles.parquet \
  --output_dir model_data/inputs
```

### Experimental Hypothesis

**H1 (q50 sufficiency):** Config A (q50 + EIVE) will match or exceed full-quantile performance, confirming that environmental variability metrics (q05/q95/iqr) add noise rather than signal.

**H2 (EIVE necessity for axis prediction):** Config A (WITH EIVE) should **easily outperform** Config B (NO EIVE) because we are **predicting EIVE axis values as targets**, not imputing traits.
- **Critical distinction from Stage 1:** In trait imputation (Stage 1 Perm3), EIVE features were HARMFUL because traits and environment are the core signal
- **Stage 2 is fundamentally different:** EIVE axes (T/M/L/N/R) ARE the targets - p_phylo features should be essential predictors
- Config B serves as a control to quantify how much predictive power comes from EIVE features vs trait+environment relationships alone

**Expected outcomes:**
- Config A ≥ Full quantiles: validates q50 sufficiency for Stage 2 (primary hypothesis)
- **Config A >> Config B: EXPECTED** - p_phylo features should be critical for predicting EIVE targets (R² delta likely 20-40%)
- Config B ≈ Config A: would be SURPRISING - would suggest trait-environment relationships capture EIVE signal redundantly
