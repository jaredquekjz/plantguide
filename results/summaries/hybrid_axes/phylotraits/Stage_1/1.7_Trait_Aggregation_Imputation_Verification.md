# Stage 1 – Trait Aggregation & BHPMF Imputation

This note replaces the legacy narrative with a concise description of the **canonical Stage 1 pipeline** that produces modelling-ready traits, the **BHPMF** gap-filling routine (which already consumes the Stage 1 residuals), and the checks required to verify each run.

---

## 1. Methodology Overview

1. **Trait aggregation**  
   - Aggregate TRY Enhanced + AusTraits numeric traits to the species level.  
   - Merge phylogenetic predictors (`p_phylo_*`) and Stage 1 climatic / edaphic summaries (WorldClim, SoilGrids, AgroClim medians).
2. **Residual preparation**  
   - The Stage 1 environmental workflows (Docs 1.5 & 1.6) generate the EIVE trait–environment residuals. Those files are consumed automatically when the BHPMF runner joins the environmental means; no extra scripting is required.
3. **BHPMF gap filling**  
   - Convert the 1 084-species modelling shortlist into BHPMF’s numeric matrix.  
   - Traits imputed (log/logit transformed internally):  
     `Leaf area (mm2)`, `Nmass (mg/g)`, `LDMC`, `LMA (g/m2)`, `Plant height (m)`, `Diaspore mass (mg)`.  
   - Optional covariates (default: on) bring in the *_q50 environmental medians.  
   - GapFilling parameters for the canonical run:  
     ```
     used_levels = 0          # genus + species
     prediction_level = 2     # species
     num_samples = 1000
     burn = 100
     gaps = 2
     num_latent = 10
     tuning = false
     ```
4. **Post-processing**  
   - Back-transform predictions to the original scale, set provenance flags (`bhpmf_imputed`), and rebuild the “model_ready” tables used in Stage 2.

---

## 2. Canonical Scripts & Artefacts

| Stage | Script / Artefact | Purpose |
|-------|-------------------|---------|
| Trait aggregation | `src/Stage_1/rebuild_stage1_trait_tables.py` | Aggregates TRY/AusTraits, merges `p_phylo_*`, writes modelling roster and shortlist tables. |
| BHPMF run | `src/legacy/Stage_2_Data_Processing/phylo_impute_traits_bhpmf.R` | Wrapper around BHPMF’s `GapFilling`, including optional environmental medians. |
| Residuals | Stage 1 environmental workflow (Docs 1.5 & 1.6) | Produces the trait–environment residuals that feed BHPMF. |
| Diagnostics | `model_data/outputs/diag_bhpmf_ge30_20251022_env_means/` | `bhpmf_mean.tsv`, `bhpmf_std.tsv`, `coverage_before_after.csv`, hierarchy metadata. |
| Imputed roster | `model_data/outputs/trait_imputation_bhpmf_ge30_20251022_env_means.csv` | Canonical 1 084-species table with BHPMF fills. |
| Diagnostics (shortlist) | `model_data/outputs/diag_bhpmf_shortlist_20251022_env/` | Coverage report + hierarchy info for the 11.6 k shortlist run. |
| Imputed shortlist | `model_data/outputs/trait_imputation_bhpmf_shortlist_20251022_env_all.csv` | 11 680-species shortlist with environmental covariates. |
| Rebuilt tables | `model_data/inputs/traits_model_ready_20251022_ge30_phylo.parquet` (GE30) / `model_data/inputs/traits_model_ready_20251022_rerun_shortlist_phylo.parquet` | Final modelling and shortlist rosters with provenance flags. |

---

## 3. Reproduction Commands (2025‑10‑22 stamp)

1. **Aggregate traits (without BHPMF merge yet)**
   ```bash
   conda run -n AI --no-capture-output python \
     src/Stage_1/rebuild_stage1_trait_tables.py \
       --stamp 20251022
   ```

2. **BHPMF gap filling (with *_q50 environmental medians)**
   ```bash
   R_LIBS_USER="/home/olier/ellenberg/.Rlib" \
   Rscript src/legacy/Stage_2_Data_Processing/phylo_impute_traits_bhpmf.R \
     --input_csv=model_data/inputs/trait_imputation_input_modelling_ge30_20251022.csv \
     --out_csv=model_data/outputs/trait_imputation_bhpmf_ge30_20251022_env_means.csv \
     --diag_dir=model_data/outputs/diag_bhpmf_ge30_20251022_env_means \
     --add_env_covars=true \
     --env_csv=model_data/inputs/env_features_ge30_20251022_means.csv \
     --env_cols_regex=".+_q50$" \
     --traits_to_impute="Leaf area (mm2),Nmass (mg/g),LMA (g/m2),Plant height (m),Diaspore mass (mg),LDMC" \
     --used_levels=0 --prediction_level=2 --num_samples=1000 --burn=100 --gaps=2 --num_latent=10
   ```

3. **Merge BHPMF output back into the modelling roster**
   ```bash
   conda run -n AI --no-capture-output python \
     src/Stage_1/rebuild_stage1_trait_tables.py \
       --stamp 20251022 \
       --bhpmf-output model_data/outputs/trait_imputation_bhpmf_ge30_20251022_env_means.csv \
       --shortlist-output model_data/outputs/trait_imputation_bhpmf_shortlist_20251022_env_all.csv
   ```

These three commands reproduce the ge30 modelling table at the top of the Stage 2 pipeline.

---

## 4. Verification Checklist

### 4.1 Coverage & provenance (command)

```bash
conda run -n AI --no-capture-output python - <<'PY'
import pandas as pd
cov = pd.read_csv("model_data/outputs/diag_bhpmf_ge30_20251022_env_means/coverage_before_after.csv")
assert (cov["after"] == 1084).all(), "Not all traits reached full coverage"
print(cov)
cov_short = pd.read_csv("model_data/outputs/bhpmf_shortlist_env_coverage.csv")
assert (cov_short["after"] == 11680).all(), "Shortlist coverage incomplete"
print(cov_short)
PY
```
- Confirm `model_data/inputs/traits_model_ready_20251022_ge30_phylo.parquet` and `model_data/inputs/traits_model_ready_20251022_rerun_shortlist_phylo.parquet` have `*_source == 'bhpmf_imputed'` wherever gaps were filled.

### 4.2 Accuracy (log/logit RMSE)

- Reference values from the canonical diagnostic run:  
  `Leaf area 1.625`, `Nmass 0.316`, `LMA 0.324`, `Plant height 0.813`, `Diaspore mass 1.783`, `LDMC 0.292`.  
- Optional: recompute via `BHPMF::GapFilling` with a 10% validation mask if the diagnostics directory is missing.

### 4.3 Sanity assertions (command)

```bash
conda run -n AI --no-capture-output python - <<'PY'
import pandas as pd
df = pd.read_parquet("model_data/inputs/traits_model_ready_20251022_ge30_phylo.parquet")
assert (df["lma_g_m2"] > 0).all(), "LMA contains non-positive values"
assert (df["seed_mass_mg"] > 0).all(), "Seed mass contains non-positive values"
assert (df["plant_height_m"] > 0).all(), "Plant height contains non-positive values"
assert (df["ldmc_frac"].between(0, 1)).all(), "LDMC outside (0,1)"
print("Sanity checks passed.")
PY
```

### 4.4 Manual spot-checks

- Inspect `bhpmf_mean.tsv` / `bhpmf_std.tsv` for random species and cross-check against the original TRY/AusTraits measurements to confirm biological plausibility.

---

## 5. Notes

- The residual (EIVE) workflow is already part of Stage 1; no extra manual step is needed before running BHPMF.  
- For shortlist / encyclopedia outputs, rerun the aggregation script with the same `--bhpmf-output` argument; it writes all derivative artefacts automatically.  
- Earlier exploratory write-ups and dated commands have been removed—this document is now the single source of truth for reproducing and validating the Stage 1 BHPMF pipeline.
