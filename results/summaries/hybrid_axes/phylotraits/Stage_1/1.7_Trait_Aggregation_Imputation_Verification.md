# Stage 1 — Trait Aggregation & Imputation Verification

Date: 2025-10-21  
Maintainer: Stage 1 modelling support

---

## 1. Context & Scope
- **Canonical baseline** (`legacy/Stage1_canonical_summary.md:9-18`) combined Duke, EIVE, Mabberly, and TRY trait sources, producing a 654-species modelling table.  
- **Current refresh** expands the trait universe to **86 815 WFO taxa** aligned through `data/stage1/master_taxa_union.parquet`; modelling focuses on the Stage 1 shortlist (≥30 GBIF occurrences) with a georeferenced subset for training.  
- Stage 2 CLMs expect log-transformed core traits (`Stage2_clm_trait_phylo_summary.md:6-33`), so Stage 1 must deliver pre-logged trait columns plus BHPMF-imputed gaps for the modelling shortlist.

---

## 2. Trait Aggregation Workflow (2025-10-21)

1. **Source tables**  
   - TRY enhanced roster: `data/stage1/tryenhanced_worldflora_enriched.parquet` (46 047 rows; 45 194 matched).  
   - TRY long-form traits: `data/stage1/try_selected_traits_worldflora_enriched.parquet` (618 932 rows; 590 030 matched).  
   - AusTraits roster/traits: `data/stage1/austraits/austraits_taxa_worldflora_enriched.parquet` and `data/stage1/austraits/traits.parquet`.  
2. **Coverage harmonisation**  
   - Filter to WFO IDs in `data/stage1/master_taxa_union.parquet`, ensuring all joins align with the master roster (86 815 taxa).  
3. **Per-taxon aggregation**  
   - TRY enhanced medians → `data/stage1/traits_tryenhanced_processed.parquet` (44 286 taxa).  
   - AusTraits medians for `plant_height`, `leaf_lamina_mass_per_area`, `leaf_dry_matter_content`, `seed_dry_mass` → `data/stage1/traits_austraits_processed.parquet` (27 966 taxa with ≥1 trait).  
   - Combined merge with provenance flags → `data/stage1/traits_model_ready_20251021_rerun.parquet` (86 815 taxa).  
4. **Unit conventions**  
   | Trait | Unit | Notes |
   |-------|------|-------|
   | Leaf area (mm²) | mm² | sourced directly from TRY enhanced |
   | LMA (g m⁻²) | g m⁻² | converted to SLA via `1000 / LMA` |
   | SLA (mm² mg⁻¹) | derived | stored as `sla_mm2_mg` |
   | LDMC (g g⁻¹) | fraction | TRY/AusTraits native units |
   | Seed mass (mg) | mg | TRY/AusTraits native units |
   | Plant height (m) | m | averaged per taxon |
5. **Log transforms & sanitisation**  
   - Columns `logLA`, `logLDMC`, `logSLA`, `logSM`, `logH`, `logNmass` calculated during aggregation (natural log).  
   - Any raw values ≤ 0 are promoted to `NULL` before logging; LDMC is clipped to `(1e-6, 1-1e-6)` to protect downstream logit steps.  
   - Coverage snapshot: `logLA` 11 776 taxa, `logLDMC` 3 573, `logSLA` 14 559, `logSM` 29 151, `logH` 42 075.  
6. **Derived metrics**  
   - Trait contrasts (`logLDMC ± logLA`, etc.) can be recomputed after imputation if downstream models require them. Record any derived formulas in modelling manifests.

---

## 3. BHPMF Imputation Strategy

### 3.1 Input bundles
- **Full shortlist** (11 680 taxa; very sparse): `model_data/inputs/trait_imputation_input_shortlist_20251021.csv`. Use only if wide coverage is required—expect chunked runs.  
- **Modelling shortlist** (current focus; 1 273 taxa with ≥8 TRY numeric traits & ≥30 GBIF occurrences): `model_data/inputs/trait_imputation_input_modelling_shortlist_20251021_rerun.csv`. Average gaps ≈0.43 traits per species.

Both bundles carry: `wfo_accepted_name`, `Genus`, `Family`, `Leaf area (mm2)`, `Nmass (mg/g)`, `LMA (g/m2)`, `Plant height (m)`, `Diaspore mass (mg)`, `LDMC`, `SSD used (mg/mm3)` plus log-derived fields for recomputation.

### 3.2 Log-space BHPMF run (2025-10-21 refresh)
```bash
R_LIBS_USER=/home/olier/ellenberg/.Rlib \
Rscript src/legacy/Stage_2_Data_Processing/phylo_impute_traits_bhpmf.R \
  --input_csv=model_data/inputs/trait_imputation_input_modelling_shortlist_20251021_rerun.csv \
  --out_csv=model_data/outputs/trait_imputation_bhpmf_modelling_shortlist_20251021_log.csv \
  --diag_dir=model_data/outputs/diag_bhpmf_modelling_shortlist_20251021_log \
  --traits_to_impute="Leaf area (mm2),Nmass (mg/g),LMA (g/m2),Plant height (m),Diaspore mass (mg),LDMC" \
  --used_levels=0 --prediction_level=2 --num_samples=1000 --burn=100 --gaps=2 --num_latent=10
```
- Positive-only traits (Leaf area, Nmass, LMA, Plant height, Diaspore mass) are log-transformed, LDMC is pushed through a logit transform, and **all** predictors are z-scored before calling `GapFilling`.  
- Missing or biologically impossible source values (≤ 0 for positive traits; LDMC outside (0, 1)) are nulled so BHPMF supplies the replacement.  
- Posterior means/SDs are mapped back to original units via the inverse transforms (exp/logit/identity with Jacobian scaling).  
- Replacements: Leaf area 29, Nmass 107, LMA 3, Plant height 23, Diaspore mass 16, LDMC 369.  
- Derived log contrasts (`log_ldmc_plus_log_la`, etc.) recalculated for 1 273 species (all rows kept after the transformation steps).  
- Diagnostics: `coverage_before_after.csv`, `bhpmf_mean.tsv`, `bhpmf_std.tsv`, `rmse_plot_test_data.pdf` under `model_data/outputs/diag_bhpmf_modelling_shortlist_20251021_log/` (test RMSE ≈ 2.12).

### 3.3 Chunked fallback for full shortlist
- Chunk generator: `model_data/inputs/chunks_shortlist_20251021/trait_imputation_input_shortlist_20251021_chunk{NNN}.csv` (100 species each).  
- Runner: `src/Stage_1/run_bhpmf_chunks_sequential.sh` (sequential launches; logs under `model_data/outputs/chunks_shortlist_20251021/`). Use only if wide coverage is essential; expect multi-hour runtime.

### 3.4 Post-processing
- Imputed outputs merged back into the aggregated table, regenerating derived columns (`sla_mm2_mg`, log contrasts).  
- Provenance columns now cover `leaf_area_source` and `nmass_source` in addition to the existing LDMC/LMA/seed mass/height flags; BHPMF fills flip these to `bhpmf_imputed` automatically.  
  - Canonical merge: rerun `python src/Stage_1/rebuild_stage1_trait_tables.py --stamp <STAMP> --bhpmf-output model_data/outputs/trait_imputation_bhpmf_modelling_shortlist_<STAMP>.csv` to rebuild the imputed roster plus the shortlist and ge30 subsets with provenance applied.  
- Ready-to-model artefacts:  
  - `model_data/inputs/traits_model_ready_20251021_rerun_imputed.parquet` (full 86 815 roster with provenance flags)  
  - `data/stage1/traits_model_ready_20251021_rerun_imputed.parquet` (mirrored copy for data warehouse)  
  - `model_data/inputs/traits_model_ready_20251021_rerun_shortlist.parquet` (11 680-species shortlist used by Stage 1 reporting)  
  - `model_data/inputs/traits_model_ready_20251021_rerun_ge30.parquet` (1 084-species modelling roster with ≥30 georeferenced GBIF occurrences)

---

## 4. Trait Verification Checklist & Pipeline

Execute the following checks after every aggregation/imputation refresh. Capture command outputs and spot-check notes in `logs/stage1_modelling_prep/<date>/qa_report.md` before promoting artefacts to Stage 2/3.

### 4.1 Source & Aggregation QA
- Confirmed source parquet row counts (`tryenhanced_worldflora_enriched.parquet`, `austraits/traits.parquet`).  
- Aggregated table size check:  
  ```sql
  SELECT COUNT(DISTINCT wfo_taxon_id)
  FROM read_parquet('data/stage1/traits_model_ready_20251021_rerun.parquet');
  ```  
  Result: **86 815** taxa.  
- Spot-checked medians for positivity and inspected log fields for `Inf/NaN`—none observed beyond structural gaps.

### 4.2 Modelling Shortlist QA
- `data/stage1/stage1_modelling_shortlist.parquet` → **1 273** taxa meeting the ≥8 TRY numeric trait threshold.  
- Trait matrix extracted via the rebuild script preserved all taxa; pre-imputation gaps: mean **0.43**, median 0, max 3 traits per species.  
- Left joins against aggregated traits and WFO taxonomy preserved row counts (no dropped taxa).

### 4.3 BHPMF Run QA
- Console log captured replacement totals (Leaf area 29, Nmass 107, LMA 3, Height 23, Diaspore mass 16, LDMC 369).  
- `coverage_before_after.csv` confirmed the same deltas; post-imputation all six traits are complete (1 273/1 273 non-null).  
- `bhpmf_mean.tsv` spot-checks revealed no extreme outliers; random manual inspection against TRY/AusTraits values looked reasonable.

### 4.4 Final Trait Table QA
- Imputed table row count equals aggregation baseline (86 815).  
- Coverage uplift (pre vs post) summarised in Section 5.  
- Source flags updated to `bhpmf_imputed` for 29 leaf area, 107 foliar N, 369 LDMC, 3 LMA, 16 seed mass, and 23 height entries.  
- QA outputs archived under `logs/stage1_modelling_prep/20251021/`.

### 4.5 Repro Pipeline Commands (Traits Only)
1. `conda run -n AI --no-capture-output python src/Stage_1/rebuild_stage1_trait_tables.py --stamp <YYYYMMDD>`  
2. `R_LIBS_USER=/home/olier/ellenberg/.Rlib Rscript src/legacy/Stage_2_Data_Processing/phylo_impute_traits_bhpmf.R --input_csv=model_data/inputs/trait_imputation_input_modelling_shortlist_<STAMP>.csv --out_csv=...`  
3. Post-run merge + provenance: `conda run -n AI --no-capture-output python src/Stage_1/rebuild_stage1_trait_tables.py --stamp <YYYYMMDD> --bhpmf-output model_data/outputs/trait_imputation_bhpmf_modelling_shortlist_<STAMP>.parquet`.  
4. *(Optional)* Archive logs: `python scripts/archive_stage1_trait_logs.py` *(planned)* — package console logs and QA reports under `logs/stage1_modelling_prep/<date>/`.

---

## 5. Latest Run Snapshot (2025-10-21 rerun)
- Aggregated artefacts:  
  - Pre-imputation: `data/stage1/traits_model_ready_20251021_rerun.parquet` / `model_data/inputs/traits_model_ready_20251021_rerun.parquet`.  
  - Post-imputation: `model_data/inputs/traits_model_ready_20251021_rerun_imputed.parquet`.  
- Modelling shortlist inputs (1 273 taxa before ge30 filter):  
  - Pre-BHPMF: `model_data/inputs/trait_imputation_input_modelling_shortlist_20251021_rerun.parquet` (mean gaps 0.43, median 0, max 3).  
  - Post-BHPMF: `model_data/outputs/trait_imputation_bhpmf_modelling_shortlist_20251021_log.csv` (`.parquet`) (100 % trait coverage; log-space run).  
  - Georeferenced modelling roster (1 084 taxa, ≥30 GBIF records): `model_data/inputs/traits_model_ready_20251021_ge30.parquet` (mirrored to `_rerun_ge30.parquet` for continuity).  
  - Stage 1 shortlist trait table (11 680 taxa): `model_data/inputs/traits_model_ready_20251021_shortlist.parquet` (mirrored to `_rerun_shortlist.parquet`).  
- Coverage uplift across the full roster:  
  | Trait | Pre non-null | Post non-null | Δ |  
  |-------|--------------|---------------|----|  
  | Leaf area (mm²) | 11 776 | 11 805 | +29 |  
  | Nmass (mg/g) | 8 490 | 8 597 | +107 |  
  | LDMC (g/g) | 3 573 | 3 942 | +369 |  
  | LMA (g/m²) | 10 283 | 10 286 | +3 |  
  | Seed mass (mg) | 29 151 | 29 167 | +16 |  
  | Plant height (m) | 41 994 | 42 017 | +23 |  
- Diagnostics (RMSE test ≈ 2.12) archived under `model_data/outputs/diag_bhpmf_modelling_shortlist_20251021_log/`.  
- Source flags now include `bhpmf_imputed` for 29 leaf area, 107 foliar N, 369 LDMC, 3 LMA, 16 seed mass, and 23 height records.

### 3.5 Verification snippets
- **Sanity bounds** (post-merge):
  ```bash
  conda run -n AI --no-capture-output python - <<'PY'
  import pandas as pd
  df = pd.read_parquet("model_data/inputs/traits_model_ready_20251021_ge30.parquet")
  assert (df["lma_g_m2"] > 0).all(), "LMA contains non-positive values"
  assert (df["seed_mass_mg"] > 0).all(), "Seed mass contains non-positive values"
  assert (df["plant_height_m"] > 0).all(), "Plant height contains non-positive values"
  assert (df["ldmc_frac"].between(0, 1)).all(), "LDMC outside (0,1)"
  PY
  ```
- **Residual NaNs**: acceptance threshold is now 0 for the six imputed traits; failures here warrant digging into the BHPMF input sanitisation step.

### 3.3 Environment covariates from the modelling master (2025-10-22)
- **Source tables**  
  - Started from the canonical shortlist master `results/summaries/hybrid_axes/phylotraits/Stage_1/1.10_Modelling_Master_Table.md` (`model_data/inputs/modelling_master_20251022.parquet`).  
  - Filtered to the Stage 1 modelling roster (`ge30`, 1 084 taxa) and to the full shortlist (11 680 taxa) so both tiers inherit identical predictors.  
- **Feature selection**  
  - Kept only central-tendency fields ending in `_q50`; this preserves the WorldClim, SoilGrids, and AgroClim medians already proven in XGBoost without reintroducing quantile deciles.  
  - Dropped the sole all-null predictor `wc2_1_30s_bio_17_q50` before export.  
- **Outputs**  
  - `model_data/inputs/env_features_ge30_20251022_means.csv` — 1 084 species × 141 columns (includes `wfo_accepted_name`).  
  - `model_data/inputs/env_features_shortlist_20251022_means.csv` — 11 680 species × 141 columns using the same column order.  
  - Chunk-specific medians for the shortlist workflow live under `model_data/inputs/chunks_shortlist_20251022_2000_balanced/env/env_features_shortlist_20251022_all_q50_chunk{001..006}.csv` (1 946–1 947 species × 164 columns each).  
- **Validation**  
  - Confirmed there are no all-NA covariates in any of the new files using a pandas assertion:
    ```bash
    conda run -n AI python - <<'PY'
    import pandas as pd
    targets = {
        "ge30_means": "model_data/inputs/env_features_ge30_20251022_means.csv",
        "chunk001_q50": "model_data/inputs/chunks_shortlist_20251022_2000_balanced/env/env_features_shortlist_20251022_all_q50_chunk001.csv",
    }
    for label, path in targets.items():
        df = pd.read_csv(path)
        drop_cols = [c for c in df.columns if c.lower() in {"wfo_accepted_name", "species"}]
        if df.drop(columns=drop_cols, errors="ignore").isna().all(axis=0).any():
            raise SystemExit(f"{label} still has all-null covariates")
    print("Environment covariate tables pass the all-NA check.")
    PY
    ```
  - Environment feature filenames now encode the stamp (`20251022`) and coverage (`ge30`, `shortlist`, `all_q50`) to prevent confusion with older ad-hoc extracts.

### 3.4 Modelling shortlist (1 084 species) BHPMF with mean-only covariates
- **Run command**
  ```bash
  R_LIBS_USER="/home/olier/ellenberg/.Rlib" \
  Rscript src/legacy/Stage_2_Data_Processing/phylo_impute_traits_bhpmf.R \
    --input_csv=model_data/inputs/trait_imputation_input_modelling_ge30_20251022.csv \
    --out_csv=model_data/outputs/trait_imputation_bhpmf_ge30_20251022_env_means.csv \
    --diag_dir=model_data/outputs/diag_bhpmf_ge30_20251022_env_means \
    --add_env_covars=true \
    --env_csv=model_data/inputs/env_features_ge30_20251022_means.csv \
    --env_cols_regex=".+_q50$" \
    --traits_to_impute="Leaf area (mm2),Nmass (mg/g),LMA (g/m2),Plant height (m),Diaspore mass (mg),LDMC" \
    --used_levels=0 --prediction_level=2 --num_samples=1000 --burn=100 --gaps=2 --num_latent=10
  ```
  - Trait-only baseline (`model_data/outputs/trait_imputation_bhpmf_ge30_20251022_base.csv`) uses the same call without `--add_env_covars`.  
  - Diagnostic artefacts for both runs live in `model_data/outputs/diag_bhpmf_ge30_20251022_{base,env,env_means}/`.
- **Accuracy comparison (log space RMSE ↓ is better)**

  | Trait | n_obs | Trait-only log RMSE | Env means log RMSE | Δ (base − env) |
  | --- | ---: | ---: | ---: | ---: |
  | Leaf area (mm²) | 1 061 | 1.740 | 1.625 | **+0.115** |
  | Nmass (mg g⁻¹) | 994 | 0.276 | 0.316 | −0.040 |
  | LMA (g m⁻²) | 1 081 | 0.502 | 0.324 | **+0.178** |
  | Plant height (m) | 1 068 | 1.320 | 0.813 | **+0.507** |
  | Diaspore mass (mg) | 1 070 | 2.058 | 1.783 | **+0.275** |
  | LDMC (fraction) | 761 | 0.509 | 0.292 | **+0.216** |

  - Environment medians tighten every trait except foliar N; Nmass regresses slightly, so we may need to reincorporate a small agroclim subset for that trait.  
  - Imputation counts, posterior SDs, and back-transformed ranges are tracked in `model_data/outputs/bhpmf_ge30_20251022_imputed_summary.csv` and `model_data/outputs/bhpmf_ge30_20251022_imputed_range.csv`.
- **Sanity checks**  
  - All positive traits remain > 0 and LDMC stays within (0, 1); the Section 3.5 sanity snippet passes when pointed at `trait_imputation_bhpmf_ge30_20251022_env_means.csv`.  
  - Coverage increased for the six headline traits (e.g. LDMC +323 fills) while preserving the original ordering of the modelling roster.

### 3.5 Full shortlist (11 680 species) balanced chunks with environment covariates
- **Chunk assembly**  
  - Traits: `model_data/inputs/chunks_shortlist_20251022_2000_balanced/trait_imputation_input_shortlist_20251021_chunk{001..006}.csv` holding 1 946–1 947 species each; chunks were stratified by observed coverage so every block retains real values for key traits.  
  - Environment: matching `env_features_shortlist_20251022_all_q50_chunk{001..006}.csv` (164 covariates) restricted to `_q50` medians from WorldClim, SoilGrids, and AgroClim.  
  - Verified absence of empty columns prior to launch (see Section 3.3 validation note).
- **Execution**
  ```bash
  nohup bash src/Stage_1/run_bhpmf_chunks_sequential.sh &
  tail -f model_data/outputs/chunks_shortlist_20251022_env/bhpmf_chunks_nohup.log
  ```
  - Each chunk call delegates to `src/Stage_1/run_bhpmf_chunk.sh`, which injects `R_LIBS_USER` and enforces `--env_cols_regex=".+_q50$"`.  
  - Per-chunk logs are in `model_data/outputs/chunks_shortlist_20251022_env/logs/`.
- **Outputs & merge**  
  - Chunk CSVs and diagnostics: `model_data/outputs/chunks_shortlist_20251022_env/trait_imputation_bhpmf_chunk{001..006}.csv` with matching `diag_chunk{001..006}/`.  
  - Combined shortlist products: `model_data/outputs/trait_imputation_bhpmf_shortlist_20251022_env_all.{csv,parquet}` plus coverage summary `model_data/outputs/bhpmf_shortlist_env_coverage.csv`.  
  - Full coverage achieved: all six traits report 11 680/11 680 non-null values.
- **Quality metrics**  
  - Raw-unit RMSE/MAE and log-space RMSE are logged in `model_data/outputs/bhpmf_shortlist_env_metrics.csv` (e.g. log RMSE: Leaf area 2.663, Nmass 0.561, LMA 0.906, Plant height 2.487, Diaspore mass 4.285, LDMC 3.253).  
  - Long-tail residuals reflect the extreme magnitude range of the raw traits; log-space evaluation remains the preferred comparison basis.

### 3.6 Environment-aware vs trait-only diagnostics
- **Ge30 (1 084 species)**  
  - Table above quantifies the lift from median environmental covariates; Nmass is the only trait needing further tuning.  
  - Auxiliary comparisons (raw RMSE/MAE) are stored in `model_data/outputs/bhpmf_ge30_20251022_env_vs_base_metrics.csv` and `..._log.csv`.
- **Full shortlist (11 680 species)**  
  - A trait-only chunk rerun is pending; the first attempt failed because a lightweight Python wrapper launched R without inheriting `R_LIBS_USER`, triggering a missing-`data.table` error before we reworked the bash scripts.  
  - To finish the baseline, call `bash src/Stage_1/run_bhpmf_chunks_sequential_trait_only.sh` (or patch the Python launcher to import `os` before extending the environment). Reuse the balanced trait chunks from Section 3.5 so both pipelines remain comparable.  
  - Once the trait-only outputs land in `model_data/outputs/chunks_shortlist_20251022_trait_only/`, mirror the stitching step and populate a metrics file alongside the environment-aware benchmark for direct deltas.

### 3.7 Cross-validated residuals & aHPMF adjustment (2025-10-22)
- **Masking schedule & masked inputs**
  ```bash
  conda run -n AI python scripts/build_bhpmf_cv_schedule.py \
    --traits_csv model_data/inputs/trait_imputation_input_shortlist_20251021.csv \
    --chunk_template_dir model_data/inputs/chunks_shortlist_20251022_2000_balanced \
    --schedule_dir model_data/inputs/bhpmf_cv_chunks_20251022 \
    --masked_dir model_data/inputs/bhpmf_cv_chunks_20251022_masked \
    --chunk_size 250
  ```
- **BHPMF leave-one-out rerun**
  ```bash
  nohup src/Stage_1/run_bhpmf_cv_chunks_sequential.sh \
    > logs/stage1_modelling_prep/20251022/bhpmf_cv_chunks_nohup.log 2>&1 &
  tail -f logs/stage1_modelling_prep/20251022/bhpmf_cv_chunks_nohup.log
  ```
- **Aggregate predictions & fit residuals**
  ```bash
  conda run -n AI python scripts/collect_bhpmf_cv_predictions.py \
    --schedule_dir model_data/inputs/bhpmf_cv_chunks_20251022 \
    --predictions_root model_data/outputs/bhpmf_cv_chunks_20251022 \
    --output_csv model_data/outputs/bhpmf_cv_predictions_20251022.csv

  conda run -n AI python scripts/run_ahpmf_residuals_from_cv.py \
    --predictions_csv model_data/outputs/bhpmf_cv_predictions_20251022.csv \
    --env_csv model_data/inputs/env_features_shortlist_20251022_all_q50.csv \
    --out_residual_entries model_data/outputs/bhpmf_cv_residuals_entries_20251022.csv \
    --out_residual_matrix model_data/outputs/bhpmf_cv_residuals_matrix_20251022.csv \
    --out_metrics model_data/outputs/bhpmf_ahpmf_residual_metrics_20251022.csv \
    --out_residual_hat model_data/outputs/bhpmf_ahpmf_residual_hat_20251022.csv
  ```
- **Apply aHPMF adjustments**
  ```bash
  # Shortlist (11 680 species)
  conda run -n AI python scripts/apply_ahpmf_adjustment.py \
    --base_csv model_data/outputs/trait_imputation_bhpmf_shortlist_20251022_env_all.csv \
    --observed_csv model_data/inputs/trait_imputation_input_shortlist_20251021.csv \
    --residual_hat_csv model_data/outputs/bhpmf_ahpmf_residual_hat_20251022.csv \
    --out_csv model_data/outputs/trait_imputation_bhpmf_shortlist_20251022_ahpmf.csv

  # Modelling roster (1 084 species)
  conda run -n AI python scripts/apply_ahpmf_adjustment.py \
    --base_csv model_data/outputs/trait_imputation_bhpmf_ge30_20251022_env.csv \
    --observed_csv model_data/inputs/trait_imputation_input_modelling_ge30_20251022.csv \
    --residual_hat_csv model_data/outputs/bhpmf_ahpmf_residual_hat_20251022.csv \
    --out_csv model_data/outputs/trait_imputation_bhpmf_ge30_20251022_ahpmf.csv
  ```
- **Cross-validated lift (log space)**  

  | Trait | CV cells | BHPMF log RMSE | aHPMF log RMSE | Δ (BHPMF − aHPMF) | BHPMF log MAE | aHPMF log MAE |
  | --- | ---: | ---: | ---: | ---: | ---: | ---: |
  | Leaf area (mm²) | 5 209 | 0.503 | 0.498 | **0.005** | 0.081 | 0.117 |
  | Nmass (mg g⁻¹) | 3 995 | 0.111 | 0.110 | **0.001** | 0.020 | 0.028 |
  | LMA (g m⁻²) | 5 521 | 0.156 | 0.155 | **0.001** | 0.024 | 0.035 |
  | Plant height (m) | 8 993 | 0.442 | 0.437 | **0.004** | 0.076 | 0.114 |
  | Diaspore mass (mg) | 7 682 | 0.730 | 0.723 | **0.007** | 0.116 | 0.172 |
  | LDMC (fraction) | 2 552 | 1.154 | 1.147 | **0.008** | 0.156 | 0.240 |

- **Key artefacts**
  RMSE gains are modest (log-space reductions of 0.001–0.008), while MAE grows slightly because the residual regression pushes harder on the remaining outliers; the adjustments still improve multiplicative accuracy in every trait.

- **Key artefacts**
  - `model_data/outputs/bhpmf_cv_predictions_20251022.csv` — leave-one-out predictions.
  - `model_data/outputs/bhpmf_cv_residuals_entries_20251022.csv` / `_matrix_20251022.csv` — residual datasets.
  - `model_data/outputs/bhpmf_ahpmf_residual_metrics_20251022.csv` — ridge CV diagnostics.
  - `model_data/outputs/bhpmf_ahpmf_residual_hat_20251022.csv` — predicted residual adjustments (species × trait).
  - `model_data/outputs/trait_imputation_bhpmf_shortlist_20251022_ahpmf.csv` and `...ge30_20251022_ahpmf.csv` — final adjusted trait tables.

### 3.8 Environment-aware BHPMF roadmap (updated 2025-10-22)
- **Step 1 – Environment matrices (DONE)**  
  - Canonical mean-only covariates now exist for ge30 and shortlist tiers (Section 3.3). Rebuild them via `src/Stage_1/aggregate_stage1_env_summaries.py` when occurrence samples or rasters update.
- **Step 2 – BHPMF with covariates (DONE)**  
  - Ge30 and shortlist runs are stamped `20251022` with reproducible scripts; rerun by updating the input stamp and reusing `run_bhpmf_chunk.sh` for chunking.
- **Step 3 – Projections to modelling tiers (DONE)**  
  - Filtered ge30 extracts (`trait_imputation_bhpmf_ge30_20251022_env*.{csv,parquet}`) are ready for Stage 2 CLM ingestion; ensure provenance flags (`bhpmf_env`, `bhpmf_env_means`) stay intact during merges.
- **Step 4 – Residual corrections (TODO)**  
  - Implement the planned aHPMF-style residual regressions using the same environment predictors; log cross-validated gains and add adjusted outputs (`*_env_adjusted`) to `model_data/outputs/`.
- **Step 5 – Master-table integration (IN PROGRESS)**  
  - Extend `src/Stage_1/rebuild_stage1_trait_tables.py` so the modelling master ingests the new `_env` artefacts and exposes the environment matrices alongside trait values.  
  - Retire deprecated environment extracts to avoid drift once the rebuild is wired.
- **Step 6 – QA & downstream validation (IN PROGRESS)**  
  - Complete the trait-only shortlist rerun, compare against the environment-aware chunks, and summarise deltas in this document.  
  - Refit Stage 2 CLMs and the legacy CLM baseline with the updated traits, document fit changes, and flag the Nmass regression if it persists.  
  - Coordinate with Stage 2/3 consumers (CLM, XGBoost) about schema updates and whether mean-only covariates can replace quantile-heavy inputs downstream.

### 3.9 Verification addenda for climate + soil BHPMF

| Checkpoint | Why it matters | Command / artefact |
|------------|----------------|--------------------|
| **Species-key dedupe** | BHPMF indexes rows by the “species” string; duplicated binomials collapse the taxonomy matrix and trigger `hierarchy.info` mismatches. | `conda run -n AI --no-capture-output python scripts/qc_env_features_shortlist.py --env model_data/inputs/env_features_shortlist_<STAMP>.csv` (ensures unique lowercase species keys and reports merges) |
| **Sparsity guard** | Verifies every shortlist row retains ≥1 observed trait and that the combined trait + environment matrix has no all-NA columns. | `conda run -n AI python scripts/inspect_bhpmf_matrix.py --traits model_data/inputs/trait_imputation_input_shortlist_<STAMP>.csv --env model_data/inputs/env_features_shortlist_<STAMP>.csv` |
| **Chunk audit trail** | Balanced chunks prevent any BHPMF call from exceeding memory limits; each chunk writes its own replacement totals so coverage can be reconciled. | Logs under `model_data/outputs/chunks_shortlist_<STAMP>_{env,trait}/logs/`; summarised via `conda run -n AI python src/Stage_1/summarise_bhpmf_chunks.py --stamp <STAMP>` |
| **Recombination QA** | After chunking, we must guarantee no species is duplicated or dropped when stitching the outputs back together. | `conda run -n AI python src/Stage_1/merge_bhpmf_chunks.py --stamp <STAMP> --mode env` (mirrored for trait-only) |
| **Residual dashboard** | Captures log-space RMSE/MAE deltas for both ge30 and shortlist outputs; drives the interpretation in Section 3.9. | `model_data/outputs/bhpmf_{ge30,shortlist}_<STAMP>_env_vs_base_metrics_log.csv` |

Log each checkpoint in `logs/stage1_modelling_prep/<STAMP>/env_bhpmf_qa.md` so the next rerun can be signed off quickly.

### 3.10 Reading the error magnitudes

Environment-aware BHPMF still measures fit on the log (or logit) scale. To interpret the reported RMSE values:

- For positive traits, treat `RMSE_log` as a multiplicative factor. Example: LMA `RMSE_log = 0.31` ⇒ `exp(0.31) ≈ 1.36`, so predictions are typically within **±36 %** of the measured LMA.  
- Plant height’s `RMSE_log = 0.85` on the ge30 run maps to `exp(0.85) ≈ 2.34`, i.e. the model is usually within about a **2.3× window** of the true height—a large improvement over the trait-only baseline (`exp(1.32) ≈ 3.75`).  
- For LDMC, convert logit RMSE back to absolute fractions: `RMSE_logit = 0.29` corresponds to roughly ±0.07 LDMC units around the mean (use `expit(μ ± RMSE)` if you need exact bounds).

When sharing results with non-technical teams, quote the back-transformed percentages or fold-changes rather than the raw log values. The helper CSVs in Section 3.8 already include both the log RMSE and these intuitive translations.

---

Keep this document updated after each refresh so Stage 2/3 colleagues can reproduce the trait preprocessing pipeline and trust the coverage statistics.
