# TRY Categorical Traits Addition Summary (2025-10-27)

## What Was Done

Added 3 missing TRY categorical traits to the XGBoost imputation pipeline:
1. **Leaf phenology** (TraitID 37)
2. **Photosynthesis pathway** (TraitID 22)
3. **Mycorrhiza type** (TraitID 7)

## Source Data

**File**: `data/stage1/try_selected_traits_worldflora_enriched.parquet`
- 618,932 trait observations from raw TRY database
- 7 TraitIDs extracted (including the 3 new categorical traits)
- 590,030 matched to WFO (95.3%)

## Standardization Applied

### Leaf Phenology (TraitID 37)
**Categories**: `evergreen`, `deciduous`, `semi_deciduous`
**Coverage**: 20,112 / 55,053 species (36.5%)
**Standardization rules**:
- evergreen: "evergreen", "E", "EV", "always persistent/summer/overwintering green"
- deciduous: "deciduous", "D", "aestival", "vernal"  
- semi_deciduous: "semi-deciduous", "drought deciduous", "winter deciduous"

### Photosynthesis Pathway (TraitID 22)
**Categories**: `C3`, `C4`, `CAM`, `C3_C4`, `C3_CAM`, `C4_CAM`
**Coverage**: 25,061 / 55,053 species (45.5%)
**Standardization rules**:
- Normalized capitalization (all uppercase)
- Mapped intermediates with "/" or "-" to "_" format

### Mycorrhiza Type (TraitID 7)
**Categories**: `AM`, `EM`, `NM`, `ericoid`, `orchid`, `mixed`
**Coverage**: 5,810 / 55,053 species (10.6%)
**Standardization rules**:
- AM: "AM", "VAM", "arbuscular", "vesicular"
- EM: "EM", "ecto"
- NM: "no", "NM", "non-ectomycorrhizal", "absent"
- ericoid: "ericoid", "E.CH.ECT"
- orchid: "orchid", "PH.TH.END"
- mixed: "AMNM" or combinations

## Files Updated

### 1. Canonical Union
**File**: `data/stage1/stage1_union_canonical.parquet`
- **Before**: 63 columns
- **After**: 66 columns (added 3)
- Size: 5.24 MB

### 2. Perm3 Dataset
**File**: `model_data/inputs/mixgb_perm3_11680/mixgb_input_perm3_shortlist_11680_20251025_sla_canonical.csv`
- **Before**: 179 columns (4 categorical)
- **After**: 182 columns (7 categorical)
- Size: 25.2 MB

**Column breakdown**:
- 2 IDs
- 6 target traits
- **7 TRY categorical** (was 4)
- 156 environmental q50
- 6 log transforms  
- 5 phylogenetic codes

### 3. Perm8 Dataset  
**File**: `model_data/inputs/mixgb_perm8_11680/mixgb_input_perm8_eigenvectors_11680_20251027.csv`
- **Before**: 266 columns (4 categorical)
- **After**: 269 columns (7 categorical)
- Size: 46.8 MB (CSV), 14.1 MB (parquet)

**Column breakdown**:
- 2 IDs
- 6 target traits
- **7 TRY categorical** (was 4)
- 156 environmental q50
- 6 log transforms
- 92 phylogenetic eigenvectors

## Scripts Created/Updated

### Created
- `src/Stage_1/aggregate_try_categorical_traits.py` - Aggregates 3 new categorical traits

### Updated  
- `src/Stage_1/build_xgboost_perm3_dataset.py` - Now includes 7 categorical features
- `src/Stage_1/build_xgboost_perm8_eigenvectors.py` - Updated verification for 7 features

## Expected Performance Impact

### Leaf Phenology (36.5% coverage)
- **Strong ecological signal**: Deciduous/evergreen strongly correlates with:
  - Temperature seasonality
  - Water availability patterns
  - Frost tolerance
  - Leaf economics spectrum traits
- **Expected importance**: 5-10% of model gain

### Photosynthesis Pathway (45.5% coverage)
- **Fundamental metabolic distinction**: C3/C4/CAM affects:
  - Water use efficiency
  - Temperature optima
  - Leaf nitrogen content
  - SLA and LDMC
- **Expected importance**: 10-15% of model gain (likely top 20 features)

### Mycorrhiza Type (10.6% coverage)
- **Nutrient acquisition strategy**: AM vs EM distinction affects:
  - Soil nutrient preferences
  - Root architecture
  - Plant-soil feedbacks
- **Expected importance**: 2-5% of model gain
- **Note**: Lower coverage may limit impact

### Combined Impact
- **Total expected importance**: 17-30% of model gain
- Should rival or exceed the 44% importance of the original 4 categorical features
- May reduce RMSE by 3-8% across traits with strong ecological correlates

## Verification

All categorical features verified present in:
```bash
# Check Perm3
head -1 model_data/inputs/mixgb_perm3_11680/mixgb_input_perm3_shortlist_11680_20251025_sla_canonical.csv | tr ',' '\n' | grep try_

# Check Perm8  
head -1 model_data/inputs/mixgb_perm8_11680/mixgb_input_perm8_eigenvectors_11680_20251027.csv | tr ',' '\n' | grep try_
```

**Output** (both files):
```
try_woodiness
try_growth_form
try_habitat_adaptation
try_leaf_type
try_leaf_phenology
try_photosynthesis_pathway
try_mycorrhiza_type
```

### Dataset Construction Verification (2025-10-27)

**Script:** `scripts/verify_dataset_construction.py` (updated for 7 categorical features)

**Result:** All 7 TRY categorical features verified in Perm3 dataset:
```
✓ try_woodiness                 : object (6 levels)
✓ try_growth_form               : object (27 levels)
✓ try_habitat_adaptation        : object (5 levels)
✓ try_leaf_type                 : object (6 levels)
✓ try_leaf_phenology            : object (3 levels)
✓ try_photosynthesis_pathway    : object (5 levels)
✓ try_mycorrhiza_type           : object (6 levels)
```

**Report:** `results/perm3_verification_7cats_20251027.txt`

**Key findings:**
- All 7 categorical features present with correct data types
- Column count: 182 (matches expected)
- Row count: 11,680 species
- EIVE exclusion verified (critical check passed)

## Next Steps

1. **Update documentation**: ✓ Complete - Added categorical trait standardization table to 1.7b_Imputation_Dataset_Preparation.md
2. **Run validation CV**: Test Perm3 with 7 categorical features vs old 4-feature version
3. **Feature importance analysis**: Quantify contribution of new categorical traits
4. **Consider adding more**: Succulence, parasitism, carnivory are in canonical union but not yet included

---
**Date**: 2025-10-27
**Status**: ✓ Complete - Ready for model training and validation
