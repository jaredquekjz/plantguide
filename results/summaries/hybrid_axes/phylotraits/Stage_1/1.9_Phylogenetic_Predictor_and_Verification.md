# Stage 1 — Phylogenetic Predictor & Verification

Date: 2025-10-21  
Maintainer: Stage 1 modelling support

---

## 1. Purpose
- Extend the Stage 1 pipeline with Bill Shipley’s weighted phylogenetic neighbour predictor (`p_phylo`) for each EIVE axis (T, M, L, N, R).
- Produce tidy artefacts that:
  - aggregate EIVE residuals per accepted WFO concept;
  - compute leave-one-out weighted averages on the canonical phylogeny;
  - merge the resulting predictors into the 1 084-species modelling roster (≥30 georeferenced occurrences), with optional commands for the 11 680 encyclopaedia shortlist when needed.

### Inputs
- EIVE residuals: `data/stage1/eive_worldflora_enriched.parquet`
- Trait table (modelling shortlist ≥30 GBIF occurrences, 1 084 species): `model_data/inputs/traits_model_ready_20251021_rerun_ge30.parquet`
- Phylogeny (2025-10 rebuild): `data/phylogeny/eive_try_tree_20251021.nwk`

### Outputs
- Aggregated residuals: `model_data/inputs/eive_residuals_by_wfo.parquet` (`.csv` twin)
- Phylogenetic predictors:
  - `model_data/outputs/p_phylo_ge30_20251021.parquet`
- Trait tables with predictors merged:
  - `model_data/inputs/traits_model_ready_20251021_rerun_ge30_phylo.parquet`
- (Optional, not required for modelling) 11 680-species shortlist artefacts can be generated by re-running the commands with the shortlist parquet; we skip them by default.

---

## 2. Step-by-step Commands

### 2.1 Aggregate EIVE residuals by WFO concept
```bash
conda run -n AI --no-capture-output \
  python src/Stage_1/aggregate_eive_residuals.py \
    --input data/stage1/eive_worldflora_enriched.parquet \
    --output model_data/inputs/eive_residuals_by_wfo.parquet \
    --output_csv model_data/inputs/eive_residuals_by_wfo.csv
```

### 2.2 Export species + family roster for V.PhyloMaker
```bash
conda run -n AI --no-capture-output python - <<'PY'
import pandas as pd
resid = pd.read_parquet("model_data/inputs/eive_residuals_by_wfo.parquet")
enriched = pd.read_parquet("data/stage1/eive_worldflora_enriched.parquet")
names = enriched[["wfo_taxon_id", "wfo_scientific_name"]].dropna().drop_duplicates()
tax = pd.read_parquet("model_data/inputs/wfo_taxonomy_subset.parquet")
species = (
    resid[["wfo_taxon_id"]]
    .merge(names, on="wfo_taxon_id", how="left")
    .merge(tax, left_on="wfo_taxon_id", right_on="taxonID", how="left")
)
species["family"] = species["family"].fillna("Unknown")
species["genus"] = species["genus"].fillna(species["wfo_scientific_name"].str.split().str[0])
species.loc[
    (species["family"] == "Unknown") & (species["genus"] == "Hablitzia"),
    "family"
] = "Amaranthaceae"
species[["wfo_taxon_id", "wfo_scientific_name", "family", "genus"]].to_csv(
    "data/phylogeny/eive_residual_species_20251021.csv", index=False
)
PY
```

### 2.3 Rebuild phylogeny with family backfill
```bash
Rscript src/Stage_1/build_phylogeny_from_species.R \
  --species_csv=data/phylogeny/eive_residual_species_20251021.csv \
  --output_newick=data/phylogeny/eive_try_tree_20251021.nwk
```

### 2.4 Compute weighted phylogenetic neighbours (Bill Shipley’s LOO scheme)
```bash
# 1 084-species modelling roster (≥30 GBIF)
Rscript src/Stage_1/compute_phylo_predictor.R \
  --traits_csv=model_data/inputs/traits_model_ready_20251021_rerun_ge30.csv \
  --eive_csv=model_data/inputs/eive_residuals_by_wfo.csv \
  --phylogeny_newick=data/phylogeny/eive_try_tree_20251021.nwk \
  --x_exp=2 --k_trunc=0 \
  --output_csv=model_data/outputs/p_phylo_ge30_20251021.csv

# Convert to parquet for Python merges (optional but convenient)
conda run -n AI --no-capture-output python - <<'PY'
import pandas as pd
pd.read_csv("model_data/outputs/p_phylo_ge30_20251021.csv").to_parquet(
    "model_data/outputs/p_phylo_ge30_20251021.parquet", index=False
)
PY
```

### 2.5 Merge predictors into trait tables
```bash
conda run -n AI --no-capture-output python - <<'PY'
import pandas as pd

traits = pd.read_parquet("model_data/inputs/traits_model_ready_20251021_rerun_ge30.parquet")
phylo = pd.read_parquet("model_data/outputs/p_phylo_ge30_20251021.parquet")
merged = traits.merge(phylo, on="wfo_taxon_id", how="left")
merged.to_parquet("model_data/inputs/traits_model_ready_20251021_rerun_ge30_phylo.parquet", index=False)
PY
```

---

## 3. QA Checklist
- **Residual aggregation**: verify numeric conversion and per-axis coverage (expect 12 879 WFO IDs with residuals).
- **Phylogenetic coverage (modelling roster only)**:
  - `p_phylo_*` non-null counts logged in `logs/stage1_modelling_prep/20251021/qa_report.md`
  - Expect ≈1 032/1 084 species covered; any NA indicates species absent from the tree or lacking residuals.
- **Trait merge**: row count unchanged at 1 084; `p_phylo_{T…R}` appended.
- **Config values**: document `x_exp`, `k_trunc`, and tree path in the QA log.

---

## 4. References
- Bill Shipley, “Using a weighted phylogenetic distance as an additional predictor of EIVE – initial thoughts” (`docs/shipley/Using a weighted phylogenetic distance as an additional predictor of EIVE.mmd`).
- Legacy implementation reference: `src/legacy/Stage_3RF_Hybrid/hybrid_trait_bioclim_comprehensive.R` (Section 3.1, `compute_p_from_dist`).

---

## 5. Verification Pipeline

Run these checks immediately after any rebuild to confirm coverage, match fidelity, and alignment with Shipley’s weighting recipe.

### 5.1 Residual coverage audit
```bash
conda run -n AI --no-capture-output python - <<'PY'
import pandas as pd
raw = pd.read_parquet("data/stage1/eive_worldflora_enriched.parquet")
raw["has_wfo"] = raw["wfo_taxon_id"].notna()
axes = ["EIVEres-T", "EIVEres-M", "EIVEres-L", "EIVEres-N", "EIVEres-R"]
counts = {
    "total_rows": len(raw),
    "unique_species": raw["scientificName"].nunique(),
    "with_wfo": raw.loc[raw["has_wfo"], "wfo_taxon_id"].nunique(),
}
for axis in axes:
    counts[f"{axis}_non_null"] = raw.loc[raw[axis].notna(), "wfo_taxon_id"].nunique()
print(counts)
PY
```
- Confirm the `with_wfo` value matches the Stage 1 ingest stats in `1.1_Raw_Data_Preparation.md`.
- Ensure each axis count is ≤ `with_wfo`; gaps reveal axis-level residual absence.

### 5.2 Aggregated residual consistency
```bash
conda run -n AI --no-capture-output python - <<'PY'
import pandas as pd
agg = pd.read_parquet("model_data/inputs/eive_residuals_by_wfo.parquet")
print("Aggregated taxa:", agg["wfo_taxon_id"].nunique())
print(agg.notna().sum())
PY
```
- Expect `Aggregated taxa = 12879` (as of 2025-10-21). Investigate any drop: re-run Step 2.1 or revisit WFO matches.
- Non-null sums should mirror Step 5.1 axis counts after aggregation.

### 5.3 Phylogenetic coverage & parameter fidelity
```bash
conda run -n AI --no-capture-output python - <<'PY'
import pandas as pd
phy = pd.read_parquet("model_data/outputs/p_phylo_ge30_20251021.parquet")
print("Rows:", len(phy))
print("Coverage per axis:")
print(phy.filter(like="p_phylo").notna().sum())
PY
```
- Verify row count = 1 084 (current modelling shortlist size).
- `p_phylo_*` counts should be 1 084; any NA indicates a species absent from the tree or lacking residuals.
- Cross-check that the R log echoes `x_exp=2`, `k_trunc=0`, and tree `data/phylogeny/eive_try_tree_20251021.nwk`, matching Shipley’s memo.

### 5.4 Shipley weighting spot-check
```bash
Rscript - <<'R'
library(ape)
source("src/Stage_1/compute_phylo_predictor.R") # loads helper functions
traits <- read.csv("model_data/inputs/traits_model_ready_20251021_rerun_ge30.csv")
phylo <- read.tree("data/phylogeny/eive_try_tree_20251021.nwk")
sample_ids <- head(traits$wfo_taxon_id[!is.na(traits$wfo_taxon_id)], 5)
merged <- subset(traits, wfo_taxon_id %in% sample_ids)
merged$tip_label <- normalise_name(merged$wfo_scientific_name)
phy_sub <- keep.tip(phylo, merged$tip_label)
cop <- cophenetic.phylo(phy_sub)
vals <- read.csv("model_data/inputs/eive_residuals_by_wfo.csv")
vals <- vals[match(merged$wfo_taxon_id, vals$wfo_taxon_id), ]
p_vals <- compute_p(cop, vals$EIVEres_T, x_exp = 2, k_trunc = 0)
print(data.frame(sample_ids, manual_p = p_vals))
R
```
- Confirm manual values match the published `p_phylo_T` column for these species (values should align to 1e-6 tolerance). Repeat for other axes as needed.

### 5.5 Documentation reconciliation
- Update `logs/stage1_modelling_prep/<date>/qa_report.md` with the key counts (`with_wfo`, `12879`, coverage totals, parameter settings).
- If any check fails, re-read Bill’s note (`docs/shipley/Using a weighted phylogenetic distance as an additional predictor of EIVE.mmd`) to confirm we still honour the leave-one-out weighting, exponent choice, and absence of self-distance contributions.
