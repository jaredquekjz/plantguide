# Stage 2 — L Axis XGBoost (2025-10-22)

## Performance Snapshot
- **Cross-validation**: 10-fold shuffled species (`strategy = "kfold"`).
- **R²**: 0.636 ± 0.032.
- **RMSE**: 0.889 ± 0.046 (axis units).
- **MAE**: 0.672 ± 0.036.
- **Accuracy (±1 rank)**: 89.5 % *(rounded predictions within one EIVE rank)*.
- **Accuracy (±2 ranks)**: 98.2 %.
- **Selected hyperparameters**: `learning_rate = 0.03`, `n_estimators = 3 000` (best of the 3×3 grid search; see `xgb_L_cv_grid.csv`).

> Outputs written to `model_data/outputs/stage2_xgb/L_20251022/` with the k-fold metrics in `xgb_L_cv_metrics.json`.

## Data & Command
- **Feature table**: `model_data/inputs/stage2_features/L_features_20251022.csv` (1084 species).  
  - Built from `modelling_master_20251022.parquet` joined with `eive_residuals_by_wfo.parquet`.  
  - Target column renamed to `y` (former `EIVEres_L`).  
  - Species label: `wfo_scientific_name`.
- **Runner**: `src/Stage_2/xgb_kfold.py` (GPU enabled).

```bash
conda run -n AI --no-capture-output python src/Stage_2/xgb_kfold.py \
  --features_csv model_data/inputs/stage2_features/L_features_20251022.csv \
  --axis L \
  --target_column y \
  --species_column wfo_scientific_name \
  --out_dir model_data/outputs/stage2_xgb/L_20251022 \
  --cv_folds 10 \
  --gpu true \
  --pd_vars logLA,logLDMC,logSLA,logSM,logH,p_phylo_L \
  --pd_pairs logLDMC:wc2.1_30s_bio_12_q50,logSM:wc2.1_30s_bio_4_q50
```

## Top 15 Predictors (SHAP Mean | `xgb_L_shap_importance.csv`)

| Rank | Feature | Mean | Block |
|------|---------|------|-------|
| 1 | `EIVEres_M` | 0.301 | EIVE cross-axis |
| 2 | `p_phylo_L` | 0.188 | Phylogeny |
| 3 | `sla_mm2_mg` | 0.164 | Trait (canonical SLA) |
| 4 | `phh2o_0_5cm_q50` | 0.127 | Soil pH (0–5 cm, median) |
| 5 | `EIVEres_N` | 0.068 | EIVE cross-axis |
| 6 | `soc_0_5cm_q05` | 0.054 | Soil organic carbon (0–5 cm, p05) |
| 7 | `wc2_1_30s_elev_q05` | 0.054 | Elevation quantile |
| 8 | `try_seed_mass` | 0.053 | Trait (seed mass) |
| 9 | `wc2_1_30s_vapr_08_q05` | 0.040 | Climate (vapour pressure August, q05) |
|10 | `phh2o_100_200cm_q95` | 0.040 | Soil pH (100–200 cm, p95) |
|11 | `try_height` | 0.039 | Trait (height) |
|12 | `phh2o_30_60cm_q95` | 0.036 | Soil pH (30–60 cm, p95) |
|13 | `nitrogen_30_60cm_q50` | 0.035 | Soil nitrogen (30–60 cm, median) |
|14 | `logSLA` | 0.034 | Trait (log SLA) |
|15 | `phh2o_60_100cm_q95` | 0.030 | Soil pH (60–100 cm, p95) |

## Model Observations
- **Cross-axis signal**: `EIVEres_M` and `EIVEres_N` remain high-value predictors, mirroring the canonical run’s reliance on other axes.
- **Phylogenetic weight (`p_phylo_L`)**: second-highest contributor, validating the Stage 1 shipley-style neighbour scores.
- **Soil chemistry prominence**: upper-soil pH quantiles (0–200 cm) and nitrogen variability feature strongly, suggesting edaphic controls on L-axis residuals in the expanded dataset.
- **Trait foundations**: Canonical `sla_mm2_mg` now absorbs the leaf-economics signal; once redundant LMA columns and metadata counts were removed, SLA rose to rank 3 while seed mass and height remain prominent.
- **Climate**: Vapour-pressure and elevation quantiles now edge into the top 15, though they lag trait and soil chemistry signals.
- **Solar radiation context**: SRAD quantiles peak lower in the ranking (best feature `wc2.1_30s_srad_04_q95`, SHAP ≈ 0.012, rank ≈ 30). They are highly correlated with moisture surrogates (e.g., `phh2o_0_5cm_q50`, `wc2.1_30s_vapr_08_q05`) and the model prefers those proxies; once soil moisture and vapour pressure are in the tree, SRAD adds only a small incremental gain.
- **Rank accuracy**: ±1 / ±2 scores above derive from rounding both truth and prediction to the nearest integer EIVE rank before tallying hits.
- **Best hyperparameters**: grid search selected `learning_rate = 0.03` with `n_estimators = 3 000`, beating the legacy 0.05/600 default by ~0.01 absolute R².

### Verification notes (2025-10-22)
- Feature table `L_features_20251022.parquet` contains no missing `y`, all core traits respect positivity/fraction bounds, and redundant metadata columns (legacy LMA/SLA variants, `leaf_area_n`, imputation flags) were removed before modelling.
- Console log confirms the 3×3 grid completed; `xgb_L_cv_grid.csv` shows `learning_rate = 0.03`, `n_estimators = 3 000` as the top-R² combination.
- Metrics recomputed from `xgb_L_cv_predictions_kfold.csv` (MAE ≈ 0.672, RMSE ≈ 0.889, R² ≈ 0.642) agree with the JSON summary within rounding tolerance.
- SHAP top 15 is trait/climate focused—no provenance fields remain; canonical SLA, soil moisture, phylogeny dominate the importance ranking.
- Residuals: σ ≈ 0.889 with 12 species beyond 3σ; these align with known high-residual taxa earmarked for Stage 1 trait review.
- `xgb_L_model.json` and `xgb_L_scaler.json` present; the scaler tracks 573 predictors (matching the retained feature list).

## Comparison — no other EIVE axes
- **Setup**: retrained using `model_data/inputs/stage2_features/L_features_noEIVE_20251022.csv`, which drops `EIVEres_T/M/N/R`.
- **Outputs**: `model_data/outputs/stage2_xgb/L_noEIVE_20251022/` (includes `xgb_L_noEIVE_cv_grid.csv`, metrics, SHAP, PD grids).
- **Cross-validation**: 10-fold; `learning_rate = 0.03`, `n_estimators = 3 000` emerged from the same grid (R² peak 0.606 ± 0.042).
- **RMSE / MAE**: 0.923 ± 0.045 / 0.703 ± 0.033.
- **Accuracy (±1 / ±2 ranks)**: 88.0 % / 97.97 %.

### Top 15 predictors (no EIVE axes)

| Rank | Feature | Mean | Block |
|------|---------|------|-------|
| 1 | `phh2o_0_5cm_q50` | 0.259 | Soil pH (0–5 cm, median) |
| 2 | `p_phylo_L` | 0.230 | Phylogeny |
| 3 | `sla_mm2_mg` | 0.174 | Trait (canonical SLA) |
| 4 | `soc_0_5cm_q05` | 0.061 | Soil organic carbon (0–5 cm, p05) |
| 5 | `wc2_1_30s_vapr_08_q05` | 0.060 | Climate (vapour pressure August, q05) |
| 6 | `phh2o_100_200cm_q95` | 0.059 | Soil pH (100–200 cm, p95) |
| 7 | `try_seed_mass` | 0.059 | Trait (seed mass) |
| 8 | `nitrogen_30_60cm_q50` | 0.057 | Soil nitrogen (30–60 cm, median) |
| 9 | `wc2_1_30s_elev_q05` | 0.047 | Elevation quantile |
|10 | `phh2o_30_60cm_q95` | 0.046 | Soil pH (30–60 cm, p95) |
|11 | `try_height` | 0.044 | Trait (height) |
|12 | `plant_height_m` | 0.038 | Trait (height, raw metres) |
|13 | `logSLA` | 0.036 | Trait (log SLA) |
|14 | `wc2_1_30s_vapr_07_q05` | 0.031 | Climate (vapour pressure July, q05) |
|15 | `nitrogen_0_5cm_iqr` | 0.028 | Soil nitrogen variability |

**Impact of removing cross-axis predictors**
- R² drops by ~0.036 and ±1 accuracy by ~1 ppt, confirming that `EIVEres_M/N` provide real signal but that soil chemistry + traits + phylogeny still capture most variance.
- Soil moisture and leaf-economics traits become the undisputed leaders once cross-axis cues are absent, while `p_phylo_L` maintains its standing as the #2 predictor.

## Artefacts
- Metrics & predictions: `xgb_L_cv_metrics.json`, `xgb_L_cv_predictions_kfold.csv`.
- Interpretation: `xgb_L_shap_importance.csv` plus PD grids (`xgb_L_pd1_*`, `xgb_L_pd2_*`).
- Model bundle: `xgb_L_model.json`, `xgb_L_scaler.json`.
