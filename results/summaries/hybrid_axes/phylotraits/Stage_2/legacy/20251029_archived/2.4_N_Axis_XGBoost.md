# Stage 2 — N Axis XGBoost (2025-10-22)

## Performance Snapshot
- **Cross-validation**: 10-fold shuffled species (`strategy = "kfold"`).
- **R²**: 0.711 ± 0.044.
- **RMSE**: 0.993 ± 0.080 (axis units).
- **MAE**: 0.777 ± 0.066.
- **Accuracy (±1 rank)**: 86.2 %.
- **Accuracy (±2 ranks)**: 97.9 %.
- **Selected hyperparameters**: `learning_rate = 0.03`, `n_estimators = 3 000`.

> Outputs stored in `model_data/outputs/stage2_xgb/N_20251022/`; metrics in `xgb_N_cv_metrics.json`.

## Data & Command
- **Feature table**: `model_data/inputs/stage2_features/N_features_20251022.csv` (1 084 species).
  - Canonical SLA only; provenance columns and redundant LMA/SLA variants removed.
  - Joined with `eive_residuals_by_wfo.parquet` to append `EIVEres_T/M/L/R`.
  - Target renamed to `y` (former `EIVEres_N`); species labels via `wfo_scientific_name`.
- **Runner**: `src/Stage_2/xgb_kfold.py` (GPU).

```bash
conda run -n AI --no-capture-output python src/Stage_2/xgb_kfold.py \
  --features_csv model_data/inputs/stage2_features/N_features_20251022.csv \
  --axis N \
  --target_column y \
  --species_column wfo_scientific_name \
  --out_dir model_data/outputs/stage2_xgb/N_20251022 \
  --cv_folds 10 \
  --gpu true \
  --learning_rates 0.03,0.05,0.08 \
  --n_estimators_grid 1500,3000,5000 \
  --pd_vars logLA,logLDMC,logSLA,logSM,logH,p_phylo_N \
  --pd_pairs logLDMC:wc2_1_30s_bio_12_q50,logSM:wc2_1_30s_bio_4_q50
```

## Top 15 Predictors (SHAP Mean | `xgb_N_shap_importance.csv`)

| Rank | Feature | Mean | Block |
|------|---------|------|-------|
| 1 | `EIVEres_M` | 0.426 | EIVE cross-axis |
| 2 | `p_phylo_N` | 0.387 | Phylogeny |
| 3 | `EIVEres_R` | 0.276 | EIVE cross-axis |
| 4 | `leaf_area_mm2` | 0.236 | Trait (leaf area) |
| 5 | `sla_mm2_mg` | 0.151 | Trait (canonical SLA) |
| 6 | `try_height` | 0.080 | Trait (height) |
| 7 | `try_logNmass` | 0.078 | Trait (leaf nitrogen) |
| 8 | `wc2_1_30s_elev_iqr` | 0.077 | Climate (elevation variability) |
| 9 | `EIVEres_L` | 0.066 | EIVE cross-axis |
|10 | `wc2_1_30s_elev_q50` | 0.066 | Climate (elevation median) |
|11 | `plant_height_m` | 0.043 | Trait (height, metres) |
|12 | `clay_60_100cm_q95` | 0.039 | Soil texture (clay, 60–100 cm q95) |
|13 | `logLA` | 0.038 | Trait (log leaf area) |
|14 | `bdod_5_15cm_q95` | 0.037 | Soil bulk density (5–15 cm q95) |
|15 | `wc2_1_30s_bio_8_q95` | 0.035 | Climate (BIO8 q95 — mean temp wettest quarter) |

## Model Observations
- **Cross-axis leverage**: `EIVEres_M` and `EIVEres_R` shoulder nearly half of the explanatory power, reinforcing the coupling between N, metabolic and reproductive axes.
- **Phylogenetic weight**: `p_phylo_N` remains the second-most important feature, aligning with Bill Shipley’s recommendation for lineage-based weighting.
- **Trait cluster**: Leaf area, SLA, height, and nitrogen traits collectively supply strong signal; the harmonised SLA ensures no duplicate provenance inflates importance.
- **Elevation and soils**: Elevation quantiles (WorldClim DEM) and deep clay/bulk-density metrics help explain species with similar trait bundles but different environmental contexts.
- **Residual check**: Residual σ ≈ 0.996 with only 5 species above 3σ—lowest tail among the axes, pointing to a stable fit.

### Verification notes (2025-10-22)
- Feature table validated to confirm removal of `leaf_area_n`, `_source`, and legacy SLA/LMA columns; canonical `sla_mm2_mg` retained.
- Grid search results in `xgb_N_cv_grid.csv` highlight the 0.03 / 3 000 combo as best; matches console output.
- Recomputed MAE/RMSE/accuracy from `xgb_N_cv_predictions_kfold.csv`; numbers match the JSON summary (± rounding).
- Partial-dependence CSVs now available for requested features; underscore naming fixed for the 2-D plots.
- `wc2_1_30s_bio_17_*` columns again auto-dropped (all-NA) and listed in the console log.

## Comparison — no other EIVE axes
- **Inputs**: `model_data/inputs/stage2_features/N_features_noEIVE_20251022.csv`.
- **Outputs**: `model_data/outputs/stage2_xgb/N_noEIVE_20251022/`.
- **Cross-validation**: 10-fold; best `learning_rate = 0.03`, `n_estimators = 3 000`.
- **R² / RMSE / MAE**: 0.609 ± 0.053 / 1.158 ± 0.091 / 0.909 ± 0.066.
- **Accuracy (±1 / ±2 ranks)**: 80.7 % / 96.2 %.

### Top 15 predictors (no EIVE axes)

| Rank | Feature | Mean | Block |
|------|---------|------|-------|
| 1 | `p_phylo_N` | 0.432 | Phylogeny |
| 2 | `leaf_area_mm2` | 0.284 | Trait (leaf area) |
| 3 | `sla_mm2_mg` | 0.212 | Trait (canonical SLA) |
| 4 | `try_height` | 0.146 | Trait (height) |
| 5 | `wc2_1_30s_elev_iqr` | 0.125 | Climate (elevation variability) |
| 6 | `try_logNmass` | 0.079 | Trait (leaf nitrogen) |
| 7 | `wc2_1_30s_elev_q50` | 0.073 | Climate (elevation median) |
| 8 | `try_logLA` | 0.051 | Trait (log leaf area) |
| 9 | `plant_height_m` | 0.047 | Trait (height, metres) |
|10 | `try_ldmc` | 0.046 | Trait (LDMC) |
|11 | `wc2_1_30s_elev_q95` | 0.045 | Climate (elevation q95) |
|12 | `try_nmass` | 0.043 | Trait (leaf nitrogen) |
|13 | `logLA` | 0.038 | Trait (log leaf area) |
|14 | `cec_5_15cm_q05` | 0.036 | Soil cation exchange capacity (5–15 cm q05) |
|15 | `wc2_1_30s_bio_8_q95` | 0.039 | Climate (BIO8 q95) |

**Impact of removing cross-axis predictors**
- R² falls by ≈ 0.102 and ±1 accuracy declines by ~5.5 ppt, showing the dependence of the N axis on metabolic/reproductive residuals.
- Trait variables dominate once cross-axis cues disappear, underscoring that the comprehensive model balances phylogeny, traits, and environmental context simultaneously.

### Clustered significance (≥25th percentile SHAP mean)
- Threshold ≈ 0.0014; 427 of 569 predictors retained (covering 97.0 % of overall SHAP mass).

| Cluster | SHAP sum | % of retained | % of total |
|---------|----------|---------------|------------|
| Traits | 0.9458 | 25.4 | 24.6 |
| Soil texture | 0.5670 | 15.2 | 14.8 |
| Agroclimate | 0.4963 | 13.3 | 12.9 |
| Phylogeny | 0.4947 | 13.3 | 12.9 |
| Soil nutrients | 0.2887 | 7.7 | 7.5 |
| Topography | 0.2576 | 6.9 | 6.7 |
| Climate temperature | 0.2027 | 5.4 | 5.3 |
| Solar radiation | 0.1611 | 4.3 | 4.2 |
| Climate precipitation | 0.1066 | 2.9 | 2.8 |
| Other | 0.1024 | 2.7 | 2.7 |
| Climate humidity | 0.0702 | 1.9 | 1.8 |
| Soil pH | 0.0347 | 0.9 | 0.9 |

### Ecological interpretation
- **Leaf-nutrient spectrum confirmed**: Trait clusters dominate (~25 %), led by leaf area, SLA, and nitrogen content, in line with the nitrogen-rich end of the Leaf Economics Spectrum.
- **Edaphic anchoring**: Soil texture and nutrients together contribute ~23 %, spotlighting substrate structure and fertility as key filters for nutrient strategy—matching theories that nitrogen axes respond to rooting-zone constraints.
- **Phylogeny and topography**: Similar contributions from phylogeny (~13 %) and topographic relief (~7 %) indicate that evolutionary history and elevational gradients jointly structure nutrient acquisition.
- **Hydroclimate support**: Agroclimate (~13 %) and solar radiation (~4 %) modulate productivity and phenology, reinforcing known links between nutrient cycling and climate seasonality.
- **No inconsistencies observed**: The mix of traits, edaphic filters, and moderate climatic effects maps cleanly onto ecological theory; nothing appears out of place or inflated.

## Artefacts
- Metrics & residuals: `xgb_N_cv_metrics.json`, `xgb_N_cv_predictions_kfold.csv`.
- Interpretation: `xgb_N_shap_importance.csv`, `xgb_N_pd1_*`, `xgb_N_pd2_*`.
- Model bundle: `xgb_N_model.json`, `xgb_N_scaler.json`.
