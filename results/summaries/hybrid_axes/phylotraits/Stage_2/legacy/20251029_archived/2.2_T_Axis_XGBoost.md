# Stage 2 — T Axis XGBoost (2025-10-22)

## Performance Snapshot
- **Cross-validation**: 10-fold shuffled species (`strategy = "kfold"`).
- **R²**: 0.832 ± 0.044.
- **RMSE**: 0.523 ± 0.060 (axis units).
- **MAE**: 0.360 ± 0.026.
- **Accuracy (±1 rank)**: 97.8 %.
- **Accuracy (±2 ranks)**: 99.6 %.
- **Selected hyperparameters**: `learning_rate = 0.05`, `n_estimators = 1 500` (best of the 3 × 3 grid search; see `xgb_T_cv_grid.csv`).

> Outputs written to `model_data/outputs/stage2_xgb/T_20251022/`; metrics live in `xgb_T_cv_metrics.json`.

## Data & Command
- **Feature table**: `model_data/inputs/stage2_features/T_features_20251022.csv` (1 084 species).
  - Derived from `modelling_master_20251022.parquet` (canonical SLA only; provenance columns removed).
  - Residual columns from the other axes (`EIVEres_*`) added via `eive_residuals_by_wfo.parquet`.
  - Target column renamed to `y` (former `EIVEres_T`); species label `wfo_scientific_name`.
- **Runner**: `src/Stage_2/xgb_kfold.py` (GPU enabled).

```bash
conda run -n AI --no-capture-output python src/Stage_2/xgb_kfold.py \
  --features_csv model_data/inputs/stage2_features/T_features_20251022.csv \
  --axis T \
  --target_column y \
  --species_column wfo_scientific_name \
  --out_dir model_data/outputs/stage2_xgb/T_20251022 \
  --cv_folds 10 \
  --gpu true \
  --learning_rates 0.03,0.05,0.08 \
  --n_estimators_grid 1500,3000,5000 \
  --pd_vars logLA,logLDMC,logSLA,logSM,logH,p_phylo_T \
  --pd_pairs logLDMC:wc2_1_30s_bio_12_q50,logSM:wc2_1_30s_bio_4_q50
```

## Top 15 Predictors (SHAP Mean | `xgb_T_shap_importance.csv`)

| Rank | Feature | Mean | Block |
|------|---------|------|-------|
| 1 | `wc2_1_30s_bio_10_q05` | 0.278 | Climate (BIO10 q05 — warmest quarter) |
| 2 | `wc2_1_30s_bio_5_q05` | 0.150 | Climate (BIO5 q05 — max temperature) |
| 3 | `wc2_1_30s_bio_1_q05` | 0.082 | Climate (BIO1 q05 — annual mean temp) |
| 4 | `wc2_1_30s_bio_1_q50` | 0.051 | Climate (BIO1 median) |
| 5 | `EIVEres_M` | 0.046 | EIVE cross-axis |
| 6 | `wc2_1_30s_bio_10_q50` | 0.038 | Climate (BIO10 median) |
| 7 | `BEDD_1_q05` | 0.036 | Agroclim (growing degree days) |
| 8 | `wc2_1_30s_bio_9_q95` | 0.031 | Climate (BIO9 q95 — mean temp of driest quarter) |
| 9 | `wc2_1_30s_vapr_04_q95` | 0.030 | Climate (vapour pressure April q95) |
|10 | `sand_100_200cm_q05` | 0.027 | Soil texture (sand, deep) |
|11 | `nitrogen_0_5cm_q50` | 0.027 | Soil nitrogen (surface median) |
|12 | `nitrogen_5_15cm_q05` | 0.027 | Soil nitrogen (5–15 cm q05) |
|13 | `EIVEres_L` | 0.026 | EIVE cross-axis |
|14 | `TX_1_q05` | 0.021 | Agroclim (max temperature q05) |
|15 | `p_phylo_T` | 0.021 | Phylogeny |

## Model Observations
- **Thermal niche dominates**: BIO10/BIO5 quantiles (warm-season temperature) top the list and deliver >40 % of total contribution, emphasising temperature regimes for Species–Trait alignment along T.
- **Cross-axis signal**: `EIVEres_M` and `EIVEres_L` still improve fit, but the gain over the no-EIVE model is modest (ΔR² ≈ 0.007).
- **Climate richness**: Vapr (humidity) and agroclim indices (BEDD, TX) round out the temperature story, suggesting moisture–energy interactions remain relevant.
- **Soil properties**: Deep sand fractions and near-surface nitrogen provide fine-grained differentiation, hinting at edaphic co-drivers for tropical affinity.
- **Phylogeny**: `p_phylo_T` stays in the top 15 even with strong climate cues, confirming neighbour-weight usefulness.
- **Residual flags**: Standard deviation of residuals ≈ 0.526; 17 species exceed 3σ — logged for follow-up in `xgb_T_cv_predictions_kfold.csv`.

### Verification notes (2025-10-22)
- Feature table confirmed free of provenance counts (`leaf_area_n`, `*_source`) and redundant LMA columns; canonical `sla_mm2_mg` is the only leaf-economics predictor.
- Hyperparameter grid completed; `xgb_T_cv_grid.csv` shows the 0.05 / 1 500 combination leading with the highest mean R².
- CV metrics recomputed from `xgb_T_cv_predictions_kfold.csv` match the JSON summary; ±1/±2 rank accuracy uses rounded residual classes.
- Partial-dependence outputs now include the requested 2-D surfaces (`xgb_T_pd2_logLDMC__wc2_1_30s_bio_12_q50.csv`, `xgb_T_pd2_logSM__wc2_1_30s_bio_4_q50.csv`).
- `wc2_1_30s_bio_17_*` columns were dropped automatically (all-NA in the modelling shortlist); recorded in the console log for traceability.

## Comparison — no other EIVE axes
- **Inputs**: `model_data/inputs/stage2_features/T_features_noEIVE_20251022.csv`.
- **Outputs**: `model_data/outputs/stage2_xgb/T_noEIVE_20251022/`.
- **Cross-validation**: 10-fold; `learning_rate = 0.05`, `n_estimators = 1 500`.
- **R² / RMSE / MAE**: 0.825 ± 0.045 / 0.534 ± 0.058 / 0.365 ± 0.026.
- **Accuracy (±1 / ±2 ranks)**: 97.5 % / 99.6 %.

### Top 15 predictors (no EIVE axes)

| Rank | Feature | Mean | Block |
|------|---------|------|-------|
| 1 | `wc2_1_30s_bio_10_q05` | 0.260 | Climate (BIO10 q05) |
| 2 | `wc2_1_30s_bio_5_q05` | 0.175 | Climate (BIO5 q05) |
| 3 | `wc2_1_30s_bio_1_q05` | 0.084 | Climate (BIO1 q05) |
| 4 | `wc2_1_30s_bio_1_q50` | 0.052 | Climate (BIO1 q50) |
| 5 | `wc2_1_30s_bio_10_q50` | 0.040 | Climate (BIO10 q50) |
| 6 | `BEDD_1_q05` | 0.038 | Agroclim (growing degree days) |
| 7 | `wc2_1_30s_vapr_04_q95` | 0.028 | Climate (vapour pressure April q95) |
| 8 | `soc_5_15cm_q50` | 0.028 | Soil organic carbon (5–15 cm q50) |
| 9 | `wc2_1_30s_bio_9_q95` | 0.022 | Climate (BIO9 q95) |
|10 | `p_phylo_T` | 0.022 | Phylogeny |
|11 | `nitrogen_5_15cm_q05` | 0.022 | Soil nitrogen (5–15 cm q05) |
|12 | `TX_1_q05` | 0.021 | Agroclim (max temperature q05) |
|13 | `sand_100_200cm_q05` | 0.021 | Soil texture (sand, deep) |
|14 | `soc_5_15cm_q05` | 0.020 | Soil organic carbon (5–15 cm q05) |
|15 | `nitrogen_0_5cm_q50` | 0.020 | Soil nitrogen (0–5 cm q50) |

**Impact of removing cross-axis predictors**
- R² dip is minor (≈ 0.007) and ±1 accuracy shifts by <0.3 ppt. The axis can rely almost entirely on thermal-focussed climate predictors, while phylogeny and soil chemistry supply the residual variance.
- Trait covariates stay out of the top 15, aligning with expectations that T is climate-dominated once leaf-economics redundancy is eliminated.

### Clustered significance (≥25th percentile SHAP mean)
- Threshold ≈ 0.0008; 427 of 569 predictors retained (covering 96.8 % of overall SHAP mass).

| Cluster | SHAP sum | % of retained | % of total |
|---------|----------|---------------|------------|
| Climate temperature | 0.7251 | 34.8 | 33.6 |
| Agroclimate | 0.3931 | 18.8 | 18.2 |
| Soil nutrients | 0.2208 | 10.6 | 10.2 |
| Soil texture | 0.1987 | 9.5 | 9.2 |
| Climate humidity | 0.1546 | 7.4 | 7.2 |
| Solar radiation | 0.0922 | 4.4 | 4.3 |
| Traits | 0.0793 | 3.8 | 3.7 |
| Soil pH | 0.0772 | 3.7 | 3.6 |
| Phylogeny | 0.0630 | 3.0 | 2.9 |
| Climate precipitation | 0.0558 | 2.7 | 2.6 |
| Topography | 0.0181 | 0.9 | 0.8 |
| Other | 0.0076 | 0.4 | 0.4 |

### Ecological interpretation
- **Thermal niche dominance**: Temperature metrics alone contribute ~35 % of the retained SHAP mass—exactly what tropicality theory predicts. Warmest-quarter and maximum-temperature quantiles map onto species’ thermal optima along the T axis.
- **Hydroclim and phenology**: Agroclim indices (~19 %) and humidity (~7 %) represent rainfall seasonality and vapor-pressure demand that modulate tropical distributions; their importance corroborates moisture–energy balance concepts.
- **Soil and texture context**: Soil nutrients + texture (~20 %) indicate that even for a climate-led axis, edaphic fertility still differentiates species (likely via nutrient availability needed for high productivity in warm climates).
- **No surprises**: The cluster balance mirrors tropical ecology expectations—climate signals first, edaphic and trait adjustments second. The small trait share (~4 %) confirms that leaf form matters but remains secondary once thermal and moisture gradients are captured.

## Artefacts
- Metrics & residuals: `xgb_T_cv_metrics.json`, `xgb_T_cv_predictions_kfold.csv`.
- Interpretation: `xgb_T_shap_importance.csv`, `xgb_T_pd1_*`, `xgb_T_pd2_*`.
- Model bundle: `xgb_T_model.json`, `xgb_T_scaler.json`.
