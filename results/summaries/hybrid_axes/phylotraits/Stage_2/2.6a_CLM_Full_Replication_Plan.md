# Stage 2.6a: Plan for Full CLM Replication

**Date**: 2025-10-30
**Purpose**: Achieve strict replication of Shipley et al. (2017) CLM specification for fair XGBoost comparison

## Current Status

### Current Implementation Issues

**File**: `src/Stage_2/run_clm_traits_only.R`

**Problem 1: Simplified Interaction Structure**
- Current: Main effects + 2-way interactions only (15 parameters)
- Shipley: Varies by axis using AIC-based stepwise selection
  - Nutrients: Up to 2-way interactions
  - Light: Full 4-way interactions
  - Moisture: Up to 3-way interactions

**Problem 2: Wrong R Package**
- Current: `VGAM::vglm` with `family = cumulative(link = "logit", parallel = TRUE)`
- Shipley: `ordinal::clm` with cumulative link
- These packages have different implementations and may yield different results

**Problem 3: Coefficient Structure**
- Current: All coefficients vary by plant_form
- Shipley: Some coefficients shared across plant types, others vary (see Table 2)
  - Example: ln(SM) has single coefficient (0.52) for all plant types in Nutrients
  - Example: ln(LA) varies by plant type: 0.82, -0.04, -0.66, 1.06 for G, H, S, T

**Problem 4: No Stepwise Selection**
- Current: Fixed formula
- Shipley: Used `stepAIC` function from MASS library to select interaction terms

**Problem 5: EIVE Weighting**
- Current: Attempts to use L.n, M.n, N.n weights but falls back to uniform if missing
- Shipley: Used observation counts as weights (not clearly documented)

## Shipley et al. (2017) Full Specification

### Sample Sizes (Table 1)
- Ellenberg Nutrients: 922 species
- Ellenberg Moisture: 988 species
- Ellenberg Light: 981 species

**Our data**: 1,084 species (MORE than Shipley - rank deficiency unlikely)

### Model Structure (Equations 1-2)

**Latent score**:
```
LS_i = β₁·ln(LA_i) + β₂·ln(LDMC_i) + β₃·ln(SLA_i) + β₄·ln(SM_i)
       + interactions + plant_form effects
```

**Cumulative probability**:
```
P_i(≤ j) = exp(α_j - LS_i) / (1 + exp(α_j - LS_i))
```

Where α_j are "threshold" or "intercept" coefficients

### Features Used
1. **Plant functional type**: 4 levels (graminoid, herb, shrub, tree)
2. **4 log-transformed traits**:
   - ln(LA): Leaf area (mm²)
   - ln(LDMC): Leaf dry matter content (g·g⁻¹)
   - ln(SLA): Specific leaf area (mm²·mg⁻¹)
   - ln(SM): Seed mass (mg)
3. **Interaction terms**: Determined by stepAIC

### Interaction Structure by Axis (Table 2 "Best Model Using AIC")

**Ellenberg Nutrients (N)**:
- Main effects: plant_form, A, B, C, D
- 2-way interactions: A×B, A×C, A×D, B×C, B×D, C×D
- No 3-way or 4-way interactions
- **Total predictors**: ~18 (8 intercepts + 3 plant_form + 4 main + 6 two-way)

**Ellenberg Light (L)**:
- Main effects: plant_form, A, B, C, D
- 2-way interactions: All 6 combinations
- 3-way interactions: A×B×C, A×B×D, A×C×D, B×C×D (4 terms)
- 4-way interaction: A×B×C×D (1 term)
- **Total predictors**: ~26 (8 intercepts + 3 plant_form + 4 main + 6 two-way + 4 three-way + 1 four-way)

**Ellenberg Moisture (M)**:
- Main effects: plant_form, A, B, C, D
- 2-way interactions: All 6 combinations
- 3-way interactions: A×B×C, A×B×D, A×C×D, B×C×D (4 terms)
- No 4-way interaction
- **Total predictors**: ~25 (8 intercepts + 3 plant_form + 4 main + 6 two-way + 4 three-way)

### Coefficient Sharing Pattern

**Important**: Not all coefficients vary by plant type in Shipley's models!

Looking at Table 2 "Best Model Using AIC":
- **Nutrients axis**: ln(SM) shared (0.52 for all), but many interactions vary
- **Light axis**: Most interactions have shared coefficients across plant types
- **Moisture axis**: A (ln(LA)) is SHARED (-1.84 for all plant types)

This suggests the formula structure includes some plant_form interactions and some shared terms.

## Replication Strategy

### Phase 1: Package Migration (VGAM → ordinal)

**Action**: Rewrite CLM script to use `ordinal::clm` instead of `VGAM::vglm`

**Key differences**:
```r
# Current (VGAM)
vglm(axis_y ~ plant_form + traits + interactions,
     family = cumulative(link = "logit", parallel = TRUE),
     weights = weights)

# Target (ordinal)
clm(axis_y ~ plant_form + traits + interactions,
    link = "logit",
    weights = weights)
```

**Benefits**:
- Matches Shipley's exact implementation
- May have better numerical stability
- Consistent with published methods

### Phase 2: Implement Stepwise AIC Selection

**Action**: Add stepwise model selection to find optimal interaction structure per axis

**Approach**:
```r
# Start with maximal model
maximal_formula <- axis_y ~ plant_form * (logLA + logLDMC + logSLA + logSM)^4

# Use stepAIC to select terms
library(MASS)
best_model <- stepAIC(
  clm(maximal_formula, data = train_df, link = "logit"),
  direction = "both",  # Forward and backward selection
  trace = 0
)
```

**Note**: The `*` operator in R formula means:
- `A * B` expands to `A + B + A:B`
- `(A + B + C + D)^4` expands to all main effects + all 2-way, 3-way, 4-way interactions

**Challenge**: The maximal model `plant_form * (traits)^4` includes plant_form interactions with ALL trait interactions. This creates a HUGE number of parameters:
- 4 traits → 15 terms (4 main + 6 two-way + 4 three-way + 1 four-way)
- × 4 plant types = 60 trait-related coefficients
- + 8 intercepts
- **Total**: ~68 parameters

This is likely TOO MANY for 1,084 species → rank deficiency.

### Phase 3: Simplified Stepwise Strategy

**Observation from Table 2**: Shipley's models have SHARED coefficients for many interactions.

**Alternative approach**: Build candidate models with partial plant_form interactions:

**Model 1: Simplified (current)**
```r
axis_y ~ plant_form + logLA + logLDMC + logSLA + logSM +
         logLA:logLDMC + logLA:logSLA + logLA:logSM +
         logLDMC:logSLA + logLDMC:logSM + logSLA:logSM
```

**Model 2: Add 3-way interactions (shared)**
```r
axis_y ~ plant_form + logLA + logLDMC + logSLA + logSM +
         (logLA + logLDMC + logSLA + logSM)^3
```

**Model 3: Add 4-way interaction (shared)**
```r
axis_y ~ plant_form + logLA + logLDMC + logSLA + logSM +
         (logLA + logLDMC + logSLA + logSM)^4
```

**Model 4: Plant_form interactions with main effects only**
```r
axis_y ~ plant_form * (logLA + logLDMC + logSLA + logSM) +
         (logLA + logLDMC + logSLA + logSM)^2
```

**Then use AIC to select best model per axis.**

### Phase 4: Verify Against Shipley Results

**Validation checks**:
1. Compare mean predictive error (MPE) to Shipley Table 2:
   - Nutrients: Our R² 0.287 vs Shipley MEP 1.77
   - Light: Our R² 0.233 vs Shipley MEP 1.27
   - Moisture: Our R² 0.111 vs Shipley MEP 1.76

2. Compare coefficient signs and magnitudes (if possible)

3. Check distribution of prediction errors (Shipley Table 3)

### Phase 5: Fair XGBoost Comparison

Once CLM is properly replicated:

**Comparison criteria**:
1. **Same data**: 1,084 species Tier 1 subset
2. **Same CV**: 10-fold stratified by EIVE level
3. **Same evaluation**: R², MAE, RMSE, Acc±1

**Expected outcome**: XGBoost should STILL outperform by large margin because:
- Environmental features (633 quantiles) critical for M-axis
- Phylogenetic predictors (p_phylo_L/M/N) capture niche conservatism
- Nonlinear trait-environment interactions

But the comparison will be FAIR and defensible.

## Implementation Plan

### Task 1: Create `run_clm_ordinal_stepwise.R`
- Use `ordinal::clm` package
- Implement 4 candidate models
- Use AIC to select best per axis
- Save AIC comparison table

### Task 2: Test on Single Axis (L-axis)
- Run all 4 models on L-axis
- Compare AIC scores
- Verify numerical stability
- Check CV performance

### Task 3: Run Full 3-Axis Comparison
- Run best models for L, M, N
- Generate performance metrics
- Compare to current simplified results
- Document improvement (if any)

### Task 4: Update Stage 2.6 Documentation
- Add section on replication methodology
- Present AIC-selected models
- Show comparison to Shipley Table 2
- Update XGBoost comparison with fair CLM baseline

## Expected Timeline

- **Task 1**: 2 hours (script development)
- **Task 2**: 30 minutes (single axis test)
- **Task 3**: 30 minutes (3-axis full run)
- **Task 4**: 1 hour (documentation update)
- **Total**: ~4 hours

## Expected Outcomes

### Scenario 1: Higher-Order Interactions Help
- Simplified model: R² 0.11-0.29
- Full AIC-selected: R² 0.15-0.35 (+~20%)
- Still much worse than XGBoost: R² 0.53-0.81

**Conclusion**: Environmental and phylogenetic features remain essential.

### Scenario 2: No Meaningful Improvement
- AIC selects simplified model (2-way only)
- Performance unchanged
- Original comparison already fair

**Conclusion**: Traits alone fundamentally limited, regardless of interaction structure.

### Scenario 3: Rank Deficiency Issue
- Full interaction models cause numerical instability
- Must restrict to simpler models
- Document limitation in methods

**Conclusion**: Sample size insufficient for 4-way interactions with plant_form effects.

## Scientific Rationale

**Why this matters**:

1. **Methodological rigor**: Published comparisons must use correct baseline implementation
2. **Fair benchmarking**: XGBoost advantages should be attributable to features, not implementation differences
3. **Replicability**: Using Shipley's exact methods ensures reproducible science
4. **Transparency**: Documenting limitations of trait-only models guides future work

**Key argument**: Even if full CLM improves R² from 0.11→0.20, XGBoost still achieves 0.68 (240% better). The advantage is fundamental, not artifactual.

---

**Status**: PLANNED - Ready for implementation
**Priority**: High - Affects scientific validity of Stage 2.6 benchmark
**Assignee**: Claude Code
