# Stage 2.7 — Production CV & Imputation (Canonical)

**Date:** 2025-10-29
**Status:** COMPLETE - All models trained, imputation successful (100% coverage)

---

## Overview

This document provides the complete canonical workflow for:

1. **Tier 2 Production CV:** Train full and no-EIVE models on ~6,200 species per axis
2. **Hybrid Imputation:** Impute missing EIVE for 5,756 species using axis-by-axis model selection

**Key principle:** All paths and datasets traced from canonical Stage 1 outputs (1.9 and 1.10)

---

## 1. Input Datasets (From Stage 1.10)

### 1.1 Master Table

**Source:** Stage 1.10 Section 3.2

**File:**
```
model_data/outputs/perm2_production/perm2_11680_complete_final_20251028.parquet
```

**Dimensions:** 11,680 species × 736 features (no phylo predictors yet)

**Contents:**
- Identifiers: wfo_taxon_id, wfo_scientific_name
- Log traits: 100% complete (logLA, logNmass, logLDMC, logSLA, logH, logSM)
- Phylo eigenvectors: 99.6% (phylo_ev1...phylo_ev92)
- EIVE indicators: 52.8% (EIVEres-L/T/M/N/R, observed only)
- Categorical traits: 29-79%
- Environmental quantiles: 100% (624 features: q05/q50/q95/iqr)

**EIVE coverage per axis:**
| Axis | Species with Observed EIVE | Missing EIVE |
|------|---------------------------|--------------|
| L | 6,165 (52.8%) | 5,515 (47.2%) |
| T | 6,220 (53.2%) | 5,460 (46.8%) |
| M | 6,245 (53.5%) | 5,435 (46.5%) |
| N | 6,000 (51.4%) | 5,680 (48.6%) |
| R | 6,063 (51.9%) | 5,617 (48.1%) |

**EIVE missingness patterns:**
- Complete (all 5 axes): 5,924 species (50.7%)
- Partial (1-4 axes): 337 species (2.9%)
- None (0 axes): 5,419 species (46.4%)

---

## 2. Phylogenetic Predictors (From Stage 1.9)

**Source:** Stage 1.9 Section 2

### 2.1 Context-Matched Phylo (Per Axis)

**Why context-matched?** Phylo predictors must be calculated within the same phylogenetic context as training data to avoid predictor collapse.

**Files (to be generated if not present):**
```
model_data/outputs/p_phylo_tier2_cv/p_phylo_L_tier2_cv_20251029.csv  (6,165 species, ~5,400-species tree)
model_data/outputs/p_phylo_tier2_cv/p_phylo_T_tier2_cv_20251029.csv  (6,220 species, ~5,400-species tree)
model_data/outputs/p_phylo_tier2_cv/p_phylo_M_tier2_cv_20251029.csv  (6,245 species, ~5,400-species tree)
model_data/outputs/p_phylo_tier2_cv/p_phylo_N_tier2_cv_20251029.csv  (6,000 species, ~5,400-species tree)
model_data/outputs/p_phylo_tier2_cv/p_phylo_R_tier2_cv_20251029.csv  (6,063 species, ~5,400-species tree)
```

**Calculation script:** `src/Stage_2/calculate_tier2_cv_phylo.R`

**Process (per axis):**
1. Load axis roster (species with observed EIVE)
2. Load EIVE residuals
3. Load full phylogenetic tree (10,977 tips)
4. Prune tree to species with observed EIVE for this axis (→ ~5,400 tips)
5. Calculate phylogenetic distance matrix
6. Apply Shipley leave-one-out weighted averaging (w_ij = 1/d_ij², x_exp=2)
7. Generate p_phylo_{AXIS}

**Coverage:** ~87% per axis (phylo calculated for species in pruned tree)

---

## 3. Feature Table Build (Step-by-Step)

### 3.1 Initial Feature Tables (Without Context-Matched Phylo)

**Script:** `src/Stage_2/build_tier2_features.py`

**Input:** Master table from 1.10
**Output (per axis):**
```
model_data/inputs/stage2_features/L_features_11680_20251029.csv
model_data/inputs/stage2_features/T_features_11680_20251029.csv
model_data/inputs/stage2_features/M_features_11680_20251029.csv
model_data/inputs/stage2_features/N_features_11680_20251029.csv
model_data/inputs/stage2_features/R_features_11680_20251029.csv
```

**Process (per axis):**
1. Load master table
2. Remove target axis EIVE (e.g., remove EIVEres-L for L-axis)
3. Keep other axes' EIVE as cross-axis features
4. Keep all other features (traits, phylo eigenvectors, environment, categorical)
5. Filter to species with observed EIVE for this axis (for training subset identification)
6. Save 11,680 species with all features EXCEPT target axis EIVE

**Execution:**
```bash
conda run -n AI python src/Stage_2/build_tier2_features.py
```

---

### 3.2 Calculate Context-Matched Phylo Predictors

**Script:** `src/Stage_2/calculate_tier2_cv_phylo.R`

**Input:**
- Feature tables from 3.1 (for species rosters)
- EIVE residuals: `model_data/inputs/eive_residuals_by_wfo.csv`
- Phylogenetic tree: `data/phylogeny/mixgb_tree_11676_species_20251027.nwk`

**Output:**
```
model_data/outputs/p_phylo_tier2_cv/p_phylo_L_tier2_cv_20251029.csv
model_data/outputs/p_phylo_tier2_cv/p_phylo_T_tier2_cv_20251029.csv
model_data/outputs/p_phylo_tier2_cv/p_phylo_M_tier2_cv_20251029.csv
model_data/outputs/p_phylo_tier2_cv/p_phylo_N_tier2_cv_20251029.csv
model_data/outputs/p_phylo_tier2_cv/p_phylo_R_tier2_cv_20251029.csv
```

**Execution:**
```bash
env R_LIBS_USER="/home/olier/ellenberg/.Rlib" \
  /usr/bin/Rscript src/Stage_2/calculate_tier2_cv_phylo.R
```

---

### 3.3 Merge Context-Matched Phylo Into Feature Tables

**Script:** `src/Stage_2/update_tier2_features_with_cv_phylo.py`

**Input:**
- Initial feature tables from 3.1
- Context-matched phylo from 3.2

**Output:**
```
model_data/inputs/stage2_features/L_features_11680_corrected_20251029.csv
model_data/inputs/stage2_features/T_features_11680_corrected_20251029.csv
model_data/inputs/stage2_features/M_features_11680_corrected_20251029.csv
model_data/inputs/stage2_features/N_features_11680_corrected_20251029.csv
model_data/inputs/stage2_features/R_features_11680_corrected_20251029.csv
```

**Process (per axis):**
1. Load initial feature table (11,680 species)
2. Load context-matched phylo for this axis
3. Merge on wfo_taxon_id
4. Result: 11,680 species × 741 features (with context-matched p_phylo_{AXIS})

**Execution:**
```bash
conda run -n AI python src/Stage_2/update_tier2_features_with_cv_phylo.py
```

---

### 3.4 Build No-EIVE Feature Tables

**Script:** `src/Stage_2/build_tier2_no_eive_features.py`

**Input:** Corrected feature tables from 3.3

**Output:**
```
model_data/inputs/stage2_features/L_features_11680_no_eive_20251029.csv
model_data/inputs/stage2_features/T_features_11680_no_eive_20251029.csv
model_data/inputs/stage2_features/M_features_11680_no_eive_20251029.csv
model_data/inputs/stage2_features/N_features_11680_no_eive_20251029.csv
model_data/inputs/stage2_features/R_features_11680_no_eive_20251029.csv
```

**Process (per axis):**
1. Load corrected feature table (with context-matched phylo)
2. Remove ALL EIVE-related predictors (9 features per axis):
   - Cross-axis EIVE: 4 features (target axis already excluded, e.g., EIVEres-T/M/N/R for L-axis)
   - EIVE-based phylo: 5 features (p_phylo_L, p_phylo_T, p_phylo_M, p_phylo_N, p_phylo_R)
3. Keep: traits (6), phylo eigenvectors (92), environmental quantiles (624), categorical traits (7)
4. Result: ~6,200 species × 732 features per axis (9 EIVE-related removed, 732 = 741 - 9)

**Purpose:** For imputing species with NO or PARTIAL observed EIVE
**Rationale:** EIVE-based phylo predictors (p_phylo_*) are unavailable for species without EIVE neighbors

**Execution:**
```bash
conda run -n AI python src/Stage_2/build_tier2_no_eive_features.py
```

---

## 4. Model Training

### 4.1 Tier 2 Full Models (WITH Cross-Axis EIVE)

**Script:** `src/Stage_2/run_tier2_production_corrected_all_axes.sh`

**Hyperparameters (from Tier 1 tuning):**
| Axis | Learning Rate | N Estimators | Max Depth |
|------|---------------|--------------|-----------|
| L | 0.03 | 1500 | 6 |
| T | 0.03 | 1500 | 6 |
| M | 0.03 | 5000 | 6 |
| N | 0.03 | 1500 | 6 |
| R | 0.05 | 1500 | 6 |

**Input (per axis):** Corrected feature tables from 3.3

**Training data:** Species with observed EIVE for this axis (~6,200 per axis)

**Output (per axis):**
```
model_data/outputs/stage2_xgb/L_11680_production_corrected_20251029/
├── xgb_L_model.json               # XGBoost model
├── xgb_L_scaler.json              # Z-score standardization parameters
├── xgb_L_cv_metrics_kfold.json    # 10-fold CV performance
├── xgb_L_cv_predictions_kfold.csv # Per-species CV predictions
└── xgb_L_shap_importance.csv      # Feature importance rankings
```

**Expected performance:**
| Axis | R² | MAE | Acc±1 | Top Predictor |
|------|-----|-----|-------|---------------|
| L | 0.664 ± 0.024 | 0.654 | 90.4% | EIVEres-M |
| T | 0.823 ± 0.016 | 0.522 | 94.2% | bio_10_q05 |
| M | 0.704 ± 0.023 | 0.627 | 90.9% | p_phylo_M |
| N | 0.694 ± 0.026 | 0.810 | 85.3% | logLA |
| R | 0.506 ± 0.037 | 0.825 | 83.6% | clay_0_5cm_q50 |

**Phylo predictor ranks:** #1 (M), #3 (L/N/R), #5 (T)

**Execution:**
```bash
bash src/Stage_2/run_tier2_production_corrected_all_axes.sh
```

**Runtime:** ~6-10 minutes (all 5 axes, sequential)

---

### 4.2 Tier 2 No-EIVE Models (WITHOUT EIVE-Related Features)

**Script:** `src/Stage_2/run_tier2_no_eive_all_axes.sh`

**Hyperparameters:** Same as full models (from Tier 1)

**Input (per axis):** No-EIVE feature tables from 3.4 (excludes 9 EIVE-related features per axis)

**Training data:** Same species as full models (~6,200 per axis with observed EIVE)

**Excluded features (9 per axis):**
- Cross-axis EIVE: 4 features (target axis already excluded in base feature table)
- EIVE-based phylo: 5 features (p_phylo_L, T, M, N, R)

**Retained features:**
- 6 log-transformed traits
- 92 phylogenetic eigenvectors (non-EIVE)
- 624 environmental quantiles
- 7 TRY categorical traits (woodiness, growth form, habitat adaptation, leaf type, etc.)

**Output (per axis):**
```
model_data/outputs/stage2_xgb/L_11680_no_eive_20251029/
├── xgb_L_model.json
├── xgb_L_scaler.json
├── xgb_L_cv_metrics_kfold.json
├── xgb_L_cv_predictions_kfold.csv
└── xgb_L_shap_importance.csv
```

**Actual performance (corrected NO-EIVE models):**
| Axis | R² | MAE | Acc±1 | Δ R² vs Full | % Drop |
|------|-----|-----|-------|--------------|--------|
| L | 0.611 ± 0.022 | 0.704 | 88.4% | -0.053 | -8.0% |
| T | 0.806 ± 0.016 | 0.548 | 93.1% | -0.017 | -2.1% |
| M | 0.649 ± 0.024 | 0.693 | 88.9% | -0.055 | -7.8% |
| N | 0.601 ± 0.038 | 0.934 | 79.8% | -0.093 | -13.4% |
| R | 0.441 ± 0.030 | 0.883 | 81.3% | -0.065 | -12.8% |
| **Avg** | **0.622** | **0.752** | **86.3%** | **-0.057** | **-8.8%** |

**Note:** These models correctly exclude 9 EIVE-related features per axis (4 cross-axis + 5 phylo). All other features retained (traits, phylo eigenvectors, environment, categorical). Average 8.8% performance drop vs full models is expected and acceptable for imputing species without EIVE.

**Execution:**
```bash
bash src/Stage_2/run_tier2_no_eive_all_axes.sh
```

**Runtime:** ~10-12 minutes (all 5 axes, sequential)

---

## 5. EIVE Imputation - Complete Documentation

### 5.1 Imputation Strategy

**Method:** NO-EIVE models for all species needing imputation (5,756 species total)

**Rationale:**
- NO-EIVE models exclude 9 EIVE-related features per axis (4 cross-axis EIVE + 5 phylo EIVE)
- Retain all non-EIVE features: 6 traits, 92 phylo eigenvectors, 624 environmental quantiles, 7 categorical traits
- Handles both zero-EIVE (5,419 species) and partial-EIVE (337 species) uniformly
- Avoids feature availability mismatches for partial-EIVE species
- Consistent methodology over complex hybrid approach

**Imputation targets:**
- Zero-EIVE species (0/5 axes): 5,419 (46.4%) → NO-EIVE models
- Partial-EIVE species (1-4/5 axes): 337 (2.9%) → NO-EIVE models (conservative)
- Complete-EIVE species (5/5 axes): 5,924 (50.7%) → No imputation needed

**Trade-off accepted:**
- 337 partial-EIVE species lose potential cross-axis signal (~5-10% accuracy loss)
- Simplicity and consistency prioritized for 2.9% of dataset

### 5.2 Complete Reproduction

**Script:** `src/Stage_2/impute_eive_no_eive_only.py`

**Full reproduction command:**
```bash
/home/olier/miniconda3/envs/AI/bin/python \
  src/Stage_2/impute_eive_no_eive_only.py \
  2>&1 | tee logs/eive_imputation_20251029_final.log
```

**Environment:**
- Python: conda env `AI`
- Packages: xgboost 3.0.5, pandas, numpy
- GPU: NVIDIA RTX 6000 Ada (426MB usage)
- Runtime: 15.4 seconds (batch processing)

**Input dependencies:**
- Master table: `model_data/outputs/perm2_production/perm2_11680_complete_final_20251028.parquet`
- NO-EIVE models: `model_data/outputs/stage2_xgb/{axis}_11680_no_eive_20251029/xgb_{axis}_model.json`
- Scalers: `model_data/outputs/stage2_xgb/{axis}_11680_no_eive_20251029/xgb_{axis}_scaler.json`

### 5.3 Results Summary

**Input coverage:**
- Total species: 11,680
- Complete EIVE (5/5 axes): 5,924 (50.7%)
- Partial EIVE (1-4/5 axes): 337 (2.9%)
  - 4 axes: 102 species
  - 3 axes: 214 species
  - 2 axes: 2 species
  - 1 axis: 19 species
- Zero EIVE (0/5 axes): 5,419 (46.4%)

**Imputation results:**
- Total EIVE values imputed: 27,707
- 100% completeness (0 missing values)
- Per-axis imputation:
  - L: 5,515 imputed (from 6,165 observed)
  - T: 5,460 imputed (from 6,220 observed)
  - M: 5,435 imputed (from 6,245 observed)
  - N: 5,680 imputed (from 6,000 observed)
  - R: 5,617 imputed (from 6,063 observed)

**Value ranges (sanity verified):**
- L: [0.00, 9.83], mean 7.33
- T: [0.00, 10.00], mean 5.40
- M: [0.16, 9.38], mean 4.02
- N: [0.15, 10.00], mean 4.20
- R: [0.33, 10.00], mean 6.24

All values within expected 0-10 EIVE scale, means biologically plausible.

### 5.4 Technical Implementation

**Features used (722 total):**
- Log traits (6): 100% complete in imputation targets
- Phylo eigenvectors (92): 99.6% complete
- Environmental quantiles (624): Variable completeness

**Features excluded (10 total):**
- Direct EIVE: EIVEres-L, T, M, N, R
- EIVE-based phylo: p_phylo_L, T, M, N, R

**NO-EIVE model performance (10-fold CV on training data):**
| Axis | R² | RMSE | MAE | Acc±1 | Training N |
|------|-----|------|-----|-------|-----------|
| L | 0.611 ± 0.022 | 0.945 | 0.704 | 88.4% | 6,165 |
| T | 0.806 ± 0.016 | 0.786 | 0.548 | 93.1% | 6,220 |
| M | 0.649 ± 0.024 | 0.937 | 0.693 | 88.9% | 6,245 |
| N | 0.601 ± 0.038 | 1.208 | 0.934 | 79.8% | 6,000 |
| R | 0.441 ± 0.030 | 1.196 | 0.883 | 81.3% | 6,063 |
| **Avg** | **0.622** | **1.014** | **0.752** | **86.3%** | **6,139** |

8.8% average R² drop vs full models (expected without cross-axis EIVE).

**Batch processing efficiency:**
- Axis-by-axis prediction (5 axes)
- Vectorized scaling and DMatrix creation
- Per-axis timing: 0.1-0.2s per axis
- Total imputation: 0.7s (inference only)
- Full runtime: 15.4s (including I/O)

### 5.5 Missing Value Handling

**Challenge:** Distribution shift in environmental features

**Training species (European, WITH observed EIVE):**
- nitrogen_60_100cm: 2.9% missing
- cec_5_15cm: 0.1% missing
- sand_0_5cm: 0.1% missing
- Dense GBIF occurrence data

**Imputation species (non-European, WITHOUT observed EIVE):**
- nitrogen_60_100cm: 69.5% missing (24× higher)
- cec_5_15cm: 42.4% missing (424× higher)
- sand_0_5cm: 42.2% missing (422× higher)
- Sparse occurrence data outside Europe

**Solution:** XGBoost native missing value handling
- Models learn default split directions during training
- Missing values routed via learned defaults during inference
- No imputation or special handling required

**Impact assessment (SHAP importance analysis):**

Problematic features ranked by importance:
- nitrogen_60_100cm_q50: Rank 25 (0.43% importance)
- nitrogen_60_100cm_q05: Rank 123 (0.14%)
- nitrogen_60_100cm_q95: Rank 255 (0.09%)
- nitrogen_60_100cm_iqr: Rank 151 (0.13%)
- cec_5_15cm_q50: Rank 40 (0.29%)
- sand_0_5cm_q50: Rank 92 (0.18%)

**Total combined importance: ~1.3%**

Top 10 features by importance:
1. logSLA: 10.0%
2. logLA: 5.2%
3. logH: 2.6%
4. soc_0_5cm_q05: 2.5%
5. elevation_q05: 2.0%
6. phh2o_0_5cm_q50: 2.0%
7. phylo_ev15: 1.8%
8. logSM: 1.6%
9. phh2o_30_60cm_q95: 1.1%
10. phh2o_60_100cm_q95: 1.0%

**Conclusion:** Missing environmental features affect only low-importance predictors. Estimated impact: ~1-2% accuracy degradation, negligible for production use.

**Observed missingness in imputation targets:**
- Average: 6/722 features (0.9%)
- Maximum: 104/722 features (14.4%)
- Median: 6 features

### 5.6 Output Files and Verification

**Primary output:**
```
model_data/outputs/eive_imputed_no_eive_20251029.csv
```
- 11,680 species × 12 columns
- Columns: wfo_taxon_id, wfo_scientific_name, EIVEres-L/T/M/N/R, L/T/M/N/R_source
- Size: 1.7 MB
- Format: CSV with header

**Metadata:**
```
model_data/outputs/eive_imputation_metadata_20251029.json
```
Contains:
- Total species breakdown (complete/partial/none)
- Per-axis statistics (observed, imputed, avg/max missing features, timing)
- Method identifier (no_eive_batch)
- Timestamp and total runtime

**Log file:**
```
logs/eive_imputation_20251029_final.log
```
Complete console output with progress indicators and timing.

**Verification checks:**
```bash
# Check completeness
/home/olier/miniconda3/envs/AI/bin/python -c "
import pandas as pd
df = pd.read_csv('model_data/outputs/eive_imputed_no_eive_20251029.csv')
eive_cols = ['EIVEres-L', 'EIVEres-T', 'EIVEres-M', 'EIVEres-N', 'EIVEres-R']
print('Missing values per axis:')
print(df[eive_cols].isnull().sum())
print()
print('Value ranges:')
for col in eive_cols:
    print(f'{col}: [{df[col].min():.2f}, {df[col].max():.2f}], mean={df[col].mean():.2f}')
print()
print('Source distribution:')
for ax in ['L', 'T', 'M', 'N', 'R']:
    print(df[f'{ax}_source'].value_counts())
"

# Expected output: All zeros for missing, ranges 0-10, reasonable means
```

**Verification results:**
- ✓ Zero missing values across all axes
- ✓ All values within 0-10 EIVE scale
- ✓ Reasonable mean values (L=7.3, T=5.4, M=4.0, N=4.2, R=6.2)
- ✓ Source distribution: ~50% observed, ~50% imputed

---

## 6. Canonical Execution Sequence

**Complete workflow from Stage 1 outputs to final imputation:**

```bash
# === PHASE 1: FEATURE TABLE BUILD ===

# 1. Build initial feature tables (without context-matched phylo)
conda run -n AI python src/Stage_2/build_tier2_features.py

# 2. Calculate context-matched phylo predictors (per axis)
env R_LIBS_USER="/home/olier/ellenberg/.Rlib" \
  /usr/bin/Rscript src/Stage_2/calculate_tier2_cv_phylo.R

# 3. Merge context-matched phylo into feature tables
conda run -n AI python src/Stage_2/update_tier2_features_with_cv_phylo.py

# 4. Build no-EIVE feature variants
conda run -n AI python src/Stage_2/build_tier2_no_eive_features.py

# === PHASE 2: MODEL TRAINING ===

# 5. Train full models (WITH cross-axis EIVE)
bash src/Stage_2/run_tier2_production_corrected_all_axes.sh

# 6. Train no-EIVE models (WITHOUT cross-axis EIVE)
bash src/Stage_2/run_tier2_no_eive_all_axes.sh

# === PHASE 3: IMPUTATION ===

# 7. Run NO-EIVE imputation (for all 5,756 species)
/home/olier/miniconda3/envs/AI/bin/python src/Stage_2/impute_eive_no_eive_only.py \
  2>&1 | tee logs/eive_imputation_20251029_final.log
```

**Total estimated runtime:** ~20-30 minutes (feature build 2-5 min, training 15-20 min, imputation ~15s)

---

## 7. Validation Checks

### After Feature Table Build:

```bash
# Check feature table dimensions
wc -l model_data/inputs/stage2_features/*_corrected_20251029.csv
wc -l model_data/inputs/stage2_features/*_no_eive_20251029.csv

# Verify phylo merges
head -1 model_data/inputs/stage2_features/L_features_11680_corrected_20251029.csv | grep "p_phylo_L"

# Verify cross-axis EIVE removal in no-EIVE tables
head -1 model_data/inputs/stage2_features/L_features_11680_no_eive_20251029.csv | grep -c "EIVEres"
# Should be 0 (all EIVEres columns removed)
```

### After Model Training:

```bash
# Check model files exist
ls -lh model_data/outputs/stage2_xgb/*_corrected_20251029/xgb_*_model.json
ls -lh model_data/outputs/stage2_xgb/*_no_eive_20251029/xgb_*_model.json

# Check CV metrics
for axis in L T M N R; do
    echo "=== ${axis} Full Model ==="
    jq '.r2_mean, .mae_mean' model_data/outputs/stage2_xgb/${axis}_11680_production_corrected_20251029/xgb_${axis}_cv_metrics_kfold.json
    echo "=== ${axis} No-EIVE Model ==="
    jq '.r2_mean, .mae_mean' model_data/outputs/stage2_xgb/${axis}_11680_no_eive_20251029/xgb_${axis}_cv_metrics_kfold.json
done
```

### After Imputation:

```bash
# Check output dimensions
wc -l model_data/outputs/eive_imputed_no_eive_20251029.csv
# Should be 11,681 (header + 11,680 species)

# Verify no missing values
conda run -n AI python -c "
import pandas as pd
df = pd.read_csv('model_data/outputs/eive_imputed_no_eive_20251029.csv')
eive_cols = ['EIVEres-L', 'EIVEres-T', 'EIVEres-M', 'EIVEres-N', 'EIVEres-R']
print('Missing values per axis:')
print(df[eive_cols].isnull().sum())
"

# Check metadata
jq '.total_species, .imputed_species' model_data/outputs/eive_imputation_metadata_20251029.json

# Verify source breakdown
conda run -n AI python -c "
import pandas as pd
df = pd.read_csv('model_data/outputs/eive_imputed_no_eive_20251029.csv')
print('L_source counts:')
print(df['L_source'].value_counts())
"
```

---

## 8. Key Results Summary

### 8.1 Model Training Results

**Full models (WITH cross-axis EIVE):**
| Axis | R² | MAE | Acc±1 | Training N |
|------|-----|-----|-------|-----------|
| L | 0.664 ± 0.024 | 0.654 | 90.4% | 6,165 |
| T | 0.823 ± 0.016 | 0.522 | 94.2% | 6,220 |
| M | 0.704 ± 0.023 | 0.627 | 90.9% | 6,245 |
| N | 0.694 ± 0.026 | 0.810 | 85.3% | 6,000 |
| R | 0.506 ± 0.037 | 0.825 | 83.6% | 6,063 |
| **Avg** | **0.678** | **0.688** | **88.9%** | **6,139** |

**NO-EIVE models (WITHOUT cross-axis EIVE):**
| Axis | R² | MAE | Acc±1 | Δ R² | Training N |
|------|-----|-----|-------|------|-----------|
| L | 0.611 ± 0.022 | 0.704 | 88.4% | -0.053 | 6,165 |
| T | 0.806 ± 0.016 | 0.548 | 93.1% | -0.017 | 6,220 |
| M | 0.649 ± 0.024 | 0.693 | 88.9% | -0.055 | 6,245 |
| N | 0.601 ± 0.038 | 0.934 | 79.8% | -0.093 | 6,000 |
| R | 0.441 ± 0.030 | 0.883 | 81.3% | -0.065 | 6,063 |
| **Avg** | **0.622** | **0.752** | **86.3%** | **-0.057** | **6,139** |

Average 8.8% R² drop without cross-axis EIVE (expected).

**Phylogenetic context:**
| Axis | Training Species | Phylo Tree Tips | Context-Matched Phylo Coverage |
|------|-----------------|-----------------|-------------------------------|
| L | 6,165 | ~5,400 | ~87% |
| T | 6,220 | ~5,400 | ~87% |
| M | 6,245 | ~5,400 | ~87% |
| N | 6,000 | ~5,400 | ~87% |
| R | 6,063 | ~5,400 | ~87% |

### 8.2 Imputation Results

**Input coverage:**
- Total species: 11,680
- Complete-EIVE (5/5 axes): 5,924 (50.7%) → No imputation
- Partial-EIVE (1-4/5 axes): 337 (2.9%) → NO-EIVE models
- Zero-EIVE (0/5 axes): 5,419 (46.4%) → NO-EIVE models
- **Total needing imputation:** 5,756 species (49.3%)

**Imputation results:**
- Total EIVE values imputed: 27,707 (across 5 axes)
- Method: NO-EIVE models (batch processing)
- Runtime: 15.4 seconds
- Final completeness: 100% (0 missing values)

**Per-axis imputation:**
| Axis | Observed | Imputed | Total | Completeness |
|------|----------|---------|-------|--------------|
| L | 6,165 | 5,515 | 11,680 | 100% |
| T | 6,220 | 5,460 | 11,680 | 100% |
| M | 6,245 | 5,435 | 11,680 | 100% |
| N | 6,000 | 5,680 | 11,680 | 100% |
| R | 6,063 | 5,617 | 11,680 | 100% |

**Value ranges (verified):**
| Axis | Range | Mean | Within Scale |
|------|-------|------|--------------|
| L | [0.00, 9.83] | 7.33 | ✓ 0-10 |
| T | [0.00, 10.00] | 5.40 | ✓ 0-10 |
| M | [0.16, 9.38] | 4.02 | ✓ 0-10 |
| N | [0.15, 10.00] | 4.20 | ✓ 0-10 |
| R | [0.33, 10.00] | 6.24 | ✓ 0-10 |

### 8.3 Output Files

**Primary output:**
- `model_data/outputs/eive_imputed_no_eive_20251029.csv` (1.7 MB)
- 11,680 species × 12 columns
- Columns: IDs, 5 EIVE axes, 5 source flags

**Metadata:**
- `model_data/outputs/eive_imputation_metadata_20251029.json`
- Per-axis statistics, timing, missing value patterns

**Models:**
- Full models: `model_data/outputs/stage2_xgb/{axis}_11680_production_corrected_20251029/`
- NO-EIVE models: `model_data/outputs/stage2_xgb/{axis}_11680_no_eive_20251029/`

**Log:**
- `logs/eive_imputation_20251029_final.log`

---

## 9. Technical Considerations and Limitations

### 9.1 Missing Value Handling in Imputation

**Challenge:** Distribution shift between training and imputation species

**Training species (European, WITH EIVE):**
- nitrogen_60_100cm: 2.9% missing
- cec_5_15cm: 0.1% missing
- sand_0_5cm: 0.1% missing
- Dense occurrence data from European range

**Imputation species (non-European, WITHOUT EIVE):**
- nitrogen_60_100cm: **69.5% missing** (24× higher)
- cec_5_15cm: **42.4% missing** (424× higher)
- sand_0_5cm: **42.2% missing** (422× higher)
- Sparse occurrence data outside Europe

**Solution:** XGBoost handles missing values natively via learned default directions

**Impact assessment via SHAP importance:**
- nitrogen_60_100cm ranks 25-255: 0.79% combined importance
- cec_5_15cm ranks 40: 0.29% importance
- sand_0_5cm ranks 92: 0.18% importance
- **Total impact: ~1.3% of model importance**
- **Conclusion:** Negligible performance degradation (~1-2% accuracy loss)

**Observed missingness in imputation targets:**
- Average: 6/722 features (0.9%)
- Maximum: 104/722 features (14.4%)

### 9.2 Simplified Imputation Strategy

**Original plan:** Hybrid approach using both full and NO-EIVE models
- Full models for partial-EIVE species (337 with 1-4 observed axes)
- NO-EIVE models for zero-EIVE species (5,419 with 0 observed axes)

**Challenge:** Feature availability mismatch
- Full models expect cross-axis EIVE features (EIVEres-T, EIVEres-M, etc.)
- Partial-EIVE species have incomplete cross-axis features
- Cannot use full models without all required cross-axis EIVE

**Implemented solution:** NO-EIVE models for ALL imputation (simplified)
- Use NO-EIVE models for both partial-EIVE (337) and zero-EIVE (5,419) species
- Consistent methodology, no feature matching complexity
- Trade-off: 337 partial-EIVE species (~3% of dataset) lose potential cross-axis signal

**Performance impact:** Estimated 5-10% accuracy loss for 337 species only

### 9.3 Alternative Approaches Considered

**Option 1: Retrain models with missing-aware sampling**
- Train on data matching imputation missingness patterns
- Rejected: Low-importance features, not worth retraining

**Option 2: mixgb joint imputation**
- Handles missing predictors natively (like Stage 1 trait imputation)
- Would achieve near-100% coverage with proper missing handling
- Rejected: Different methodology from tuned XGBoost, unnecessary complexity for ~1% impact

**Option 3: Nested imputation**
- First pass: NO-EIVE models for all
- Second pass: Full models for partial-EIVE using first-pass predictions
- Rejected: Additional complexity for 3% of dataset

**Selected approach:** Direct NO-EIVE imputation with XGBoost missing handling
- Leverages existing models and tuned hyperparameters
- Batch processing (15.4s runtime vs 11+ min for one-by-one)
- Acceptable accuracy for low-importance missing features

### 9.4 Quality Assurance

**Verification checks passed:**
- 0 missing values across all 5 axes (100% completeness)
- Value ranges within expected bounds (0-10 EIVE scale)
- Reasonable means: L=7.3, T=5.4, M=4.0, N=4.2, R=6.2
- Source distribution: 50.7% observed, 49.3% imputed

**Model performance (NO-EIVE):**
- Average R²: 0.622 (range 0.441-0.806)
- Average MAE: 0.752
- Average Acc±1: 86.3%
- 8.8% average performance drop vs full models (expected)

### 9.5 Limitations Accepted

1. **Partial-EIVE species:** Conservative imputation without cross-axis signal (3% of dataset)

2. **Distribution shift:** Models trained on dense European data, applied to sparse non-European data
   - Affects only low-importance environmental features (~1% model importance)

3. **No hybrid approach:** Single model type (NO-EIVE) for all imputation
   - Simplicity and consistency prioritized over marginal gains

4. **No model retraining:** Existing models used despite training/imputation missingness discrepancy
   - XGBoost default directions sufficient for low-importance features

**Overall assessment:** Acceptable trade-offs for production use. Imputation quality suitable for downstream gardening recommendation pipeline.

---

## 10. Related Documentation

**Stage 1 inputs:**
- Phylo predictors: `Stage_1/1.9_Phylogenetic_Predictors.md`
- Master tables: `Stage_1/1.10_Modelling_Master_Tables.md`

**Stage 2 outputs:**
- Model paths: `MODEL_PATHS_REFERENCE_20251029.md`
- Tier 2 CV results: `results/summaries/hybrid_axes/phylotraits/Stage_2/tier2_canonical_results_20251029.md`
- Axis summaries: `2.1_L_Axis_XGBoost.md`, `2.2_T_Axis_XGBoost.md`, etc.
- Overview: `2.0_Modelling_Overview.md`

**Note:** All reproduction commands, results, coverage statistics, and technical limitations are documented comprehensively in this file (Sections 3-5, 9).

---

**Status:** COMPLETE - Production models and imputation ready for downstream use
