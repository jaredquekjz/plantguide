# Stage 2.7 — Production CV & Imputation (Canonical)

**Date:** 2025-10-29
**Status:** Canonical execution plan using datasets from Stage 1.9 and 1.10

---

## Overview

This document provides the complete canonical workflow for:

1. **Tier 2 Production CV:** Train full and no-EIVE models on ~6,200 species per axis
2. **Hybrid Imputation:** Impute missing EIVE for 5,756 species using axis-by-axis model selection

**Key principle:** All paths and datasets traced from canonical Stage 1 outputs (1.9 and 1.10)

---

## 1. Input Datasets (From Stage 1.10)

### 1.1 Master Table

**Source:** Stage 1.10 Section 3.2

**File:**
```
model_data/outputs/perm2_production/perm2_11680_complete_final_20251028.parquet
```

**Dimensions:** 11,680 species × 736 features (no phylo predictors yet)

**Contents:**
- Identifiers: wfo_taxon_id, wfo_scientific_name
- Log traits: 100% complete (logLA, logNmass, logLDMC, logSLA, logH, logSM)
- Phylo eigenvectors: 99.6% (phylo_ev1...phylo_ev92)
- EIVE indicators: 52.8% (EIVEres-L/T/M/N/R, observed only)
- Categorical traits: 29-79%
- Environmental quantiles: 100% (624 features: q05/q50/q95/iqr)

**EIVE coverage per axis:**
| Axis | Species with Observed EIVE | Missing EIVE |
|------|---------------------------|--------------|
| L | 6,165 (52.8%) | 5,515 (47.2%) |
| T | 6,220 (53.2%) | 5,460 (46.8%) |
| M | 6,245 (53.5%) | 5,435 (46.5%) |
| N | 6,000 (51.4%) | 5,680 (48.6%) |
| R | 6,063 (51.9%) | 5,617 (48.1%) |

**EIVE missingness patterns:**
- Complete (all 5 axes): 5,924 species (50.7%)
- Partial (1-4 axes): 337 species (2.9%)
- None (0 axes): 5,419 species (46.4%)

---

## 2. Phylogenetic Predictors (From Stage 1.9)

**Source:** Stage 1.9 Section 2

### 2.1 Context-Matched Phylo (Per Axis)

**Why context-matched?** Phylo predictors must be calculated within the same phylogenetic context as training data to avoid predictor collapse.

**Files (to be generated if not present):**
```
model_data/outputs/p_phylo_tier2_cv/p_phylo_L_tier2_cv_20251029.csv  (6,165 species, ~5,400-species tree)
model_data/outputs/p_phylo_tier2_cv/p_phylo_T_tier2_cv_20251029.csv  (6,220 species, ~5,400-species tree)
model_data/outputs/p_phylo_tier2_cv/p_phylo_M_tier2_cv_20251029.csv  (6,245 species, ~5,400-species tree)
model_data/outputs/p_phylo_tier2_cv/p_phylo_N_tier2_cv_20251029.csv  (6,000 species, ~5,400-species tree)
model_data/outputs/p_phylo_tier2_cv/p_phylo_R_tier2_cv_20251029.csv  (6,063 species, ~5,400-species tree)
```

**Calculation script:** `src/Stage_2/calculate_tier2_cv_phylo.R`

**Process (per axis):**
1. Load axis roster (species with observed EIVE)
2. Load EIVE residuals
3. Load full phylogenetic tree (10,977 tips)
4. Prune tree to species with observed EIVE for this axis (→ ~5,400 tips)
5. Calculate phylogenetic distance matrix
6. Apply Shipley leave-one-out weighted averaging (w_ij = 1/d_ij², x_exp=2)
7. Generate p_phylo_{AXIS}

**Coverage:** ~87% per axis (phylo calculated for species in pruned tree)

---

## 3. Feature Table Build (Step-by-Step)

### 3.1 Initial Feature Tables (Without Context-Matched Phylo)

**Script:** `src/Stage_2/build_tier2_features.py`

**Input:** Master table from 1.10
**Output (per axis):**
```
model_data/inputs/stage2_features/L_features_11680_20251029.csv
model_data/inputs/stage2_features/T_features_11680_20251029.csv
model_data/inputs/stage2_features/M_features_11680_20251029.csv
model_data/inputs/stage2_features/N_features_11680_20251029.csv
model_data/inputs/stage2_features/R_features_11680_20251029.csv
```

**Process (per axis):**
1. Load master table
2. Remove target axis EIVE (e.g., remove EIVEres-L for L-axis)
3. Keep other axes' EIVE as cross-axis features
4. Keep all other features (traits, phylo eigenvectors, environment, categorical)
5. Filter to species with observed EIVE for this axis (for training subset identification)
6. Save 11,680 species with all features EXCEPT target axis EIVE

**Execution:**
```bash
conda run -n AI python src/Stage_2/build_tier2_features.py
```

---

### 3.2 Calculate Context-Matched Phylo Predictors

**Script:** `src/Stage_2/calculate_tier2_cv_phylo.R`

**Input:**
- Feature tables from 3.1 (for species rosters)
- EIVE residuals: `model_data/inputs/eive_residuals_by_wfo.csv`
- Phylogenetic tree: `data/phylogeny/mixgb_tree_11676_species_20251027.nwk`

**Output:**
```
model_data/outputs/p_phylo_tier2_cv/p_phylo_L_tier2_cv_20251029.csv
model_data/outputs/p_phylo_tier2_cv/p_phylo_T_tier2_cv_20251029.csv
model_data/outputs/p_phylo_tier2_cv/p_phylo_M_tier2_cv_20251029.csv
model_data/outputs/p_phylo_tier2_cv/p_phylo_N_tier2_cv_20251029.csv
model_data/outputs/p_phylo_tier2_cv/p_phylo_R_tier2_cv_20251029.csv
```

**Execution:**
```bash
env R_LIBS_USER="/home/olier/ellenberg/.Rlib" \
  /usr/bin/Rscript src/Stage_2/calculate_tier2_cv_phylo.R
```

---

### 3.3 Merge Context-Matched Phylo Into Feature Tables

**Script:** `src/Stage_2/update_tier2_features_with_cv_phylo.py`

**Input:**
- Initial feature tables from 3.1
- Context-matched phylo from 3.2

**Output:**
```
model_data/inputs/stage2_features/L_features_11680_corrected_20251029.csv
model_data/inputs/stage2_features/T_features_11680_corrected_20251029.csv
model_data/inputs/stage2_features/M_features_11680_corrected_20251029.csv
model_data/inputs/stage2_features/N_features_11680_corrected_20251029.csv
model_data/inputs/stage2_features/R_features_11680_corrected_20251029.csv
```

**Process (per axis):**
1. Load initial feature table (11,680 species)
2. Load context-matched phylo for this axis
3. Merge on wfo_taxon_id
4. Result: 11,680 species × 741 features (with context-matched p_phylo_{AXIS})

**Execution:**
```bash
conda run -n AI python src/Stage_2/update_tier2_features_with_cv_phylo.py
```

---

### 3.4 Build No-EIVE Feature Tables

**Script:** `src/Stage_2/build_tier2_no_eive_features.py`

**Input:** Corrected feature tables from 3.3

**Output:**
```
model_data/inputs/stage2_features/L_features_11680_no_eive_20251029.csv
model_data/inputs/stage2_features/T_features_11680_no_eive_20251029.csv
model_data/inputs/stage2_features/M_features_11680_no_eive_20251029.csv
model_data/inputs/stage2_features/N_features_11680_no_eive_20251029.csv
model_data/inputs/stage2_features/R_features_11680_no_eive_20251029.csv
```

**Process (per axis):**
1. Load corrected feature table (with context-matched phylo)
2. Remove ALL cross-axis EIVE predictors (EIVEres-L/T/M/N/R for other axes)
3. Keep: traits, phylo eigenvectors, p_phylo_{AXIS}, environment, categorical
4. Result: 11,680 species × 737 features (4 cross-axis EIVE columns removed)

**Purpose:** For imputing species with NO observed EIVE on any axis

**Execution:**
```bash
conda run -n AI python src/Stage_2/build_tier2_no_eive_features.py
```

---

## 4. Model Training

### 4.1 Tier 2 Full Models (WITH Cross-Axis EIVE)

**Script:** `src/Stage_2/run_tier2_production_corrected_all_axes.sh`

**Hyperparameters (from Tier 1 tuning):**
| Axis | Learning Rate | N Estimators | Max Depth |
|------|---------------|--------------|-----------|
| L | 0.03 | 1500 | 6 |
| T | 0.03 | 1500 | 6 |
| M | 0.03 | 5000 | 6 |
| N | 0.03 | 1500 | 6 |
| R | 0.05 | 1500 | 6 |

**Input (per axis):** Corrected feature tables from 3.3

**Training data:** Species with observed EIVE for this axis (~6,200 per axis)

**Output (per axis):**
```
model_data/outputs/stage2_xgb/L_11680_production_corrected_20251029/
├── xgb_L_model.json               # XGBoost model
├── xgb_L_scaler.json              # Z-score standardization parameters
├── xgb_L_cv_metrics_kfold.json    # 10-fold CV performance
├── xgb_L_cv_predictions_kfold.csv # Per-species CV predictions
└── xgb_L_shap_importance.csv      # Feature importance rankings
```

**Expected performance:**
| Axis | R² | MAE | Acc±1 | Top Predictor |
|------|-----|-----|-------|---------------|
| L | 0.664 ± 0.024 | 0.654 | 90.4% | EIVEres-M |
| T | 0.823 ± 0.016 | 0.522 | 94.2% | bio_10_q05 |
| M | 0.704 ± 0.023 | 0.627 | 90.9% | p_phylo_M |
| N | 0.694 ± 0.026 | 0.810 | 85.3% | logLA |
| R | 0.506 ± 0.037 | 0.825 | 83.6% | clay_0_5cm_q50 |

**Phylo predictor ranks:** #1 (M), #3 (L/N/R), #5 (T)

**Execution:**
```bash
bash src/Stage_2/run_tier2_production_corrected_all_axes.sh
```

**Runtime:** ~6-10 minutes (all 5 axes, sequential)

---

### 4.2 Tier 2 No-EIVE Models (WITHOUT Cross-Axis EIVE)

**Script:** `src/Stage_2/run_tier2_no_eive_all_axes.sh`

**Hyperparameters:** Same as full models (from Tier 1)

**Input (per axis):** No-EIVE feature tables from 3.4

**Training data:** Same species as full models (~6,200 per axis with observed EIVE)

**Output (per axis):**
```
model_data/outputs/stage2_xgb/L_11680_no_eive_20251029/
├── xgb_L_model.json
├── xgb_L_scaler.json
├── xgb_L_cv_metrics_kfold.json
├── xgb_L_cv_predictions_kfold.csv
└── xgb_L_shap_importance.csv
```

**Expected performance:**
| Axis | R² | MAE | Acc±1 | Δ R² vs Full | % Drop |
|------|-----|-----|-------|--------------|--------|
| L | 0.615 ± 0.022 | 0.699 | 88.8% | -0.049 | -7.4% |
| T | 0.807 ± 0.018 | 0.545 | 93.4% | -0.016 | -1.9% |
| M | 0.662 ± 0.028 | 0.682 | 89.2% | -0.042 | -6.0% |
| N | 0.618 ± 0.036 | 0.910 | 80.5% | -0.076 | -11.0% |
| R | 0.448 ± 0.030 | 0.879 | 81.5% | -0.058 | -11.5% |

**Execution:**
```bash
bash src/Stage_2/run_tier2_no_eive_all_axes.sh
```

**Runtime:** ~6-10 minutes (all 5 axes, sequential)

---

## 5. Hybrid EIVE Imputation

### 5.1 Imputation Strategy (Axis-by-Axis)

**For EACH axis being imputed:**

1. **Identify species missing EIVE on THIS axis** (from master table)
2. **For each missing species, check EIVE availability on OTHER axes:**
   - **IF** species has observed EIVE on any other axis → use **full model** (WITH cross-axis EIVE)
   - **IF** species has NO observed EIVE on any axis → use **no-EIVE model** (WITHOUT cross-axis EIVE)

**Example:**
- Species A: Has observed T, M → Missing L, N, R
  - L imputation: Full model (uses EIVEres-T, EIVEres-M as cross-axis features)
  - N imputation: Full model (uses EIVEres-T, EIVEres-M as cross-axis features)
  - R imputation: Full model (uses EIVEres-T, EIVEres-M as cross-axis features)

- Species B: No observed EIVE → Missing L, T, M, N, R
  - All 5 axes: Use no-EIVE models (no cross-axis features available)

### 5.2 Imputation Script

**Script:** `src/Stage_2/impute_eive_hybrid.py`

**Inputs:**

**Full feature tables (for species with any EIVE):**
```
model_data/inputs/stage2_features/L_features_11680_corrected_20251029.csv
model_data/inputs/stage2_features/T_features_11680_corrected_20251029.csv
model_data/inputs/stage2_features/M_features_11680_corrected_20251029.csv
model_data/inputs/stage2_features/N_features_11680_corrected_20251029.csv
model_data/inputs/stage2_features/R_features_11680_corrected_20251029.csv
```

**No-EIVE feature tables (for species with no EIVE):**
```
model_data/inputs/stage2_features/L_features_11680_no_eive_20251029.csv
model_data/inputs/stage2_features/T_features_11680_no_eive_20251029.csv
model_data/inputs/stage2_features/M_features_11680_no_eive_20251029.csv
model_data/inputs/stage2_features/N_features_11680_no_eive_20251029.csv
model_data/inputs/stage2_features/R_features_11680_no_eive_20251029.csv
```

**Full models:**
```
model_data/outputs/stage2_xgb/L_11680_production_corrected_20251029/xgb_L_model.json (+ scaler)
model_data/outputs/stage2_xgb/T_11680_production_corrected_20251029/xgb_T_model.json (+ scaler)
model_data/outputs/stage2_xgb/M_11680_production_corrected_20251029/xgb_M_model.json (+ scaler)
model_data/outputs/stage2_xgb/N_11680_production_corrected_20251029/xgb_N_model.json (+ scaler)
model_data/outputs/stage2_xgb/R_11680_production_corrected_20251029/xgb_R_model.json (+ scaler)
```

**No-EIVE models:**
```
model_data/outputs/stage2_xgb/L_11680_no_eive_20251029/xgb_L_model.json (+ scaler)
model_data/outputs/stage2_xgb/T_11680_no_eive_20251029/xgb_T_model.json (+ scaler)
model_data/outputs/stage2_xgb/M_11680_no_eive_20251029/xgb_M_model.json (+ scaler)
model_data/outputs/stage2_xgb/N_11680_no_eive_20251029/xgb_N_model.json (+ scaler)
model_data/outputs/stage2_xgb/R_11680_no_eive_20251029/xgb_R_model.json (+ scaler)
```

**Outputs:**

**Imputed EIVE table:**
```
model_data/outputs/eive_imputed_hybrid_20251029.csv
```

Columns:
- wfo_taxon_id, wfo_scientific_name
- EIVEres-L, EIVEres-T, EIVEres-M, EIVEres-N, EIVEres-R (final values: observed or imputed)
- L_source, T_source, M_source, N_source, R_source ('observed', 'full_model', 'no_eive_model')

**Metadata:**
```
model_data/outputs/eive_imputation_metadata_20251029.json
```

Contains:
- Total species breakdown (complete/partial/none)
- Per-axis imputation counts (full_model vs no_eive_model)
- Model performance summary

**Verification report:**
```
results/verification/eive_hybrid_imputation_20251029.md
```

**Execution:**
```bash
conda run -n AI python src/Stage_2/impute_eive_hybrid.py
```

**Runtime:** ~2-5 minutes (5,756 species × 5 axes = 28,780 predictions)

---

## 6. Canonical Execution Sequence

**Complete workflow from Stage 1 outputs to final imputation:**

```bash
# === PHASE 1: FEATURE TABLE BUILD ===

# 1. Build initial feature tables (without context-matched phylo)
conda run -n AI python src/Stage_2/build_tier2_features.py

# 2. Calculate context-matched phylo predictors (per axis)
env R_LIBS_USER="/home/olier/ellenberg/.Rlib" \
  /usr/bin/Rscript src/Stage_2/calculate_tier2_cv_phylo.R

# 3. Merge context-matched phylo into feature tables
conda run -n AI python src/Stage_2/update_tier2_features_with_cv_phylo.py

# 4. Build no-EIVE feature variants
conda run -n AI python src/Stage_2/build_tier2_no_eive_features.py

# === PHASE 2: MODEL TRAINING ===

# 5. Train full models (WITH cross-axis EIVE)
bash src/Stage_2/run_tier2_production_corrected_all_axes.sh

# 6. Train no-EIVE models (WITHOUT cross-axis EIVE)
bash src/Stage_2/run_tier2_no_eive_all_axes.sh

# === PHASE 3: IMPUTATION ===

# 7. Run hybrid imputation (axis-by-axis model selection)
conda run -n AI python src/Stage_2/impute_eive_hybrid.py
```

**Total estimated runtime:** ~20-30 minutes (feature build 2-5 min, training 12-20 min, imputation 2-5 min)

---

## 7. Validation Checks

### After Feature Table Build:

```bash
# Check feature table dimensions
wc -l model_data/inputs/stage2_features/*_corrected_20251029.csv
wc -l model_data/inputs/stage2_features/*_no_eive_20251029.csv

# Verify phylo merges
head -1 model_data/inputs/stage2_features/L_features_11680_corrected_20251029.csv | grep "p_phylo_L"

# Verify cross-axis EIVE removal in no-EIVE tables
head -1 model_data/inputs/stage2_features/L_features_11680_no_eive_20251029.csv | grep -c "EIVEres"
# Should be 0 (all EIVEres columns removed)
```

### After Model Training:

```bash
# Check model files exist
ls -lh model_data/outputs/stage2_xgb/*_corrected_20251029/xgb_*_model.json
ls -lh model_data/outputs/stage2_xgb/*_no_eive_20251029/xgb_*_model.json

# Check CV metrics
for axis in L T M N R; do
    echo "=== ${axis} Full Model ==="
    jq '.r2_mean, .mae_mean' model_data/outputs/stage2_xgb/${axis}_11680_production_corrected_20251029/xgb_${axis}_cv_metrics_kfold.json
    echo "=== ${axis} No-EIVE Model ==="
    jq '.r2_mean, .mae_mean' model_data/outputs/stage2_xgb/${axis}_11680_no_eive_20251029/xgb_${axis}_cv_metrics_kfold.json
done
```

### After Imputation:

```bash
# Check output dimensions
wc -l model_data/outputs/eive_imputed_hybrid_20251029.csv
# Should be 11,681 (header + 11,680 species)

# Verify no missing values
conda run -n AI python -c "
import pandas as pd
df = pd.read_csv('model_data/outputs/eive_imputed_hybrid_20251029.csv')
eive_cols = ['EIVEres-L', 'EIVEres-T', 'EIVEres-M', 'EIVEres-N', 'EIVEres-R']
print('Missing values per axis:')
print(df[eive_cols].isnull().sum())
"

# Check metadata
jq '.total_species, .imputed_species' model_data/outputs/eive_imputation_metadata_20251029.json
```

---

## 8. Key Results Summary

**Training data per axis:**
| Axis | Species | Tree Tips | Phylo Coverage |
|------|---------|-----------|----------------|
| L | 6,165 | ~5,400 | ~87% |
| T | 6,220 | ~5,400 | ~87% |
| M | 6,245 | ~5,400 | ~87% |
| N | 6,000 | ~5,400 | ~87% |
| R | 6,063 | ~5,400 | ~87% |

**Imputation targets:**
- Total needing imputation: 5,756 species (49.3%)
  - Partial-EIVE (1-4 axes): 337 species (2.9%) → Use full models
  - No-EIVE (0 axes): 5,419 species (46.4%) → Use no-EIVE models

**Final coverage:**
- Complete EIVE dataset: 11,680 species × 5 axes
- 100% completeness (observed + imputed)

---

## 9. Related Documentation

- **Phylo predictors:** `Stage_1/1.9_Phylogenetic_Predictors.md`
- **Master tables:** `Stage_1/1.10_Modelling_Master_Tables.md`
- **Model paths:** `MODEL_PATHS_REFERENCE_20251029.md`
- **Imputation plan:** `PLAN_Hybrid_Imputation_20251029.md`
- **Tier 1 results:** `2.1-2.5` axis summaries
- **Overview:** `2.0_Modelling_Overview.md`

---

**Status:** Ready for canonical execution
