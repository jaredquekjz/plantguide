# Stage 2 — CLM Baseline Alignment with XGBoost

## Purpose
- **Objective**: retain the Shipley-style cumulative link model (CLM) baseline while reusing the updated Stage 2 modelling master deployed for XGBoost.
- **Scope**: axes `L`, `M`, `N` for the 1 084-species shortlist; match species coverage, trait scaling, and QC rules applied in `2.0_Modelling_Overview.md`.
- **Deliverables**: refreshed CLM artefacts (trait-only and trait + phylogeny), verification metrics, and a documented comparison against the new XGBoost runs.

## CLM Feature Assembly
- Source table: `model_data/inputs/modelling_master_20251022.{parquet,csv}` (Stage 2 shortlist with harmonised trait measurements and environmental quantiles).
- Required fields pulled into the CLM build helper:
  - Identifiers: `wfo_taxon_id`, `wfo_scientific_name` (`wfo_accepted_name` alias added for legacy scripts).
  - Raw traits: `Leaf area (mm2)`, `LDMC`, `LMA`/`LMA (g/m2)`, `Diaspore mass (mg)`, `Plant height (m)`.
  - Axis targets: `EIVEres-L`, `EIVEres-M`, `EIVEres-N` (merged from Stage 2 feature tables).
- Growth form data: joined from `artifacts/traits_matched.csv` with a 56-genus override map baked into `src/Stage_2/build_clm_master.py` so every shortlisted taxon obtains `Growth Form`, `Woodiness`, and a categorical `plant_form` (`graminoid`, `herb`, `shrub`, `tree`).
- Output artefact: `model_data/inputs/stage2_clm/clm_master_20251022.csv` (1 084 rows, 15 canonical columns) regenerated via
  ```bash
  conda run -n AI python src/Stage_2/build_clm_master.py
  ```
  and stored alongside the Stage 2 XGBoost feature snapshots.

## CLM Specification
- Response encoding: `ordered(round(axis_*_rank) + 1)` to reproduce 11 ordered categories.
- Predictors:
  - Main effects: `plant_form_factor`, `logLA`, `logLDMC`, `logSLA`, `logSM`.
  - Interactions: all log-trait two-, three-, and four-way combinations, plus trait × plant-form slopes, matching Shipley et al. (2017).
- Phylogenetic smoother: neighbour-weight predictor `phylo_pred` with exponent `x = 2`, recomputed inside each CV training split and z-scored before scoring the hold-out fold.
- Fitting engine: `VGAM::vglm(..., family = cumulative(link = "logit", parallel = TRUE))`.

## Execution Plan
1. **Assemble CLM master table**  
   - Implement `src/Stage_2/build_clm_master.py` (or reuse existing helper) to extract the required columns, drop incomplete species, and export the timestamped CSV under `model_data/inputs/stage2_clm/`.
2. **Run CLM workflow (trait + phylogeny)**  
   - Command:  
     ```bash
     R_LIBS_USER=/home/olier/ellenberg/.Rlib \
     Rscript src/Stage_4_SEM_Analysis/run_clm_trait_phylo.R \
       --axis {L|M|N} \
       --input model_data/inputs/stage2_clm/clm_master_20251022.csv \
       --out_dir artifacts/stage2_clm_trait_phylo_20251022 \
       --folds 10 --repeats 5 --x_grid 2
     ```
   - Expect outputs per axis: CV predictions/metrics, coefficient tables, `phylo_scaling.csv`, `final_model.rds`.
3. **Run trait-only baseline**  
   - Reinvoke with `--no_phylo` and `--out_dir artifacts/stage2_clm_trait_only_20251022` to preserve the comparison from the legacy document.
4. **Verification**  
   - Recalculate MAE/RMSE from CV predictions; ensure ±1/±2 hit rates match `cv_metrics.csv`.
   - Compare R² and hit rates against both the legacy CLM (2025‑09‑20) and the new XGBoost metrics (files `2.1`–`2.5`).
   - Log findings in this document, citing artefact paths and deviations.

## Reporting Checklist
- Summaries of refreshed CLM metrics vs XGBoost per axis (tables mirroring legacy format).
- Notes on species coverage differences (if any), including taxa dropped by the phylogeny step.
- Decision log on whether CLM remains part of Stage 2 canonical comparisons.

## Execution Log — 2025-10-22
- `build_clm_master.py` regenerated `clm_master_20251022.csv`, united Stage 2 targets (`EIVEres-*`) and legacy trait fields, and hard-filled 56 missing growth-form records via genus overrides so all 1 084 shortlist species gained categorical `plant_form` labels.
- Ran `run_clm_trait_phylo.R` for axes `L/M/N` with and without the phylogenetic smoother (`--x_grid 2`, `--no_phylo` variant) writing to `artifacts/stage2_clm_trait_phylo_20251022` and `artifacts/stage2_clm_trait_only_20251022`. All runs now point at `data/phylogeny/eive_try_tree_20251021.nwk`, the tree used in Stage 1.
- Coverage: the updated tree alignment retains all 1 084 species; varietal epithets (e.g., `Pueraria montana var. lobata`) are now preserved so no taxa fall out during CV.

## Metric Summary

| Variant | Axis | Species | MAE | RMSE | ±1 Hit† | ±2 Hit† | R² |
|---------|------|---------|-----|------|---------|---------|-----|
| trait + phylo | L | 1 084 | 0.914 | 1.226 | 79.7 % | 94.2 % | 0.318 |
| trait + phylo | M | 1 084 | 0.931 | 1.246 | 78.9 % | 94.0 % | 0.346 |
| trait + phylo | N | 1 084 | 1.137 | 1.426 | 70.0 % | 91.6 % | 0.417 |
| trait-only | L | 1 084 | 0.951 | 1.271 | 78.5 % | 94.4 % | 0.268 |
| trait-only | M | 1 084 | 1.069 | 1.414 | 74.2 % | 91.3 % | 0.159 |
| trait-only | N | 1 084 | 1.268 | 1.565 | 64.7 % | 89.1 % | 0.298 |

†Hit rates computed after rounding both truth and predictions to the 11-point EIVE rank scale, mirroring the cross-validation reporting in Shipley et al. (2017).

*Metrics computed from `cv_predictions.csv`/`cv_metrics.csv` under each artefact directory. R² calculated from the aggregated cross-validation predictions.*

## Comparison With XGBoost (Stage 2, 2025-10-22 grid; no cross-axis predictors)

| Axis | CLM trait + phylo | XGBoost (no EIVE) | Gap (XGB – CLM) |
|------|--------------------|-------------------|-----------------|
| L | R² = 0.315, ±1 = 79.6 % | R² = 0.613, ±1 = 88.0 % | ΔR² = 0.298, Δ±1 = +8.4 ppt |
| M | R² = 0.346, ±1 = 78.8 % | R² = 0.616, ±1 = 89.0 % | ΔR² = 0.270, Δ±1 = +10.2 ppt |
| N | R² = 0.416, ±1 = 69.6 % | R² = 0.614, ±1 = 80.7 % | ΔR² = 0.198, Δ±1 = +11.1 ppt |

- Even after removing the cross-axis residuals, XGBoost lifts rounded accuracy by 8–11 ppt and adds ~0.2–0.3 R² over the Shipley-style CLM while retaining all 1 084 species.
- Including `EIVEres_*` (main Stage 2 run) pushes R² to 0.64–0.71 and ±1 accuracy to 86–90 %, delivering an additional +0.03–0.10 R² and +5–7 ppt beyond the no-EIVE baseline.

## Notes & Follow-ups
- **Tree alignment**: Keep CLM workflows pointed at `data/phylogeny/eive_try_tree_20251021.nwk` so they stay in lockstep with Stage 1. Varietal epithets are now preserved (`Pueraria montana var. lobata`, etc.), so coverage stays at the full 1 084 species.
- **Species-name sync**: Stage 1 predictors (`p_phylo_*`) already include varietal concepts (`model_data/outputs/p_phylo_ge30_20251021.csv`); the CLM helper now keeps those labels so no taxa are dropped during CV.
- **Documentation**: incorporate these metrics into Stage 2 canonical summaries (legacy vs refreshed) and flag the widened R² delta relative to 2025‑09‑20 (new EIVE residuals plus trait harmonisation).
- **Automation**: keep `src/Stage_2/build_clm_master.py` wired into any future modelling-master refresh so the CLM baseline stays reproducible alongside the Stage 2 XGBoost runs.

## Why XGBoost Pulls Ahead

| Axis | CLM (trait + phylo) R² | XGBoost (no EIVE) R² | ΔR² | ±1 Hit Δ (XGB – CLM) |
|------|------------------------|----------------------|------|-----------------------|
| L | 0.315 | 0.613 | +0.298 | +0.084 (88.0 % vs 79.6 %) |
| M | 0.346 | 0.616 | +0.270 | +0.102 (89.0 % vs 78.8 %) |
| N | 0.416 | 0.614 | +0.198 | +0.111 (80.7 % vs 69.6 %) |

**Drivers of the gap**
- **Feature breadth**: CLM sticks to four log traits plus plant form, mirroring Shipley et al. (2017). XGBoost ingests the full Stage 2 stack—soil chemistry, climate quantiles, agroclimate, phylogeny, cross-axis residuals—so it captures edaphic and climatic gradients absent from the original trait-only specification.
- **Automatic interactions & non-linearity**: Gradient-boosted trees discover high-order splits without enumerating the massive trait×form interaction set the CLM must predefine.
- **Cross-axis signal**: Removing `EIVEres_*` from XGBoost still yields R² ~ 0.61 per axis, but keeping them adds +0.03 to +0.10 R²—information the Shipley CLM design omits by construction.
- **Species coverage**: With the 2025-10-21 tree and preserved varietal labels, CLM predictions now cover the same 1 084 species as XGBoost; earlier runs pegged an old tree and dropped 222 taxa.
- **Prediction resolution**: CLM returns expected ordinal classes which we round, matching the Stage 2 reporting convention and the original paper. XGBoost optimises continuous residuals directly, so MAE/RMSE and rounded accuracy remain tighter.

**Implication for reporting**
- Keep the Shipley-style CLM in view as the historical baseline—especially when referencing Shipley et al. (2017, *Journal of Vegetation Science*, see `papers/mmd/Shipley_et_al-2017-Journal_of_Vegetation_Science.mmd`)—but anchor Stage 2 interpretation on the boosted models. Highlight that the uplift stems from richer soil/climate predictors plus the model’s ability to learn flexible interactions without manual specification.

## Historical Context — Shipley et al. (2017)

Shipley et al. (2017, Table 3) reported that cumulative link models kept **70–90 %** of cross-validated predictions within one Ellenberg rank (axes 1–9) and **≥90 %** within two; exact hits spanned **40–64 %** depending on the axis. To stay comparable we round modern predictions to integer ranks before tabulating accuracy.

| Variant | Axis | Species | MAE | RMSE | ±1 Hit | ±2 Hit | Notes |
|---------|------|---------|-----|------|--------|--------|-------|
| CLM (Shipley et al. 2017, AIC-selected) | L | 972 | ~1.30 | — | 63.7 % | 96.5 % | Table 3 (AIC) |
|  | M | 981 | ~1.80 | — | 45.2 % | 97.4 % | Table 3 (AIC) |
|  | N | 922 | ~1.80 | — | 39.5 % | 90.7 % | Table 3 (AIC) |

*Original Ellenberg axes span nine classes; percentages reproduce Table 3 of Shipley et al. (2017).*
