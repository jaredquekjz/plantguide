# Stage 2.8 — SHAP Feature Category Analysis

**Date:** 2025-10-30
**Purpose:** Aggregate SHAP importance by feature categories for Tier 2 production models

---

## Overview

This analysis aggregates SHAP feature importance values into interpretable categories:

- **Log traits:** logLA, logSLA, logH, logNmass, logLDMC, logSM (6 features)
- **Cross-axis EIVE:** EIVEres-L/T/M/N/R — direct EIVE indicators from other axes
- **Cross-axis phylo:** p_phylo_L/T/M/N/R — EIVE-based phylogenetic predictors from other axes
- **Phylo eigenvectors:** phylo_ev1...phylo_ev92 — non-EIVE phylogenetic structure (92 features)
- **Climate:** WorldClim bioclim + Agroclim variables (252 features)
- **Soil:** SoilGrids + derived soil chemistry/texture (168 features)
- **Categorical traits:** try_* categorical features (7 features)

---

## L-Axis (Light)

### Category Importance

| Rank | Category | Total SHAP | % Importance | # Features | Avg SHAP/Feature |
|------|----------|------------|--------------|------------|------------------|
| 1 | Climate | 0.8962 | 24.8% | 368 | 0.00244 |
| 7 | Soil | 0.8055 | 22.3% | 168 | 0.00479 |
| 2 | Cross-axis EIVE | 0.5323 | 14.7% | 4 | 0.13307 |
| 4 | Log traits | 0.4682 | 13.0% | 6 | 0.07803 |
| 6 | Phylo eigenvectors | 0.4056 | 11.2% | 92 | 0.00441 |
| 3 | Cross-axis phylo | 0.2843 | 7.9% | 5 | 0.05686 |
| 5 | Other | 0.2227 | 6.2% | 88 | 0.00253 |

### Top 5 Features per Category

**Climate (24.8% total):**

1. wc2.1_30s_elev_q05: 0.0933
2. wc2.1_30s_srad_04_q95: 0.0169
3. wc2.1_30s_elev_q50: 0.0157
4. wc2.1_30s_elev_iqr: 0.0120
5. wc2.1_30s_bio_5_q05: 0.0109

**Soil (22.3% total):**

1. soc_0_5cm_q05: 0.0693
2. phh2o_60_100cm_q95: 0.0336
3. phh2o_100_200cm_q95: 0.0262
4. bdod_0_5cm_q95: 0.0212
5. nitrogen_0_5cm_q05: 0.0192

**Cross-axis EIVE (14.7% total):**

1. EIVEres-M: 0.3209
2. EIVEres-N: 0.0894
3. EIVEres-T: 0.0879
4. EIVEres-R: 0.0340

**Log traits (13.0% total):**

1. logSLA: 0.2669
2. logLA: 0.0837
3. logSM: 0.0554
4. logH: 0.0482
5. logNmass: 0.0079

**Phylo eigenvectors (11.2% total):**

1. phylo_ev1: 0.0157
2. phylo_ev15: 0.0141
3. phylo_ev50: 0.0140
4. phylo_ev28: 0.0123
5. phylo_ev17: 0.0119

---

## T-Axis (Temperature)

### Category Importance

| Rank | Category | Total SHAP | % Importance | # Features | Avg SHAP/Feature |
|------|----------|------------|--------------|------------|------------------|
| 1 | Climate | 2.0501 | 59.9% | 368 | 0.00557 |
| 7 | Soil | 0.5241 | 15.3% | 168 | 0.00312 |
| 5 | Other | 0.2396 | 7.0% | 88 | 0.00272 |
| 2 | Cross-axis EIVE | 0.2229 | 6.5% | 4 | 0.05571 |
| 6 | Phylo eigenvectors | 0.1898 | 5.5% | 92 | 0.00206 |
| 3 | Cross-axis phylo | 0.0991 | 2.9% | 5 | 0.01983 |
| 4 | Log traits | 0.0951 | 2.8% | 6 | 0.01585 |

### Top 5 Features per Category

**Climate (59.9% total):**

1. wc2.1_30s_bio_10_q05: 0.3121
2. wc2.1_30s_bio_1_q05: 0.2846
3. wc2.1_30s_bio_10_q50: 0.2476
4. wc2.1_30s_bio_1_q50: 0.0576
5. wc2.1_30s_bio_9_q95: 0.0524

**Soil (15.3% total):**

1. nitrogen_5_15cm_q50: 0.0327
2. soc_5_15cm_q50: 0.0283
3. soc_5_15cm_q05: 0.0143
4. nitrogen_0_5cm_iqr: 0.0136
5. sand_60_100cm_q50: 0.0085

**Other (7.0% total):**

1. CDD_q05: 0.0091
2. WW_q95: 0.0072
3. TG_q50: 0.0071
4. WSDI.1_iqr: 0.0070
5. WW.1_q95: 0.0066

**Cross-axis EIVE (6.5% total):**

1. EIVEres-M: 0.1103
2. EIVEres-L: 0.0429
3. EIVEres-N: 0.0400
4. EIVEres-R: 0.0297

**Phylo eigenvectors (5.5% total):**

1. phylo_ev74: 0.0058
2. phylo_ev82: 0.0043
3. phylo_ev41: 0.0042
4. phylo_ev57: 0.0041
5. phylo_ev92: 0.0034

---

## M-Axis (Moisture)

### Category Importance

| Rank | Category | Total SHAP | % Importance | # Features | Avg SHAP/Feature |
|------|----------|------------|--------------|------------|------------------|
| 7 | Soil | 1.1299 | 30.2% | 168 | 0.00673 |
| 1 | Climate | 0.7871 | 21.0% | 368 | 0.00214 |
| 2 | Cross-axis EIVE | 0.5540 | 14.8% | 4 | 0.13849 |
| 6 | Phylo eigenvectors | 0.4150 | 11.1% | 92 | 0.00451 |
| 3 | Cross-axis phylo | 0.3911 | 10.5% | 5 | 0.07822 |
| 5 | Other | 0.2448 | 6.5% | 88 | 0.00278 |
| 4 | Log traits | 0.2203 | 5.9% | 6 | 0.03672 |

### Top 5 Features per Category

**Soil (30.2% total):**

1. phh2o_0_5cm_q05: 0.1725
2. nitrogen_100_200cm_q95: 0.1069
3. phh2o_5_15cm_q05: 0.0757
4. nitrogen_60_100cm_q95: 0.0408
5. phh2o_0_5cm_q50: 0.0360

**Climate (21.0% total):**

1. wc2.1_30s_elev_q05: 0.0444
2. wc2.1_30s_elev_q50: 0.0191
3. wc2.1_30s_bio_2_q05: 0.0108
4. wc2.1_30s_vapr_11_iqr: 0.0092
5. wc2.1_30s_vapr_07_q50: 0.0088

**Cross-axis EIVE (14.8% total):**

1. EIVEres-N: 0.2746
2. EIVEres-L: 0.1255
3. EIVEres-T: 0.1024
4. EIVEres-R: 0.0514

**Phylo eigenvectors (11.1% total):**

1. phylo_ev45: 0.0165
2. phylo_ev10: 0.0152
3. phylo_ev47: 0.0148
4. phylo_ev49: 0.0133
5. phylo_ev1: 0.0114

**Cross-axis phylo (10.5% total):**

1. p_phylo_M: 0.3528
2. p_phylo_T: 0.0147
3. p_phylo_N: 0.0091
4. p_phylo_R: 0.0077
5. p_phylo_L: 0.0068

---

## N-Axis (Nitrogen)

### Category Importance

| Rank | Category | Total SHAP | % Importance | # Features | Avg SHAP/Feature |
|------|----------|------------|--------------|------------|------------------|
| 1 | Climate | 1.1371 | 24.4% | 368 | 0.00309 |
| 4 | Log traits | 1.0038 | 21.5% | 6 | 0.16729 |
| 2 | Cross-axis EIVE | 0.7522 | 16.1% | 4 | 0.18805 |
| 7 | Soil | 0.7014 | 15.0% | 168 | 0.00417 |
| 6 | Phylo eigenvectors | 0.4330 | 9.3% | 92 | 0.00471 |
| 3 | Cross-axis phylo | 0.3279 | 7.0% | 5 | 0.06558 |
| 5 | Other | 0.3057 | 6.6% | 88 | 0.00347 |

### Top 5 Features per Category

**Climate (24.4% total):**

1. wc2.1_30s_elev_q05: 0.0666
2. wc2.1_30s_elev_q50: 0.0597
3. wc2.1_30s_srad_10_q95: 0.0365
4. wc2.1_30s_elev_q95: 0.0321
5. TXx_q95: 0.0171

**Log traits (21.5% total):**

1. logLA: 0.4580
2. logSLA: 0.1746
3. logNmass: 0.1496
4. logH: 0.1225
5. logLDMC: 0.0711

**Cross-axis EIVE (16.1% total):**

1. EIVEres-M: 0.3947
2. EIVEres-R: 0.2537
3. EIVEres-T: 0.0544
4. EIVEres-L: 0.0494

**Soil (15.0% total):**

1. bdod_30_60cm_q95: 0.0366
2. clay_100_200cm_q95: 0.0357
3. nitrogen_15_30cm_q05: 0.0291
4. clay_30_60cm_q95: 0.0174
5. bdod_15_30cm_q95: 0.0126

**Phylo eigenvectors (9.3% total):**

1. phylo_ev12: 0.0250
2. phylo_ev22: 0.0146
3. phylo_ev9: 0.0120
4. phylo_ev2: 0.0105
5. phylo_ev63: 0.0088

---

## R-Axis (Reaction (pH))

### Category Importance

| Rank | Category | Total SHAP | % Importance | # Features | Avg SHAP/Feature |
|------|----------|------------|--------------|------------|------------------|
| 7 | Soil | 1.3622 | 32.0% | 168 | 0.00811 |
| 1 | Climate | 1.3228 | 31.1% | 368 | 0.00359 |
| 5 | Other | 0.4146 | 9.7% | 88 | 0.00471 |
| 6 | Phylo eigenvectors | 0.4044 | 9.5% | 92 | 0.00440 |
| 2 | Cross-axis EIVE | 0.3982 | 9.4% | 4 | 0.09955 |
| 3 | Cross-axis phylo | 0.1869 | 4.4% | 5 | 0.03738 |
| 4 | Log traits | 0.1690 | 4.0% | 6 | 0.02817 |

### Top 5 Features per Category

**Soil (32.0% total):**

1. clay_0_5cm_q50: 0.2106
2. clay_5_15cm_q50: 0.0898
3. phh2o_30_60cm_q50: 0.0414
4. clay_0_5cm_q05: 0.0369
5. phh2o_5_15cm_q05: 0.0355

**Climate (31.1% total):**

1. wc2.1_30s_bio_19_q95: 0.0503
2. CSDI_q95: 0.0257
3. wc2.1_30s_elev_q05: 0.0227
4. CSDI_q05: 0.0213
5. wc2.1_30s_bio_18_q95: 0.0199

**Other (9.7% total):**

1. WSDI.1_q05: 0.0132
2. WSDI_q05: 0.0129
3. WSDI_q50: 0.0126
4. SDII_q05: 0.0116
5. WSDI.1_q95: 0.0107

**Phylo eigenvectors (9.5% total):**

1. phylo_ev3: 0.0146
2. phylo_ev69: 0.0123
3. phylo_ev64: 0.0098
4. phylo_ev72: 0.0091
5. phylo_ev67: 0.0085

**Cross-axis EIVE (9.4% total):**

1. EIVEres-N: 0.1850
2. EIVEres-M: 0.0978
3. EIVEres-L: 0.0684
4. EIVEres-T: 0.0470

---

## Cross-Axis Category Comparison

### Percentage of Total SHAP Importance by Category

| Category | L | T | M | N | R |
|----------|---|---|---|---|---|
| Log traits | 13.0% | 2.8% | 5.9% | 21.5% | 4.0% |
| Cross-axis EIVE | 14.7% | 6.5% | 14.8% | 16.1% | 9.4% |
| Cross-axis phylo | 7.9% | 2.9% | 10.5% | 7.0% | 4.4% |
| Phylo eigenvectors | 11.2% | 5.5% | 11.1% | 9.3% | 9.5% |
| Climate | 24.8% | 59.9% | 21.0% | 24.4% | 31.1% |
| Soil | 22.3% | 15.3% | 30.2% | 15.0% | 32.0% |
| Categorical traits | 0.0% | 0.0% | 0.0% | 0.0% | 0.0% |

---

## Key Insights

### Category Dominance Patterns

- **L-axis (Light):** Climate dominates (24.8%)
- **T-axis (Temperature):** Climate dominates (59.9%)
- **M-axis (Moisture):** Soil dominates (30.2%)
- **N-axis (Nitrogen):** Climate dominates (24.4%)
- **R-axis (Reaction (pH)):** Soil dominates (32.0%)

### Cross-Axis EIVE Coupling

Cross-axis EIVE predictors capture ecological correlations between axes:

- **L-axis:** 14.7% importance from cross-axis EIVE
- **T-axis:** 6.5% importance from cross-axis EIVE
- **M-axis:** 14.8% importance from cross-axis EIVE
- **N-axis:** 16.1% importance from cross-axis EIVE
- **R-axis:** 9.4% importance from cross-axis EIVE

### Phylogenetic Signal

Phylogenetic predictors (context-matched p_phylo + eigenvectors) reveal evolutionary conservation:

- **L-axis:** 19.1% total phylo signal (p_phylo: 7.9%, eigenvectors: 11.2%)
- **T-axis:** 8.4% total phylo signal (p_phylo: 2.9%, eigenvectors: 5.5%)
- **M-axis:** 21.5% total phylo signal (p_phylo: 10.5%, eigenvectors: 11.1%)
- **N-axis:** 16.3% total phylo signal (p_phylo: 7.0%, eigenvectors: 9.3%)
- **R-axis:** 13.9% total phylo signal (p_phylo: 4.4%, eigenvectors: 9.5%)

---

## Methods

**SHAP aggregation:** Sum of mean absolute SHAP contributions across all features in each category

**Models:** Tier 2 production models (corrected context-matched phylo)
- L: 6,165 species, lr=0.03, trees=1500
- T: 6,220 species, lr=0.03, trees=1500
- M: 6,245 species, lr=0.03, trees=5000
- N: 6,000 species, lr=0.03, trees=1500
- R: 6,063 species, lr=0.05, trees=1500

**Script:** `src/Stage_2/analyze_shap_by_category.py`

**Output files:**
- `results/summaries/hybrid_axes/phylotraits/Stage_2/shap_category_analysis_20251030.csv`
- `results/summaries/hybrid_axes/phylotraits/Stage_2/shap_category_comparison_20251030.csv`

---

**Status:** ✓ COMPLETE