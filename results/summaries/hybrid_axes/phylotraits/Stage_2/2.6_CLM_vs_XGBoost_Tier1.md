# Stage 2.6: CLM vs XGBoost Comparison (Tier 1)

**Date**: 2025-10-29
**Dataset**: 1,084 species (Tier 1 modelling subset)
**Task**: Compare Shipley-style CLM baseline with XGBoost hybrid models

## Summary

This analysis compares two modeling approaches for predicting European plant ecological indicator values (EIVE):

1. **CLM Baseline**: Cumulative link model (ordinal logistic regression) with traits only
2. **XGBoost Hybrid**: Gradient boosting with traits, phylogenetic predictors, and environmental quantiles

Both models use 10-fold cross-validation on the same 1,084-species Tier 1 dataset.

## Model Specifications

### CLM Baseline (Traits-Only)

**Formula structure**:
```
EIVEres-{L,M,N} ~ plant_form + logLA + logLDMC + logSLA + logSM +
                   logLA:logLDMC + logLA:logSLA + logLA:logSM +
                   logLDMC:logSLA + logLDMC:logSM + logSLA:logSM
```

**Features**:
- Plant functional form (4 categories: graminoid, herb, shrub, tree)
- 4 log-transformed traits (leaf area, LDMC, SLA, seed mass)
- 6 pairwise trait interactions

**Total predictors**: ~15 terms (including categorical expansion)

**Method**: VGAM::vglm with cumulative logit link, parallel slopes

**Note**: Original Shipley et al. (2017) specification included 3-way and 4-way interactions, but these caused rank deficiency with 1,084 species. Simplified to main effects + 2-way interactions.

### XGBoost Hybrid (Full Feature Set)

**Features** (741 total):
- Same 4 canonical traits (log-transformed)
- 7 TRY categorical traits (woodiness, growth form, habitat, etc.)
- 92 phylogenetic eigenvectors
- 5 phylogenetic predictors (p_phylo_{L,T,M,N,R}) - context-dependent neighbor EIVE values
- 4 cross-axis EIVE predictors (other axes as features)
- 633 environmental quantiles (WorldClim, soil properties, climate extremes)

**Method**: XGBoost with grid-searched hyperparameters (learning_rate, n_estimators)

## Performance Comparison

### L-Axis (Light)

| Model | R² | MAE | RMSE |
|-------|---------|---------|----------|
| **CLM** | 0.233 ± 0.085 | 1.002 ± 0.056 | 1.331 ± 0.072 |
| **XGBoost** | 0.621 ± 0.050 | 0.694 ± 0.066 | 0.911 ± 0.079 |
| **Improvement** | +166% | -31% | -32% |

### M-Axis (Moisture)

| Model | R² | MAE | RMSE |
|-------|---------|---------|----------|
| **CLM** | 0.111 ± 0.101 | 1.138 ± 0.064 | 1.486 ± 0.090 |
| **XGBoost** | 0.675 ± 0.049 | 0.631 ± 0.052 | 0.881 ± 0.085 |
| **Improvement** | +508% | -45% | -41% |

### N-Axis (Nitrogen)

| Model | R² | MAE | RMSE |
|-------|---------|---------|----------|
| **CLM** | 0.287 ± 0.060 | 1.294 ± 0.057 | 1.601 ± 0.066 |
| **XGBoost** | 0.701 ± 0.030 | 0.792 ± 0.028 | 1.026 ± 0.045 |
| **Improvement** | +144% | -39% | -36% |

### T-Axis (Temperature) and R-Axis (Reaction/pH)

CLM results not available (only L, M, N in original Shipley specification). XGBoost results:

| Axis | R² | MAE | RMSE |
|------|---------|---------|----------|
| **T** | 0.809 ± 0.043 | 0.380 ± 0.036 | 0.575 ± 0.081 |
| **R** | 0.530 ± 0.109 | 0.737 ± 0.042 | 1.004 ± 0.066 |

## Key Findings

### 1. XGBoost Substantially Outperforms CLM

XGBoost achieves 2-6× higher R² across all axes:
- L-axis: 0.621 vs 0.233 (166% improvement)
- M-axis: 0.675 vs 0.111 (508% improvement)
- N-axis: 0.701 vs 0.287 (144% improvement)

MAE and RMSE reduced by 31-45% with XGBoost.

### 2. CLM Baseline Is Weak for M-Axis

The CLM model barely explains moisture variation (R² = 0.111), with high uncertainty (±0.101). This suggests:
- Traits alone have limited predictive power for moisture tolerance
- Environmental context and phylogenetic history are critical

XGBoost achieves R² = 0.675 for M-axis, primarily through environmental quantiles (see Stage 2.3).

### 3. Trait-Only Models Miss Environmental Signal

CLM uses only plant traits, ignoring:
- **Environmental adaptation**: Species distributions reflect climate/soil niches
- **Phylogenetic conservatism**: Related species share ecological strategies
- **Cross-axis dependencies**: EIVE values are correlated (e.g., light-moisture coupling)

XGBoost captures these relationships through:
- 633 environmental quantiles (climate, soil, topography)
- 5 phylogenetic predictors (p_phylo_L/T/M/N/R)
- 4 cross-axis EIVE predictors

### 4. Phylogenetic Predictors Are Critical

In XGBoost SHAP rankings (Stage 2.1-2.5):
- p_phylo_L: Rank #2 for L-axis (SHAP = 0.174)
- p_phylo_M: Rank #1 for M-axis (SHAP = 0.347)
- p_phylo_N: Rank #2 for N-axis (SHAP = 0.322)

These predictors encode phylogenetic niche conservatism: species inherit ecological strategies from ancestors. CLM cannot capture this signal.

### 5. Model Complexity and Overfitting

**CLM**:
- ~15 parameters (simplified from original 30+ due to rank deficiency)
- Linear-additive structure on logit scale
- Minimal overfitting (train-test gap small)
- But severely underfits (R² < 0.3)

**XGBoost**:
- 741 features, 1,500-5,000 trees
- Nonlinear interactions automatically learned
- Regularization prevents overfitting (train-test gap ~0.05)
- High predictive power (R² = 0.53-0.81)

## Methodological Notes

### CLM Rank Deficiency Issue

The original Shipley et al. (2017) CLM specification includes:
- Main effects: 5 terms (plant_form + 4 traits)
- 2-way interactions: 6 trait-trait + 4 form-trait = 10 terms
- 3-way interactions: 4 terms
- 4-way interaction: 1 term

**Total**: ~30 parameters × 10 ordinal categories = 300 coefficients

With 1,084 species, this causes rank deficiency (singular design matrix). We simplified to main effects + 2-way interactions only (~15 terms), but performance remained poor.

### Why XGBoost Works

1. **Automatic feature selection**: Tree splits ignore irrelevant features
2. **Nonlinear interactions**: Captures complex trait-environment-phylogeny couplings
3. **Environmental signal**: WorldClim and soil data encode habitat preferences
4. **Phylogenetic signal**: p_phylo predictors capture niche conservatism
5. **Regularization**: Prevents overfitting despite 741 features

### EIVE Weighting

CLM typically uses EIVE observation weights (L.n, M.n, N.n from mainTable.csv) to account for sample size variation. However, these weights were not found in the CLM master table, so uniform weights were used.

XGBoost does not use EIVE weights - all species contribute equally to training.

## Reproduction

### CLM Baseline

```bash
# Build CLM master table from Tier 1 data
python src/Stage_2/build_clm_master_tier1.py \
  --input model_data/inputs/modelling_master_1084_tier1_20251029.parquet \
  --output model_data/inputs/stage2_clm/clm_master_tier1_20251029.csv \
  --axes L,M,N

# Run CLM for all axes (sequential)
for axis in L M N; do
  Rscript src/Stage_2/run_clm_traits_only.R \
    --axis $axis \
    --input model_data/inputs/stage2_clm/clm_master_tier1_20251029.csv \
    --eive data/EIVE/EIVE_Paper_1.0_SM_08_csv/mainTable.csv \
    --out_dir artifacts/stage2_clm_trait_only_tier1_20251029 \
    --folds 10 \
    --repeats 1 \
    --seed 42
done
```

**Runtime**: ~10 seconds per axis (30 seconds total)

**Outputs**:
- `artifacts/stage2_clm_trait_only_tier1_20251029/{L,M,N}/summary.csv`
- `artifacts/stage2_clm_trait_only_tier1_20251029/{L,M,N}/cv_results.csv`
- `artifacts/stage2_clm_trait_only_tier1_20251029/{L,M,N}/coefficients.csv`

### XGBoost Hybrid

```bash
# Grid search all axes (sequential, 741 features)
bash src/Stage_2/run_tier1_grid_search_all_axes.sh
```

**Runtime**: ~24 minutes total (4-6 minutes per axis)

**Outputs**:
- `model_data/outputs/stage2_xgb/{L,T,M,N,R}_1084_tier1_20251029/xgb_{AXIS}_cv_metrics_kfold.json`
- `model_data/outputs/stage2_xgb/{L,T,M,N,R}_1084_tier1_20251029/xgb_{AXIS}_shap_importance.csv`

## Conclusions

1. **XGBoost is the clear winner**: 2-6× higher R², 31-45% lower error
2. **Traits alone are insufficient**: Environmental and phylogenetic context essential
3. **CLM baseline validates XGBoost gains**: Improvement is not due to overfitting
4. **Phylogenetic predictors critical**: p_phylo consistently ranks in top 3 features
5. **Tier 1 results guide Tier 2 production**: Proceed with XGBoost for 11,680-species predictions

The substantial performance gap demonstrates that ecological indicator values emerge from complex interactions between plant traits, environmental niches, and phylogenetic history - relationships that gradient boosting captures but linear ordinal models cannot.
