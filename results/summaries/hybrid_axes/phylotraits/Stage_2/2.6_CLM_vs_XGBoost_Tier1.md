# Stage 2.6: CLM vs XGBoost Comparison (Tier 1)

**Date**: 2025-10-30 (updated with Shipley replication)
**Dataset**: 1,084 species (Tier 1 modelling subset)
**Task**: Compare Shipley et al. (2017) CLM baseline with XGBoost hybrid models

## Summary

This analysis compares two modeling approaches for predicting European plant ecological indicator values (EIVE):

1. **CLM Baseline**: Cumulative link model using Shipley et al. (2017) specification - traits only
2. **XGBoost Hybrid**: Gradient boosting with traits, phylogenetic predictors, and environmental quantiles

Both models use 10-fold cross-validation on the same 1,084-species Tier 1 dataset.

## Model Specifications

### CLM Baseline (Shipley et al. 2017 Replication)

**Formula** (Table 2 "Simplified Model without Interactions"):
```
EIVEres-{L,M,N} ~ plant_form * (logLA + logLDMC + logSLA + logSM)
```

This allows plant functional type to interact with all traits, giving different trait slopes for each plant type.

**Features**:
- Plant functional form (3 categories: graminoid, herb, tree)
  - Note: Shrubs (n=3) merged with trees due to insufficient sample size
- 4 log-transformed traits (leaf area, LDMC, SLA, seed mass)
- Plant_form × trait interactions (different slopes per plant type)

**Total predictors**: ~17 parameters (3 plant types × 4 traits + 3 plant intercepts + 8 ordinal thresholds)

**Method**: VGAM::vglm with cumulative logit link, parallel slopes
**Package**: VGAM (ordinal::clm encountered numerical instability in our implementation)

### XGBoost Hybrid (Full Feature Set)

**Features** (741 total):
- Same 4 canonical traits (log-transformed)
- 7 TRY categorical traits (woodiness, growth form, habitat, etc.)
- 92 phylogenetic eigenvectors
- 5 phylogenetic predictors (p_phylo_{L,T,M,N,R}) - context-dependent neighbor EIVE values
- 4 cross-axis EIVE predictors (other axes as features)
- 633 environmental quantiles (WorldClim, soil properties, climate extremes)

**Method**: XGBoost with grid-searched hyperparameters (learning_rate, n_estimators)

## Performance Comparison

### L-Axis (Light)

| Model | R² | MAE | RMSE |
|-------|---------|---------|----------|
| **CLM** | 0.233 ± 0.060 | 1.014 ± 0.042 | 1.332 ± 0.053 |
| **XGBoost** | 0.621 ± 0.050 | 0.694 ± 0.066 | 0.911 ± 0.079 |
| **Improvement** | +167% | -32% | -32% |

### M-Axis (Moisture)

| Model | R² | MAE | RMSE |
|-------|---------|---------|----------|
| **CLM** | 0.110 ± 0.088 | 1.122 ± 0.061 | 1.487 ± 0.078 |
| **XGBoost** | 0.675 ± 0.049 | 0.631 ± 0.052 | 0.881 ± 0.085 |
| **Improvement** | +514% | -44% | -41% |

### N-Axis (Nitrogen)

| Model | R² | MAE | RMSE |
|-------|---------|---------|----------|
| **CLM** | 0.298 ± 0.060 | 1.276 ± 0.056 | 1.589 ± 0.067 |
| **XGBoost** | 0.701 ± 0.030 | 0.792 ± 0.028 | 1.026 ± 0.045 |
| **Improvement** | +135% | -38% | -35% |

### T-Axis (Temperature) and R-Axis (Reaction/pH)

CLM results not available (only L, M, N in original Shipley specification). XGBoost results:

| Axis | R² | MAE | RMSE |
|------|---------|---------|----------|
| **T** | 0.809 ± 0.043 | 0.380 ± 0.036 | 0.575 ± 0.081 |
| **R** | 0.530 ± 0.109 | 0.737 ± 0.042 | 1.004 ± 0.066 |

## Key Findings

### 1. XGBoost Substantially Outperforms CLM

XGBoost achieves 1.4-6× higher R² across all axes:
- L-axis: 0.621 vs 0.233 (167% improvement)
- M-axis: 0.675 vs 0.110 (514% improvement)
- N-axis: 0.701 vs 0.298 (135% improvement)

MAE and RMSE reduced by 32-44% with XGBoost.

### 2. CLM Baseline Is Weak for M-Axis

The CLM model barely explains moisture variation (R² = 0.110), with high uncertainty (±0.088). This suggests:
- Traits alone have limited predictive power for moisture tolerance
- Environmental context and phylogenetic history are critical

XGBoost achieves R² = 0.675 for M-axis, primarily through environmental quantiles (see Stage 2.3).

### 3. Trait-Only Models Miss Environmental Signal

CLM uses only plant traits, ignoring:
- **Environmental adaptation**: Species distributions reflect climate/soil niches
- **Phylogenetic conservatism**: Related species share ecological strategies
- **Cross-axis dependencies**: EIVE values are correlated (e.g., light-moisture coupling)

XGBoost captures these relationships through:
- 633 environmental quantiles (climate, soil, topography)
- 5 phylogenetic predictors (p_phylo_L/T/M/N/R)
- 4 cross-axis EIVE predictors

### 4. Phylogenetic Predictors Are Critical

In XGBoost SHAP rankings (Stage 2.1-2.5):
- p_phylo_L: Rank #2 for L-axis (SHAP = 0.174)
- p_phylo_M: Rank #1 for M-axis (SHAP = 0.347)
- p_phylo_N: Rank #2 for N-axis (SHAP = 0.322)

These predictors encode phylogenetic niche conservatism: species inherit ecological strategies from ancestors. CLM cannot capture this signal.

## Methodological Notes

### Shipley et al. (2017) Replication

**Formula**: We replicated Shipley's Table 2 "Simplified Model without Interactions":
```r
axis_y ~ plant_form * (logLA + logLDMC + logSLA + logSM)
```

This model allows trait effects to vary by plant type (graminoid/herb/tree).

**Data adjustment**: Shrubs (n=3) merged with trees due to insufficient sample size for estimating separate interaction terms. This is necessary because the model estimates 4 trait slopes for each plant type, requiring sufficient observations per category.

**Original Shipley sample**:
- Nutrients: 922 species
- Moisture: 988 species
- Light: 981 species

**Our sample**: 1,082-1,084 species (comparable or larger)

**Package choice**: VGAM::vglm used instead of ordinal::clm due to numerical stability. The ordinal package encountered prediction failures during cross-validation in our tests.

### Why XGBoost Works

1. **Environmental features**: 633 climate/soil quantiles encode habitat preferences
   - M-axis improvement from 0.11 → 0.68 primarily attributable to soil moisture variables
2. **Phylogenetic predictors**: p_phylo features capture niche conservatism (top 3 features)
3. **Nonlinear interactions**: Tree-based splits capture complex trait-environment couplings
4. **Automatic feature selection**: Irrelevant features ignored through tree splitting
5. **Regularization**: Prevents overfitting despite 741 features

### EIVE Weighting

CLM and XGBoost both use uniform weights (all species contribute equally to training). EIVE observation weights (L.n, M.n, N.n) were not available in the input data.

## Reproduction

### CLM Baseline (Shipley Replication)

```bash
# Build CLM master table from Tier 1 data
python src/Stage_2/build_clm_master_tier1.py \
  --input model_data/inputs/modelling_master_1084_tier1_20251029.parquet \
  --output model_data/inputs/stage2_clm/clm_master_tier1_20251029.csv \
  --axes L,M,N

# Run Shipley formula CLM for all axes
for axis in L M N; do
  env R_LIBS_USER="/home/olier/ellenberg/.Rlib" \
    /usr/bin/Rscript src/Stage_2/run_clm_shipley_vgam.R \
    --axis $axis \
    --input model_data/inputs/stage2_clm/clm_master_tier1_20251029.csv \
    --eive data/EIVE/EIVE_Paper_1.0_SM_08_csv/mainTable.csv \
    --out_dir artifacts/stage2_clm_shipley_vgam_tier1_20251030 \
    --folds 10 \
    --seed 42
done
```

**Runtime**: ~20 seconds per axis (60 seconds total)

**Outputs**:
- `artifacts/stage2_clm_shipley_vgam_tier1_20251030/{L,M,N}/summary.csv`
- `artifacts/stage2_clm_shipley_vgam_tier1_20251030/{L,M,N}/cv_results.csv`
- `artifacts/stage2_clm_shipley_vgam_tier1_20251030/{L,M,N}/coefficients.csv`

### XGBoost Hybrid

```bash
# Grid search all axes (sequential, 741 features)
bash src/Stage_2/run_tier1_grid_search_all_axes.sh
```

**Runtime**: ~24 minutes total (4-6 minutes per axis)

**Outputs**:
- `model_data/outputs/stage2_xgb/{L,T,M,N,R}_1084_tier1_20251029/xgb_{AXIS}_cv_metrics_kfold.json`
- `model_data/outputs/stage2_xgb/{L,T,M,N,R}_1084_tier1_20251029/xgb_{AXIS}_shap_importance.csv`

## Conclusions

1. **XGBoost is the clear winner**: 1.4-6× higher R², 32-44% lower error
2. **Traits alone are insufficient**: Environmental and phylogenetic context essential
3. **Shipley replication validates findings**: Even with plant_form × trait interactions, CLM achieves R² 0.11-0.30
4. **Phylogenetic predictors critical**: p_phylo consistently ranks in top 3 features across all axes
5. **Environmental signal dominant**: M-axis improvement (0.11 → 0.68) driven by climate/soil features

The substantial performance gap demonstrates that ecological indicator values emerge from complex interactions between plant traits, environmental niches, and phylogenetic history - relationships that gradient boosting captures but linear ordinal models cannot.

**Scientific implication**: Trait-based EIVE prediction requires environmental context and phylogenetic information. Traits alone, regardless of interaction complexity, provide insufficient predictive power.
