# Stage 2.2 — M-Axis (Moisture) XGBoost Tier 1

**Date:** 2025-10-29 (Tier 1 with corrected phylo)  
**Model:** XGBoost with 10-fold CV  
**Dataset:** 1,084 species (Tier 1 hyperparameter tuning)  
**Target:** EIVEres-M (EIVE Moisture indicator)

---

## Performance Snapshot

**Optimal Configuration:**
- Learning rate: 0.03
- Trees: 5000
- Max depth: 6
- GPU: CUDA

**Cross-Validation Metrics (10-fold):**
- R²: 0.675 ± 0.049
- RMSE: 0.881 ± 0.085
- MAE: 0.631 ± 0.052
- Accuracy ±1 rank: 90.1% ± 1.8%
- Accuracy ±2 ranks: 98.0% ± 1.0%

---

## Top 15 SHAP Predictors

| Rank | Feature | SHAP | Category |
|------|---------|------|----------|
| 1 | p_phylo_M ✓ | 0.3473 | Phylogenetic |
| 2 | EIVEres-N | 0.3100 | Cross-axis EIVE |
| 3 | nitrogen_100_200cm_q95 | 0.1659 | Soil |
| 4 | nitrogen_60_100cm_q95 | 0.1065 | Soil |
| 5 | EIVEres-T | 0.1062 | Cross-axis EIVE |
| 6 | EIVEres-L | 0.0739 | Cross-axis EIVE |
| 7 | logSLA | 0.0563 | Functional trait |
| 8 | phh2o_0_5cm_q05 | 0.0397 | Soil |
| 9 | phylo_ev45 | 0.0371 | Phylo eigenvector |
| 10 | soc_30_60cm_q95 | 0.0355 | Soil |
| 11 | logLA | 0.0331 | Functional trait |
| 12 | phh2o_15_30cm_q05 | 0.0320 | Soil |
| 13 | phylo_ev1 | 0.0312 | Phylo eigenvector |
| 14 | nitrogen_15_30cm_q95 | 0.0278 | Soil |
| 15 | nitrogen_60_100cm_iqr | 0.0255 | Soil |

---

## Phylogenetic Predictor Status

**p_phylo_M: RANK #1 (SHAP = 0.3473)**

✓ EXCELLENT - Phylogenetic signal restored

**Context:** This run uses Tier 1 p_phylo calculated on a tree pruned to 1,075 species (matching the modeling population). This context-appropriate phylogenetic predictor captures the phylogenetic signal relevant to the 1,084-species subset used for hyperparameter tuning.

---

## Ecological Interpretation

**Moisture preference prediction** shows:
1. **Strongest phylogenetic signal** (p_phylo_M rank 1!): Moisture tolerance is highly phylogenetically conserved
2. **Moisture-nitrogen coupling** (EIVEres-N rank 2): Strong ecological correlation
3. **Deep soil nitrogen** (nitrogen_100_200cm_q95 rank 3): Water availability linked to nutrient dynamics

The top-ranked phylogenetic predictor indicates that moisture tolerance is one of the most phylogenetically conserved ecological traits.

---

## Files

**Model outputs:** `model_data/outputs/stage2_xgb/M_1084_tier1_20251029/`
- `xgb_M_cv_grid.csv` - Grid search results (9 combinations)
- `xgb_M_cv_metrics.json` - Best configuration metrics  
- `xgb_M_shap_importance.csv` - Feature importance rankings
- `xgb_M_model.json` - Trained model (best config)

**Input data:** `model_data/inputs/stage2_features/M_features_1084_tier1_20251029.csv`

---

## Tier 2 Production CV (6,245 Species)

### Full Model Performance

**Configuration:** Same as Tier 1 (lr=0.03, trees=5000, depth=6)
**Dataset:** 6,245 species with observed M-axis EIVE
**Context-matched phylo:** Calculated on ~5,400-species tree (axis-specific)

**Cross-Validation Metrics (10-fold):**
- R²: 0.704 ± 0.023
- RMSE: 0.860 ± 0.024
- MAE: 0.627 ± 0.012
- Accuracy ±1 rank: 90.9% ± 0.6%
- Accuracy ±2 ranks: 98.3% ± 0.2%

**Location:** `model_data/outputs/stage2_xgb/M_11680_production_corrected_20251029/`

---

### Top 20 SHAP Predictors (Tier 2 Full Model)

| Rank | Feature | SHAP | Category |
|------|---------|------|----------|
| 1 | p_phylo_M ✓ | 0.3528 | Phylogenetic |
| 2 | EIVEres-N | 0.2746 | Cross-axis EIVE |
| 3 | phh2o_0_5cm_q05 | 0.1725 | Soil |
| 4 | EIVEres-L | 0.1255 | Cross-axis EIVE |
| 5 | nitrogen_100_200cm_q95 | 0.1069 | Soil |
| 6 | EIVEres-T | 0.1024 | Cross-axis EIVE |
| 7 | phh2o_5_15cm_q05 | 0.0757 | Soil |
| 8 | logSM | 0.0615 | Functional trait |
| 9 | EIVEres-R | 0.0514 | Cross-axis EIVE |
| 10 | wc2.1_30s_elev_q05 | 0.0444 | Climate |
| 11 | logLDMC | 0.0437 | Functional trait |
| 12 | nitrogen_60_100cm_q95 | 0.0408 | Soil |
| 13 | logSLA | 0.0369 | Functional trait |
| 14 | phh2o_0_5cm_q50 | 0.0360 | Soil |
| 15 | logLA | 0.0325 | Functional trait |
| 16 | logNmass | 0.0236 | Functional trait |
| 17 | logH | 0.0221 | Functional trait |
| 18 | nitrogen_100_200cm_q05 | 0.0201 | Soil |
| 19 | wc2.1_30s_elev_q50 | 0.0191 | Climate |
| 20 | bdod_100_200cm_q05 | 0.0188 | Soil |

**Phylogenetic signal:** p_phylo_M ranks #1 with SHAP=0.3528 (strongest phylogenetic conservation across all axes)

---

### No-EIVE Model Performance

**Purpose:** Imputation for species with no observed EIVE on any axis
**Features excluded:** All 10 EIVE-related predictors (5 direct EIVE + 5 EIVE-based phylo)

**Cross-Validation Metrics (10-fold):**
- R²: 0.649 ± 0.024
- RMSE: 0.937 ± 0.029
- MAE: 0.693 ± 0.020
- Accuracy ±1 rank: 88.9% ± 1.0%
- Accuracy ±2 ranks: 97.7% ± 0.6%

**Performance drop:** -7.8% R² vs full model (moderate loss, lost EIVEres-N #2 predictor)

**Location:** `model_data/outputs/stage2_xgb/M_11680_no_eive_20251029/`

---

### Tier 1 vs Tier 2 Comparison

| Metric | Tier 1 (1,084 sp) | Tier 2 Full (6,245 sp) | Δ |
|--------|------------------|----------------------|---|
| R² | 0.675 ± 0.049 | 0.704 ± 0.023 | +0.029 |
| MAE | 0.660 ± 0.055 | 0.627 ± 0.012 | -0.033 |
| Acc±1 | 90.1% ± 2.8% | 90.9% ± 0.6% | +0.8% |
| p_phylo rank | #1 (0.347) | #1 (0.353) | ✓ Top |

**Generalization:** Tier 2 maintained top phylo rank and improved performance. Moisture prediction strongly phylogenetically conserved.

---

## Next Steps

**Hybrid M-Axis Imputation (axis-by-axis):**

For species missing M-axis EIVE:
- **Full model:** Species with observed EIVE on any other axis (L, T, N, or R) → can leverage cross-axis features
- **No-EIVE model:** Species with no observed EIVE on any axis → no cross-axis features available

**Total M-axis imputation targets:** Species from the 5,756 needing at least one axis, specifically those missing M

**Note:** The 6,245 training species already have observed M-axis EIVE and do not need imputation.

**See:** `/home/olier/ellenberg/results/summaries/phylotraits/Stage_2/2.0_Modelling_Overview.md` Section 3.4 for complete axis-by-axis imputation strategy.

---

**Status:** ✓ TIER 1 & TIER 2 COMPLETED
**Hyperparameters:** OPTIMIZED and deployed
