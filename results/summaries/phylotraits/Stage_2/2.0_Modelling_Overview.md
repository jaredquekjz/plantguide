# Stage 2 — XGBoost Modelling Overview

**Date:** 2025-10-29 (updated for context-matched phylo predictors)
**Status:** Two-tier modeling with context-specific phylogenetic predictors

---

## ⚠️ CRITICAL: Context-Matched Phylo Predictors Required

**XGBoost models MUST use context-matched phylo predictors (NOT the 11,680-species production phylo).**

**Three phylo predictor contexts:**

1. **11,680 production phylo (10,977-species tree):**
   - File: `model_data/outputs/p_phylo_11680_20251028.csv`
   - **NOT used for modeling** - causes predictor collapse (ranks #45-#149)

2. **Tier 1 phylo (1,075-species tree):**
   - File: `model_data/outputs/p_phylo_1084_tier1_20251029.csv`
   - **Used for**: Tier 1 hyperparameter tuning (1,084 species)
   - Coverage: 1,075 / 1,084 species (99.2%)

3. **Tier 2 CV phylo (axis-specific ~5,400-species trees):**
   - Files:
     - `model_data/outputs/p_phylo_tier2_cv/p_phylo_L_tier2_cv_20251029.csv`
     - `model_data/outputs/p_phylo_tier2_cv/p_phylo_T_tier2_cv_20251029.csv`
     - `model_data/outputs/p_phylo_tier2_cv/p_phylo_M_tier2_cv_20251029.csv`
     - `model_data/outputs/p_phylo_tier2_cv/p_phylo_N_tier2_cv_20251029.csv`
     - `model_data/outputs/p_phylo_tier2_cv/p_phylo_R_tier2_cv_20251029.csv`
   - **Used for**: Tier 2 production CV (~6,200 species per axis)
   - Coverage: ~87.2% per axis

**Result:** Using context-matched phylo restored predictor importance (M #1, L/N #3, R #3, T #5).

**Documentation:** See `RESOLUTION_phylo_context_issue_20251029.md` (Tier 1) and `RESOLUTION_phylo_context_tier2_20251029.md` (Tier 2).

---

### Key Stage 2 XGBoost Scripts

- `src/Stage_2/xgb_kfold.py` — training driver for Tier 1 grid search and Tier 2 production CV (handles folds, logging, model export).
- `src/Stage_2/build_tier2_features.py` / `src/Stage_2/build_tier2_no_eive_features.py` — assemble production feature tables with and without cross-axis EIVE columns.
- `src/Stage_2/calculate_tier2_cv_phylo.R` + `src/Stage_2/update_tier2_features_with_cv_phylo.py` — generate and merge context-matched phylogenetic predictors for each axis.
- `src/Stage_2/impute_eive_no_eive_only.py` — production imputation (current baseline for 11,680 species).
- `src/Stage_2/impute_eive_hybrid.py` — optional hybrid route (full models for partial-EIVE species, no-EIVE models otherwise).
- `src/Stage_2/analyze_shap_by_category.py` — SHAP-based post-hoc interpretation.

---

## 1. Purpose

**Objective:** Predict EIVE axis values (T, M, L, N, R) from traits, environment, and phylogenetic features using XGBoost

**Two-tier approach with context-matched phylo:**
1. **Tier 1 (1,084 species):** Hyperparameter tuning using 1,075-species phylo context
2. **Tier 2 (~6,200 per axis):** Production CV using axis-specific phylo contexts

**Model family:** XGBoost regressors only
**Validation:** 10-fold CV with shuffled species (no LOSO, no spatial blocks)

---

## 2. Input Datasets (Stage 1.10 Outputs)

### 2.1 Tier 1: Modelling Shortlist (1,084 species)

**Purpose:** Hyperparameter tuning (fast iteration, robust GBIF coverage)

**File:**
```
model_data/inputs/modelling_master_1084_20251029.parquet
model_data/inputs/modelling_master_1084_20251029.csv
```

**Dimensions:** 1,084 species × 741 features

**Coverage:**
| Feature Group | Coverage |
|--------------|----------|
| Traits (log) | 100% (1,084 / 1,084) |
| Phylo eigenvectors | 99.6% (1,078 / 1,084) |
| Phylo predictors (p_phylo) | 94.7% (1,026 / 1,084) |
| EIVE indicators | ~83% (900 / 1,084) |
| Environmental quantiles (full) | 100% (1,084 / 1,084) |
| Categorical traits | 29-79% |

**Selection criteria:**
- GBIF ≥30 georeferenced occurrences
- Median GBIF: 4,370 occurrences
- Strong environmental data extraction

**Documentation:** See `1.10_Modelling_Master_Table.md` Section 2.2

---

### 2.2 Tier 2: Full Production (11,680 species)

**Purpose:** Encyclopedia-scale EIVE prediction (apply optimal config from tier 1)

**File:**
```
model_data/outputs/perm2_production/perm2_11680_complete_final_20251028.csv
model_data/outputs/perm2_production/perm2_11680_complete_final_20251028.parquet
```

**Dimensions:** 11,680 species × 741 features (identical feature set to 1,084)

**Coverage:**
| Feature Group | Coverage |
|--------------|----------|
| Traits (log) | 100% (11,680 / 11,680) |
| Phylo eigenvectors | 99.6% (11,638 / 11,680) |
| Phylo predictors (p_phylo) | 94.0% (10,977 / 11,680) |
| EIVE indicators | 52.8% (6,165 / 11,680) |
| Environmental quantiles (full) | 100% (11,680 / 11,680) |
| Categorical traits | 29-79% |

**Prediction target:**
- 5,515 species (47.2%) lack observed EIVE → predict from traits + environment + phylogeny

**Use cases:**
- Pan-European trait database production
- Maximum coverage for rare/under-sampled species
- Phylogenetic comparative methods

**Documentation:** See `1.10_Modelling_Master_Table.md` Section 2.1

---

### 2.3 Unified Feature Inventory (741 features)

| Feature Group | Count | Description |
|--------------|-------|-------------|
| **Identifiers** | 2 | wfo_taxon_id, wfo_scientific_name |
| **Log traits** | 6 | logLA, logNmass, logLDMC, logSLA, logH, logSM |
| **Phylo eigenvectors** | 92 | phylo_ev1...phylo_ev92 (PCoA on VCV matrix) |
| **EIVE indicators** | 5 | EIVEres-L/T/M/N/R (observed values) |
| **Phylo predictors** | 5 | p_phylo_T/M/L/N/R (Shipley formula) |
| **Categorical traits** | 7 | woodiness, growth_form, habitat, leaf, phenology, pathway, mycorrhiza |
| **Environmental quantiles** | 624 | WorldClim (252) + SoilGrids (168) + Agroclim (204) — q05/q50/q95/iqr for 156 vars |
| **TOTAL** | **741** | Same features across both tiers |

**Categorical trait names:**
- `try_woodiness` (6 levels)
- `try_growth_form` (27 levels)
- `try_habitat_adaptation` (5 levels)
- `try_leaf_type` (6 levels)
- `try_leaf_phenology` (3 levels)
- `try_photosynthesis_pathway` (5 levels)
- `try_mycorrhiza_type` (6 levels)

**Environmental quantiles rationale:**

Full quantiles (q05, q50, q95, iqr) included despite Perm 4 rejection for Stage 1 trait imputation:

- **Stage 1 result:** Perm 4 (full quantiles) was 1.2% worse than Perm 2 (q50 only) for trait imputation with 3.29× longer runtime
- **Stage 2 hypothesis:** EIVE indicators represent environmental adaptation — variability features may capture:
  - Ecological plasticity (wide tolerance ranges)
  - Extreme environment adaptation (cold hardiness, drought resistance)
  - Niche breadth complementary to median conditions
- **Flexibility:** Models can test with/without variability features to determine if they improve EIVE prediction
- **Cost:** Storage overhead acceptable for final production datasets

See `1.10_Modelling_Master_Table.md` Section 4.1 for full analysis.

---

## 3. Two-Tier Modeling Workflow

### 3.1 Tier 1: Hyperparameter Tuning (1,084 species)

**Purpose:** Find optimal XGBoost configuration per axis using grid search

**Dataset:** 1,084 species with GBIF ≥30 + 1,075-species context-matched phylo

**Grid search parameters:**
- Learning rates: 3 values (0.03, 0.05, 0.08)
- Tree counts: 3 values (1500, 3000, 5000)
- **Total:** 9 combinations per axis

**Fixed parameters:**
- `max_depth=6`, `subsample=0.8`, `colsample_bytree=0.8`

**Selection criteria:** Highest mean R² across 10 folds

**Runtime:** ~24 minutes (all 5 axes, 45 models total)

**Status:** ✓ COMPLETED (2025-10-29)

**Results:**
| Axis | Optimal Config | R² | Acc±1 | Phylo Rank |
|------|----------------|-----|-------|-----------|
| L | lr=0.03, trees=1500 | 0.621 ± 0.050 | 88.0% | #2 (SHAP=0.174) |
| T | lr=0.03, trees=1500 | 0.809 ± 0.043 | 97.0% | #19 (SHAP=0.016) |
| M | lr=0.03, trees=5000 | 0.675 ± 0.049 | 90.1% | #1 (SHAP=0.347) |
| N | lr=0.03, trees=1500 | 0.701 ± 0.030 | 84.5% | #2 (SHAP=0.322) |
| R | lr=0.05, trees=1500 | 0.530 ± 0.109 | 86.3% | #6 (SHAP=0.065) |

**Documentation:** See `results/verification/xgboost_tier1_corrected_phylo_20251029.md`

---

### 3.2 Tier 2: Production CV (~6,200 species per axis)

**Purpose:** Validate performance at production scale using axis-specific context-matched phylo

**Dataset:** ~6,200 species per axis (those with observed EIVE) + axis-specific phylo (~5,400-species trees)

**Hyperparameters:** Use Tier 1 optimal configs (no grid search)

**Runtime:** ~6 minutes (all 5 axes, sequential)

**Status:** ✓ COMPLETED (2025-10-29)

**Results (Full Models with Cross-Axis EIVE):**
| Axis | N (species) | R² | Acc±1 | Phylo Rank | Top Predictor |
|------|-------------|-----|-------|-----------|---------------|
| L | 6,165 | 0.664 ± 0.024 | 90.4% | #3 (SHAP=0.251) | EIVEres-M |
| T | 6,220 | 0.823 ± 0.016 | 94.2% | #5 (SHAP=0.077) | bio_10_q05 |
| M | 6,245 | 0.704 ± 0.023 | 90.9% | #1 (SHAP=0.353) | p_phylo_M |
| N | 6,000 | 0.694 ± 0.026 | 85.3% | #3 (SHAP=0.290) | logLA |
| R | 6,063 | 0.506 ± 0.037 | 83.6% | #3 (SHAP=0.149) | clay_0_5cm_q50 |

**Key Achievement:** Context-matched phylo restored predictor importance (M #1, L/N/R #3, T #5)

**Documentation:** See `results/verification/tier2_production_corrected_full_summary_20251029.md`

**Output directories:**
- `model_data/outputs/stage2_xgb/{L,T,M,N,R}_11680_production_corrected_20251029/`

---

### 3.3 Two-Model Hybrid Strategy (For Imputation)

**Problem:** 49.3% of species (5,756 / 11,680) lack EIVE on at least one axis and need imputation. The challenge: 5,419 species have NO observed EIVE on any axis → cannot use cross-axis EIVE features.

**Solution:** Train two sets of models for each axis. Apply axis-by-axis based on EIVE availability.

#### Model Set 1: Full Models (WITH cross-axis EIVE)
- **Training:** ~6,200 species with observed EIVE on THIS axis
- **Features:** All predictors including cross-axis EIVE (e.g., EIVEres-M for predicting L)
- **Use for imputing this axis:** Species missing EIVE on THIS axis BUT having observed EIVE on OTHER axes
  - Can leverage cross-axis EIVE information
  - Example: Species with observed T,M → use full model to impute L (leverages EIVEres-T, EIVEres-M)
- **Status:** ✓ COMPLETED (same as Tier 2 production CV)
- **Performance:** R² 0.506-0.823

#### Model Set 2: No-EIVE Models (WITHOUT cross-axis EIVE)
- **Training:** Same ~6,200 species with observed EIVE on THIS axis
- **Features:** Exclude ALL cross-axis EIVE predictors (EIVEres-L/T/M/N/R removed)
  - Keep: p_phylo, traits, soil, climate, phylo eigenvectors
- **Use for imputing this axis:** Species missing EIVE on ALL axes (no cross-axis features available)
  - Example: Species with no observed EIVE → use no-EIVE model to impute all 5 axes
- **Status:** ✓ COMPLETED (2025-10-29)
- **Performance:** R² 0.441-0.806 (avg -8.8% vs full models)
- **Runtime:** ~6 minutes (all 5 axes)

**Performance Comparison:**
| Axis | Full R² | No-EIVE R² | Δ R² | % Drop | Notes |
|------|---------|------------|------|--------|-------|
| L | 0.664 | 0.611 | -0.053 | -8.0% | Lost EIVEres-M (#1 predictor) |
| T | 0.823 | 0.806 | -0.017 | -2.1% | Minimal loss (climate-driven) |
| M | 0.704 | 0.649 | -0.055 | -7.8% | Lost EIVEres-N (#2 predictor) |
| N | 0.694 | 0.601 | -0.093 | -13.4% | Lost EIVEres-M (#2 predictor) |
| R | 0.506 | 0.441 | -0.065 | -12.8% | Lost EIVEres-N (#2 predictor) |

**Key Insight:** No-EIVE models lose 2-13% of cross-axis EIVE importance but remain scientifically valid (R² 0.441-0.806) for species lacking all observed EIVE.

**Documentation:** See `results/verification/full_vs_no_eive_comparison_20251029.csv`

**Output directories:**
- **Full models:** `model_data/outputs/stage2_xgb/{L,T,M,N,R}_11680_production_corrected_20251029/`
- **No-EIVE models:** `model_data/outputs/stage2_xgb/{L,T,M,N,R}_11680_no_eive_20251029/`

---

### 3.4 Imputation Strategy (Axis-by-Axis)

**Apply appropriate model per axis based on species EIVE availability:**

| Species EIVE Pattern | Count | Imputation Strategy |
|---------------------|-------|---------------------|
| Complete (all 5 axes) | 5,924 (50.7%) | None needed - all EIVE observed |
| Partial (1-4 axes) | 337 (2.9%) | For each missing axis: use **full model** (can leverage observed EIVE from other axes as cross-axis features) |
| None (0 axes) | 5,419 (46.4%) | For all 5 axes: use **no-EIVE models** (no cross-axis features available) |

**Example: Species with observed T and M only:**
- L imputation: Full model (uses EIVEres-T, EIVEres-M as cross-axis features)
- N imputation: Full model (uses EIVEres-T, EIVEres-M as cross-axis features)
- R imputation: Full model (uses EIVEres-T, EIVEres-M as cross-axis features)

**Example: Species with no observed EIVE:**
- L, T, M, N, R imputation: All use no-EIVE models (no cross-axis features available)

**Total imputation targets:** 5,756 species (337 + 5,419) requiring at least one axis

**Note:** The ~6,200 training species per axis do NOT need imputation for THAT axis - they already have observed values.

**Next step:** Implement hybrid imputation script `src/Stage_2/impute_eive_hybrid.py`

---
## 4. Completed Scripts

### 4.1 Tier 1: Grid Search Script

**Script:** `src/Stage_2/run_tier1_grid_search_all_axes.sh`

**Features:**
- Sequential execution of all 5 axes
- Context-matched phylo (1,075-species tree)
- Progress tracking and status files
- Phylo rank sanity checks

**Runtime:** 24 minutes total (all 5 axes, 45 models)

**Logs:** `logs/tier1_grid_search_20251029.log`

---

### 4.2 Tier 2: Production CV Scripts

#### Full Models (WITH cross-axis EIVE)

**Script:** `src/Stage_2/run_tier2_production_all_axes_corrected.sh`

**Features:**
- Corrected feature tables with axis-specific phylo
- Sequential execution of all 5 axes
- Uses Tier 1 optimal hyperparameters
- Real-time progress indicators

**Runtime:** 6 minutes total (all 5 axes)

**Logs:** `logs/tier2_production_corrected_20251029.log`

**Feature Builder:** `src/Stage_2/build_tier2_features.py`
**Phylo Calculator:** `src/Stage_2/calculate_tier2_cv_phylo.R`
**Phylo Updater:** `src/Stage_2/update_tier2_features_with_cv_phylo.py`

#### No-EIVE Models (WITHOUT cross-axis EIVE)

**Script:** `src/Stage_2/run_tier2_no_eive_all_axes.sh`

**Features:**
- Exclude all cross-axis EIVE predictors
- Same training data as full models (~6,200 per axis)
- Same optimal hyperparameters from Tier 1
- Quantifies performance loss without EIVE coupling

**Runtime:** 6 minutes total (all 5 axes)

**Logs:** `logs/tier2_no_eive_20251029.log`

**Feature Builder:** `src/Stage_2/build_tier2_no_eive_features.py`

---

## 5. Output Files Structure

### 5.1 Tier 1 Grid Search (1,084 species)

**Location:** `model_data/outputs/stage2_xgb/{L,T,M,N,R}_1084_tier1_20251029/`

**Files per axis:**
- `xgb_{AXIS}_model.json` — Best model (optimal config)
- `xgb_{AXIS}_scaler.json` — Z-score parameters
- `xgb_{AXIS}_cv_grid.csv` — All 9 combinations ranked by R²
- `xgb_{AXIS}_cv_metrics_kfold.json` — Performance metrics (best config)
- `xgb_{AXIS}_cv_predictions_kfold.csv` — Row-level predictions
- `xgb_{AXIS}_shap_importance.csv` — Feature importance rankings

---

### 5.2 Tier 2 Full Models (~6,200 species)

**Location:** `model_data/outputs/stage2_xgb/{L,T,M,N,R}_11680_production_corrected_20251029/`

**Files per axis:**
- `xgb_{AXIS}_model.json` — Production model (full features)
- `xgb_{AXIS}_scaler.json` — Z-score parameters
- `xgb_{AXIS}_cv_metrics_kfold.json` — Performance metrics
- `xgb_{AXIS}_cv_predictions_kfold.csv` — Row-level predictions
- `xgb_{AXIS}_shap_importance.csv` — Feature importance rankings

---

### 5.3 Tier 2 No-EIVE Models (~6,200 species)

**Location:** `model_data/outputs/stage2_xgb/{L,T,M,N,R}_11680_no_eive_20251029/`

**Files per axis:**
- `xgb_{AXIS}_model.json` — No-EIVE model (no cross-axis EIVE)
- `xgb_{AXIS}_scaler.json` — Z-score parameters
- `xgb_{AXIS}_cv_metrics_kfold.json` — Performance metrics
- `xgb_{AXIS}_cv_predictions_kfold.csv` — Row-level predictions
- `xgb_{AXIS}_shap_importance.csv` — Feature importance rankings

---

## 6. Key Results Summary

### 6.1 Phylogenetic Predictor Restoration

**Problem Resolved:** Context-matched phylo predictors restored importance across all axes

**Tier 2 Production (Full Models):**
| Axis | p_phylo Rank | SHAP Value | Status |
|------|--------------|------------|--------|
| M | #1 | 0.353 | ✓ Top predictor |
| L | #3 | 0.251 | ✓ Top 3 |
| N | #3 | 0.290 | ✓ Top 3 |
| R | #3 | 0.149 | ✓ Top 3 |
| T | #5 | 0.077 | ✓ Strong signal |

**Documentation:**
- Tier 1 results: `results/verification/xgboost_tier1_corrected_phylo_20251029.md`
- Tier 2 results: `results/verification/tier2_production_corrected_full_summary_20251029.md`

---

### 6.2 Two-Model Performance Comparison

**Performance trade-off quantified:**

| Axis | Full R² | No-EIVE R² | Performance Drop | Interpretative Note |
|------|---------|------------|------------------|---------------------|
| L | 0.664 | 0.611 | -8.0% | Moderate (lost EIVEres-M top predictor) |
| T | 0.823 | 0.806 | -2.1% | Minimal (climate-dominated) |
| M | 0.704 | 0.649 | -7.8% | Moderate (lost EIVEres-N) |
| N | 0.694 | 0.601 | -13.4% | Largest (lost EIVEres-M #2) |
| R | 0.506 | 0.441 | -12.8% | Large (lost EIVEres-N #2) |

**Average drop:** 8.8% R² without cross-axis EIVE coupling

**Scientific validity:** All no-EIVE models achieve R² > 0.44, suitable for imputation of species lacking all observed EIVE

**Documentation:** `results/verification/full_vs_no_eive_comparison_20251029.csv`

---

## 7. Axis-Specific Documentation

Detailed per-axis results available in:

- **2.1_L_Axis_XGBoost.md** — Light axis results (Tier 1 corrected phylo)
- **2.2_T_Axis_XGBoost.md** — Temperature axis results (Tier 1 corrected phylo)
- **2.3_M_Axis_XGBoost.md** — Moisture axis results (Tier 1 corrected phylo)
- **2.4_N_Axis_XGBoost.md** — Nitrogen axis results (Tier 1 corrected phylo)
- **2.5_R_Axis_XGBoost.md** — Reaction/pH axis results (Tier 1 corrected phylo)

**Status:** All axis summaries updated with Tier 1 corrected phylo results (2025-10-29)

---

## 8. Next Steps

### 8.1 Hybrid EIVE Imputation (Pending)

**Objective:** Predict missing EIVE for 5,756 species using appropriate models

**Implementation:**

| Species Pattern | Count | Model Selection | Script |
|----------------|-------|-----------------|--------|
| Complete EIVE (5 axes) | 5,924 (50.7%) | None (already observed) | - |
| Partial EIVE (1-4 axes) | 337 (2.9%) | Full models | `impute_eive_hybrid.py` |
| No EIVE (0 axes) | 5,419 (46.4%) | No-EIVE models | `impute_eive_hybrid.py` |

**Expected output:**
- Complete EIVE dataset (11,680 species × 5 axes)
- Prediction uncertainty estimates (CV-based)
- Provenance flags (observed vs imputed)

**Planning document:** `2.7_Production_CV_and_Imputation_Plan.md`

---

### 8.2 Performance Validation

**Compare Tier 1 vs Tier 2:**
- Generalization assessment (1,084 → 6,200 species)
- Phylo signal consistency across tiers
- Feature importance stability

**Compare Full vs No-EIVE:**
- Cross-axis EIVE contribution quantification
- Prediction uncertainty for no-EIVE species
- Guidance for future data collection priorities

---

### 8.3 Production Deployment

**Final models for Stage 3 (gardening recommendations):**
- Select appropriate model based on species EIVE pattern
- Apply uncertainty thresholds for prediction confidence
- Flag predictions requiring expert review

---

## 9. References

**Completed work:**
1. **Stage 1.9** — Phylogenetic Predictor & Verification (context issue identified)
2. **Stage 1.10** — Modelling Master Table (three phylo contexts documented)
3. **RESOLUTION_phylo_context_issue_20251029.md** — Tier 1 phylo fix
4. **RESOLUTION_phylo_context_tier2_20251029.md** — Tier 2 phylo fix

**Verification reports:**
1. `results/verification/xgboost_tier1_corrected_phylo_20251029.md`
2. `results/verification/tier2_production_corrected_full_summary_20251029.md`
3. `results/verification/full_vs_no_eive_comparison_20251029.csv`

**Scripts:**
1. `src/Stage_2/run_tier1_grid_search_all_axes.sh`
2. `src/Stage_2/run_tier2_production_all_axes_corrected.sh`
3. `src/Stage_2/run_tier2_no_eive_all_axes.sh`
4. `src/Stage_2/calculate_tier2_cv_phylo.R`
5. `src/Stage_2/update_tier2_features_with_cv_phylo.py`

---

**Document Status:** ✓ UPDATED (2025-10-29)
**Phylo Predictors:** ✓ CORRECTED (context-matched)
**Tier 1:** ✓ COMPLETED (1,084 species)
**Tier 2 Full Models:** ✓ COMPLETED (~6,200 per axis)
**Tier 2 No-EIVE Models:** ✓ COMPLETED (~6,200 per axis)
**Next:** Hybrid EIVE imputation for 5,756 species
