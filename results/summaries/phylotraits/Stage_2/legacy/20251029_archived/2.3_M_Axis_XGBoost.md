# Stage 2 — M Axis XGBoost (2025-10-22)

## Performance Snapshot
- **Cross-validation**: 10-fold shuffled species (`strategy = "kfold"`).
- **R²**: 0.653 ± 0.079.
- **RMSE**: 0.891 ± 0.092 (axis units).
- **MAE**: 0.638 ± 0.058.
- **Accuracy (±1 rank)**: 89.9 %.
- **Accuracy (±2 ranks)**: 97.8 %.
- **Selected hyperparameters**: `learning_rate = 0.03`, `n_estimators = 1 500`.

> Outputs written to `model_data/outputs/stage2_xgb/M_20251022/`; metrics stored in `xgb_M_cv_metrics.json`.

## Data & Command
- **Feature table**: `model_data/inputs/stage2_features/M_features_20251022.csv` (1 084 species).
  - Same canonical trait stack used for the L/T runs; only `sla_mm2_mg` represents leaf-economics information.
  - Joined against `eive_residuals_by_wfo.parquet` to append `EIVEres_T/L/N/R`.
  - Target renamed to `y` (former `EIVEres_M`); species name carried in `wfo_scientific_name`.
- **Runner**: `src/Stage_2/xgb_kfold.py` (GPU).

```bash
conda run -n AI --no-capture-output python src/Stage_2/xgb_kfold.py \
  --features_csv model_data/inputs/stage2_features/M_features_20251022.csv \
  --axis M \
  --target_column y \
  --species_column wfo_scientific_name \
  --out_dir model_data/outputs/stage2_xgb/M_20251022 \
  --cv_folds 10 \
  --gpu true \
  --learning_rates 0.03,0.05,0.08 \
  --n_estimators_grid 1500,3000,5000 \
  --pd_vars logLA,logLDMC,logSLA,logSM,logH,p_phylo_M \
  --pd_pairs logLDMC:wc2_1_30s_bio_12_q50,logSM:wc2_1_30s_bio_4_q50
```

## Top 15 Predictors (SHAP Mean | `xgb_M_shap_importance.csv`)

| Rank | Feature | Mean | Block |
|------|---------|------|-------|
| 1 | `p_phylo_M` | 0.391 | Phylogeny |
| 2 | `EIVEres_N` | 0.291 | EIVE cross-axis |
| 3 | `nitrogen_100_200cm_q95` | 0.158 | Soil nitrogen (100–200 cm q95) |
| 4 | `nitrogen_60_100cm_q95` | 0.127 | Soil nitrogen (60–100 cm q95) |
| 5 | `EIVEres_T` | 0.087 | EIVE cross-axis |
| 6 | `EIVEres_L` | 0.087 | EIVE cross-axis |
| 7 | `sla_mm2_mg` | 0.059 | Trait (canonical SLA) |
| 8 | `phh2o_15_30cm_q05` | 0.043 | Soil pH (15–30 cm q05) |
| 9 | `nitrogen_15_30cm_q95` | 0.042 | Soil nitrogen (15–30 cm q95) |
|10 | `soc_60_100cm_q95` | 0.035 | Soil organic carbon (60–100 cm q95) |
|11 | `leaf_area_mm2` | 0.034 | Trait (leaf area) |
|12 | `soc_100_200cm_q95` | 0.034 | Soil organic carbon (100–200 cm q95) |
|13 | `phh2o_0_5cm_q05` | 0.031 | Soil pH (0–5 cm q05) |
|14 | `WW_q50` | 0.030 | Agroclim (wet days median) |
|15 | `nitrogen_30_60cm_q95` | 0.030 | Soil nitrogen (30–60 cm q95) |

## Model Observations
- **Phylogeny first**: `p_phylo_M` contributes nearly 40 % of the explanatory power, echoing Bill Shipley’s emphasis on lineage-weighted residuals for the M axis.
- **Deep-soil chemistry**: Nitrogen and organic carbon quantiles from 60–200 cm dominate, indicating that rooting-zone nutrient reserves closely track the M-axis signal.
- **Cross-axis reliance**: Retaining `EIVEres_T/L/N` boosts R² by ~0.044 versus the no-EIVE model and stabilises rank accuracy.
- **Traits as modifiers**: Canonical SLA and leaf area retain influence but sit behind the edaphic/phylogenetic terms; no provenance or duplicate SLA columns leak in.
- **Hydrology and extremes**: `phh2o_*` and the wet-day index (`WW_q50`) suggest moisture availability tempers the nutrient-driven trends.
- **Residual review**: Residual σ ≈ 0.895; 17 species exceed 3σ and are logged in `xgb_M_cv_predictions_kfold.csv` for Stage 1 feedback.

### Verification notes (2025-10-22)
- Confirmed the feature CSV excludes `leaf_area_n`, legacy LMA/SLA, and all `_source` columns; `sla_mm2_mg` remains the single SLA predictor.
- Grid search ran to completion; `xgb_M_cv_grid.csv` shows the 0.03 / 1 500 pair as the top mean-R² combo.
- Independent recompute of MAE/RMSE from `xgb_M_cv_predictions_kfold.csv` matches JSON metrics within rounding tolerance; ±1/±2 accuracy derived from rounded residual classes.
- Partial-dependence exports include both requested 2-D plots with the corrected underscore column names.
- `wc2_1_30s_bio_17_*` columns were dropped (all-NA) as in other axes; noted in the run log.

## Comparison — no other EIVE axes
- **Inputs**: `model_data/inputs/stage2_features/M_features_noEIVE_20251022.csv`.
- **Outputs**: `model_data/outputs/stage2_xgb/M_noEIVE_20251022/`.
- **Cross-validation**: 10-fold; best `learning_rate = 0.05`, `n_estimators = 5 000`.
- **R² / RMSE / MAE**: 0.609 ± 0.079 / 0.950 ± 0.104 / 0.703 ± 0.071.
- **Accuracy (±1 / ±2 ranks)**: 89.0 % / 97.4 %.

### Top 15 predictors (no EIVE axes)

| Rank | Feature | Mean | Block |
|------|---------|------|-------|
| 1 | `p_phylo_M` | 0.424 | Phylogeny |
| 2 | `nitrogen_100_200cm_q95` | 0.156 | Soil nitrogen (100–200 cm q95) |
| 3 | `nitrogen_60_100cm_q95` | 0.133 | Soil nitrogen (60–100 cm q95) |
| 4 | `sla_mm2_mg` | 0.109 | Trait (canonical SLA) |
| 5 | `leaf_area_mm2` | 0.087 | Trait (leaf area) |
| 6 | `try_height` | 0.054 | Trait (height) |
| 7 | `soc_60_100cm_q95` | 0.048 | Soil organic carbon (60–100 cm q95) |
| 8 | `nitrogen_15_30cm_q95` | 0.046 | Soil nitrogen (15–30 cm q95) |
| 9 | `phh2o_15_30cm_q05` | 0.046 | Soil pH (15–30 cm q05) |
|10 | `try_logLA` | 0.043 | Trait (log leaf area) |
|11 | `soc_100_200cm_q95` | 0.033 | Soil organic carbon (100–200 cm q95) |
|12 | `try_ldmc` | 0.032 | Trait (LDMC) |
|13 | `phh2o_30_60cm_q50` | 0.031 | Soil pH (30–60 cm q50) |
|14 | `wc2_1_30s_elev_q05` | 0.027 | Climate (elevation q05) |
|15 | `nitrogen_5_15cm_iqr` | 0.026 | Soil nitrogen variability (5–15 cm) |

**Impact of removing cross-axis predictors**
- R² drops by ≈ 0.044 and MAE increases by ~0.065, revealing that `EIVEres_T/L/N` still capture complementary ecological structure for M.
- Trait variables (SLA, leaf area, height) rise sharply once cross-axis cues vanish, confirming that the full model shares variance between phylogeny, deep nutrients, and residual axes.

### Clustered significance (≥25th percentile SHAP mean)
- Threshold ≈ 0.0011; 427 of 569 predictors retained (covering 97.3 % of overall SHAP mass).

| Cluster | SHAP sum | % of retained | % of total |
|---------|----------|---------------|------------|
| Soil nutrients | 0.7375 | 24.6 | 23.9 |
| Phylogeny | 0.4692 | 15.7 | 15.2 |
| Agroclimate | 0.3940 | 13.2 | 12.8 |
| Traits | 0.3873 | 12.9 | 12.6 |
| Soil pH | 0.2437 | 8.1 | 7.9 |
| Soil texture | 0.1986 | 6.6 | 6.4 |
| Climate precipitation | 0.1388 | 4.6 | 4.5 |
| Climate temperature | 0.1209 | 4.0 | 3.9 |
| Solar radiation | 0.1204 | 4.0 | 3.9 |
| Climate humidity | 0.0847 | 2.8 | 2.7 |
| Topography | 0.0512 | 1.7 | 1.7 |
| Other | 0.0497 | 1.7 | 1.6 |

### Ecological interpretation
- **Metabolic theory fit**: Deep soil nutrients (~24 %) and agroclimatic wet-day frequency (~13 %) suggest the M axis is responsive to resource fluxes that fuel metabolic turnover—aligning with expectations that fast metabolism requires nitrogen- and carbon-rich substrates plus reliable moisture.
- **Phylogeny + traits**: With ~29 % combined contribution, phylogenetic weights and canonical traits confirm that metabolic strategies remain lineage-tied and trait-mediated (SLA, leaf area, height), echoing the Leaf Economics Spectrum’s metabolic dimension.
- **Moisture chemistry coupling**: Soil pH and texture (~15 %) alongside humidity (~3 %) highlight how oxygen availability and water retention regulate metabolic function—consistent with ecohydrological constraints.
- **No anomalies**: The cluster ordering (nutrients > phylogeny/traits > hydroclimate) is coherent with theory. Solar radiation’s modest share (~4 %) reflects its secondary role once nutrient and moisture regimes are considered.

## Artefacts
- Metrics & residuals: `xgb_M_cv_metrics.json`, `xgb_M_cv_predictions_kfold.csv`.
- Interpretation: `xgb_M_shap_importance.csv`, `xgb_M_pd1_*`, `xgb_M_pd2_*`.
- Model bundle: `xgb_M_model.json`, `xgb_M_scaler.json`.
