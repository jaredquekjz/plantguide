# Stage 2 — R Axis XGBoost (2025-10-22)

## Performance Snapshot
- **Cross-validation**: 10-fold shuffled species (`strategy = "kfold"`).
- **R²**: 0.582 ± 0.082.
- **RMSE**: 0.943 ± 0.108 (axis units).
- **MAE**: 0.696 ± 0.067.
- **Accuracy (±1 rank)**: 87.8 %.
- **Accuracy (±2 ranks)**: 97.5 %.
- **Selected hyperparameters**: `learning_rate = 0.03`, `n_estimators = 5 000`.

> Outputs saved under `model_data/outputs/stage2_xgb/R_20251022/`; metrics in `xgb_R_cv_metrics.json`.

## Data & Command
- **Feature table**: `model_data/inputs/stage2_features/R_features_20251022.csv` (1 084 species).
  - Canonical SLA only; provenance counts (`leaf_area_n`) and duplicate SLA/LMA columns removed.
  - Cross-axis residuals appended from `eive_residuals_by_wfo.parquet`.
  - Target column renamed to `y` (former `EIVEres_R`); species name field `wfo_scientific_name`.
- **Runner**: `src/Stage_2/xgb_kfold.py` (GPU).

```bash
conda run -n AI --no-capture-output python src/Stage_2/xgb_kfold.py \
  --features_csv model_data/inputs/stage2_features/R_features_20251022.csv \
  --axis R \
  --target_column y \
  --species_column wfo_scientific_name \
  --out_dir model_data/outputs/stage2_xgb/R_20251022 \
  --cv_folds 10 \
  --gpu true \
  --learning_rates 0.03,0.05,0.08 \
  --n_estimators_grid 1500,3000,5000 \
  --pd_vars logLA,logLDMC,logSLA,logSM,logH,p_phylo_R \
  --pd_pairs logLDMC:wc2_1_30s_bio_12_q50,logSM:wc2_1_30s_bio_4_q50
```

## Top 15 Predictors (SHAP Mean | `xgb_R_shap_importance.csv`)

| Rank | Feature | Mean | Block |
|------|---------|------|-------|
| 1 | `clay_0_5cm_q50` | 0.182 | Soil texture (clay, 0–5 cm q50) |
| 2 | `clay_0_5cm_q95` | 0.167 | Soil texture (clay, 0–5 cm q95) |
| 3 | `EIVEres_N` | 0.148 | EIVE cross-axis |
| 4 | `clay_15_30cm_q50` | 0.118 | Soil texture (clay, 15–30 cm q50) |
| 5 | `p_phylo_R` | 0.118 | Phylogeny |
| 6 | `phh2o_30_60cm_q50` | 0.060 | Soil pH (30–60 cm q50) |
| 7 | `wc2_1_30s_bio_19_q95` | 0.042 | Climate (BIO19 q95 — precipitation coldest quarter) |
| 8 | `clay_5_15cm_q50` | 0.042 | Soil texture (clay, 5–15 cm q50) |
| 9 | `clay_60_100cm_q05` | 0.033 | Soil texture (clay, 60–100 cm q05) |
|10 | `phh2o_5_15cm_q05` | 0.032 | Soil pH (5–15 cm q05) |
|11 | `phh2o_15_30cm_q95` | 0.032 | Soil pH (15–30 cm q95) |
|12 | `EIVEres_M` | 0.032 | EIVE cross-axis |
|13 | `sand_5_15cm_q50` | 0.030 | Soil texture (sand, 5–15 cm q50) |
|14 | `EIVEres_L` | 0.030 | EIVE cross-axis |
|15 | `phh2o_0_5cm_q95` | 0.030 | Soil pH (0–5 cm q95) |

## Model Observations
- **Edaphic dominance**: Clay fractions and soil pH across 0–60 cm explain the majority of variance—consistent with reproductive strategies being tied to soil structure.
- **Cross-axis support**: `EIVEres_N/M/L` provide secondary lifts, raising R² by ~0.040 compared with the no-EIVE run.
- **Phylogenetic weight**: `p_phylo_R` is the fifth-ranked predictor, indicating lineage context aids reproductive residual estimates even with strong soil signals.
- **Climate moderation**: BIO19 (cold-season precipitation) slips into the top 10, indicating moisture pulses still modulate the axis.
- **Residual diagnostics**: Residual σ ≈ 0.950; 12 species exceed 3σ, flagged in `xgb_R_cv_predictions_kfold.csv` for downstream review.

### Verification notes (2025-10-22)
- Feature matrix inspected: canonical SLA only, no provenance or `_source` columns, consistent with Stage 1 trait policy.
- Grid search table (`xgb_R_cv_grid.csv`) confirms 0.03 / 5 000 as best combo; run log records the same.
- MAE/RMSE recomputed from `xgb_R_cv_predictions_kfold.csv` match the JSON summary; rank-accuracy uses rounded EIVE classes.
- Requested PD surfaces (`xgb_R_pd2_*`) produced successfully with corrected underscore names.
- As with other axes, `wc2_1_30s_bio_17_*` columns dropped due to all-NA values in the shortlist.

## Comparison — no other EIVE axes
- **Inputs**: `model_data/inputs/stage2_features/R_features_noEIVE_20251022.csv`.
- **Outputs**: `model_data/outputs/stage2_xgb/R_noEIVE_20251022/`.
- **Cross-validation**: 10-fold; best `learning_rate = 0.03`, `n_estimators = 1 500`.
- **R² / RMSE / MAE**: 0.542 ± 0.093 / 0.987 ± 0.126 / 0.731 ± 0.080.
- **Accuracy (±1 / ±2 ranks)**: 87.2 % / 96.9 %.

### Top 15 predictors (no EIVE axes)

| Rank | Feature | Mean | Block |
|------|---------|------|-------|
| 1 | `clay_0_5cm_q50` | 0.199 | Soil texture (clay, 0–5 cm q50) |
| 2 | `clay_0_5cm_q95` | 0.170 | Soil texture (clay, 0–5 cm q95) |
| 3 | `p_phylo_R` | 0.135 | Phylogeny |
| 4 | `clay_15_30cm_q50` | 0.121 | Soil texture (clay, 15–30 cm q50) |
| 5 | `phh2o_30_60cm_q50` | 0.059 | Soil pH (30–60 cm q50) |
| 6 | `wc2_1_30s_bio_19_q95` | 0.049 | Climate (BIO19 q95) |
| 7 | `phh2o_100_200cm_q05` | 0.048 | Soil pH (100–200 cm q05) |
| 8 | `phh2o_15_30cm_q95` | 0.047 | Soil pH (15–30 cm q95) |
| 9 | `clay_5_15cm_q50` | 0.040 | Soil texture (clay, 5–15 cm q50) |
|10 | `phh2o_5_15cm_q05` | 0.035 | Soil pH (5–15 cm q05) |
|11 | `try_logLA` | 0.034 | Trait (log leaf area) |
|12 | `sand_5_15cm_q50` | 0.031 | Soil texture (sand, 5–15 cm q50) |
|13 | `phh2o_0_5cm_q95` | 0.029 | Soil pH (0–5 cm q95) |
|14 | `clay_100_200cm_q05` | 0.028 | Soil texture (clay, 100–200 cm q05) |
|15 | `nitrogen_100_200cm_q95` | 0.023 | Soil nitrogen (100–200 cm q95) |

**Impact of removing cross-axis predictors**
- R² drops by ~0.040 and MAE climbs by ~0.035—less dramatic than the N axis, but still material. Soil descriptors remain dominant, while phylogeny grows relatively in importance.
- Trait variables stay largely absent from the top ranks even without cross-axis residuals, underscoring the soil-centric nature of R for this shortlist.

### Clustered significance (≥25th percentile SHAP mean)
- Threshold ≈ 0.0012; 427 of 569 predictors retained (covering 96.3 % of overall SHAP mass).

| Cluster | SHAP sum | % of retained | % of total |
|---------|----------|---------------|------------|
| Soil texture | 0.8648 | 30.9 | 29.8 |
| Agroclimate | 0.5144 | 18.4 | 17.7 |
| Soil pH | 0.3568 | 12.8 | 12.3 |
| Soil nutrients | 0.2596 | 9.3 | 8.9 |
| Climate precipitation | 0.1685 | 6.0 | 5.8 |
| Phylogeny | 0.1681 | 6.0 | 5.8 |
| Solar radiation | 0.1219 | 4.4 | 4.2 |
| Climate temperature | 0.1187 | 4.2 | 4.1 |
| Traits | 0.1164 | 4.2 | 4.0 |
| Climate humidity | 0.0632 | 2.3 | 2.2 |
| Topography | 0.0297 | 1.1 | 1.0 |
| Other | 0.0143 | 0.5 | 0.5 |

### Ecological interpretation
- **Soil structure primacy**: Texture and pH clusters together account for ~44 % of retained SHAP, aligning with the expectation that reproductive strategies hinge on rooting environment, seed-bed stability, and water retention.
- **Disturbance and seasonality**: Agroclimate metrics (~18 %) and precipitation (~6 %) track disturbance frequency (e.g., intense rain events) that shape regenerative niches—consistent with CSR theory where reproductive allocation adapts to disturbance regimes.
- **Lineage and traits**: Phylogeny plus traits (~10 %) indicate that reproductive axes retain evolutionary signature, but only after edaphic and disturbance cues are satisfied; this mirrors observations that reproductive syndromes are conserved yet environmentally tuned.
- **No surprises**: The dominance of soil factors is expected for R; the modest humidity and radiation shares reinforce, rather than contradict, eco-theory by highlighting their role in flowering phenology without overshadowing edaphic filters.

## Artefacts
- Metrics & residuals: `xgb_R_cv_metrics.json`, `xgb_R_cv_predictions_kfold.csv`.
- Interpretation: `xgb_R_shap_importance.csv`, `xgb_R_pd1_*`, `xgb_R_pd2_*`.
- Model bundle: `xgb_R_model.json`, `xgb_R_scaler.json`.
