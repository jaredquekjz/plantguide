# 4.0 Taxonomic Vernacular Labelling - Implementation Summary

**Objective:** Assign gardener-friendly category labels to animal genera using LLM reasoning over multilingual vernacular names.

**Status:** IN PROGRESS - Kimi AI production run active (Rate: ~92 req/min, ETA: ~57 min)

**Date:** 2025-11-16

---

## Overview

Two-phase approach:
1. **Phase 1 (Complete):** iNaturalist-based multilingual vernaculars for all taxa (75.2% coverage)
2. **Phase 2 (In Progress):** Kimi AI gardener-friendly labels for animal genera

---

## Phase 1: iNaturalist Multilingual Vernaculars

**Status:** COMPLETE

**Coverage:** 75.2% overall (31,396 / 41,738 taxa)
- Plants: 89.1% (10,598 / 11,892 species)
- Animals: 69.7% (20,798 / 29,846 organisms)

**Pipeline location:** `/home/olier/ellenberg/shipley_checks/src/Stage_4/taxonomy/`

**Run complete pipeline:**
```bash
cd /home/olier/ellenberg/shipley_checks/src/Stage_4/taxonomy

env R_LIBS_USER="/home/olier/ellenberg/.Rlib" \
  /usr/bin/Rscript run_complete_pipeline.R
```

**Output:** `data/taxonomy/all_taxa_vernacular_final.parquet` (41,738 taxa, 12 language columns)

**Time:** ~49 seconds

**See detailed documentation:** Phase 1 implementation in previous version of this file.

---

## Phase 2: Kimi AI Gardener-Friendly Labels

### Why Vector Embeddings Failed

Initial approach using vector similarity (KaLM-Embedding-Gemma3-12B-2511) achieved only **45-50% accuracy** due to compound name confusion:

**Problem:** Vectors cannot parse compositional structure
- "duckweed weevil" → "duckweeds" ✗ (should be "weevils")
- "sugar maple borer" → "maples" ✗ (should be "beetles")
- "fruit bat" → "fruits" ✗ (should be "bats")

**Root cause:** Vector embeddings match entire string to nearest category, cannot understand "[HOST/HABITAT] + [ORGANISM TYPE]" patterns.

### LLM Solution: Kimi AI

**Why LLMs succeed:**
- Parse compound names ("duckweed weevil" = weevil ON duckweed)
- Biological knowledge ("skipper" = butterfly, "borer" = beetle)
- Multi-language reasoning (English + Chinese for context)

**Validation:** 100% accuracy (15/15) on compound name test set vs 46.7% (7/15) for vectors

---

## Current Pipeline Architecture

```
Step 1: Aggregate Vernaculars by Genus
  ├─ 01_aggregate_inat_by_genus.R → English vernaculars (5,066 animal genera)
  └─ 01b_aggregate_inat_chinese.R → Chinese vernaculars (4,286 animal genera)

Step 2: Pre-filter to Animals with Vernaculars
  └─ 00_prefilter_animals_only.py → 5,409 unique animal genera
       ├─ Filter: Metazoa kingdom only
       ├─ Has English OR Chinese vernaculars
       └─ One unique genus per row

Step 3: Kimi API Labeling (IN PROGRESS)
  └─ 06_kimi_gardener_labels.py → kimi_gardener_labels.csv
       ├─ Sequential processing (200 RPM rate limit)
       ├─ Consolidated prompt (40 standard categories + fallback)
       ├─ Kingdom filter (prevent plant name contamination)
       └─ Incremental CSV output every 50 genera
```

---

## Data Contamination Fix

**Issue discovered:** Vernacular aggregations included BOTH animal AND plant rows for homonymous genera (e.g., "Chloris" = bird genus AND grass genus).

**Example before fix:**
- Chloris (bird) got 43 grass vernaculars → labeled "Grasses" ✗
- Lomatia (bee fly) got 15 plant vernaculars → labeled "Plants" ✗

**Solution:** Filter vernacular aggregations to `kingdom='Animalia'` when loading.

**Affected genera:** 25 homonyms now get correct animal vernaculars.

---

## Kimi AI Consolidated Prompt

**Design:** 40 standard gardening categories + fallback for edge cases

```
STANDARD CATEGORIES:
- Moths, Beetles, Butterflies, Flies, Wasps, Bees, Bugs
- Ants, Aphids, Leafhoppers, Spiders, Scales, Grasshoppers
- Thrips, Mites, Snails, Dragonflies, Lacewings, Birds, Bats
- Millipedes, Centipedes, Springtails, Nematodes, Earwigs
- Termites, Cockroaches, Mantises, Stick insects, Lice, Fleas
- Ticks, Psyllids, Planthoppers, Treehoppers, Cicadas
- Spittlebugs, Barklice

FALLBACK: If organism doesn't fit standard categories,
output appropriate generic category (e.g., "Crabs", "Snakes", "Fish")

RULES:
- Output ONLY the category name
- Always use plural form
- Focus on organism TYPE, not specific names or host plants
```

**Advantages:**
- Consolidates specific subcategories (e.g., "Weevils" → "Beetles")
- Reduces label fragmentation (273 unique labels → ~40 core categories)
- Maintains flexibility via fallback for rare organisms

---

## Reproduction Commands

### Complete Pipeline (from scratch)

**Location:** `/home/olier/ellenberg/`

**Step 1: Aggregate English vernaculars**
```bash
cd /home/olier/ellenberg

env R_LIBS_USER="/home/olier/ellenberg/.Rlib" \
  /usr/bin/Rscript src/Stage_4/taxonomy/nlp/01_aggregate_inat_by_genus.R
```

**Output:** `data/taxonomy/genus_vernacular_aggregations.parquet`
- 7,648 genera total (animals + plants)
- Grouped by genus AND kingdom (prevents homonym mixing)

**Step 2: Aggregate Chinese vernaculars**
```bash
env R_LIBS_USER="/home/olier/ellenberg/.Rlib" \
  /usr/bin/Rscript src/Stage_4/taxonomy/nlp/01b_aggregate_inat_chinese.R
```

**Output:** `data/taxonomy/genus_vernacular_aggregations_chinese.parquet`
- 6,841 genera with Chinese vernaculars (zh, zh-CN, zh-TW, zh-HK)

**Step 3: Pre-filter to animal genera with vernaculars**
```bash
/home/olier/miniconda3/envs/AI/bin/python \
  src/Stage_4/taxonomy/nlp/00_prefilter_animals_only.py
```

**Output:** `data/taxonomy/animal_genera_with_vernaculars.parquet`
- 5,409 unique animal genera (Metazoa only)
- All have English OR Chinese vernaculars
- Deduplicated (one genus per row)

**Step 4: Kimi API labeling**
```bash
# Set API key (add to ~/.bashrc for persistence)
export MOONSHOT_API_KEY="your-api-key"

# Run production pipeline
nohup /home/olier/miniconda3/envs/AI/bin/python -u \
  src/Stage_4/taxonomy/nlp/06_kimi_gardener_labels.py \
  > nohup_kimi_labels.log 2>&1 &

# Monitor progress
tail -f nohup_kimi_labels.log
```

**Output:** `data/taxonomy/kimi_gardener_labels.csv`
- genus, english_vernacular, chinese_vernacular, kimi_label, success, error
- Incremental writes every 50 genera
- Progress indicator: count, success rate, req/min, ETA

**Time:** ~60 minutes (5,409 genera at 200 RPM rate limit)

---

## Technical Configuration

### Kimi API Settings

- **Endpoint:** https://api.moonshot.ai/v1
- **Model:** kimi-k2-turbo-preview
- **Rate limit:** 200 requests/minute (hard limit)
- **Processing:** Sequential (no concurrency to avoid rate limit issues)
- **Temperature:** 0.3 (consistent categorization)
- **Max tokens:** 200 (category label output)
- **Retries:** 3 attempts per request

### Rate Limiting Implementation

**Method:** Rolling window timestamp tracking
- Track last 200 request timestamps
- If 200 requests sent in last 60 seconds, sleep until window clears
- Ensures strict compliance with 200 RPM limit

**Performance:**
- Actual rate: ~90-100 req/min (safe margin below limit)
- 100% success rate (no 429 errors)
- ETA calculated dynamically

### Kingdom Filter Implementation

**Critical fix:** Prevent homonym contamination

```python
# Load vernaculars with Animalia filter
english_df = con.execute("""
    SELECT genus, vernaculars_all, n_vernaculars
    FROM read_parquet('genus_vernacular_aggregations.parquet')
    WHERE kingdom = 'Animalia'
""").fetchdf()
```

**Impact:** 25 previously contaminated genera now get correct animal vernaculars

---

## Output Files

```
data/taxonomy/
├── genus_vernacular_aggregations.parquet          # 7,648 genera (English) ✅
├── genus_vernacular_aggregations_chinese.parquet  # 6,841 genera (Chinese) ✅
├── animal_genera_with_vernaculars.parquet         # 5,409 animal genera ✅
└── kimi_gardener_labels.csv                       # IN PROGRESS (~150/5,409)
```

---

## Current Status (2025-11-16 09:20)

**Process:** Running (PID: 2480959)
**Progress:** 150/5,409 genera (2.8%)
**Success rate:** 100%
**Processing rate:** ~92 req/min
**ETA:** ~57 minutes

**Monitor:**
```bash
tail -f /home/olier/ellenberg/nohup_kimi_v3.log
```

---

## Expected Results

**Target:** 5,409 animal genera
**Expected coverage:** ~95-98% (based on vernacular availability)
**Expected accuracy:** ~95-100% (based on validation tests)

**Quality improvements over vectors:**
- Accuracy: 100% vs 45-50% (2.2× better)
- Compound name parsing: Perfect vs Failed
- Biological knowledge: Built-in vs None
- Multi-language reasoning: Yes vs No

---

## Integration with Guild Scorer

**Current:** Hardcoded pattern matching in Rust guild scorer
**Future:** Use `kimi_label` column for data-driven categorization

**Benefits:**
- Remove hardcoded regex patterns
- Consistent labels across pipeline
- Easier to update categories (data file vs code changes)

---

## Dependencies

**R packages (custom library `.Rlib`):**
- duckdb, arrow, dplyr, stringr, purrr

**Python environment (conda AI):**
- openai (synchronous OpenAI client for Kimi API)
- pandas, duckdb (data processing)
- time, collections (rate limiting)

**Infrastructure:**
- R: `/usr/bin/Rscript` with `R_LIBS_USER=/home/olier/ellenberg/.Rlib`
- Python: `/home/olier/miniconda3/envs/AI/bin/python`
- Kimi API key: Environment variable `MOONSHOT_API_KEY`

---

## Limitations

1. **Rate limit:** 200 RPM maximum (Kimi API restriction)
2. **Animal scope only:** Plants excluded (already 89.1% covered in Phase 1)
3. **Vernacular dependency:** ~5% of genera lack vernaculars (will remain uncategorized)
4. **Processing time:** ~60 minutes for full dataset (unavoidable with rate limit)

---

## Next Steps

1. **Complete production run** (~57 minutes remaining)
2. **Validate output quality** (sample 100 random labels)
3. **Merge with Phase 1 data** (combine multilingual vernaculars + gardener labels)
4. **Integrate with guild scorer** (replace hardcoded patterns)

---

**Last updated:** 2025-11-16 09:30

**Status:** Phase 1 complete (75.2%), Phase 2 in progress (2.8% complete, 100% success rate)
