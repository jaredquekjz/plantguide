# Stage 4.1: GloBI Data Structure Analysis

## Overview

Prior to extracting biotic interaction data for the Guild Builder system, a comprehensive analysis of the Global Biotic Interactions (GloBI) database structure was conducted to identify data quality issues, taxonomic inconsistencies, and optimization opportunities. This document presents findings from systematic exploration of interaction types, taxonomic patterns, and cross-kingdom relationships.

## Methodology

### Dataset Scope

- **Full GloBI dataset**: `data/stage1/globi_interactions_original.parquet` (~20M records)
- **Filtered dataset**: `data/stage4/globi_interactions_final_dataset_11680.parquet` (1.9M records matching our 11,680 plants)
- **Final plant dataset**: `model_data/outputs/perm2_production/perm2_11680_with_ecoservices_20251030.parquet`

### Analysis Approach

Three temporary analysis scripts were created to systematically examine:

1. **Interaction type distribution** - Frequency and taxonomic patterns across all relationship types
2. **Source-target taxonomic validation** - Kingdom-level consistency checks
3. **Cross-category overlaps** - Organisms appearing in multiple incompatible roles
4. **Circular relationships** - Bidirectional predation patterns
5. **Data completeness** - Missing taxonomy fields
6. **Case studies** - Deep dives into specific organisms (honeybees, aphids, ladybugs)
7. **Quantitative impact** - Before/after comparisons of proposed filters

## Key Findings

### Finding 1: Interaction Type Distribution

**Top 5 interaction types in 11,680-plant dataset:**

| Interaction Type | Count | Percentage | Interpretation |
|-----------------|-------|------------|----------------|
| hasHost | 860,700 | 45.4% | Organism uses plant as host (fungi, pathogens, parasites) |
| interactsWith | 360,038 | 19.0% | Generic/unspecified interaction |
| pollinates | 234,475 | 12.4% | Pollination service |
| eats | 184,395 | 9.7% | Herbivory or nectar/pollen consumption |
| visitsFlowersOf | 106,631 | 5.6% | Flower visitation (potential pollination) |

**Observation**: `hasHost` dominates the dataset but is rarely used in ecological analyses. It overlaps significantly with `pathogenOf` and `parasiteOf`.

### Finding 2: Source Kingdom Patterns

**Top source kingdoms interacting with plants (as targets):**

| Source Kingdom | Primary Interaction | Count | Examples |
|----------------|---------------------|-------|----------|
| Fungi | hasHost | 610,015 | *Cercospora*, *Merulius*, *Dothidea* |
| Animalia | interactsWith | 184,229 | Generic animal interactions |
| Animalia | eats | 153,045 | Herbivory and nectar feeding |
| Animalia | pollinates | 105,789 | Animal pollinators |
| Metazoa | pollinates | 86,121 | Animal pollinators (alternative classification) |

**Observation**: Fungi dominate as plant pathogens via `hasHost`. Animal kingdoms split across `eats` (ambiguous - includes both herbivory and nectar feeding).

### Finding 3: Critical Data Quality Issues

#### Issue 3.1: Plants Appearing as Pollinators

**Problem**: 212 plant species recorded as pollinators of other plants.

**Examples**:
- *Trifolium repens* (white clover) "pollinates" other species (1 record)
- Generic "Lucilia", "Prosopis", "Manettia" appearing as pollinators (47, 43, 12 records respectively)

**Analysis**:
- True wind pollination (anemophily) is not directed "Plant A pollinates Plant B" - wind disperses pollen non-specifically
- Self-pollinating plants (autogamy) pollinate themselves, not other individuals
- **These records are data entry errors or misclassifications**

**Impact without filtering**:
- Spurious pollinator relationships in compatibility matrix
- Inflated shared pollinator counts between plants
- False positive "beneficial pollinator" signals

#### Issue 3.2: Pollinators Appearing as Pathogens

**Problem**: 20 organisms classified as BOTH pollinators AND pathogens.

**Examples**:
- *Tenthredo vespa* (sawfly): 4 pollination records, 1 pathogen record
- *Trifolium repens*: 998 as pollination target, 2 as pathogen source
- *Pemphigus spyrothecae* (aphid): Both pollinator and pathogen
- *Aceria cephalonea* (mite): Both roles

**Analysis**:
- Sawflies are legitimate flower visitors but not pathogens
- Plants cannot be pathogens (except parasitic plants via different interaction types)
- **Data source conflicts or taxonomic misidentification**

#### Issue 3.3: hasHost vs pathogenOf Overlap

**Problem**: Two interaction types represent the same ecological relationship with vastly different usage.

| Interaction Type | Records | Unique Organisms | Plants Affected |
|-----------------|---------|------------------|-----------------|
| hasHost | 860,700 | 34,064 | 7,400+ |
| pathogenOf | 10,364 | 1,048 | 1,733 |
| **Overlap** | - | **1,201** | - |

**Kingdom breakdown of hasHost**:
- Fungi: 610,015 (71%)
- Animalia: 92,386 (11%)
- Chromista: 16,107 (2%)

**Analysis**:
- `hasHost` and `pathogenOf` describe similar antagonistic relationships
- Different data sources use different terminology
- Current extraction (`pathogenOf` + `parasiteOf` only) misses **96% of pathogen data**

**Impact**: Severely underestimated pathogen diversity (1,733 → 7,417 plants affected when including hasHost).

#### Issue 3.4: Plant-to-Plant Interactions

**Problem**: 48,062 plant-to-plant `interactsWith` records, plus smaller counts for other interaction types.

**Legitimate plant-to-plant interactions**:

| Interaction Type | Count | Examples | Valid? |
|-----------------|-------|----------|--------|
| parasiteOf | 867 | *Viscum album*, *Cuscuta*, *Ileostylus micranthus* | ✓ YES |
| hemiparasiteOf | 20 | *Cuscuta rostrata*, *Loranthaceae* | ✓ YES |
| pollinates | 212 | "Lucilia", "Prosopis", "Manettia" | ✗ NO |
| eats | 761 | Various plant species | ? UNCLEAR |

**Analysis**:
- Parasitic plant interactions are biologically valid and should be retained
- Plants appearing as "pollinators" are data quality issues
- Plants "eating" other plants may represent allelopathy or competition, not true herbivory

#### Issue 3.5: Visitor-Herbivore Overlap

**Finding**: 30 organisms appear as BOTH flower visitors AND herbivores.

**Examples**:
- *Bombus griseocollis* (bumblebee)
- *Polygonia comma* (butterfly)
- *Maniola jurtina* (butterfly)
- *Calypte anna* (hummingbird)

**Analysis**: **This overlap is EXPECTED and biologically valid**
- Beetles visit flowers for nectar AND eat leaves
- Butterflies pollinate as adults AND caterpillars eat foliage
- Hummingbirds consume nectar AND occasionally eat insects/plant material

**Current filter handles this correctly**: Excluding pollinators from herbivores prevents spurious "Apis mellifera eats Apis mellifera" relationships while allowing legitimate dual-role organisms in predator networks.

### Finding 4: Herbivore Taxonomic Diversity

**Top herbivore classes** (after excluding pollinators):

| Taxonomic Class | Species Count | Interaction Count | Examples |
|----------------|---------------|-------------------|----------|
| Aves (Birds) | 1,775 | 103,469 | *Turdus merula*, *Fringilla coelebs* |
| Insecta | 6,093 | 27,317 | *Euphilotes spaldingi*, *Graphium leonidas* |
| Mammalia | 1,217 | 27,747 | *Cercopithecus*, *Cynopterus* (bats) |
| Agaricomycetes (Fungi) | 597 | 1,516 | *Fomitopsis pinicola*, *Trametes* |
| Squamata (Reptiles) | 13 | 305 | *Iguana iguana*, *Basiliscus vittatus* |

**Observation**: Vertebrate herbivores (birds, mammals, reptiles) represent legitimate herbivory pressure and should be retained in Guild Builder analysis. Frontend can display "Deer grazing risk" or "Bird foraging pressure" as ecological factors.

### Finding 5: Circular Predation Relationships

**Finding**: 20 circular predation relationships exist where "A eats B AND B eats A".

**Examples**:
- *Metacyrba* ↔ *Misumenops* (spiders)
- *Procladius* ↔ *Simulium erythrocephalum* (aquatic insects)
- *Phoxinus phoxinus* ↔ *Salmo salar* (fish)

**Analysis**: These are likely legitimate:
- Cannibalism
- Life stage differences (adults eat larvae, larvae eat adults)
- Size-dependent predation
- Opportunistic feeding

**Recommendation**: Retain these relationships in multi-trophic network.

### Finding 6: Data Completeness

**Missing taxonomy fields**:

| Field | Missing Records | Percentage |
|-------|----------------|------------|
| sourceTaxonName | 0 | 0.00% |
| targetTaxonName | 0 | 0.00% |
| interactionTypeName | 0 | 0.00% |
| sourceTaxonKingdomName | 212,031 | 11.18% |
| targetTaxonKingdomName | 21,538 | 1.14% |

**Observation**: Kingdom-level taxonomy missing for ~11% of source organisms. These will be excluded by kingdom filters, which is acceptable given data quality improvements.

### Finding 7: Case Study - Apis mellifera

**Honeybee interaction types**:

| Interaction Type | Count | Role |
|-----------------|-------|------|
| pollinates | 36,666 | Pollinator |
| visitsFlowersOf | 9,822 | Flower visitor |
| interactsWith | 2,435 | Generic |
| **eats** | **798** | **"Herbivore"** |
| visits | 262 | Visitor |

**Critical observation**: *Apis mellifera* recorded as "eating" 798 plant species. This represents nectar/pollen consumption (mutualistic), not harmful herbivory. Without filtering, honeybees would appear in herbivore lists, leading to the spurious "Apis mellifera eats Apis mellifera" error discovered during frontend testing.

## Proposed Optimization Strategy

### Fix 1: Kingdom Filter for Pollinators

**Current logic**:
```sql
WHERE interactionTypeName IN ('pollinates', 'visitsFlowersOf', 'visits')
```

**Improved logic**:
```sql
WHERE interactionTypeName IN ('pollinates', 'visitsFlowersOf', 'visits')
  AND sourceTaxonKingdomName IN ('Animalia', 'Metazoa')
```

**Impact**:
- Records: 353,623 → 292,191 (17.4% reduction)
- Removes 4,642 non-animal "pollinators" (plants, fungi, bacteria)
- Eliminates data quality issues like *Trifolium repens* as pollinator

### Fix 2: Include hasHost + Kingdom Filter for Pathogens

**Current logic**:
```sql
WHERE interactionTypeName IN ('pathogenOf', 'parasiteOf')
```

**Improved logic**:
```sql
WHERE interactionTypeName IN ('pathogenOf', 'parasiteOf', 'hasHost')
  AND sourceTaxonKingdomName IN ('Fungi', 'Bacteria', 'Chromista',
                                  'Orthornavirae', 'Shotokuvirae', 'Pararnavirae')
```

**Impact**:
- Pathogen species: 3,622 → 35,673 (10x increase)
- Plants affected: 1,733 → 7,417 (4.3x increase, 15% → 63% coverage)
- Adds 624,673 records (mostly fungal pathogens)
- Removes animals, plants mistakenly classified as pathogens

**Kingdom breakdown of new pathogen dataset**:
- Fungi: 614,217 records (95%)
- Chromista: 16,180 records (2.5%)
- Bacteria: 5,293 records (0.8%)
- Orthornavirae: 2,322 records (0.4%)

### Fix 3: Exclude Plants from Herbivore List

**Current logic** (already implemented):
```sql
WHERE interactionTypeName IN ('eats', 'preysOn')
  AND sourceTaxonName NOT IN (
      SELECT sourceTaxonName
      FROM interactions
      WHERE interactionTypeName IN ('pollinates', 'visitsFlowersOf', 'visits')
  )
```

**Improved logic**:
```sql
WHERE interactionTypeName IN ('eats', 'preysOn')
  AND source_wfo_taxon_id IS NULL  -- Exclude plants as herbivores
  AND sourceTaxonName NOT IN (
      SELECT sourceTaxonName
      FROM interactions
      WHERE interactionTypeName IN ('pollinates', 'visitsFlowersOf', 'visits')
        AND sourceTaxonKingdomName IN ('Animalia', 'Metazoa')
  )
```

**Impact**:
- Removes ~10 plant "herbivores" (e.g., *Viscum album*, *Drymoanthus adversus*)
- Retains legitimate parasitic plant relationships via `parasiteOf` interaction type
- Maintains all animal, fungal, insect herbivores

### Fix 4: Kingdom Filter for Flower Visitors

**Improved logic**:
```sql
WHERE interactionTypeName IN ('pollinates', 'visitsFlowersOf', 'visits')
  AND sourceTaxonKingdomName IN ('Animalia', 'Metazoa')
```

**Impact**:
- Visitor species: 12,870 → 8,228 (36% reduction)
- Removes 4,642 non-animal visitors
- Ensures visitor-prey network contains only animals that can be eaten by predators

## Implementation Impact Summary

### Before Optimization

| Organism Type | Species | Plants Affected | Records |
|--------------|---------|-----------------|---------|
| Pollinators | 12,870 | 1,558 | 353,623 |
| Herbivores | 13,176 | 3,898 | 134,249 |
| Pathogens | 3,622 | 1,733 | 21,423 |
| Flower Visitors | 12,870 | 3,087 | 353,623 |

### After Optimization

| Organism Type | Species | Plants Affected | Records | Change |
|--------------|---------|-----------------|---------|--------|
| Pollinators | 8,228 | ~1,540 | 292,191 | -17% records |
| Herbivores | 13,583 | ~3,990 | 140,662 | +5% records |
| Pathogens | 35,673 | 7,417 | 646,096 | +30x records |
| Flower Visitors | 8,228 | ~3,050 | 292,191 | -36% species |

### Quality Improvements

1. **Eliminated spurious relationships**:
   - Plants as pollinators: 212 removed
   - Plants as pathogens: ~100 removed
   - Pollinators as pathogens: 20 overlaps resolved
   - Plants as herbivores: ~10 removed

2. **Massively improved pathogen coverage**:
   - 15% → 63% of plants with pathogen data
   - Captures full fungal pathogen diversity from hasHost

3. **Retained biologically valid relationships**:
   - Parasitic plants (via `parasiteOf`, `hemiparasiteOf`)
   - Vertebrate herbivores (birds, mammals, reptiles)
   - Dual-role organisms (visitors that are also herbivores)
   - Circular predation patterns

## Recommendations

### Immediate Actions

1. **Apply all four fixes** to `src/Stage_4/01_extract_organism_profiles.py`
2. **Re-run full extraction** on 11,680-plant dataset
3. **Validate** results against known plant-pathogen relationships (e.g., *Abies* species sharing *Curreya pityophila*)
4. **Document** kingdom filtering logic in code comments

### Frontend Considerations

- **Pathogen counts will increase substantially** - update UI to handle larger organism lists
- **Vertebrate herbivores** - consider separate display category ("Wildlife Grazing Risk")
- **Fungal pathogens** - now the dominant pathogen type, may need taxonomic icons
- **Virus pathogens** - Orthornavirae included, consider display as "Viral Diseases"

### Future Enhancements

1. **Interaction strength weighting** - `hasHost` may be weaker signal than `pathogenOf`
2. **Taxonomic specificity** - Filter by Class/Order for more precise herbivore categorization
3. **Geographic filtering** - Many GloBI records include location data
4. **Temporal filtering** - Interaction timing (flowering period alignment)

## Data Quality Lessons Learned

1. **Never trust interaction type alone** - Always validate with taxonomic kingdom
2. **Different data sources use different terms** - `hasHost` ≈ `pathogenOf`
3. **"eats" is ambiguous** - Includes mutualistic (nectar feeding) and antagonistic (herbivory) interactions
4. **Cross-category overlaps are often valid** - Organisms play multiple ecological roles
5. **Plant-to-plant interactions require careful interpretation** - Distinguish parasitism from data errors

## Conclusion

Comprehensive GloBI data structure analysis revealed critical data quality issues that would have resulted in:
- Spurious pollinator relationships (plants pollinating plants)
- Severely underestimated pathogen diversity (96% missing)
- False positive beneficial predator signals (honeybees eating themselves)

Proposed taxonomic filtering strategy increases pathogen coverage 30-fold while eliminating cross-kingdom inconsistencies. All fixes maintain biological validity and improve Guild Builder accuracy.

**Next Step**: Implement optimized extraction logic and re-process full 11,680-plant dataset.
