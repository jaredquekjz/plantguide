# Stage 4.5: Frontend with 7-Metric Framework

**Date Created**: 2025-11-05
**Purpose**: Document frontend alignment with 7-metric framework and qualitative organism display
**Status**: Production Ready

---

## Executive Summary

Frontend updated to align with 7-metric framework (4.2c) which consolidates N1/N2 into M1 using phylogenetic distance.

**Key Changes**:
1. **Metrics**: Reduced from 11 to 7 calibrated metrics + 2 flags
2. **N1/N2 Removal**: Pest/pathogen sharing now measured by M1 (phylogenetic distance)
3. **Qualitative Display**: Observed pest/pathogen data shown separately (not scored)
4. **Metric Grouping**: Universal indicators first, then bonus indicators

**Status**: ‚úÖ All components tested and working

---

## Part 1: 7-Metric Framework Structure

### 1.1 The 7 Core Metrics

| # | Metric Name | Code | Calculation | Coverage |
|---|-------------|------|-------------|----------|
| **1** | **Pest & Pathogen Independence** | **M1** | **Phylogenetic distance (exponential)** | **100%** |
| 2 | Growth Compatibility | M2 | CSR conflicts (inverted) | 100% |
| 3 | Beneficial Insect Networks | M3 | Biocontrol mechanisms | Variable |
| 4 | Disease Suppression | M4 | Antagonist fungi | Variable |
| 5 | Beneficial Fungi Networks | M5 | Shared mycorrhizae | Variable |
| 6 | Structural Diversity | M6 | Vertical stratification | 100% |
| 7 | Pollinator Support | M7 | Shared pollinators | Variable |

**Plus Flags** (not percentile-ranked):
- N5: Nitrogen self-sufficiency (has N-fixer: Yes/No)
- N6: Soil pH compatibility (pH range: X.X-X.X)

### 1.2 Metric Grouping for Display

**Universal Indicators** (available for all plants):
1. Pest & Pathogen Independence (M1)
2. Structural Diversity (M6)
3. Growth Compatibility (M2)

**Bonus Indicators** (dependent on GloBI data):
4. Beneficial Fungi (M5)
5. Disease Control (M4)
6. Insect Control (M3)
7. Pollinator Support (M7)

---

## Part 2: Guild Scorer V3 Output Structure

### 2.1 Metric Output Format

```python
from guild_scorer_v3 import GuildScorerV3
scorer = GuildScorerV3(calibration_type='7plant', climate_tier='tier_3_humid_temperate')
result = scorer.score_guild(['wfo-0000292049', 'wfo-0000348570', 'wfo-0000404021'])
```

### 2.2 Result Dictionary Structure

```json
{
  "overall_score": 75.3,
  "metrics": {
    "pest_pathogen_indep": 68.5,
    "growth_compatibility": 92.1,
    "insect_control": 45.2,
    "disease_control": 78.9,
    "beneficial_fungi": 100.0,
    "structural_diversity": 85.0,
    "pollinator_support": 56.7
  },
  "flags": {
    "nitrogen": "Present",
    "soil_ph": "5.5-7.2"
  },
  "veto": false,
  "n_plants": 7,

  "negative": {...},
  "positive": {...},
  "climate": {...},

  "plant_details": [...],
  "plant_names": [...],
  "organism_to_plants": {...},
  "plant_organism_profiles": {...}
}
```

### 2.3 New: Plant Organism Profiles

**Location**: `result['plant_organism_profiles']`

Structure for qualitative display of observed organisms:

```json
{
  "wfo-0000292049": {
    "herbivores": [
      {"name": "Aphis fabae", "n_plants": 3},
      {"name": "Myzus persicae", "n_plants": 2},
      {"name": "Pieris rapae", "n_plants": 1}
    ],
    "herbivores_total": 15,

    "pathogenic_fungi": [
      {"name": "Botrytis cinerea", "n_plants": 4},
      {"name": "Fusarium oxysporum", "n_plants": 2}
    ],
    "pathogenic_fungi_total": 8,

    "bacteria": [
      {"name": "Pseudomonas syringae", "n_plants": 1}
    ],
    "bacteria_total": 1,

    "viruses": [],
    "oomycetes": [],
    "nematodes": [],
    "pollinators": [],
    "flower_visitors": []
  }
}
```

**Sorting Algorithm**:
- Shared organisms first (sorted by `n_plants` DESC)
- Non-shared organisms alphabetically
- Top 5 per category shown

---

## Part 3: Data Extraction Updates

### 3.1 Fungal Guild Extraction (Broadened)

**File**: `src/Stage_4/01_extract_fungal_guilds_hybrid.py`

**Changes**:
- OLD: Only `hasHost` relationship
- NEW: `hasHost`, `parasiteOf`, `pathogenOf`, `interactsWith`

**Rationale**: Cast wide net, let FungalTraits validate and sort into guilds

**Output**: `data/stage4/plant_fungal_guilds_hybrid.parquet`

**Coverage**: 7,187 plants (61.5%) with pathogenic fungi

**Validation**: FungalTraits (128 mycologists) + FunGuild (fallback)

**Guilds**: 8 categories
- Pathogenic (general)
- Pathogenic (host-specific)
- AMF (arbuscular mycorrhizal)
- EMF (ectomycorrhizal)
- Endophytic
- Saprotrophic
- Mycoparasite
- Entomopathogenic

### 3.2 Non-Fungal Pathogen Extraction (New)

**File**: `src/Stage_4/02_extract_nonfungal_pathogens.py`

**Purpose**: Extract bacteria, viruses, oomycetes, nematodes separately from fungi

**Relationships Used**:
- Bacteria: `hasHost`, `pathogenOf`, `parasiteOf`, `interactsWith`
- Viruses: `pathogenOf`, `hasHost`, `interactsWith`
- Oomycetes: `hasHost`, `parasiteOf`, `pathogenOf`, `interactsWith`
- Nematodes: `parasiteOf`, `pathogenOf`, `livesInsideOf`

**Output**: `data/stage4/plant_nonfungal_pathogens.parquet`

**Coverage**: 1,749 plants (15.0%)

**Assumption**: All extracted organisms are pathogenic (no validation database exists)

---

## Part 4: Frontend Display Components

### 4.1 Markdown Export Structure

**File**: `src/Stage_4/export_explanation_md.py`

**Sections** (in order):
1. Overall Score with stars (e.g., ‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ Good Guild)
2. Plants in Guild (WFO IDs)
3. **Observed Organisms (GloBI Data)** ‚Üê NEW qualitative section
4. Climate Compatibility
5. Risks (currently shows "No Specific Risk Factors Detected")
6. Benefits (evolutionary distance, fungi networks, pollinators, etc.)
7. Warnings (CSR conflicts, nitrogen, pH)
8. Detailed Metrics (grouped: Universal + Bonus)

### 4.2 Observed Organisms Section

**Format**:
```markdown
## Observed Organisms (GloBI Data)

*This is qualitative information only (not used for scoring). Shows top 5 organisms per plant with shared organisms highlighted.*

### Vitis vinifera

**Herbivores** (showing 5 of 50):
- üî¥ *Lobesia botrana* (4 plants)
- üü† *Planococcus ficus* (2 plants)
- ‚ö™ *Empoasca vitis*

**Pathogenic Fungi** (FungalTraits validated, showing 5 of 35):
- üü† *Botrytis cinerea* (3 plants)
- üü† *Plasmopara viticola* (2 plants)
- ‚ö™ *Uncinula necator*

**Oomycetes** (water molds, showing 5 of 40):
- ‚ö™ *Phytophthora cinnamomi*
- ‚ö™ *Pythium ultimum*

---

**Legend:** üî¥ Critical (‚â•50% of guild) | üü† High (‚â•2 plants) | ‚ö™ Low (1 plant)
```

**Severity Indicators**:
- üî¥ **Critical**: Affects ‚â•50% of guild plants
- üü† **High**: Affects ‚â•2 plants
- ‚ö™ **Low**: Affects only 1 plant

### 4.3 Metrics Display

**Format**:
```markdown
## üìä Detailed Metrics

**Universal Indicators** (available for all plants):

| Metric | Score |
|--------|-------|
| Pest Pathogen Indep | ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë 39.9 |
| Structural Diversity | ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë 37.2 |
| Growth Compatibility | ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë 55.0 |

**Bonus Indicators** (dependent on available data):

| Metric | Score |
|--------|-------|
| Beneficial Fungi | ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà 100.0 |
| Disease Control | ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà 100.0 |
| Insect Control | ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë 98.5 |
| Pollinator Support | ‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë 0.0 |
```

**Bar Chart**:
- `‚ñà` (filled) = score value
- `‚ñë` (light shade) = remaining to 100
- 20 characters total (each = 5 points)

---

## Part 5: Explanation Engine Updates

### 5.1 Risk Generation (Updated)

**File**: `src/Stage_4/explanation_engine.py`

**Changes**:
- **REMOVED**: N1 (Shared Pathogenic Fungi) risk messages
- **REMOVED**: N2 (Shared Pest Vulnerabilities) risk messages

**Rationale**:
- Pest/pathogen sharing now measured by M1 (phylogenetic distance)
- M1 provides 100% coverage vs N1/N2 sparse 28% coverage
- Literature validates phylogenetic distance as PRIMARY predictor
- Observed data shown in qualitative "Observed Organisms" section only

**Current Behavior**:
```json
{
  "risks": [
    {
      "type": "none",
      "severity": "none",
      "icon": "‚úì",
      "title": "No Specific Risk Factors Detected",
      "message": "Guild metrics show generally compatible plants",
      "detail": "Review individual metrics and observed organisms for optimization opportunities",
      "advice": "Check metric breakdown and qualitative organism data for specific guidance"
    }
  ]
}
```

### 5.2 Benefit Generation (Unchanged)

Still generates explanations for:
- Evolutionary Distance Benefits (M1/phylogenetic diversity)
- Shared Beneficial Fungi (M5)
- Shared Pollinator Network (M7)
- Natural Pest Control System (M3)
- Biological Disease Suppression (M4)
- Vertical Space Utilization (M6)

---

## Part 6: Testing and Validation

### 6.1 Test Script

**File**: `src/Stage_4/test_three_guilds.py`

**Test Guilds**:
1. Forest Garden (7 plants) - Diverse heights/forms
2. Competitive Clash (7 plants) - All high-C plants
3. Stress-Tolerant (7 plants) - All high-S plants
4. Biocontrol Powerhouse (7 plants) - Hedgerow/woodland edge

**Test Results** (2025-11-05):
```
Guild 1: 82.7/100 - Excellent Guild
  Risks: None detected
  Observed organisms displayed correctly

Guild 2: 61.5/100 - Good Guild
  Risks: None detected
  CSR conflict warnings shown

Guild 3: 49.5/100 - Neutral Guild
  Risks: None detected

Guild 4: 85.3/100 - Excellent Guild
  Risks: None detected
```

### 6.2 Validation Checklist

- ‚úÖ 7 metrics output correctly (no N1/N2)
- ‚úÖ M1 (Pest & Pathogen Independence) calculated via phylogenetic distance
- ‚úÖ Exponential transformation applied to M1 (exp(-3.0 √ó distance))
- ‚úÖ No N1/N2 risk messages generated
- ‚úÖ Observed organisms displayed qualitatively with severity indicators
- ‚úÖ Metrics grouped: Universal first, Bonus second
- ‚úÖ Fungal guilds broadened (4 relationships)
- ‚úÖ Non-fungal pathogens extracted separately
- ‚úÖ All markdown exports formatted correctly

---

## Part 7: API Alignment

### 7.1 Guild API Changes Required

**File**: `src/Stage_4/guild_api.py` (to be updated)

**Key Changes**:
1. Ensure using `GuildScorerV3` with `calibration_type='7plant'`
2. Return `plant_organism_profiles` in API response
3. Map metric names correctly (no n1/n2, add m1)
4. Include climate tier parameter in scorer initialization

**Example Response Structure**:
```json
{
  "overall_score": 75.3,
  "rating": "‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ",
  "label": "Good Guild",

  "metrics": {
    "universal": {
      "pest_pathogen_indep": 68.5,
      "structural_diversity": 85.0,
      "growth_compatibility": 92.1
    },
    "bonus": {
      "beneficial_fungi": 100.0,
      "disease_control": 78.9,
      "insect_control": 45.2,
      "pollinator_support": 56.7
    }
  },

  "plant_organism_profiles": {...},

  "explanation": {
    "risks": [],
    "benefits": [],
    "warnings": []
  }
}
```

---

## Part 8: References

**Implementation Documents**:
- `/home/olier/ellenberg/results/summaries/phylotraits/Stage_4/4.2c_7_Metric_Framework_Implementation_Plan.md`
- `/home/olier/ellenberg/results/summaries/phylotraits/Stage_4/4.2c_PLAN_Qualitative_Pest_Display.md`

**Literature Basis**:
- Phylopathogen 2013 (Gilbert & Webb): Exponential pest sharing decay
- Gougherty-Davies 2021: Phylogenetic constraints across pest types
- Silva-Valderrama et al. 2025: Host phylogeny determines pathogen interaction
- PhyloEpi Model: 74.5% classification accuracy

**Data Sources**:
- GloBI: Global Biotic Interactions database
- FungalTraits: Expert-curated (128 mycologists)
- FunGuild: Confidence-filtered fallback
- WFO: World Flora Online taxonomic backbone

---

## Part 9: Next Steps

**Immediate**:
1. ‚úÖ Update frontend documentation (this document)
2. Run 2-plant calibration extraction (1000 guilds)
3. Run 7-plant calibration extraction (1000 guilds)
4. Verify calibration percentiles align with new M1 metric

**Future**:
1. Update `guild_api.py` to serve organism profiles
2. Implement frontend UI for organism display
3. Add filtering/sorting options for organism lists
4. Consider adding severity threshold configuration

---

**Document Status**: Complete
**Last Updated**: 2025-11-05
**Validation**: All test guilds pass with correct output
