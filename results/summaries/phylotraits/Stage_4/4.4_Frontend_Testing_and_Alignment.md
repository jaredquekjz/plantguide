# Stage 4.4: Frontend Testing and Alignment

**Date Created**: 2025-11-04
**Purpose**: Verify frontend API and explanation engine are correctly aligned with all 11 guild scoring metrics
**Status**: Testing Documentation

---

## Executive Summary

This document validates that the frontend API (`guild_api.py`) and explanation engine (`explanation_engine.py`) correctly handle all 11 metrics from the guild scoring framework.

**Test Results**: âœ… All 11 metrics present and functional with 1 critical bug fixed

**Critical Fix Applied** (2025-11-04):
- **Bug**: Percentile normalization used wrong key format ('p01' vs 'p1')
- **Impact**: Guild scorer crashed on initialization
- **Fix**: Changed `f'p{p:02d}'` to `f'p{p}'` in lines 148 and 199 of guild_scorer_v3.py
- **Status**: âœ… Fixed and tested

**Key Findings**:
1. âœ… GuildScorerV3 outputs all 11 metrics in detailed technical format
2. âœ… Frontend receives user-friendly metric names for display
3. âš ï¸ API imports outdated guild_scorer_v2 instead of guild_scorer_v3
4. âš ï¸ Explanation engine only explicitly references 2 metrics (P4, N4)

---

## Part 1: Guild Scorer V3 Output Structure

### 1.1 Metric Output Format

**Test Command**:
```bash
python -c "
from guild_scorer_v3 import GuildScorerV3
scorer = GuildScorerV3(calibration_type='7plant')
result = scorer.score_guild(['wfo-0000292049', 'wfo-0000348570', 'wfo-0000404021'])
"
```

### 1.2 Detailed Output Structure

Guild Scorer V3 returns a comprehensive result dict with THREE levels of metric representation:

#### Level 1: User-Friendly Display Names
**Location**: `result['metrics']`

```json
{
  "pathogen_independence": 100.0,
  "pest_independence": 100.0,
  "growth_compatibility": 100.0,
  "insect_control": 0.0,
  "disease_control": 0.0,
  "beneficial_fungi": 23.3,
  "phylo_diversity": 0.0,
  "structural_diversity": 0.0,
  "pollinator_support": 0.0
}
```

**Purpose**: Frontend visualization (charts, scores display)

**Mapping to Technical IDs**:
| Display Name | Technical ID | Component Type |
|--------------|--------------|----------------|
| pathogen_independence | N1 | Negative |
| pest_independence | N2 | Negative |
| growth_compatibility | N4 | Negative |
| insect_control | P1 | Positive |
| disease_control | P2 | Positive |
| beneficial_fungi | P3 | Positive |
| phylo_diversity | P4 | Positive |
| structural_diversity | P5 | Positive |
| pollinator_support | P6 | Positive |

**Missing from Display**: N5 (Nitrogen Fixation), N6 (pH Incompatibility) â†’ shown in `flags` instead

#### Level 2: Technical Metric Details (Negative)
**Location**: `result['negative']`

```json
{
  "negative_risk_score": 0.0,
  "n1_pathogen_fungi": {
    "raw": 0,
    "norm": 0.0,
    "shared": {}
  },
  "n2_herbivores": {
    "raw": 0,
    "norm": 0.0,
    "shared": {}
  },
  "n4_csr_conflicts": {
    "raw": 0.0,
    "norm": 0.0,
    "conflicts": [],
    "raw_conflicts": 0,
    "conflict_density": 0.0
  },
  "n5_n_fixation": {
    "n_fixers": 0,
    "flag": "Missing"
  },
  "n6_ph": {
    "min_ph": 0.0,
    "max_ph": 0.0,
    "compatible": true,
    "flag": "No pH data"
  }
}
```

**Purpose**: Detailed breakdown for explanation engine and debugging

#### Level 3: Technical Metric Details (Positive)
**Location**: `result['positive']`

```json
{
  "positive_benefit_score": 0.035,
  "p1_biocontrol": {
    "raw": 0.0,
    "norm": 0.0,
    "mechanisms": []
  },
  "p2_pathogen_control": {
    "raw": 0.0,
    "norm": 0.0,
    "mechanisms": []
  },
  "p3_beneficial_fungi": {
    "raw": 0.133,
    "norm": 0.233,
    "shared": {}
  },
  "p4_phylo_diversity": {
    "raw": 0.0,
    "norm": 0.0,
    "mean_distance": 0.0
  },
  "p5_stratification": {
    "raw": 0.0,
    "norm": 0.0,
    "n_forms": 1
  },
  "p6_pollinators": {
    "raw": 0,
    "norm": 0.0,
    "shared": {}
  }
}
```

**Purpose**: Detailed breakdown with raw scores, normalized scores, and evidence

### 1.3 Metric Coverage Assessment

**âœ… ALL 11 METRICS PRESENT**:

**Negative Metrics (5)**:
- âœ… N1 (Pathogen Fungi Overlap) â†’ `n1_pathogen_fungi`
- âœ… N2 (Herbivore Overlap) â†’ `n2_herbivores`
- âœ… N4 (CSR Conflicts) â†’ `n4_csr_conflicts`
- âœ… N5 (Nitrogen Fixation) â†’ `n5_n_fixation`
- âœ… N6 (pH Incompatibility) â†’ `n6_ph`

**Positive Metrics (6)**:
- âœ… P1 (Insect Biocontrol) â†’ `p1_biocontrol`
- âœ… P2 (Disease Control) â†’ `p2_pathogen_control`
- âœ… P3 (Beneficial Fungi) â†’ `p3_beneficial_fungi`
- âœ… P4 (Phylogenetic Diversity) â†’ `p4_phylo_diversity`
- âœ… P5 (Vertical Stratification) â†’ `p5_stratification`
- âœ… P6 (Shared Pollinators) â†’ `p6_pollinators`

---

## Part 2: Explanation Engine Analysis

### 2.1 Implementation Review

**Source**: `src/Stage_4/explanation_engine.py`

**Function**: `generate_explanation(guild_result: Dict) -> Dict`

### 2.2 Metric Handling

The explanation engine transforms technical guild_result into user-friendly explanations.

#### Metrics Explicitly Referenced

**P4 (Phylogenetic Diversity)** - Line 74:
```python
phylo_score = guild_result['positive'].get('p4_phylo_diversity', {}).get('norm', 0)
```

**N4 (CSR Conflicts)** - Line 493:
```python
csr_data = guild_result.get('negative', {}).get('n4_csr_conflicts', {})
```

#### Metrics Implicitly Handled

**N1 (Pathogen Fungi)** â†’ Extracted from `shared_pathogenic_fungi` dict:
```python
def _explain_risks(negative_result: Dict, n_plants: int):
    shared_fungi = negative_result.get('shared_pathogenic_fungi', {})
    # Generates "Shared Pathogenic Fungi" risk card
```

**N2 (Herbivores)** â†’ Extracted from `shared_herbivores` dict:
```python
shared_herbivores = negative_result.get('shared_herbivores', {})
# Generates "Shared Pest Vulnerabilities" risk card
```

**P3 (Beneficial Fungi)** â†’ Extracted from `shared_beneficial_fungi` dict:
```python
def _explain_benefits(positive_result: Dict, n_plants: int, phylo_bonus: float):
    shared_beneficial = positive_result.get('shared_beneficial_fungi', {})
    # Generates "Shared Beneficial Fungi" benefit card
```

**P6 (Pollinators)** â†’ Extracted from `shared_pollinators` dict:
```python
shared_pollinators = positive_result.get('shared_pollinators', {})
# Generates "Shared Pollinator Network" benefit card
```

#### Metrics NOT Explicitly Mentioned

**N5 (Nitrogen Fixation)** - âš ï¸ No explanation generated
- Data available in `flags['nitrogen']`
- Could add advisory text: "Contains N-fixing legumes - may enrich soil"

**N6 (pH Compatibility)** - âš ï¸ No explanation generated
- Data available in `flags['soil_ph']`
- Could add warning: "Plants have conflicting pH requirements"

**P1 (Insect Biocontrol)** - âš ï¸ Grouped into general "biocontrol"
- Data available in `p1_biocontrol['mechanisms']`
- Mechanisms include predator-herbivore and fungal-insect relationships

**P2 (Disease Control)** - âš ï¸ Grouped into general "pathogen control"
- Data available in `p2_pathogen_control['mechanisms']`
- Mechanisms include mycoparasite fungi attacking pathogens

**P5 (Vertical Stratification)** - âš ï¸ No explanation generated
- Data available in `p5_stratification['n_forms']`
- Could add benefit: "Plants occupy different height layers - maximizes space"

### 2.3 Explanation Engine Output Structure

```json
{
  "overall": {
    "rating": 2,
    "stars": "â˜…â˜…â˜†â˜†â˜†",
    "label": "Below Average Guild",
    "message": "35.9th percentile - requires careful management"
  },
  "climate": {
    "compatible": true,
    "messages": ["âœ“ All plants can grow in temperature range..."]
  },
  "risks": [
    {
      "type": "shared_pathogens",
      "severity": "critical",
      "title": "Shared Pathogenic Fungi (15 total)",
      "message": "Up to 80% of plants share disease vulnerabilities"
    }
  ],
  "benefits": [
    {
      "type": "beneficial_fungi",
      "strength": "high",
      "title": "Shared Beneficial Fungi (8 total)",
      "message": "Up to 60% of plants connect through beneficial fungi"
    }
  ],
  "warnings": [
    {
      "type": "csr_conflict",
      "severity": "medium",
      "message": "High-C and High-C plants may compete for resources"
    }
  ],
  "products": [
    {
      "type": "fungicide",
      "name": "Copper-based spray",
      "reason": "Botrytis cinerea detected on multiple plants"
    }
  ]
}
```

---

## Part 3: Frontend API Analysis

### 3.1 Guild API Implementation

**Source**: `src/Stage_4/guild_api.py`

**Critical Issue**: Line 31 imports **guild_scorer_v2** instead of **guild_scorer_v3**

```python
from guild_scorer_v2 import GuildScorer  # âŒ OUTDATED!
```

**Should be**:
```python
from guild_scorer_v3 import GuildScorerV3  # âœ… CORRECT
```

### 3.2 API Endpoint: Score Guild

**Endpoint**: `POST /api/score-guild`

**Request**:
```json
{
  "plant_ids": ["wfo-001", "wfo-002", "wfo-003"]
}
```

**Response**:
```json
{
  "success": true,
  "score": 0.75,
  "veto": false,
  "explanation": {
    "overall": {...},
    "climate": {...},
    "risks": [...],
    "benefits": [...],
    "products": [...]
  },
  "plant_names": ["Quercus robur", "Fagus sylvatica", "Pinus sylvestris"],
  "n_plants": 3
}
```

**Flow**:
1. Receive `plant_ids` from frontend
2. Call `scorer.score_guild(plant_ids)` â†’ Returns full technical result
3. Call `generate_explanation(result)` â†’ Converts to user-friendly text
4. Return both `score` and `explanation` to frontend

### 3.3 API Metric Exposure

**Frontend receives**:
- `score`: Overall percentile score (0-100)
- `explanation.overall`: Star rating and assessment
- `explanation.risks`: List of negative factors with evidence
- `explanation.benefits`: List of positive factors with evidence
- `explanation.warnings`: Actionable advice
- `explanation.products`: Product recommendations

**Frontend does NOT receive raw metric breakdown** (n1, n2, p1, p2, etc.)
- This is intentional - technical metrics stay server-side
- Only user-friendly explanations sent to frontend

---

## Part 4: Critical Bug Fix

### 4.1 Bug Description

**Issue**: Percentile normalization key mismatch

**Location**: `src/Stage_4/guild_scorer_v3.py` lines 148, 199

**Root Cause**:
- Code used `f'p{p:02d}'` â†’ generates 'p01', 'p05', 'p10'
- Calibration file uses `'p1'`, `'p5'`, `'p10'`
- KeyError on 'p01' when accessing calibration parameters

**Impact**:
- Guild scorer crashed on initialization
- Frontend API completely non-functional
- Testing revealed issue immediately

### 4.2 Fix Applied

**Before** (line 148):
```python
values = [params[f'p{p:02d}'] for p in percentiles]  # âŒ WRONG
```

**After** (line 148):
```python
values = [params[f'p{p}'] for p in percentiles]  # âœ… CORRECT
```

**Testing**:
```bash
python -c "
from guild_scorer_v3 import GuildScorerV3
scorer = GuildScorerV3(calibration_type='7plant')
result = scorer.score_guild(['wfo-0000292049', 'wfo-0000348570', 'wfo-0000404021'])
print(f'Score: {result[\"overall_score\"]:.2f}')
"
# Output: Score: 35.93
```

**Status**: âœ… Fixed and verified

---

## Part 5: Frontend Integration Recommendations

### 5.1 Critical Updates Needed

**1. Update guild_api.py to use GuildScorerV3**

**Current** (line 31):
```python
from guild_scorer_v2 import GuildScorer
scorer = GuildScorer()
```

**Required**:
```python
from guild_scorer_v3 import GuildScorerV3
scorer = GuildScorerV3(calibration_type='7plant')
```

**Impact**: High - API currently using outdated scoring framework

---

**2. Enhance Explanation Engine Coverage**

**Missing Explanations**:
- N5 (Nitrogen Fixation): Add to warnings/benefits
- N6 (pH Incompatibility): Add to warnings
- P1 (Insect Biocontrol): Expand mechanism details
- P2 (Disease Control): Expand mechanism details
- P5 (Vertical Stratification): Add to benefits

**Recommended Implementation**:

```python
def _generate_warnings(guild_result: Dict):
    warnings = []

    # N5: Nitrogen fixation warning
    n5_data = guild_result['negative']['n5_n_fixation']
    if n5_data['n_fixers'] > 0:
        warnings.append({
            'type': 'nitrogen_fixation',
            'severity': 'info',
            'message': f'{n5_data["n_fixers"]} plants are nitrogen-fixing legumes',
            'advice': 'These plants can enrich soil - reduce nitrogen fertilizer'
        })

    # N6: pH incompatibility warning
    n6_data = guild_result['negative']['n6_ph']
    if not n6_data['compatible']:
        warnings.append({
            'type': 'ph_incompatible',
            'severity': 'high',
            'message': 'Plants have conflicting pH requirements',
            'advice': f'Some prefer acidic (pH<{n6_data["min_ph"]:.1f}), others alkaline (pH>{n6_data["max_ph"]:.1f})'
        })

    return warnings
```

---

### 5.2 Frontend Display Recommendations

**Metric Visualization Structure**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Guild Score: 35.9 / 100  â˜…â˜…â˜†â˜†â˜†        â”‚
â”‚  Below Average - Requires Management    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  COMPATIBILITY METRICS                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Disease Independence     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘  80â”‚
â”‚  Pest Independence        â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100â”‚
â”‚  Growth Compatibility     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘  50â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  BENEFICIAL INTERACTIONS                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Beneficial Fungi         â–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘  23â”‚
â”‚  Insect Biocontrol        â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘   0â”‚
â”‚  Pollinator Support       â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘   0â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  RISKS DETECTED                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ”´ Shared Pathogenic Fungi             â”‚
â”‚     â€¢ Botrytis cinerea (5/7 plants)    â”‚
â”‚     â€¢ Fusarium oxysporum (3/7 plants)  â”‚
â”‚                                         â”‚
â”‚  ğŸŸ¡ Shared Pest Vulnerabilities         â”‚
â”‚     â€¢ Aphids (4/7 plants)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Part 6: Testing Validation

### 6.1 Test Guild Results

**Test Guild**: 3 plants
- wfo-0000292049 (Quercus robur - Oak)
- wfo-0000348570 (Fagus sylvatica - Beech)
- wfo-0000404021 (Pinus sylvestris - Pine)

**Scorer Output**:
- Overall Score: 35.9 (Below Average)
- Veto: No
- Climate: Compatible (tier_3_humid_temperate)

**Metric Breakdown**:
| Metric | Display Name | Score | Status |
|--------|--------------|-------|--------|
| N1 | Pathogen Independence | 100.0 | âœ… No shared pathogens |
| N2 | Pest Independence | 100.0 | âœ… No shared herbivores |
| N4 | Growth Compatibility | 100.0 | âœ… No CSR conflicts |
| N5 | Nitrogen Fixation | - | âš ï¸ No N-fixers |
| N6 | pH Compatibility | - | âš ï¸ No pH data |
| P1 | Insect Control | 0.0 | âŒ No biocontrol |
| P2 | Disease Control | 0.0 | âŒ No mycoparasites |
| P3 | Beneficial Fungi | 23.3 | âœ… Some shared beneficial |
| P4 | Phylo Diversity | 0.0 | âŒ All same family (trees) |
| P5 | Structural Diversity | 0.0 | âŒ All trees (same form) |
| P6 | Pollinator Support | 0.0 | âŒ Wind-pollinated trees |

**Explanation Output**:
- Risks: 1 card ("Minimal Shared Vulnerabilities" - generic)
- Benefits: 0 cards (P3 score too low to trigger)
- Warnings: 0
- Products: 0

### 6.2 Coverage Validation

**âœ… Metrics Computed Correctly**: All 11 metrics calculated with proper percentile normalization

**âš ï¸ Explanation Sparse**: Only high-severity items generate cards
- Low scores (0-30) typically don't generate benefit cards
- This test guild has low positive scores â†’ sparse explanation

**âœ… Frontend Structure Valid**: API returns correct JSON structure for frontend consumption

---

## Part 7: Deployment Checklist

### 7.1 Critical Fixes Required Before Deployment

- [ ] Update `guild_api.py` line 31: Change `guild_scorer_v2` â†’ `guild_scorer_v3`
- [x] Fix percentile key formatting in `guild_scorer_v3.py` (COMPLETED)
- [ ] Test API with updated scorer using `curl` commands
- [ ] Verify all 11 metrics appear in API responses
- [ ] Update explanation engine to cover N5, N6, P5 explicitly

### 7.2 Frontend Display Enhancements

- [ ] Add metric breakdown visualization (progress bars for all 9 scored metrics)
- [ ] Display N5/N6 flags prominently when relevant
- [ ] Show raw+normalized scores for debugging (admin view)
- [ ] Add tooltips explaining each metric to users

### 7.3 Testing Recommendations

**Test with diverse guilds**:
1. High-score guild (70+): Verify all benefit cards appear
2. Low-score guild (30-): Verify all risk cards appear
3. Vetoed guild: Verify climate veto explanation clear
4. Mixed guild: Verify balanced risk+benefit display

**Test metrics individually**:
- Force N1 high: Add plants with shared pathogens
- Force P6 high: Add flowering plants with shared pollinators
- Force N4 high: Mix High-C + High-C plants
- Force P5 high: Mix groundcovers + shrubs + trees

---

## Document Status

**Status**: Testing documentation complete
**Last Updated**: 2025-11-04

**Key Outcomes**:
1. âœ… All 11 metrics validated in guild_scorer_v3
2. âœ… Critical bug fixed (percentile key mismatch)
3. âš ï¸ API needs update to use v3 scorer
4. âš ï¸ Explanation engine needs expansion for 5 metrics
5. âœ… Test results saved to `test_frontend_alignment.json`

**Next Steps**:
1. Update guild_api.py to use GuildScorerV3
2. Enhance explanation_engine.py with missing metric explanations
3. Deploy to staging environment
4. Run comprehensive frontend integration tests
