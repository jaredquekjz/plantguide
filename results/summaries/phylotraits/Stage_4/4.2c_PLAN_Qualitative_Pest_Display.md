# Plan: Qualitative Pest & Pathogen Display for 7-Metric Framework

**Date**: 2025-11-05
**Context**: Document 4.2c removed N1 (pathogen overlap) and N2 (herbivore overlap) from scoring due to sparse data (24-28% coverage). However, observed pest/pathogen data should still be displayed as **qualitative information** for user awareness.

**Purpose**: Design a frontend function to show top 5 observed organisms per plant, with highlighting for shared vulnerabilities.

---

## Current State Analysis

### What Guild Scorer Already Tracks

**Location**: `src/Stage_4/guild_scorer_v3.py` lines 438-501

The scorer already builds these mappings during `score_guild()`:

```python
# Plant â†’ [Organisms] mappings (built but not fully exposed)
plant_pathogens = {
    'wfo-001': ['botrytis_cinerea', 'fusarium_oxysporum', ...],
    'wfo-002': ['phytophthora_infestans', ...],
    ...
}

plant_herbivores = {
    'wfo-001': ['aphids', 'lepidoptera_larvae', ...],
    'wfo-002': ['mites', 'beetles', ...],
    ...
}

# Inverted mapping (currently exposed to frontend)
organism_to_plants = {
    'pathogens': {'botrytis_cinerea': ['wfo-001', 'wfo-002'], ...},
    'herbivores': {'aphids': ['wfo-001', 'wfo-003'], ...},
    ...
}
```

**What's Missing**:
- Top 5 per plant (currently returns ALL organisms)
- Annotation of which organisms are shared (requires cross-referencing with inverted map)
- Separation of "pathogenic fungi" vs "other pathogens" (bacteria, viruses)
- Clear frontend-ready structure

---

## Requirements

### 1. Data Structure

For each plant in the guild, display:

**A. Herbivores** (from GloBI `herbivores` field)
- Top 5 herbivores observed on this plant
- Highlight if herbivore also affects other plants in guild
- Include count: "affects 3/7 plants"

**B. Pathogenic Fungi** (from FungalTraits/GloBI `pathogenic_fungi` field)
- Top 5 pathogenic fungi observed on this plant
- Highlight if fungus also affects other plants in guild
- Include host-specificity indicator if available

**C. Other Pathogens** (optional - if dataset includes bacteria/viruses)
- Top 5 non-fungal pathogens
- Highlight if pathogen also affects other plants

### 2. Highlighting Rules

**Shared Vulnerabilities** (HIGH priority):
- Organism affects **â‰¥2 plants** â†’ Highlight in red/orange
- Show count: "Botrytis cinerea (affects 5/7 plants)"

**Plant-Specific** (LOW priority):
- Organism affects only this plant â†’ Normal display
- Less concerning for guild compatibility

### 3. Coverage Indicators

**Per Plant**:
- Show coverage: "5 herbivores observed (24% of European plants have herbivore data)"
- If NO data: "No herbivores observed (herbivore data coverage: 24%)"

**Per Guild**:
- Summary: "3/7 plants have herbivore data, 2/7 have pathogen data"

---

## Implementation Plan

### Option A: Add to Guild Scorer Output (Recommended)

**Modify**: `src/Stage_4/guild_scorer_v3.py`

**Function**: Add new method `_build_plant_organism_profiles()`

**Location**: After line 501 in `score_guild()`, add:

```python
# Build plant-centric organism profiles for frontend display
plant_organism_profiles = self._build_plant_organism_profiles(
    plant_pathogens, plant_herbivores, organism_to_plants
)
```

**Return structure**:
```python
return {
    ...
    'organism_to_plants': organism_to_plants,  # Keep for backward compatibility
    'plant_organism_profiles': plant_organism_profiles  # NEW - frontend display
}
```

**Advantages**:
- Data computed once during scoring
- Available to both API and explanation engine
- Clean separation from explanation logic

### Option B: Add to Explanation Engine

**Modify**: `src/Stage_4/explanation_engine.py`

**Function**: Add new function `_generate_pest_pathogen_profiles()`

**Advantages**:
- Keeps guild_scorer focused on scoring
- Explanation engine already formats data for frontend

**Disadvantages**:
- Duplicates logic if multiple views need this data
- Explanation engine already complex

**Recommendation**: Use Option A (guild scorer), then reference in explanation engine if needed.

---

## Detailed Implementation Design

### Step 1: New Method in Guild Scorer

**Add to `guild_scorer_v3.py` after line 546**:

```python
def _build_plant_organism_profiles(self, plant_pathogens, plant_herbivores, organism_to_plants):
    """
    Build plant-centric organism profiles for frontend qualitative display.

    For each plant, returns:
    - Top 5 herbivores (SHARED organisms prioritized)
    - Top 5 pathogenic fungi (SHARED organisms prioritized)
    - Annotations for shared vulnerabilities (affects multiple plants)

    SORTING: Shared organisms appear first (sorted by n_plants descending),
    then non-shared organisms alphabetically.

    Args:
        plant_pathogens: Dict[plant_id, List[pathogen]]
        plant_herbivores: Dict[plant_id, List[herbivore]]
        organism_to_plants: Inverted mapping (organism â†’ [plants])

    Returns:
        Dict[plant_id, plant_profile]

    Example:
        {
            'wfo-001': {
                'herbivores': [
                    {'name': 'Aphids', 'shared': True, 'n_plants': 3, 'plant_ids': ['wfo-001', 'wfo-002', 'wfo-003']},
                    {'name': 'Beetles', 'shared': True, 'n_plants': 2, 'plant_ids': ['wfo-001', 'wfo-004']},
                    {'name': 'Leaf miner', 'shared': False, 'n_plants': 1, 'plant_ids': ['wfo-001']},
                    ...
                ],
                'pathogenic_fungi': [
                    {'name': 'Botrytis cinerea', 'shared': True, 'n_plants': 5, 'plant_ids': ['wfo-001', ...]},
                    {'name': 'Fusarium', 'shared': True, 'n_plants': 3, 'plant_ids': ['wfo-001', ...]},
                    ...
                ],
                'has_data': True,
                'herbivore_count': 12,  # Total observed (not just top 5)
                'pathogen_count': 8
            }
        }
    """

    profiles = {}

    for plant_id in set(list(plant_pathogens.keys()) + list(plant_herbivores.keys())):
        # Get all organisms for this plant
        herbivores = plant_herbivores.get(plant_id, [])
        pathogens = plant_pathogens.get(plant_id, [])

        # Build herbivore profiles (with sharing info)
        herbivore_profiles = []
        for herb in herbivores:  # All first, then we'll sort and truncate
            # Check if shared across plants
            plants_with_this_herb = organism_to_plants['herbivores'].get(herb, [plant_id])
            n_plants = len(plants_with_this_herb)

            herbivore_profiles.append({
                'name': herb,
                'shared': n_plants >= 2,
                'n_plants': n_plants,
                'plant_ids': plants_with_this_herb
            })

        # SORT: Shared first (by n_plants desc), then non-shared (alphabetically)
        herbivore_profiles.sort(key=lambda x: (-x['n_plants'], x['name']))
        herbivore_profiles = herbivore_profiles[:5]  # Top 5 after sorting

        # Build pathogen profiles (with sharing info)
        pathogen_profiles = []
        for pathogen in pathogens:  # All first, then we'll sort and truncate
            # Check if shared across plants
            plants_with_this_pathogen = organism_to_plants['pathogens'].get(pathogen, [plant_id])
            n_plants = len(plants_with_this_pathogen)

            pathogen_profiles.append({
                'name': pathogen,
                'shared': n_plants >= 2,
                'n_plants': n_plants,
                'plant_ids': plants_with_this_pathogen
            })

        # SORT: Shared first (by n_plants desc), then non-shared (alphabetically)
        pathogen_profiles.sort(key=lambda x: (-x['n_plants'], x['name']))
        pathogen_profiles = pathogen_profiles[:5]  # Top 5 after sorting

        profiles[plant_id] = {
            'herbivores': herbivore_profiles,
            'pathogenic_fungi': pathogen_profiles,
            'has_data': len(herbivores) > 0 or len(pathogens) > 0,
            'herbivore_count': len(herbivores),  # Total count (for "showing 5 of 12")
            'pathogen_count': len(pathogens)
        }

    return profiles
```

---

### Step 2: Integrate into score_guild() Return

**Modify lines 503-524** in `score_guild()`:

```python
# Build plant-centric organism profiles for frontend display
plant_organism_profiles = self._build_plant_organism_profiles(
    plant_pathogens, plant_herbivores, organism_to_plants
)

return {
    'overall_score': overall_score,
    'metrics': metrics,
    'flags': flags,
    'veto': False,
    'n_plants': n_plants,

    # Detailed component breakdowns
    'negative': negative_result,
    'positive': positive_result,
    'climate': climate_result,

    # Frontend enhancement data
    'plant_details': plant_details,
    'plant_names': plant_names,
    'organism_to_plants': organism_to_plants,          # Inverted mapping (organism â†’ plants)
    'plant_organism_profiles': plant_organism_profiles,  # NEW: Plant â†’ top 5 organisms with sharing

    # Backwards compatibility
    'guild_score': (overall_score - 50) / 50,
    'negative_risk_score': negative_result.get('negative_risk_score', 0),
    'positive_benefit_score': positive_result.get('positive_benefit_score', 0),
}
```

---

### Step 3: Explanation Engine Enhancement

**Add to `explanation_engine.py`** after existing risk/benefit logic:

```python
def _generate_pest_pathogen_summary(guild_result: Dict) -> Dict:
    """
    Generate qualitative pest/pathogen summary for frontend display.

    Returns:
        {
            'per_plant': [
                {
                    'plant_id': 'wfo-001',
                    'scientific_name': 'Quercus robur',
                    'herbivores': [
                        {'name': 'Aphids', 'severity': 'high', 'shared_with': 3},
                        ...
                    ],
                    'pathogens': [
                        {'name': 'Botrytis cinerea', 'severity': 'critical', 'shared_with': 5},
                        ...
                    ]
                }
            ],
            'shared_vulnerabilities': [
                {'name': 'Botrytis cinerea', 'type': 'pathogen', 'affects': 5, 'plant_ids': [...]},
                {'name': 'Aphids', 'type': 'herbivore', 'affects': 3, 'plant_ids': [...]}
            ],
            'coverage_warning': {
                'herbivores': '3/7 plants have herbivore data (24% global coverage)',
                'pathogens': '2/7 plants have pathogen data (24% global coverage)'
            }
        }
    """

    plant_profiles = guild_result.get('plant_organism_profiles', {})
    plant_details = guild_result.get('plant_details', [])
    n_plants = guild_result.get('n_plants', 0)

    # Build per-plant summaries
    per_plant = []
    for plant_detail in plant_details:
        plant_id = plant_detail['wfo_id']
        profile = plant_profiles.get(plant_id, {})

        # Format herbivores (top 5, with severity based on sharing)
        herbivores = []
        for herb in profile.get('herbivores', []):
            severity = 'critical' if herb['n_plants'] >= n_plants * 0.5 else \
                      'high' if herb['n_plants'] >= 2 else 'low'
            herbivores.append({
                'name': herb['name'],
                'severity': severity,
                'shared_with': herb['n_plants'] - 1  # Exclude self
            })

        # Format pathogens (top 5, with severity based on sharing)
        pathogens = []
        for pathogen in profile.get('pathogenic_fungi', []):
            severity = 'critical' if pathogen['n_plants'] >= n_plants * 0.5 else \
                      'high' if pathogen['n_plants'] >= 2 else 'low'
            pathogens.append({
                'name': pathogen['name'],
                'severity': severity,
                'shared_with': pathogen['n_plants'] - 1
            })

        per_plant.append({
            'plant_id': plant_id,
            'scientific_name': plant_detail['scientific_name'],
            'herbivores': herbivores,
            'pathogens': pathogens,
            'has_data': profile.get('has_data', False)
        })

    # Extract shared vulnerabilities (affects â‰¥2 plants)
    shared_vulnerabilities = []
    organism_to_plants = guild_result.get('organism_to_plants', {})

    for pathogen, plant_ids in organism_to_plants.get('pathogens', {}).items():
        if len(plant_ids) >= 2:
            shared_vulnerabilities.append({
                'name': pathogen,
                'type': 'pathogen',
                'affects': len(plant_ids),
                'plant_ids': plant_ids
            })

    for herbivore, plant_ids in organism_to_plants.get('herbivores', {}).items():
        if len(plant_ids) >= 2:
            shared_vulnerabilities.append({
                'name': herbivore,
                'type': 'herbivore',
                'affects': len(plant_ids),
                'plant_ids': plant_ids
            })

    # Sort by number of plants affected (descending)
    shared_vulnerabilities.sort(key=lambda x: x['affects'], reverse=True)

    # Coverage warnings
    plants_with_herbivores = sum(1 for p in plant_profiles.values() if p.get('herbivore_count', 0) > 0)
    plants_with_pathogens = sum(1 for p in plant_profiles.values() if p.get('pathogen_count', 0) > 0)

    coverage_warning = {
        'herbivores': f'{plants_with_herbivores}/{n_plants} plants have herbivore data (24% global coverage)',
        'pathogens': f'{plants_with_pathogens}/{n_plants} plants have pathogen data (24% global coverage)'
    }

    return {
        'per_plant': per_plant,
        'shared_vulnerabilities': shared_vulnerabilities[:10],  # Top 10 shared
        'coverage_warning': coverage_warning
    }
```

**Integrate into main `generate_explanation()` function**:

```python
def generate_explanation(guild_result: Dict) -> Dict:
    """Generate user-friendly explanation from guild result."""

    # ... existing code ...

    # NEW: Add pest/pathogen qualitative summary
    pest_pathogen_summary = _generate_pest_pathogen_summary(guild_result)

    return {
        'overall': overall_summary,
        'climate': climate_explanation,
        'risks': risks,
        'benefits': benefits,
        'warnings': warnings,
        'products': products,
        'pest_pathogen_info': pest_pathogen_summary  # NEW: Qualitative data
    }
```

---

## Frontend Display Mockup

### Per-Plant View

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Quercus robur (Oak)                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ› OBSERVED HERBIVORES (showing 5 of 12)                  â”‚
â”‚    ğŸ”´ Aphids (affects 3/7 plants in guild)                â”‚
â”‚    ğŸŸ  Lepidoptera larvae (affects 2/7 plants)             â”‚
â”‚    âšª Sawfly (affects only this plant)                    â”‚
â”‚    âšª Leaf miner (affects only this plant)                â”‚
â”‚    âšª Scale insect (affects only this plant)              â”‚
â”‚                                                            â”‚
â”‚  ğŸ„ OBSERVED PATHOGENIC FUNGI (showing 5 of 8)             â”‚
â”‚    ğŸ”´ Botrytis cinerea (affects 5/7 plants) âš ï¸            â”‚
â”‚    ğŸ”´ Fusarium oxysporum (affects 4/7 plants) âš ï¸          â”‚
â”‚    ğŸŸ  Phytophthora (affects 2/7 plants)                   â”‚
â”‚    âšª Powdery mildew (affects only this plant)            â”‚
â”‚    âšª Rust fungus (affects only this plant)               â”‚
â”‚                                                            â”‚
â”‚  â„¹ï¸ Data Coverage: Herbivores 24%, Pathogens 24%          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Guild Summary View

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SHARED VULNERABILITIES (Top 5)                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ”´ Botrytis cinerea (pathogen)                            â”‚
â”‚     Affects: wfo-001, wfo-002, wfo-003, wfo-005, wfo-007  â”‚
â”‚     5 out of 7 plants (71%)                                â”‚
â”‚                                                            â”‚
â”‚  ğŸ”´ Fusarium oxysporum (pathogen)                          â”‚
â”‚     Affects: wfo-001, wfo-002, wfo-003, wfo-005           â”‚
â”‚     4 out of 7 plants (57%)                                â”‚
â”‚                                                            â”‚
â”‚  ğŸŸ  Aphids (herbivore)                                     â”‚
â”‚     Affects: wfo-001, wfo-003, wfo-007                    â”‚
â”‚     3 out of 7 plants (43%)                                â”‚
â”‚                                                            â”‚
â”‚  âš ï¸ Note: This is observational data from GloBI/FungalTraitsâ”‚
â”‚     NOT used in compatibility scoring (24% coverage)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## API Response Structure

```json
{
  "success": true,
  "overall_score": 58.3,
  "metrics": { ... },
  "explanation": {
    "overall": { ... },
    "risks": [ ... ],
    "benefits": [ ... ],
    "pest_pathogen_info": {
      "per_plant": [
        {
          "plant_id": "wfo-001",
          "scientific_name": "Quercus robur",
          "herbivores": [
            {"name": "Aphids", "severity": "critical", "shared_with": 2},
            {"name": "Lepidoptera larvae", "severity": "high", "shared_with": 1}
          ],
          "pathogens": [
            {"name": "Botrytis cinerea", "severity": "critical", "shared_with": 4},
            {"name": "Fusarium oxysporum", "severity": "critical", "shared_with": 3}
          ],
          "has_data": true
        }
      ],
      "shared_vulnerabilities": [
        {"name": "Botrytis cinerea", "type": "pathogen", "affects": 5, "plant_ids": ["wfo-001", ...]},
        {"name": "Aphids", "type": "herbivore", "affects": 3, "plant_ids": ["wfo-001", ...]}
      ],
      "coverage_warning": {
        "herbivores": "3/7 plants have herbivore data (24% global coverage)",
        "pathogens": "2/7 plants have pathogen data (24% global coverage)"
      }
    }
  }
}
```

---

## Testing Plan

### Test Case 1: Guild with Shared Pathogens

**Test Guild**: 7 plants, 5 share Botrytis cinerea

**Expected**:
- Botrytis appears in 5 plant profiles with `shared: true, n_plants: 5`
- Botrytis appears in `shared_vulnerabilities` list
- Coverage warning shows data availability

**Validation**:
```python
result = scorer.score_guild(['wfo-001', 'wfo-002', ...])
profiles = result['plant_organism_profiles']

# Check plant wfo-001
assert 'Botrytis cinerea' in [p['name'] for p in profiles['wfo-001']['pathogenic_fungi']]
assert profiles['wfo-001']['pathogenic_fungi'][0]['shared'] == True
assert profiles['wfo-001']['pathogenic_fungi'][0]['n_plants'] == 5
```

### Test Case 2: Guild with NO Observed Pests

**Test Guild**: 7 plants, none have herbivore/pathogen data

**Expected**:
- All plant profiles show `has_data: false`
- Empty `shared_vulnerabilities` list
- Coverage warning shows "0/7 plants have data"

### Test Case 3: Mixed Guild (Some Data, Some Missing)

**Test Guild**: 7 plants, 3 have herbivore data, 2 have pathogen data

**Expected**:
- 3 plant profiles show herbivores
- 2 plant profiles show pathogens
- Coverage warning: "3/7 plants have herbivore data"

---

## Implementation Checklist

### Phase 1: Core Data Structure (guild_scorer_v3.py)
- [ ] Add `_build_plant_organism_profiles()` method
- [ ] Integrate into `score_guild()` return dict
- [ ] Add unit test for profile building
- [ ] Verify top 5 truncation works correctly
- [ ] Verify sharing annotation (n_plants â‰¥ 2)

### Phase 2: Explanation Engine (explanation_engine.py)
- [ ] Add `_generate_pest_pathogen_summary()` function
- [ ] Integrate into main `generate_explanation()`
- [ ] Add severity classification logic
- [ ] Add coverage warning computation
- [ ] Test with 3 diverse guilds

### Phase 3: API Integration (guild_api.py)
- [ ] Verify API returns `pest_pathogen_info` in response
- [ ] Test JSON serialization
- [ ] Add endpoint documentation
- [ ] Test with curl commands

### Phase 4: Frontend Display
- [ ] Design per-plant organism cards
- [ ] Design guild shared vulnerabilities view
- [ ] Add severity color coding (red/orange/white)
- [ ] Add tooltips explaining data coverage
- [ ] Add "View All" link if >5 organisms

---

## Data Coverage Context

**CRITICAL**: Always prominently display data coverage warnings:

**Global Coverage** (European plants):
- Herbivores: 28.3% of plants (3,310 / 11,680)
- Pathogenic Fungi: 24.4% of plants (2,851 / 11,680)

**Guild-Specific Coverage**:
- Varies widely (0-100% depending on plant selection)
- Must show: "3/7 plants have herbivore data"

**User Communication**:
> "This is observational data from global databases (GloBI, FungalTraits). Coverage is incomplete (24-28%). Missing data does NOT mean the plant is pest-free - it means we lack observations. This information is for awareness only and is NOT used in compatibility scoring."

---

## Confirmed Requirements

1. **Top 5 with count indicator** âœ… CONFIRMED
   - Display: "Showing 5 of 12 observed herbivores"
   - MD format: Shows count in header (no interactive "View All" link)
   - API format: Returns full list, frontend truncates to 5

2. **Highlight SHARED organisms** âœ… CONFIRMED
   - Top 5 MUST include shared organisms if they exist
   - Sort by: (1) shared organisms first, (2) then alphabetically
   - Display: "ğŸ”´ Botrytis cinerea (affects 5/7 plants)"

3. **No external database links** âœ… CONFIRMED
   - Do NOT link to GloBI or FungalTraits
   - Just show organism names

4. **Expand to ALL pathogens (not just fungi)** âœ… CONFIRMED
   - Current: Only `pathogenic_fungi` extracted
   - Future: Add bacteria, viruses, nematodes, etc.
   - Implementation: New extraction script for non-fungal pathogens
   - Display: Separate sections for "Pathogenic Fungi" and "Other Pathogens"

---

## Integration with Existing Test Frontend

### Current Test Scripts

**Found**: `src/Stage_4/test_three_guilds.py` and `src/Stage_4/export_explanation_md.py`

**Current Workflow**:
1. `test_three_guilds.py` scores guilds and generates JSON
2. `export_explanation_md.py` converts JSON to markdown for human review
3. Markdown includes: overall score, metrics, risks, benefits, warnings

**What's Missing**: Observed pest/pathogen data not in markdown output

### Enhancement Plan for Markdown Export

**Add to `export_explanation_md.py`** after line 143 (after warnings section):

```python
# Observed Pests & Pathogens (Qualitative)
pest_info = explanation.get('pest_pathogen_info', {})
if pest_info:
    md.append("## ğŸ›ğŸ„ Observed Pests & Pathogens (Qualitative)\n")
    md.append("*This data is for awareness only and is NOT used in compatibility scoring.*\n")

    # Coverage warning
    coverage = pest_info.get('coverage_warning', {})
    if coverage:
        md.append("**Data Coverage:**")
        md.append(f"- Herbivores: {coverage.get('herbivores', 'Unknown')}")
        md.append(f"- Pathogens: {coverage.get('pathogens', 'Unknown')}")
        md.append("")

    # Shared vulnerabilities (guild-wide)
    shared = pest_info.get('shared_vulnerabilities', [])
    if shared:
        md.append("### ğŸ”´ Shared Vulnerabilities (Affects Multiple Plants)\n")
        for vuln in shared[:10]:  # Top 10
            organism_type = vuln['type'].title()
            n_plants = vuln['affects']
            total_plants = len(plant_ids) if plant_ids else n_plants
            pct = int(n_plants / total_plants * 100) if total_plants > 0 else 0

            md.append(f"**{vuln['name']}** ({organism_type})")
            md.append(f"- Affects {n_plants}/{total_plants} plants ({pct}%)")
            md.append(f"- Plants: {', '.join([f'`{p}`' for p in vuln['plant_ids'][:5]])}")
            if len(vuln['plant_ids']) > 5:
                md.append(f"  (and {len(vuln['plant_ids']) - 5} more)")
            md.append("")

    # Per-plant details
    per_plant = pest_info.get('per_plant', [])
    if per_plant:
        md.append("### Per-Plant Organism Lists\n")

        for plant_info in per_plant:
            plant_name = plant_info['scientific_name']
            plant_id = plant_info['plant_id']
            has_data = plant_info.get('has_data', False)

            md.append(f"#### {plant_name}\n")
            md.append(f"*Plant ID: `{plant_id}`*\n")

            if not has_data:
                md.append("âšª No observed pests or pathogens in database\n")
                continue

            # Herbivores
            herbivores = plant_info.get('herbivores', [])
            if herbivores:
                total_herb = sum(1 for h in herbivores)  # Could be > 5 in full data
                md.append(f"**ğŸ› Herbivores** (showing top {min(len(herbivores), 5)}):")
                for herb in herbivores[:5]:
                    severity_icon = 'ğŸ”´' if herb['severity'] == 'critical' else \
                                   'ğŸŸ ' if herb['severity'] == 'high' else 'âšª'
                    shared_info = f" (affects {herb['shared_with'] + 1} plants)" if herb['shared_with'] > 0 else ""
                    md.append(f"- {severity_icon} {herb['name']}{shared_info}")
                md.append("")

            # Pathogens
            pathogens = plant_info.get('pathogens', [])
            if pathogens:
                total_path = sum(1 for p in pathogens)
                md.append(f"**ğŸ„ Pathogenic Fungi** (showing top {min(len(pathogens), 5)}):")
                for path in pathogens[:5]:
                    severity_icon = 'ğŸ”´' if path['severity'] == 'critical' else \
                                   'ğŸŸ ' if path['severity'] == 'high' else 'âšª'
                    shared_info = f" (affects {path['shared_with'] + 1} plants)" if path['shared_with'] > 0 else ""
                    md.append(f"- {severity_icon} {path['name']}{shared_info}")
                md.append("")

            md.append("---\n")
```

**Output Example (Markdown)**:

```markdown
## ğŸ›ğŸ„ Observed Pests & Pathogens (Qualitative)

*This data is for awareness only and is NOT used in compatibility scoring.*

**Data Coverage:**
- Herbivores: 3/7 plants have herbivore data (28% global coverage)
- Pathogens: 2/7 plants have pathogen data (24% global coverage)

### ğŸ”´ Shared Vulnerabilities (Affects Multiple Plants)

**Botrytis cinerea** (Pathogen)
- Affects 5/7 plants (71%)
- Plants: `wfo-001`, `wfo-002`, `wfo-003`, `wfo-005`, `wfo-007`

**Aphids** (Herbivore)
- Affects 3/7 plants (43%)
- Plants: `wfo-001`, `wfo-003`, `wfo-007`

### Per-Plant Organism Lists

#### Quercus robur
*Plant ID: `wfo-0000292049`*

**ğŸ› Herbivores** (showing top 5):
- ğŸ”´ Aphids (affects 3 plants)
- ğŸŸ  Lepidoptera larvae (affects 2 plants)
- âšª Sawfly
- âšª Leaf miner
- âšª Scale insect

**ğŸ„ Pathogenic Fungi** (showing top 5):
- ğŸ”´ Botrytis cinerea (affects 5 plants)
- ğŸ”´ Fusarium oxysporum (affects 4 plants)
- ğŸŸ  Phytophthora (affects 2 plants)
- âšª Powdery mildew
- âšª Rust fungus

---
```

---

## Summary

**Goal**: Display observed pest/pathogen data as qualitative information, not scoring metric.

**Approach**:
1. Add `_build_plant_organism_profiles()` to guild_scorer_v3.py
2. Return `plant_organism_profiles` with top 5 per plant + sharing annotations
3. Enhance explanation_engine.py with `_generate_pest_pathogen_summary()`
4. Display per-plant view + guild shared vulnerabilities view
5. Prominently show data coverage warnings (24-28%)

**Key Benefits**:
- Users aware of known pest/pathogen vulnerabilities
- Shared vulnerabilities highlighted (guild-wide risks)
- Clear communication about data limitations
- Not confused with compatibility scoring

**Next Step**: Implement Phase 1 in guild_scorer_v3.py and test with diverse guilds.

---

## Future Expansion: All Pathogens (Not Just Fungi)

### Current State Analysis

**GloBI Already Has ALL Pathogen Types** âœ…

Query results from `data/stage4/globi_interactions_final_dataset_11680.parquet`:

| Pathogen Type | Kingdom | Phylum | Count | Status |
|---------------|---------|--------|-------|--------|
| **Fungi** | Fungi | Ascomycota | 3,084 | âœ… Extracted |
| **Fungi** | Fungi | Basidiomycota | 1,038 | âœ… Extracted |
| **Oomycetes** | Chromista | Oomycota | 699 | âŒ Not extracted |
| **Nematodes** | Animalia | Nematoda | 540 | âŒ Not extracted |
| **Viruses** | Orthornavirae | Kitrinoviricota | 410 | âŒ Not extracted |
| **Viruses** | Orthornavirae | Pisuviricota | 358 | âŒ Not extracted |
| **Viruses** | Shotokuvirae | Cressdnaviricota | 342 | âŒ Not extracted |
| **Bacteria** | Bacteria | Proteobacteria | 325 | âŒ Not extracted |
| **Bacteria** | Bacteria | Firmicutes | 30 | âŒ Not extracted |

**Total pathogenOf interactions: 10,366**
- Currently extracted (Fungi only): 4,173 (40%)
- Available but not extracted: 6,193 (60%)

### Why Only Fungi Currently Extracted?

**Current script**: `src/Stage_4/01_extract_fungal_guilds_hybrid.py` line 78
```python
WHERE g.interactionTypeName = 'hasHost'
  AND g.sourceTaxonKingdomName = 'Fungi'  # â† FILTERS OUT ALL NON-FUNGI!
```

**Reason for filtering**:
- FungalTraits provides validation (pathogenic vs beneficial fungi)
- No equivalent trait database for bacteria/viruses/nematodes
- Only extracted what could be validated against expert curation

**However**: For qualitative display (not scoring), we don't need trait validation!

### Proposed Extraction Strategy

**NEW Script**: `src/Stage_4/02_extract_all_pathogens.py`

**Data Source**: GloBI `pathogenOf` interactions (already in dataset)

**Query Structure**:
```sql
SELECT
    target_wfo_taxon_id as plant_wfo_id,
    sourceTaxonName as pathogen_name,
    sourceTaxonKingdomName as kingdom,
    sourceTaxonPhylumName as phylum,
    sourceTaxonGenusName as genus
FROM read_parquet('data/stage4/globi_interactions_final_dataset_11680.parquet')
WHERE interactionTypeName = 'pathogenOf'
  AND target_wfo_taxon_id IN (SELECT wfo_taxon_id FROM plants)
```

**Taxonomic Classification**:
```python
def classify_pathogen_type(kingdom, phylum):
    """Classify pathogen into display category."""
    if kingdom == 'Fungi':
        return 'fungi'
    elif kingdom == 'Chromista' and phylum == 'Oomycota':
        return 'oomycetes'
    elif kingdom == 'Bacteria':
        return 'bacteria'
    elif kingdom in ['Orthornavirae', 'Shotokuvirae', 'Pararnavirae']:
        return 'viruses'
    elif kingdom == 'Animalia' and phylum == 'Nematoda':
        return 'nematodes'
    else:
        return 'other'
```

**Output Structure**:
```parquet
plant_wfo_id | pathogen_name | pathogen_type | kingdom | phylum | genus
-------------|---------------|---------------|---------|--------|-------
wfo-001      | Botrytis cinerea | fungi | Fungi | Ascomycota | botrytis
wfo-001      | Erwinia amylovora | bacteria | Bacteria | Proteobacteria | erwinia
wfo-001      | Tobacco mosaic virus | viruses | Orthornavirae | Kitrinoviricota | NULL
wfo-001      | Phytophthora ramorum | oomycetes | Chromista | Oomycota | phytophthora
wfo-001      | Meloidogyne incognita | nematodes | Animalia | Nematoda | meloidogyne
```

**Merge Strategy**:
- Create new `data/stage4/plant_all_pathogens.parquet` with ALL types
- Keep existing `plant_fungal_guilds_hybrid.parquet` for validated fungal guilds (used in P2, P3 scoring)
- New file for qualitative display only

### Display Changes

**guild_scorer_v3.py** - Add new fields:
```python
plant_all_pathogens = {
    'wfo-001': {
        'fungi': ['botrytis', 'fusarium'],
        'bacteria': ['erwinia', 'pseudomonas'],
        'viruses': ['tmv', 'cmv'],
        'nematodes': ['meloidogyne'],
        'oomycetes': ['phytophthora']
    }
}
```

**Frontend Display**:
```markdown
#### Quercus robur

**ğŸ„ Pathogenic Fungi** (showing top 5 of 8):
- ğŸ”´ Botrytis cinerea (affects 5 plants)
- ğŸŸ  Fusarium oxysporum (affects 2 plants)
...

**ğŸ¦  Bacterial Pathogens** (showing top 5 of 3):
- ğŸ”´ Erwinia amylovora (affects 3 plants)
- âšª Pseudomonas syringae

**ğŸ§¬ Viral Pathogens** (showing 2):
- âšª Tobacco mosaic virus
- âšª Cucumber mosaic virus

**ğŸª± Nematode Pathogens** (showing 1):
- âšª Root-knot nematode

**ğŸ’§ Oomycete Pathogens** (showing 1):
- ğŸŸ  Phytophthora ramorum (affects 2 plants)
```

### Implementation Timeline

**Phase A** (Current - Fungal Only):
- [x] Extract pathogenic fungi from FungalTraits + GloBI (validated)
- [ ] Display in frontend with shared highlighting
- [ ] Test with diverse guilds

**Phase B** (Next - All Pathogens from GloBI):
- [ ] Create `src/Stage_4/02_extract_all_pathogens.py`
- [ ] Extract ALL `pathogenOf` interactions (no kingdom filter)
- [ ] Classify into 5 types: fungi, oomycetes, bacteria, viruses, nematodes
- [ ] Save to `data/stage4/plant_all_pathogens.parquet`
- [ ] Expected coverage: ~6,193 additional pathogen records

**Phase C** (Integration):
- [ ] Update `guild_scorer_v3.py` to load all pathogen types
- [ ] Build pathogen profiles per type (top 5 each)
- [ ] Update explanation_engine.py display sections
- [ ] Update export_explanation_md.py for markdown output

**Phase D** (Optional - Manual Curation):
- [ ] High-priority pathogens (e.g., fire blight, late blight)
- [ ] Regional pathogen databases
- [ ] User-submitted observations

### Data Quality Notes

**GloBI pathogenOf Confidence**:
- Fungi: âœ… High (validated against FungalTraits)
- Oomycetes: âœ… High (well-documented plant pathogens like Phytophthora)
- Bacteria: âš ï¸ Medium (many soil bacteria are mutualists, not pathogens)
- Viruses: âš ï¸ Medium (taxonomy challenges, but plant viruses well-known)
- Nematodes: âœ… High (plant-parasitic nematodes well-documented)

**No Trait Validation Available**:
- FungalTraits only covers fungi
- No equivalent for bacteria/viruses/nematodes
- **Solution**: Display AS-IS with caveat "observational data, not validated"

**Data Already in GloBI** âœ…:
- 699 oomycete interactions (Phytophthora, etc.)
- 1,110 viral interactions (TMV, CMV, etc.)
- 540 nematode interactions (root-knot, cyst nematodes)
- 355 bacterial interactions (Erwinia, Pseudomonas, etc.)

**Extraction is straightforward** - just remove kingdom filter!

---

## Updated Implementation Summary

### Current Status

âœ… **GloBI data available**: 10,366 pathogenOf interactions across all pathogen types
âœ… **Test frontend found**: `test_three_guilds.py` + `export_explanation_md.py`
âœ… **Requirements confirmed**:
- Top 5 per plant with count indicator
- Shared organisms highlighted and prioritized in sorting
- No external database links
- Plan for all pathogen types (data already in GloBI!)

### Implementation Phases

**Phase 1** (Fungi Only - Qualitative Display):
1. Add `_build_plant_organism_profiles()` to guild_scorer_v3.py
2. Return `plant_organism_profiles` in score_guild()
3. Add `_generate_pest_pathogen_summary()` to explanation_engine.py
4. Update `export_explanation_md.py` to display pest/pathogen info
5. Test with existing guilds

**Phase 2** (All Pathogens - Extraction):
1. Create `src/Stage_4/02_extract_all_pathogens.py`
2. Extract ALL pathogenOf from GloBI (remove kingdom filter)
3. Classify: fungi, oomycetes, bacteria, viruses, nematodes
4. Save to `data/stage4/plant_all_pathogens.parquet`

**Phase 3** (All Pathogens - Display):
1. Update guild_scorer_v3.py to load all pathogen types
2. Build separate profiles per pathogen type
3. Update markdown export with separate sections per type
4. Add coverage warnings per pathogen type

### Key Design Decisions

**Sorting**: Shared organisms first (by n_plants desc), then alphabetical
**Display**: ğŸ”´ critical (â‰¥50%), ğŸŸ  high (â‰¥2 plants), âšª low (1 plant)
**Coverage**: Always show "X/Y plants have data (Z% global coverage)"
**Validation**: Fungi validated via FungalTraits, others "observational data"
**Not used in scoring**: Prominent caveat in display

---

**Next Step**: Implement Phase 1 (fungi only) in guild_scorer_v3.py and test with diverse guilds.
