# Stage 4.4: Guild Builder Prototype - Implementation Plan

## Objective

Build a functional prototype Guild Builder CLI that demonstrates the full workflow:
- Select 10 random plants (or user-specified)
- Analyze internal guild compatibility
- Recommend compatible additions
- Provide detailed explanations with organism evidence

## Approach: 100-Plant Test Dataset

Use the 100 test plants already extracted to create a working prototype without waiting 3 hours.

### Advantages
- Fast iteration (minutes instead of hours)
- Validates entire pipeline end-to-end
- Demonstrates frontend capabilities
- Easy to debug and refine

### Limitations
- Only 100 plants available (sufficient for testing)
- Fewer interaction data points per plant
- Once validated, can run full 11,680 plant pipeline

## Implementation Steps

### Step 1: Complete Test Pipeline (Run Stages 2-4)

Already done: Stage 1 (100 plants extracted)

**Run remaining stages:**

```bash
cd /home/olier/ellenberg

# Stage 2: Multi-trophic network (5-10 min on test data)
/home/olier/miniconda3/envs/AI/bin/python src/Stage_4/02_build_multitrophic_network.py --test

# Stage 3: Cross-plant benefits (5-10 min)
/home/olier/miniconda3/envs/AI/bin/python src/Stage_4/03_compute_cross_plant_benefits.py --test

# Stage 4: Compatibility matrix (5-10 min for 100 plants = 4,950 pairs)
/home/olier/miniconda3/envs/AI/bin/python src/Stage_4/04_compute_compatibility_matrix.py --test --cores 8

# Stage 5: Validation
/home/olier/miniconda3/envs/AI/bin/python src/Stage_4/05_validate_compatibility_matrix.py --test
```

**Total time**: 15-30 minutes

**Output**: `data/stage4/compatibility_matrix_full_test.parquet` (~5 MB)

### Step 2: Build Prototype CLI Interface

**Script**: `src/Stage_4/guild_builder_prototype.py`

**Features:**

1. **Guild Analysis Mode**
   - User provides 10 plant WFO IDs (or random selection)
   - Display overall guild compatibility score
   - Show all pairwise relationships (10 choose 2 = 45 pairs)
   - For each pair, show:
     - Compatibility score
     - Top 3 reasons why compatible/incompatible
     - Organism evidence

2. **Recommendation Mode**
   - Given the 10 selected plants
   - Find top 10 most compatible additions from remaining 90
   - For each recommendation:
     - Average compatibility with guild
     - Best/worst compatibility in guild
     - Key reasons (e.g., "attracts predators of your pests")
     - Organism evidence

3. **Output Format**
   - Formatted CLI output with colors (optional)
   - Markdown export for documentation
   - JSON export for API prototyping

### CLI Interface Design

```
╔══════════════════════════════════════════════════════════════════╗
║              GUILD BUILDER PROTOTYPE v0.1                        ║
╚══════════════════════════════════════════════════════════════════╝

Your Guild (10 Plants):
  1. Acacia melanoxylon
  2. Acacia harpophylla
  3. Acacia auriculiformis
  ...

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
GUILD ANALYSIS
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Overall Guild Score: ★★★☆☆ (0.62)
  - 23/45 pairs are compatible (score > 0)
  - 15/45 pairs are neutral
  - 7/45 pairs are antagonistic (score < 0)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
INTERNAL RELATIONSHIPS
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Best Partnership: Acacia melanoxylon ↔ Acacia auriculiformis
  Score: ★★★★★ (0.78)

  Why they work together:
  ✓ Different herbivores (pest diversification: +0.08)
  ✓ No shared pathogens (disease protection: +0.20)
  ✓ Acacia melanoxylon attracts 3 predators of Acacia auriculiformis pests
    - Coccinella septempunctata eats aphids
    - Chrysoperla carnea larvae eat thrips

  Minor concerns:
  ⚠ Share 2 herbivores: Paropsis atomaria, Uromycladium spp. (-0.03)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Worst Partnership: Acacia dealbata ↔ Acacia mearnsii
  Score: ★☆☆☆☆ (-0.12)

  Why they conflict:
  ✗ Share 8 herbivores (pest concentration: -0.15)
    - Paropsis atomaria (common on both)
    - Uromycladium tepperianum (rust fungus)
  ✗ Share 3 pathogens (disease transmission risk: -0.25)
    - Ceratocystis (wilt disease)

  Risk management:
  - Plant at least 5m apart to reduce pest/disease spread
  - Monitor closely for shared pests

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
[Show all 45 pairs with --verbose flag]

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
RECOMMENDED ADDITIONS
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Top 10 Plants to Add to Your Guild:

1. Banksia integrifolia ★★★★★ (Avg: 0.82)

   Why this works:
   ✓ Attracts hoverflies that control aphids on 6 of your plants
   ✓ No shared pathogens with any guild member
   ✓ Different herbivore profile (diversifies pest pressure)

   Best compatibility: with Acacia melanoxylon (0.89)
   Worst compatibility: with Acacia dealbata (0.65)

   Beneficial organisms:
   - Episyrphus balteatus (hoverfly) → eats aphids on your acacias
   - Harmonia conformis (ladybug) → eats scale insects
   - Attracts 15 unique pollinators

2. Eucalyptus camaldulensis ★★★★☆ (Avg: 0.74)
   ...

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Export Options:
  --json output.json    Export results as JSON
  --markdown report.md  Export as Markdown report
  --csv pairs.csv       Export pairwise scores as CSV
```

### Script Architecture

```python
# src/Stage_4/guild_builder_prototype.py

class GuildBuilder:
    def __init__(self, compatibility_matrix_path, profiles_path):
        """Load compatibility matrix and plant profiles."""
        self.matrix = load_matrix()
        self.profiles = load_profiles()

    def select_random_guild(self, n=10):
        """Select n random plants from available species."""
        return random.sample(self.all_plants, n)

    def analyze_guild(self, plant_ids):
        """Analyze internal compatibility of selected plants."""
        # Get all pairwise scores within guild
        # Calculate overall guild score
        # Identify best/worst partnerships
        # Return structured analysis

    def recommend_additions(self, plant_ids, top_n=10):
        """Recommend top N compatible plants to add."""
        # For each candidate (not in guild)
        # Calculate avg compatibility with guild members
        # Rank by compatibility
        # Return top N with explanations

    def format_explanation(self, plant_a, plant_b, score, evidence):
        """Generate human-readable explanation of compatibility."""
        # Parse component scores
        # Identify key positive/negative factors
        # Format organism evidence
        # Return formatted string

    def export_json(self, analysis, filename):
        """Export analysis as JSON for API prototyping."""

    def export_markdown(self, analysis, filename):
        """Export as Markdown report."""
```

### Usage Examples

```bash
# Random guild analysis
python src/Stage_4/guild_builder_prototype.py --random

# Specific plants (by WFO ID)
python src/Stage_4/guild_builder_prototype.py \
    --plants wfo-0000001,wfo-0000002,... \
    --recommend 10

# Interactive mode (prompt user for plants)
python src/Stage_4/guild_builder_prototype.py --interactive

# Export results
python src/Stage_4/guild_builder_prototype.py --random \
    --json results.json \
    --markdown report.md

# Verbose mode (show all pairwise details)
python src/Stage_4/guild_builder_prototype.py --random --verbose
```

## Step 3: Test and Iterate

### Test Cases

1. **Random guild of 10**
   - Should complete in <1 second (lookup only)
   - Check that explanations make sense
   - Verify organism lists are accurate

2. **Known incompatible plants**
   - Select plants with shared pathogens
   - Should show negative scores with clear warnings

3. **Known compatible plants**
   - Select plants with biological control benefits
   - Should show positive scores with beneficial organisms

4. **Edge cases**
   - Plants with no interaction data (should still work)
   - All 10 plants identical (should detect)

### Refinement

Based on test results:
- Adjust component weights if needed
- Improve explanation formatting
- Add more detailed organism info
- Handle edge cases gracefully

## Step 4: Upgrade to Full Dataset

Once prototype validated:

```bash
# Run full pipeline (3 hours)
./run_full_guild_builder_pipeline.sh

# Use same prototype script with full matrix
python src/Stage_4/guild_builder_prototype.py \
    --matrix data/stage4/compatibility_matrix_full.parquet \
    --random
```

No code changes needed - just point to full matrix instead of test matrix.

## Timeline

| Task | Time | Status |
|------|------|--------|
| Run test pipeline stages 2-4 | 30 min | Pending |
| Build prototype CLI | 2 hours | Pending |
| Test with random guilds | 30 min | Pending |
| Refine explanations | 1 hour | Pending |
| Document prototype | 30 min | Pending |
| **Total** | **4.5 hours** | |

## Success Criteria

Prototype successfully demonstrates:
- [x] Fast guild analysis (<1 second)
- [x] Clear compatibility scores
- [x] Actionable recommendations
- [x] Organism-level explanations
- [x] Export capabilities (JSON/Markdown)
- [x] Ready to scale to full 11,680 plants

---

**Plan Version**: 1.0
**Dataset**: 100 test plants
**Target**: Working prototype in 4-5 hours
**Next Step**: Run stages 2-4 on test data
