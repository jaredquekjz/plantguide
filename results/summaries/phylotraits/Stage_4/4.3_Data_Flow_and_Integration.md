# Stage 4.3: Data Flow and Integration Architecture

**Date Created**: 2025-11-04
**Purpose**: Complete documentation of how all Stage 4 scripts, datasets, and components interact
**Status**: Reference Document

---

## Executive Summary

Stage 4 has **two distinct use cases** with different data requirements:

1. **Guild Builder** (7-plant guilds) → Uses `guild_scorer_v3.py` → Requires fungal guilds
2. **Plant Doctor** (2-plant pairs) → Uses `compatibility_matrix.py` → Uses organism profiles

**Key insight**: Fungal data flows through TWO separate extraction paths for different purposes.

**Data Quality Verification**: See Document 4.3b for comprehensive examination of all extraction scripts, output validation, and identification of critical issues (including GloBI relationship inversion in pathogen_antagonists.parquet).

---

## Part 1: Data Extraction Scripts

### 1.1 GloBI Interactions Dataset (Input)

**File**: `data/stage4/globi_interactions_final_dataset_11680.parquet`

**Created by**: Stage 3 (legacy script in `src/Stage_4/legacy/extract_globi_interactions_final_dataset.py`)

**Contents**:
- All organism interactions for 11,680 plants
- Columns: `target_wfo_taxon_id`, `sourceTaxonName`, `interactionTypeName`, `sourceTaxonKingdomName`, etc.
- Interaction types: `hasHost`, `pathogenOf`, `parasiteOf`, `pollinates`, `eats`, `preysOn`, etc.

**Size**: ~600K interaction records

**Used by**: All extraction scripts below

---

### 1.2 Fungal Guild Extraction (For Guild Builder)

**Script**: `src/Stage_4/01_extract_fungal_guilds_hybrid.py`

**Input**:
- `data/stage4/globi_interactions_final_dataset_11680.parquet` (GloBI data)
- `data/fungaltraits/fungaltraits.parquet` (FungalTraits database)
- `data/funguild/funguild.parquet` (FunGuild database)

**Process**:
1. Extract fungi from GloBI where `interactionTypeName = 'hasHost'` AND `sourceTaxonKingdomName = 'Fungi'`
2. Match fungal genera to FungalTraits (primary) or FunGuild (fallback)
3. Classify into guilds based on lifestyle:
   - Pathogenic (with host-specific flag)
   - AMF (arbuscular mycorrhizal)
   - EMF (ectomycorrhizal)
   - Endophytic
   - Saprotrophic
   - Mycoparasite (biocontrol)
   - Entomopathogenic (biocontrol)

**Output**: `data/stage4/plant_fungal_guilds_hybrid.parquet`

**Schema**:
```python
{
    'plant_wfo_id': str,
    'pathogenic_fungi': list[str],              # Fungal genera
    'pathogenic_fungi_host_specific': list[str],
    'amf_fungi': list[str],
    'emf_fungi': list[str],
    'endophytic_fungi': list[str],
    'saprotrophic_fungi': list[str],
    'mycoparasite_fungi': list[str],
    'entomopathogenic_fungi': list[str],
    # ... counts and tracking columns
}
```

**Coverage**: 11,680 plants
- Pathogenic: 6,989 plants (59.8%)
- Saprotrophic: 4,650 plants (39.8%)
- Endophytic: 1,877 plants (16.1%)
- Mycoparasites: 305 plants (2.6%)
- Entomopathogens: 264 plants (2.3%)

**Used by**:
- ✓ `guild_scorer_v3.py` (Guild Builder)
- ✓ `calibrate_normalizations_simple.py`
- ✗ NOT used by compatibility_matrix.py

**References**:
- Document 4.1b: Fungal guild classification methodology
- Document 4.3b (Script 1): Data extraction verification and quality assessment

---

### 1.3 Organism Profile Extraction (For Plant Doctor)

**Script**: `src/Stage_4/01_extract_organism_profiles.py`

**Input**:
- `data/stage4/globi_interactions_final_dataset_11680.parquet` (GloBI data)

**Process**:
1. Extract pollinators where `interactionTypeName = 'pollinates'`
2. Extract herbivores where `interactionTypeName IN ('eats', 'preysOn')` AND exclude pollinators
3. Extract pathogens where:
   - `interactionTypeName IN ('pathogenOf', 'parasiteOf')` OR
   - `interactionTypeName = 'hasHost' AND sourceTaxonKingdomName = 'Fungi'`
4. Extract flower visitors where `interactionTypeName IN ('pollinates', 'visitsFlowersOf', 'visits')`

**Output**: `data/stage4/plant_organism_profiles.parquet`

**Schema**:
```python
{
    'plant_wfo_id': str,
    'pollinators': list[str],           # Organism species names
    'pollinator_count': int,
    'herbivores': list[str],
    'herbivore_count': int,
    'pathogens': list[str],             # Includes fungi via hasHost!
    'pathogen_count': int,
    'flower_visitors': list[str],
    'visitor_count': int
}
```

**Coverage**: 11,680 plants
- Pollinators: 1,556 plants (13.3%)
- Herbivores: 3,863 plants (33.1%)
- Pathogens: 7,431 plants (63.6%) - includes fungi from hasHost
- Flower visitors: 3,052 plants (26.1%)

**Used by**:
- ✓ `guild_scorer_v3.py` (for N2, P1, P6 - herbivores/pollinators only)
- ✓ `compatibility_matrix.py` (for Plant Doctor - uses ALL columns including pathogens)
- ✓ `calibrate_normalizations_simple.py`

**Important**: The `pathogens` column includes fungi but stores RAW organism names, NOT guild classifications. Guild scoring uses `plant_fungal_guilds_hybrid.parquet` for classified fungal data instead.

**References**:
- Document 4.1c: Herbivore/pollinator matching assessment
- Document 4.3b (Script 2): Data extraction verification and quality assessment

---

### 1.4 Relationship Lookup Tables (For P1/P2)

#### Herbivore-Predator Table

**Script**: `src/Stage_4/02_build_multitrophic_network.py`

**Process**: For each herbivore, find its predators in GloBI

**Output**: `data/stage4/herbivore_predators.parquet`

**Schema**:
```python
{
    'herbivore': str,           # Herbivore species name
    'predators': list[str]      # Predator species names
}
```

**Used by**: P1 biocontrol (Mechanism 1 - animal predators)

**Reference**: Document 4.3b (Script 3a): Data extraction verification and quality assessment

---

#### Insect-Fungal Parasite Table

**Script**: `src/Stage_4/02b_extract_insect_fungal_parasites.py`

**Process**: For each herbivore, find entomopathogenic fungi that target it

**Output**: `data/stage4/insect_fungal_parasites.parquet`

**Schema**:
```python
{
    'herbivore': str,                     # Herbivore species name
    'entomopathogenic_fungi': list[str]   # Fungal genera
}
```

**Used by**: P1 biocontrol (Mechanism 2 - specific fungal parasites)

**Reference**: Document 4.3b (Script 4): Data extraction verification and quality assessment

---

#### Pathogen-Antagonist Table

**Script**: `src/Stage_4/02_build_multitrophic_network.py`

**Process**: For each pathogenic fungus, find mycoparasite fungi that target it

**Output**: `data/stage4/pathogen_antagonists.parquet`

**Schema**:
```python
{
    'pathogen': str,            # Pathogenic fungus genus
    'antagonists': list[str]    # Mycoparasite genera
}
```

**Used by**: P2 pathogen control (Mechanism 1 - specific antagonists, currently rarely matched)

**Note**: Mechanism 1 rarely triggers due to limited GloBI data. Mechanism 2 (general mycoparasite presence) is primary.

**CRITICAL**: Document 4.3b (Script 3b) identifies that this table has **INVERTED relationship semantics**:
- "pathogen" column = VICTIM (thing being attacked)
- "antagonists" column = ATTACKERS (things doing attacking)
- This inversion makes ~95% of the data unusable for P2 (contains non-fungal victims, viral attackers)
- Only ~1% represents actual fungi→mycoparasite relationships

**Reference**: Document 4.3b (Script 3b): Critical data quality assessment of relationship inversion

---

## Part 2: Guild Scoring (Guild Builder)

### 2.1 Guild Scorer V3

**Script**: `src/Stage_4/guild_scorer_v3.py`

**Purpose**: Score 2-7 plant guilds for compatibility

**Input Datasets**:

| Dataset | File | Used For |
|---------|------|----------|
| Plant traits | `perm2_11680_with_koppen_tiers_20251103.parquet` | Climate, CSR, height, phylogeny, EIVE-L |
| Fungal guilds | `plant_fungal_guilds_hybrid.parquet` | N1, P2, P3 |
| Organism profiles | `plant_organism_profiles.parquet` | N2, P1, P6 (herbivores/pollinators only) |
| Herbivore predators | `herbivore_predators.parquet` | P1 Mechanism 1 |
| Insect parasites | `insect_fungal_parasites.parquet` | P1 Mechanism 2 |
| Pathogen antagonists | `pathogen_antagonists.parquet` | P2 Mechanism 1 |
| Normalization params | `normalization_params_7plant.json` | Percentile calibration |

**Data Usage by Metric**:

```
Climate Filter (F1):
  ← plant traits: temp_min, temp_max, precip_min, precip_max

N1 (Pathogen Overlap):
  ← plant_fungal_guilds: pathogenic_fungi, pathogenic_fungi_host_specific
  ✗ NOT using organism_profiles['pathogens']

N2 (Herbivore Overlap):
  ← plant_organism_profiles: herbivores, flower_visitors (for exclusion)

N4 (CSR Conflicts):
  ← plant traits: CSR_C, CSR_S, CSR_R, light_pref (EIVEres-L), height_m, growth_form

N5 (Nitrogen Fixation):
  ← plant traits: nitrogen_fixation_rating

N6 (pH Incompatibility):
  ← plant traits: EIVEres-R (as pH proxy)

P1 (Biocontrol):
  ← plant_organism_profiles: herbivores, flower_visitors
  ← plant_fungal_guilds: entomopathogenic_fungi
  ← herbivore_predators: predator lookup
  ← insect_fungal_parasites: fungal parasite lookup

P2 (Pathogen Control):
  ← plant_fungal_guilds: pathogenic_fungi, mycoparasite_fungi
  ← pathogen_antagonists: antagonist lookup (rarely matched)

P3 (Beneficial Fungi):
  ← plant_fungal_guilds: amf_fungi, emf_fungi, endophytic_fungi, saprotrophic_fungi

P4 (Phylogenetic Diversity):
  ← plant traits: phylo_ev1 through phylo_ev92

P5 (Vertical Stratification):
  ← plant traits: height_m, light_pref (EIVEres-L), growth_form

P6 (Shared Pollinators):
  ← plant_organism_profiles: flower_visitors, pollinators
```

**Output**: Guild scoring result with:
- `overall_score` ∈ [0, 100] (percentile ranking)
- `metrics` dict (9 metrics, all 0-100 scale)
- `flags` dict (N5 nitrogen, N6 pH as text)
- `veto` (climate incompatibility flag)
- Detailed breakdown of all components
- Shared organisms lists

**Calibration**: Uses tier-stratified percentile normalization from `normalization_params_7plant.json`

---

### 2.2 Why Two Fungal Data Sources?

**Question**: Why do we have both `plant_fungal_guilds_hybrid.parquet` AND `pathogens` in `plant_organism_profiles.parquet`?

**Answer**: Different granularity and use cases:

| Aspect | Fungal Guilds | Organism Profiles |
|--------|---------------|-------------------|
| **Data source** | hasHost + FungalTraits/FunGuild | hasHost + pathogenOf + parasiteOf |
| **Classification** | ✓ Guild-classified (pathogenic, AMF, etc.) | ✗ Raw organism names only |
| **Fungi only?** | ✓ Yes (sourceTaxonKingdomName = 'Fungi') | ✗ No (includes bacteria, viruses, etc.) |
| **Coverage** | 6,989 plants (59.8%) with pathogenic fungi | 7,431 plants (63.6%) with all pathogens |
| **Used by** | Guild Builder (guild_scorer_v3) | Plant Doctor (compatibility_matrix) |
| **Metrics** | N1, P2, P3 (need guild classification) | Shared pathogen counting (no classification needed) |

**Key insight**: Guild scoring needs to know WHICH TYPE of fungus (pathogenic? mycoparasite? AMF?) for weighted calculations. Compatibility matrix just needs to count shared pathogens for overlap percentage.

---

## Part 3: Compatibility Matrix (Plant Doctor)

### 3.1 Pairwise Compatibility

**Script**: `src/Stage_4/04_compute_compatibility_matrix.py`

**Purpose**: Compute 2-plant pairwise compatibility for Plant Doctor feature

**Input**:
- `plant_organism_profiles.parquet` (uses ALL columns including pathogens)
- `cross_plant_benefits.parquet` (from 03_compute_cross_plant_benefits.py)
- `plant_fungal_guilds_hybrid.parquet` (for beneficial fungi)

**Process**:
- For each plant pair (11,680 × 11,679 / 2 = 68M pairs)
- Compute 8 components:
  1. Shared pollinators (positive, +0.25)
  2. Pollinator diversity (positive, +0.15)
  3. Biocontrol benefits (positive, +0.20)
  4. Shared herbivores (negative, -0.30)
  5. Herbivore diversity (negative, -0.10)
  6. Predator-prey conflict (negative, -0.10)
  7. **Shared pathogens (negative, -0.40)** ← Uses organism_profiles['pathogens']!
  8. Beneficial fungi sharing (positive, +0.20)

**Output**: `data/stage4/compatibility_matrix_full.parquet`

**Schema**:
```python
{
    'plant_a': str,
    'plant_b': str,
    'compatibility_score': float,  # [-1, +1]
    'shared_pollinators': float,
    # ... other components
    'shared_pathogens_score': float,  # ← This uses organism_profiles!
    # ... evidence lists
}
```

**Use case**: "Which plant should I pair with my tomato?" → Return top 10 compatible plants

**Calibration**: Not using percentile normalization (fixed formula)

---

## Part 4: Calibration

### 4.1 Normalization Parameter Calibration

**Script**: `src/Stage_4/calibrate_normalizations_simple.py`

**Purpose**: Generate percentile parameters for guild scoring

**Inputs**:
- `perm2_11680_with_koppen_tiers_20251103.parquet` (plant traits)
- `plant_organism_profiles.parquet` (organisms)
- `plant_fungal_guilds_hybrid.parquet` (fungi)
- `herbivore_predators.parquet` (lookup)
- `insect_fungal_parasites.parquet` (lookup)
- `pathogen_antagonists.parquet` (lookup)

**Process**:
1. Generate 10,000 random climate-compatible guilds (size 2 or 7)
2. Compute RAW scores for all 11 metrics using same logic as guild_scorer_v3
3. Compute percentile distribution (p1, p5, p10, ..., p95, p99)
4. Save percentile parameters

**Outputs**:
- `normalization_params_2plant.json` (for Plant Doctor guild scoring)
- `normalization_params_7plant.json` (for Guild Builder)

**Usage**: guild_scorer_v3 loads appropriate calibration file based on context

**Parameters per metric**:
```json
{
  "n1": {
    "method": "percentile",
    "p1": 0.0001,
    "p50": 0.0234,
    "p99": 0.3456,
    "mean": 0.0456,
    "std": 0.0678,
    "n_samples": 10000
  },
  // ... for all 11 metrics
}
```

---

## Part 5: Complete Data Flow Diagram

```
┌─────────────────────────────────────────────────────────────────┐
│                    STAGE 3 (Input)                              │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ globi_interactions_final_dataset_11680.parquet
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│                   STAGE 4.1: EXTRACTION                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────┐      ┌──────────────────────────┐ │
│  │ 01_extract_fungal_guilds│      │ 01_extract_organism      │ │
│  │         _hybrid.py      │      │     _profiles.py         │ │
│  │                         │      │                          │ │
│  │ Input: GloBI + FT + FG  │      │ Input: GloBI only        │ │
│  │                         │      │                          │ │
│  │ Process:                │      │ Process:                 │ │
│  │ • hasHost (fungi only)  │      │ • pollinates             │ │
│  │ • Match FungalTraits    │      │ • eats/preysOn           │ │
│  │ • Classify into guilds  │      │ • hasHost (all kingdoms) │ │
│  │                         │      │ • pathogenOf/parasiteOf  │ │
│  │ Output:                 │      │                          │ │
│  │ plant_fungal_guilds     │      │ Output:                  │ │
│  │     _hybrid.parquet     │      │ plant_organism           │ │
│  │                         │      │     _profiles.parquet    │ │
│  │ • pathogenic_fungi      │      │                          │ │
│  │ • mycoparasite_fungi    │      │ • herbivores             │ │
│  │ • AMF/EMF/endo/sapro    │      │ • pollinators            │ │
│  │ • entomopathogenic      │      │ • pathogens (raw names)  │ │
│  └─────────────────────────┘      │ • flower_visitors        │ │
│             │                      └──────────────────────────┘ │
│             │                                    │               │
└─────────────┼────────────────────────────────────┼───────────────┘
              │                                    │
              │                                    │
┌─────────────┼────────────────────────────────────┼───────────────┐
│             │        STAGE 4.2: LOOKUP TABLES    │               │
│             │                                    │               │
│             │    ┌────────────────────────────┐  │               │
│             │    │ 02_build_multitrophic      │  │               │
│             │    │       _network.py          │  │               │
│             │    │                            │  │               │
│             │    │ Creates:                   │  │               │
│             │    │ • herbivore_predators      │  │               │
│             │    │ • pathogen_antagonists     │  │               │
│             │    └────────────────────────────┘  │               │
│             │                                    │               │
│             │    ┌────────────────────────────┐  │               │
│             │    │ 02b_extract_insect         │  │               │
│             │    │    _fungal_parasites.py    │  │               │
│             │    │                            │  │               │
│             │    │ Creates:                   │  │               │
│             │    │ • insect_fungal_parasites  │  │               │
│             │    └────────────────────────────┘  │               │
│             │                                    │               │
└─────────────┼────────────────────────────────────┼───────────────┘
              │                                    │
              ▼                                    ▼
┌─────────────────────────────────────────────────────────────────┐
│              STAGE 4.3: GUILD SCORING (Guild Builder)           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │              guild_scorer_v3.py                          │  │
│  │                                                           │  │
│  │  Loads:                                                   │  │
│  │  • perm2_11680_with_koppen_tiers_20251103 (traits)      │  │
│  │  • plant_fungal_guilds_hybrid ← N1, P2, P3              │  │
│  │  • plant_organism_profiles ← N2, P1, P6                 │  │
│  │  • herbivore_predators ← P1                              │  │
│  │  • insect_fungal_parasites ← P1                          │  │
│  │  • pathogen_antagonists ← P2                             │  │
│  │  • normalization_params_7plant.json                      │  │
│  │                                                           │  │
│  │  Computes:                                                │  │
│  │  • Climate filter (F1)                                    │  │
│  │  • Raw scores for 9 metrics (N1, N2, N4, P1-P6)         │  │
│  │  • Percentile conversion (tier-stratified)               │  │
│  │  • Metric inversion (N1-N4: high raw = bad → low display)│  │
│  │  • Overall score: mean(9 metrics) ∈ [0, 100]            │  │
│  │  • Flags: N5 (nitrogen), N6 (pH) as text                 │  │
│  │                                                           │  │
│  │  Output: Guild scoring result with detailed breakdown    │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│          STAGE 4.4: PAIRWISE COMPATIBILITY (Plant Doctor)       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │         04_compute_compatibility_matrix.py               │  │
│  │                                                           │  │
│  │  Loads:                                                   │  │
│  │  • plant_organism_profiles ← ALL columns (incl pathogens)│  │
│  │  • cross_plant_benefits                                   │  │
│  │  • plant_fungal_guilds_hybrid ← beneficial fungi         │  │
│  │                                                           │  │
│  │  Computes 8 components per plant pair:                    │  │
│  │  1. Shared pollinators (+)                                │  │
│  │  2. Pollinator diversity (+)                              │  │
│  │  3. Biocontrol benefits (+)                               │  │
│  │  4. Shared herbivores (-)                                 │  │
│  │  5. Herbivore diversity (-)                               │  │
│  │  6. Predator-prey conflict (-)                            │  │
│  │  7. Shared pathogens (-) ← Uses organism_profiles!       │  │
│  │  8. Beneficial fungi sharing (+)                          │  │
│  │                                                           │  │
│  │  Output: compatibility_matrix_full.parquet               │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│              STAGE 4.5: CALIBRATION                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │      calibrate_normalizations_simple.py                   │  │
│  │                                                           │  │
│  │  Loads: ALL datasets (traits, fungi, organisms, lookups) │  │
│  │                                                           │  │
│  │  Process:                                                 │  │
│  │  1. Generate 20K guilds per Köppen tier (6 tiers)       │  │
│  │     Total: 120K guilds for tier-stratified calibration   │  │
│  │  2. Compute raw scores (same logic as guild_scorer_v3)   │  │
│  │  3. Compute percentile distributions (p1-p99)            │  │
│  │  4. Save tier-stratified parameters                      │  │
│  │                                                           │  │
│  │  Outputs:                                                 │  │
│  │  • normalization_params_2plant.json                      │  │
│  │  • normalization_params_7plant.json                      │  │
│  └──────────────────────────────────────────────────────────┘  │
│                     │                                           │
│                     └─────────┐                                 │
│                               ▼                                 │
│                        ┌─────────────┐                          │
│                        │ Used by     │                          │
│                        │ guild_scorer│                          │
│                        │   _v3.py    │                          │
│                        └─────────────┘                          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## Part 6: Key Insights and Gotchas

### 6.1 Why Two Fungal Extraction Methods?

**Fungal guilds** (01_extract_fungal_guilds_hybrid.py):
- **Purpose**: Guild classification for weighted scoring
- **Filters**: Only fungi (`sourceTaxonKingdomName = 'Fungi'`)
- **Classification**: Uses FungalTraits + FunGuild to assign guilds
- **Granularity**: Genus level
- **Use case**: Guild Builder needs to know "is this a mycoparasite or a pathogen?"

**Organism profiles** (01_extract_organism_profiles.py):
- **Purpose**: Simple organism name lists for overlap calculations
- **Filters**: All kingdoms (fungi, bacteria, viruses, etc.)
- **Classification**: None (raw organism names)
- **Granularity**: Species level (from GloBI)
- **Use case**: Plant Doctor just needs "do these plants share pathogens?"

**Why not merge?**
- Guild classification is expensive (requires database matching)
- Compatibility matrix doesn't need guild info (just counts overlaps)
- Organism profiles include non-fungal pathogens (bacteria, viruses)
- Different granularity (genus vs species)

### 6.2 The "pathogens" Column Confusion

**Before fix** (2025-11-04 10:04):
```
Pathogens: 1,662 plants (14.2%)
Logic: pathogenOf + parasiteOf only
```

**After fix** (2025-11-04 10:12):
```
Pathogens: 7,431 plants (63.6%)
Logic: pathogenOf + parasiteOf + hasHost (Fungi)
```

**Impact**:
- ✓ Plant Doctor compatibility matrix now has proper pathogen overlap data
- ✗ Guild Builder scoring UNCHANGED (doesn't use organism_profiles['pathogens'])

**Lesson**: The hasHost fix helps Plant Doctor, not Guild Builder. Guild Builder already had correct fungal data via fungal guilds extraction.

### 6.3 P1/P2 Lookup Table Performance

**Why dictionary-based lookups?**

**Bad approach** (nested DataFrame filtering):
```python
for plant_a in guild:
    for plant_b in guild:
        herbivores_a = organisms_df[organisms_df['plant_wfo_id'] == plant_a]['herbivores']
        predators_b = organisms_df[organisms_df['plant_wfo_id'] == plant_b]['flower_visitors']
        # 49 DataFrame filters for 7-plant guild!
```
**Performance**: ~10 guilds/sec

**Good approach** (pre-built dictionaries):
```python
# Build lookup ONCE
plant_herbivores = {row['plant_wfo_id']: set(row['herbivores']) for _, row in organisms_df.iterrows()}
plant_predators = {row['plant_wfo_id']: set(row['flower_visitors']) for _, row in organisms_df.iterrows()}

# Fast lookup in loops
for plant_a in guild:
    for plant_b in guild:
        herbivores_a = plant_herbivores.get(plant_a, set())
        predators_b = plant_predators.get(plant_b, set())
        # Dictionary lookup: O(1)
```
**Performance**: ~250 guilds/sec (25× faster!)

**Result**: P1/P2 can be included in calibration without killing performance.

### 6.4 Calibration Guild Sizes

**Why two separate calibrations?**

| Aspect | 2-Plant | 7-Plant |
|--------|---------|---------|
| **Use case** | Plant Doctor (pairwise) | Guild Builder (multi-plant) |
| **Distribution** | Lower P1/P2 (fewer pairs) | Higher P1/P2 (more pairs) |
| **Climate filter** | Easier to pass | Harder to pass |
| **Score range** | Different percentiles | Different percentiles |

**Example**: A P1 raw score of 1.5 might be:
- 90th percentile for 2-plant guilds (impressive!)
- 30th percentile for 7-plant guilds (mediocre)

**Solution**: Separate calibration files ensure proper percentile mapping for each context.

### 6.5 Multi-Guild Fungi (Intentional Double Counting)

**Example**: Alternaria genus
- Appears in `pathogenic_fungi` (N1 penalty)
- Appears in `saprotrophic_fungi` (P3 benefit)

**Why?**
- Ecologically correct: Alternaria IS both a pathogen and a decomposer
- Represents real trade-offs in guild design
- Deduplication happens WITHIN metrics (via set operations)
- NOT deduplicated ACROSS metrics (intentional)

**User guidance**: "Your guild has Alternaria - it's a pathogen risk BUT also helps decompose organic matter. Consider if the trade-off is worth it."

---

## Part 7: File Inventory

### Input Files (External)

| File | Created By | Used By | Size |
|------|-----------|---------|------|
| `perm2_11680_with_koppen_tiers_20251103.parquet` | Stage 3 | guild_scorer_v3, calibration | 26MB |
| `globi_interactions_final_dataset_11680.parquet` | Stage 3 | All extraction scripts | ~600K rows |
| `fungaltraits.parquet` | External | 01_extract_fungal_guilds_hybrid | 10,765 genera |
| `funguild.parquet` | External | 01_extract_fungal_guilds_hybrid | 15,886 records |

### Extracted Datasets

| File | Created By | Used By | Coverage |
|------|-----------|---------|----------|
| `plant_fungal_guilds_hybrid.parquet` | 01_extract_fungal_guilds_hybrid | guild_scorer_v3, calibration | 11,680 plants |
| `plant_organism_profiles.parquet` | 01_extract_organism_profiles | guild_scorer_v3, compatibility_matrix, calibration | 11,680 plants |

### Lookup Tables

| File | Created By | Used By | Records |
|------|-----------|---------|---------|
| `herbivore_predators.parquet` | 02_build_multitrophic_network | P1 | ~5,000 |
| `insect_fungal_parasites.parquet` | 02b_extract_insect_fungal_parasites | P1 | ~1,000 |
| `pathogen_antagonists.parquet` | 02_build_multitrophic_network | P2 | ~500 |

### Calibration Files

| File | Created By | Used By | Contents |
|------|-----------|---------|----------|
| `normalization_params_2plant.json` | calibrate_normalizations_simple | guild_scorer_v3 (Plant Doctor) | Percentiles for 11 metrics |
| `normalization_params_7plant.json` | calibrate_normalizations_simple | guild_scorer_v3 (Guild Builder) | Percentiles for 11 metrics |

### Output Files

| File | Created By | Used By | Purpose |
|------|-----------|---------|---------|
| `compatibility_matrix_full.parquet` | 04_compute_compatibility_matrix | Plant Doctor frontend | 68M plant pairs |
| `cross_plant_benefits.parquet` | 03_compute_cross_plant_benefits | compatibility_matrix | Biocontrol relationships |

---

## Part 8: Metric Data Dependencies

Quick reference for "which dataset does each metric need?"

| Metric | Trait Data | Fungal Guilds | Organism Profiles | Lookup Tables |
|--------|-----------|---------------|-------------------|---------------|
| **F1** (Climate) | ✓ temp, precip | | | |
| **N1** (Pathogen Fungi) | | ✓ pathogenic_fungi | | |
| **N2** (Herbivores) | | | ✓ herbivores | |
| **N4** (CSR Conflicts) | ✓ CSR, light, height, form | | | |
| **N5** (N-fixation) | ✓ nitrogen_fixation_rating | | | |
| **N6** (pH) | ✓ EIVEres-R | | | |
| **P1** (Biocontrol) | | ✓ entomopathogenic_fungi | ✓ herbivores, visitors | ✓ predators, parasites |
| **P2** (Pathogen Control) | | ✓ pathogenic_fungi, mycoparasites | | ✓ antagonists |
| **P3** (Beneficial Fungi) | | ✓ AMF, EMF, endo, sapro | | |
| **P4** (Phylo Diversity) | ✓ phylo_ev1-92 | | | |
| **P5** (Stratification) | ✓ height, light, form | | | |
| **P6** (Pollinators) | | | ✓ flower_visitors, pollinators | |

---

## Part 9: Execution Order

For a fresh Stage 4 pipeline run:

### Phase 1: Data Extraction (Parallel)
```bash
# Can run in parallel
python src/Stage_4/01_extract_organism_profiles.py &
python src/Stage_4/01_extract_fungal_guilds_hybrid.py &
wait
```

### Phase 2: Lookup Tables (Sequential, depends on Phase 1)
```bash
python src/Stage_4/02_build_multitrophic_network.py
python src/Stage_4/02b_extract_insect_fungal_parasites.py
```

### Phase 3: Calibration (Depends on Phases 1-2)
```bash
# Run sequentially (or parallel with different output files)
python src/Stage_4/calibrate_normalizations_simple.py --guild-size 2
python src/Stage_4/calibrate_normalizations_simple.py --guild-size 7
```

### Phase 4: Optional - Compatibility Matrix (For Plant Doctor)
```bash
python src/Stage_4/03_compute_cross_plant_benefits.py
python src/Stage_4/04_compute_compatibility_matrix.py
```

**Total time estimate**: ~2-3 hours for complete pipeline

---

## Part 10: Testing and Validation

### Unit Test: Guild Scorer
```bash
python src/Stage_4/guild_scorer_v3.py
# Tests 3-plant guild, outputs score
```

### Integration Test: Known Guilds
```bash
python src/Stage_4/test_guilds_v3.py
# Tests benchmark guilds against expected scores
```

### Calibration Validation
```bash
# After calibration, test that percentiles work
python -c "
from guild_scorer_v3 import GuildScorerV3
scorer = GuildScorerV3(calibration_type='7plant')
result = scorer.score_guild(['wfo-123', 'wfo-456', ...])
print(f'Score: {result[\"guild_score\"]:.3f}')
"
```

---

## Document Status

**Status**: Complete reference document
**Last Updated**: 2025-11-04
**Maintainer**: System documentation (auto-generated from codebase audit)

**Cross-references**:
- Document 4.1b: Fungal guild classification details
- Document 4.1c: Herbivore/pollinator matching assessment
- Document 4.2: Unified Percentile Framework (metric formulas and framework)
- Document 4.2b: Statistical Verification of Components (scoring algorithm validation)
- **Document 4.3b: Data Extraction Verification (extraction script validation and quality assessment)**
- archive/: Deprecated framework documents
