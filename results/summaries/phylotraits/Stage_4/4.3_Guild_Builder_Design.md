# Stage 4.2: Guild Builder - Mathematical Compatibility Framework

## Objective

Design an algorithm to quantify compatibility between plant species based on their biotic interaction networks. The core principle: plants with complementary interaction profiles create stable, mutually beneficial guilds.

## Key Insight: Multi-Trophic Network Analysis

Using the **full GloBI dataset** (20.4M interactions, not just plants-only) enables tracking indirect effects through food webs:

- Plant A attracts Herbivore H1
- Herbivore H1 is eaten by Predator P1
- Therefore: Plant A indirectly benefits any plant that suffers from H1

This requires analyzing 2-3 step interaction chains, not just direct plant-organism links.

## Interaction Categories and Scoring Logic

### 1. Positive Interactions (Complementarity)

#### 1.1 Shared Beneficial Organisms (+)

**Pollinators**: Plants sharing pollinators create pollination networks
- Formula: `shared_pollinators(A,B) / union_pollinators(A,B)`
- Rationale: More pollinator visits benefit both species
- Weight: HIGH (direct reproductive benefit)

**Natural Enemies of Pests**: Plant A attracts predators that eat pests of Plant B
- Formula: `count(predators_of_B_pests attracted_by_A)`
- Rationale: Biological pest control via companion planting
- Weight: HIGH (reduces pest pressure on B)
- **Requires multi-trophic data**: Trace A → Predator P → eats → Herbivore H (pest of B)

**Natural Enemies of Pathogens**: Plant A attracts organisms that antagonize pathogens of Plant B
- Formula: `count(antagonists_of_B_pathogens attracted_by_A)`
- Rationale: Biological disease suppression
- Weight: MEDIUM (fungal/bacterial antagonism less direct)
- **Requires multi-trophic data**: A → Organism O → parasitizes/eats → Pathogen of B

#### 1.2 Pest/Pathogen Diversification (+)

**Different Herbivores**: Plants attracting non-overlapping herbivores spread risk
- Formula: `1 - jaccard_similarity(herbivores_A, herbivores_B)`
- Rationale: Enemy release through diversification
- Weight: MEDIUM (prevents monoculture effects)

**Different Pathogens**: Plants with distinct pathogen profiles reduce disease spread
- Formula: `1 - jaccard_similarity(pathogens_A, pathogens_B)`
- Rationale: Pathogen specialization prevents epidemic transmission
- Weight: HIGH (disease prevention critical)

#### 1.3 Indirect Pollinator Attraction (+)

**Pollinator Spillover**: Plant A with abundant pollinators increases visitation to nearby Plant B
- Formula: `pollinator_abundance_A * pollinator_generalism * spatial_proximity`
- Rationale: Highly attractive plants boost neighborhood pollination
- Weight: MEDIUM (indirect but valuable)

### 2. Negative Interactions (Competition/Antagonism)

#### 2.1 Shared Pests (-)

**Overlapping Herbivores**: Plants sharing herbivorous pests concentrate pest pressure
- Formula: `shared_herbivores(A,B) / union_herbivores(A,B)`
- Rationale: Pest populations amplify when hosts are adjacent
- Weight: HIGH (direct fitness cost)

**Severity Weighting**: Weight by herbivore impact
- Agricultural pests (aphids, beetles): Higher weight
- Generalist herbivores: Lower weight
- Formula: `sum(shared_pest_severity_scores)`

#### 2.2 Shared Pathogens (-)

**Overlapping Disease Agents**: Plants sharing pathogens facilitate disease transmission
- Formula: `shared_pathogens(A,B) / union_pathogens(A,B)`
- Rationale: Proximity enables pathogen spread between hosts
- Weight: VERY HIGH (disease spreads rapidly)

**Pathogen Mobility**: Weight by transmission mode
- Airborne fungi/viruses: Higher weight (spread easily)
- Soil-borne pathogens: Medium weight (persistent)
- Vector-transmitted: Depends on vector overlap

#### 2.3 Competitive Pollinator Depletion (-)

**Pollinator Competition**: Plants blooming simultaneously compete for pollinator visits
- Formula: `shared_pollinators(A,B) * temporal_overlap * pollinator_scarcity`
- Rationale: Limited pollinator availability creates competition
- Weight: LOW-MEDIUM (context-dependent)

## Multi-Trophic Network Queries

### Query 1: Predators of Plant B's Pests Attracted by Plant A

```sql
-- Find beneficial predators
WITH b_herbivores AS (
    SELECT DISTINCT sourceTaxonName AS herbivore
    FROM globi_full
    WHERE target_wfo_taxon_id = :plant_b_wfo
      AND interactionTypeName IN ('eats', 'preysOn')
),
predators_of_b_pests AS (
    SELECT DISTINCT sourceTaxonName AS predator
    FROM globi_full
    WHERE targetTaxonName IN (SELECT herbivore FROM b_herbivores)
      AND interactionTypeName IN ('eats', 'preysOn')
),
a_attracted_organisms AS (
    SELECT DISTINCT sourceTaxonName AS organism
    FROM globi_full
    WHERE target_wfo_taxon_id = :plant_a_wfo
      AND interactionTypeName IN ('pollinates', 'visitsFlowersOf', 'visits')
)
SELECT COUNT(DISTINCT predator) AS beneficial_predator_count
FROM predators_of_b_pests
WHERE predator IN (SELECT organism FROM a_attracted_organisms)
```

### Query 2: Shared Pathogen Risk

```sql
-- Calculate shared pathogen overlap
WITH a_pathogens AS (
    SELECT DISTINCT sourceTaxonName AS pathogen
    FROM globi_full
    WHERE target_wfo_taxon_id = :plant_a_wfo
      AND interactionTypeName = 'pathogenOf'
),
b_pathogens AS (
    SELECT DISTINCT sourceTaxonName AS pathogen
    FROM globi_full
    WHERE target_wfo_taxon_id = :plant_b_wfo
      AND interactionTypeName = 'pathogenOf'
)
SELECT
    (SELECT COUNT(*) FROM a_pathogens WHERE pathogen IN (SELECT pathogen FROM b_pathogens)) AS shared,
    (SELECT COUNT(DISTINCT pathogen) FROM (
        SELECT pathogen FROM a_pathogens UNION SELECT pathogen FROM b_pathogens
    )) AS total_union
```

### Query 3: Herbivore Diversification Score

```sql
-- Calculate pest diversification benefit
WITH a_herbivores AS (
    SELECT DISTINCT sourceTaxonName AS herbivore
    FROM globi_full
    WHERE target_wfo_taxon_id = :plant_a_wfo
      AND interactionTypeName IN ('eats', 'preysOn')
),
b_herbivores AS (
    SELECT DISTINCT sourceTaxonName AS herbivore
    FROM globi_full
    WHERE target_wfo_taxon_id = :plant_b_wfo
      AND interactionTypeName IN ('eats', 'preysOn')
)
SELECT
    1 - (CAST(
        (SELECT COUNT(*) FROM a_herbivores WHERE herbivore IN (SELECT herbivore FROM b_herbivores))
        AS FLOAT) /
        (SELECT COUNT(DISTINCT herbivore) FROM (
            SELECT herbivore FROM a_herbivores UNION SELECT herbivore FROM b_herbivores
        ))
    ) AS diversification_score
```

## Composite Compatibility Score

### Formula Structure

```
Compatibility(A, B) =
    w1 * shared_pollinators(A,B)
  + w2 * predators_of_B_pests_from_A(A,B)
  + w3 * predators_of_A_pests_from_B(A,B)
  + w4 * herbivore_diversification(A,B)
  + w5 * pathogen_diversification(A,B)
  - w6 * shared_herbivores(A,B)
  - w7 * shared_pathogens(A,B)
  - w8 * pollinator_competition(A,B)
```

### Suggested Weights (Preliminary)

Based on ecological impact:

| Component | Weight | Rationale |
|-----------|--------|-----------|
| Shared pollinators | +0.15 | Direct reproductive benefit |
| Predators of B's pests (from A) | +0.25 | Biological pest control |
| Predators of A's pests (from B) | +0.25 | Reciprocal pest control |
| Herbivore diversification | +0.10 | Spreading pest risk |
| Pathogen diversification | +0.20 | Critical disease prevention |
| Shared herbivores | -0.25 | Concentrated pest pressure |
| Shared pathogens | -0.40 | Epidemic disease risk |
| Pollinator competition | -0.05 | Context-dependent competition |

Weights sum to constraints: positives ≤ 1.0, negatives ≤ 1.0 (balanced)

### Normalization

All component scores normalized to [0, 1]:
- Jaccard similarity: naturally [0, 1]
- Count-based: divide by maximum observed count
- Final compatibility: range [-1, 1] where:
  - +1: Perfect complementarity
  - 0: Neutral interaction
  - -1: Strong antagonism

## Data Requirements

### From Full GloBI Dataset (20.4M rows)

**Required columns**:
- `source_wfo_taxon_id`, `target_wfo_taxon_id` (WFO matching)
- `sourceTaxonName`, `targetTaxonName` (organism identity)
- `sourceTaxonKingdomName`, `targetTaxonKingdomName` (taxonomic context)
- `interactionTypeName` (relationship type)

**Critical interaction types**:
- `eats`, `preysOn`, `preyedUponBy` (herbivory, predation)
- `pollinates`, `pollinatedBy` (pollination)
- `pathogenOf`, `hasPathogen` (disease)
- `parasiteOf`, `hasParasite` (parasitism)
- `visitsFlowersOf`, `visits` (flower visitors)

### From Final Dataset (11,680 species)

**For guild building**:
- `wfo_taxon_id` (species identifier)
- `wfo_scientific_name` (species name)

## Implementation Strategy

### Phase 1: Data Preparation

1. **Load full GloBI dataset** with WFO enrichment
   - File: `data/stage1/globi_interactions_worldflora_enriched.parquet` (20.4M rows)
   - Extract plant WFO IDs from final dataset (11,680 species)

2. **Build interaction matrices** for each plant:
   - Pollinators: Set of organisms that pollinate the plant
   - Herbivores: Set of organisms that eat the plant
   - Pathogens: Set of organisms pathogenic to the plant
   - Flower visitors: Set of organisms visiting flowers (potential predators)

3. **Build predator-prey network**:
   - Map herbivores → their predators (from full GloBI)
   - Map pathogens → their antagonists (from full GloBI)

### Phase 2: Pairwise Compatibility Calculation

For each plant pair (A, B) in the 11,680 species:

1. Calculate direct overlaps (shared pollinators, herbivores, pathogens)
2. Calculate diversification scores (Jaccard dissimilarity)
3. Query multi-trophic benefits (predators of B's pests attracted by A)
4. Aggregate weighted compatibility score

Output: 11,680 × 11,680 compatibility matrix (symmetric)

### Phase 3: Guild Optimization

Given a user's selected plants (seed set), recommend additions:

1. Calculate compatibility scores with existing guild members
2. Rank candidates by:
   - Average compatibility with guild
   - Maximum compatibility with any guild member (keystone benefit)
   - Minimum compatibility (avoid antagonists)

3. Suggest top-N compatible plants

### Phase 4: Network Visualization

Display guild as network graph:
- Nodes: Plant species
- Edge color/width: Compatibility score
- Node attributes: Key organisms attracted/repelled

## Computational Considerations

### Scalability

**11,680 × 11,680 matrix**:
- ~68 million pairwise comparisons (upper triangle)
- If each takes 100ms: ~79 days sequential
- **Solution**: Parallelization + sparse computation
  - Only compute for plants with >10 interactions (reduce matrix size)
  - Use vector operations (set operations in NumPy/Pandas)
  - Parallelize across plant pairs (embarrassingly parallel)

### Sparse Matrix Optimization

Most plant pairs will have:
- Zero shared pathogens (high sparsity)
- Zero indirect predator benefits (rare connections)

**Strategy**:
1. Pre-filter plants with zero interactions → skip pairwise computation
2. Store compatibility scores in sparse matrix format (CSR)
3. Only compute scores for plants in same geographic region (if regional data available)

## Validation Strategy

### Ecological Validation

Test predictions against known companion planting wisdom:
- Tomato + Basil (known beneficial): Expect positive score
- Tomato + Potato (solanaceae, shared pests): Expect negative score
- Clover + Grasses (nitrogen fixing): Expect positive score (if mutualist data captured)

### Statistical Validation

Compare guild recommendations to:
- Permaculture guild databases
- Agricultural intercropping trials
- Biodiversity studies (plant community composition)

Metric: Precision/recall of beneficial vs. antagonistic pairings

## Limitations

1. **Data Sparsity**: Only 75.9% of species have interaction data
2. **Interaction Strength**: GloBI is binary (presence/absence), no quantitative intensity
3. **Geographic Context**: Interactions vary by region but not captured in simple model
4. **Temporal Dynamics**: Phenology (flowering/fruiting timing) not considered
5. **Abiotic Factors**: Ignoring soil, water, light competition (addressed in later stages)

## Next Steps

1. Extract full GloBI dataset with WFO enrichment for all organisms
2. Build interaction matrices for 11,680 species
3. Implement pairwise compatibility scoring algorithm
4. Validate on known companion planting examples
5. Optimize computation for full 68M pairwise matrix
6. Build API for guild recommendations

---

**Design Stage**: 4.2 (Guild Builder Planning)
**Target Species**: 11,680
**Interaction Source**: GloBI (20.4M rows)
**Algorithm Type**: Multi-trophic network analysis with weighted compatibility scoring
