# Stage 1 — Data Pipeline Index

Date: 2025-10-21  
Maintainer: Stage 1 data engineering

This index stitches together every **current** Stage 1 summary (legacy notes live under `Stage_1/legacy/`). Use it as the master map when you need to regenerate artefacts, rerun QA, or explain the provenance of the modelling inputs.

---

## 1. End-to-end Flow

```mermaid
flowchart LR
    raw_sources([Raw Sources\nGBIF · TRY · AusTraits · WFO · Agroclim · SoilGrids]) --> raw_prep
    raw_prep[1.1 Raw Data Preparation\n1.1_Raw_Data_Preparation.md] --> wfo_norm
    wfo_norm[1.2 WFO Normalisation\n1.2_WFO_Normalisation_Verification.md] --> shortlist
    shortlist[1.3/1.4 Shortlisting\n1.3_Dataset_Construction.md · 1.4_Shortlisting_Verification.md] --> env_sampling
    env_sampling[1.5/1.6 Environmental Workflow\n1.5_Environmental_Sampling_Workflows.md · 1.6_Environmental_Verification.md] --> trait_prep
    trait_prep[1.7a-1.7d Trait Imputation Pipeline\n1.7a Feature Discovery · 1.7b Dataset Prep · 1.7c BHPMF · 1.7d XGBoost] --> phylo
    phylo[1.9 Phylogenetic Predictor\n1.9_Phylogenetic_Predictor_and_Verification.md] --> outputs
    outputs[[Stage 1 Outputs\nmodel_data/inputs/* · data/stage1/*]] --> encyclo
    env_sampling --> photos[1.8 Media QA\n1.8_iNaturalist_Media_QA.md]
    outputs --> encyclo[Modelling + Encyclopedia Pipelines]
```

---

## 2. Pipeline Checkpoints

| Step | Summary | What it covers | Key artefacts |
|------|---------|----------------|---------------|
| Raw data ingestion & parquet conversion | `1.1_Raw_Data_Preparation.md` | Source exports, parquet conversion scripts, legacy data extraction notes | `data/stage1/*.parquet` (source-level) |
| WFO normalisation & merges | `1.2_WFO_Normalisation_Verification.md` | Cross-dataset WFO reconciliation, synonym audits, legacy ID tracking | `data/stage1/master_taxa_union.parquet` |
| Shortlisting & dataset stats | `1.3_Dataset_Construction.md` · `1.4_Shortlisting_Verification.md` | Rules for shortlist tiers (master, ≥30 GBIF, modelling 1 273/1 084) and QA queries | `data/stage1/stage1_shortlist_with_gbif*.parquet` |
| Environmental sampling | `1.5_Environmental_Sampling_Workflows.md` | `src/Stage_1/Sampling/sample_env_terra.R` usage, aggregation commands, quantiles | `data/stage1/{worldclim,soilgrids,agroclime}_*.parquet` |
| Environmental QA | `1.6_Environmental_Verification.md` | Checklist outputs, null sweeps, join rehearsals | Logs in `logs/stage1_environment/<date>/` |
| Trait imputation pipeline | `1.7a_Imputation_Dataset_Preparation.md` · `1.7b_XGBoost_Experiments.md` · `1.7c_BHPMF_Gap_Filling_Imputation.md` · `1.7d_XGBoost_Production_Imputation.md` | Anti-leakage dataset preparation (Perm 1-3), hyperparameter tuning experiments (1,084 species), BHPMF gap-filling (legacy), XGBoost production imputation (11,682 species) | `model_data/inputs/mixgb_perm2_11680/` · `model_data/outputs/perm2_production/` · BHPMF outputs (legacy) |
| Phylogenetic predictor (`p_phylo`) | `1.9_Phylogenetic_Predictor_and_Verification.md` | Bill Shipley weighted neighbour implementation plus verification pipeline; trait joins with phylogenetic covariates | `model_data/outputs/p_phylo_ge30_20251021.*`, `model_data/inputs/traits_model_ready_20251021_rerun_ge30_phylo.parquet` |
| Modelling master merge & QA | `1.10_Modelling_Master_Table.md` | Final trait + phylo + WorldClim/SoilGrids/AgroClim merge, end-to-end verification | `model_data/inputs/modelling_master_20251021.{parquet,csv}` |
| Media QA | `1.8_iNaturalist_Media_QA.md` | vetted photo workflow, iNaturalist download QA | `logs/stage1_media/*` |
| AusTraits categorical mapping (annex) | `Annex_A_Austraits_TRY_Categorical_Mapping.md` | Legacy categorical crosswalk (not used in 2025-10 refresh) | — |

---

## 3. Quick Reference — Commands

| Task | Command (2025-10-21 rerun) |
|------|---------------------------|
| Rebuild environmental summaries | `conda run -n AI --no-capture-output python src/Stage_1/aggregate_stage1_env_summaries.py worldclim soilgrids agroclime` |
| Regenerate quantiles | DuckDB helper in `1.5_Climate_Soil_Agroclim_Workflows.md` (loops over datasets) |
| Rebuild trait tables + modelling shortlist | `conda run -n AI --no-capture-output python src/Stage_1/rebuild_stage1_trait_tables.py --stamp <YYYYMMDD>` |
| Run BHPMF on modelling shortlist | `R_LIBS_USER=/home/olier/ellenberg/.Rlib Rscript src/legacy/Stage_2_Data_Processing/phylo_impute_traits_bhpmf.R --input_csv=..._modelling_shortlist_<stamp>.csv ...` |
| Archive QA evidence | `logs/stage1_environment/<date>/qa_report.md` · `logs/stage1_modelling_prep/<date>/qa_report.md` |

---

## 4. When to Visit Which File

- **Regenerating parquet extracts / raw ingest?** → `1.1_Raw_Data_Preparation.md`  
- **Explaining WFO merge decisions?** → `1.2_WFO_Normalisation_Verification.md`  
- **Need shortlist thresholds or GBIF coverage numbers?** → `1.3_Dataset_Construction.md`  
- **Re-running environmental QA?** → `1.6_Environmental_Verification.md` (and update the QA log)  
- **Preparing anti-leakage imputation datasets?** → `1.7a_Imputation_Dataset_Preparation.md`
- **Understanding XGBoost hyperparameter experiments?** → `1.7b_XGBoost_Experiments.md`
- **Running BHPMF imputation (legacy)?** → `1.7c_BHPMF_Gap_Filling_Imputation.md`
- **Production XGBoost imputation (11,682 species)?** → `1.7d_XGBoost_Production_Imputation.md`  
- **Need phylogenetic neighbour predictors (`p_phylo`)?** → `1.9_Phylogenetic_Predictor_and_Verification.md`  
- **Ready to assemble the full modelling table (traits + env + phylo)?** → `1.10_Modelling_Master_Table.md`  
- **Media assets for the encyclopedia?** → `1.8_iNaturalist_Media_QA.md`
- **Legacy AusTraits categorical mapping?** → `Annex_A_Austraits_TRY_Categorical_Mapping.md`

Keep this index aligned with any new summaries or major pipeline changes. If a document moves to `legacy/`, update the mermaid diagram and table accordingly so readers always land on the canonical guidance.

---

## 5. Final Stage 1 Datasets

| Use case | Dataset | Notes |
|----------|---------|-------|
| Encyclopedia / Stage 1 shortlist (11 680 species) | `model_data/inputs/traits_model_ready_20251021_rerun_shortlist.parquet` | Trait table with BHPMF fills; phylogenetic predictors are not generated for this tier in the 2025-10 refresh. |
| Modelling roster (1 084 species, ≥30 georeferenced occurrences) | `model_data/inputs/traits_model_ready_20251021_rerun_ge30_phylo.parquet` | Ready-to-model feature base (traits + `p_phylo_*`; 100 % coverage) sourced from `stage1_modelling_shortlist_with_gbif_ge30.parquet`. |
| Modelling master table (traits + env + phylo) | `model_data/inputs/modelling_master_20251021.parquet` (`.csv`) | Full 587-column feature set combining traits, phylogeny, WorldClim, SoilGrids, AgroClim; QA logged in `logs/stage1_modelling_prep/20251021/modelling_master_qa.md`. |
| Phylogenetic neighbour scores (standalone) | `model_data/outputs/p_phylo_ge30_20251021.{csv,parquet}` | Weighted LOO predictors (x = 2, k_trunc = 0) derived from `data/phylogeny/eive_try_tree_20251021.nwk` after family-backed tree rebuild. |
| BHPMF numeric output (1 273 species before ge30 filter) | `model_data/outputs/trait_imputation_bhpmf_modelling_shortlist_20251021_rerun.parquet` | Direct BHPMF means/SDs + imputation flags; useful for auditing fills or expanding beyond the ge30 filter. |


### XGBoost Production Imputation (11,682 Species)

**Completed:** 2025-10-28  
**Configuration:** Perm 2 (phylogenetic eigenvectors + EIVE indicators)  
**Hyperparameters:** 3000 trees, eta=0.025  
**Runtime:** 5.3 hours (CV + production)

**Production output (recommended for Stage 2):**  
`model_data/outputs/perm2_production/perm2_11680_eta0025_n3000_20251027_mean.csv`

**Performance summary (10-fold CV):**

| Trait | Observed | Missing Filled | RMSE | R² |
|-------|----------|----------------|------|-----|
| logLA | 5,233 (44.8%) | 6,449 (55.2%) | 1.470 | 0.519 |
| logNmass | 4,086 (35.0%) | 7,596 (65.0%) | 0.330 | 0.465 |
| logLDMC | 2,877 (24.6%) | 8,805 (75.4%) | 0.475 | 0.334 |
| logSLA | 5,526 (47.3%) | 6,156 (52.7%) | 0.485 | 0.513 |
| logH | 9,011 (77.1%) | 2,671 (22.9%) | 0.983 | 0.716 |
| logSM | 7,698 (65.9%) | 3,984 (34.1%) | 1.674 | 0.735 |
| **Average** | 5,735 (49.1%) | 5,947 (50.9%) | 0.903 | 0.547 |

**Total imputed values:** 35,661 trait gaps filled | **Complete coverage:** 0% missing for all 6 traits

**Verification status (comprehensive pipeline executed 2025-10-28):**
- ✓ Completeness: 100% gaps filled
- ✓ Biological plausibility: No extrapolation beyond observed ranges
- ✓ Trait correlations: Leaf economics spectrum relationships preserved
- ✓ Ensemble stability: Median CV<10% for all traits
- ⚠ Feature distributions: Gap species occupy somewhat different ecological space (3-17% mean differences)

**Verification outputs:** `results/verification/xgboost_production_20251027/`
**Verification script:** `src/Stage_1/verify_xgboost_production.py`

See `1.7d_XGBoost_Production_Imputation.md` for full methodology, validation, verification results, and Stage 2 integration guidance.

---

### Modelling Shortlist Completeness (1084 species)

| Feature block | Columns tracked | Non-null species | Notes |
|---------------|----------------|------------------|-------|
| Leaf area | `leaf_area_mm2`, `leaf_area_source`, `leaf_area_n` | 1084 (metric), 1084 (source), 1023 (`n`) | All species carry BHPMF-smoothed area; 94 % retain underlying sample counts for provenance. |
| Leaf nitrogen | `try_nmass`, `nmass_source`, `logNmass` | 1084 / 1084 / 1 064 | Raw TRY values present everywhere; log transform missing only where upstream log successor was filtered for QA. |
| LDMC | `ldmc_frac`, `ldmc_source`, `logLDMC` | 1084 / 1084 / 1 010 | Fraction fully populated post-imputation; a subset lacks historical log entries but modelling-ready column is complete. |
| LMA / SLA | `lma_g_m2`, `lma_source`, `sla_mm2_mg`, `logSLA` | 1084 / 1084 / 1 083 / 1 083 | Dual representation (LMA + SLA) complete for modelling; `try_lma`/`try_sla` provide 1 081 raw records each for auditing. |
| Seed mass | `seed_mass_mg`, `seed_mass_source`, `logSM` | 1084 / 1084 / 1 079 | Remaining gaps only in legacy log field; modelling metric is saturated. |
| Plant height | `plant_height_m`, `height_source`, `logH` | 1084 / 1084 / 1 069 | Imputation closed all metric gaps; log variant absent for species where height ≤0. |
| Derived logs | `logLA`, `logNmass`, `logLDMC`, `logSLA`, `logSM`, `logH` | 1 072–1 083 | Diagnostics only; all primary (non-log) metrics above are fully populated. |
| Phylogenetic predictors | `p_phylo_T`, `p_phylo_M`, `p_phylo_L`, `p_phylo_N`, `p_phylo_R` | 1084 each | Family-backed tree ensures 100 % coverage following 2025-10 rebuild. |
| Auxiliary sources | `try_*`, `aust_*` | TRY columns mirror the coverage shown above; AusTraits provides supplementary values for 21 LDMC, 80 seed mass, 332 height records, with `aust_sla`/`aust_lma` unused (0 rows). |

All trait counts derived from `model_data/inputs/traits_model_ready_20251021_rerun_ge30_phylo.parquet` (2025-10-21 build). Environmental coverage for the merged modelling master table is documented in `1.10_Modelling_Master_Table.md` and logged in `logs/stage1_modelling_prep/20251021/modelling_master_qa.md`.
