# Stage 1 Verification — Shortlisting & Dataset Construction

## Stage 1 Composite Shortlists (Union · Master · Modelling)

### Duke · EIVE · Mabberly Union

#### Objectives

- Rebuild the three-dataset union exactly as documented in `Dataset_Construction.md`.
- Confirm row parity, dataset flag integrity, and overlap counts before the table moves downstream.
- Ensure the published sample rows and status fields match the regenerated artefacts.

#### Build Command

Reuse the Python/DuckDB block under **Stage 1 Dataset Construction → Build Commands (DuckDB)**. Capture the terminal output for later comparison.

#### Verification Steps

- Confirm that input enrichments (`duke_worldflora_enriched.parquet`, `eive_worldflora_enriched.parquet`, `mabberly_worldflora_enriched.parquet`) still satisfy the Stage 1 checks above (row counts, match coverage, schema).
- Validate the regenerated files `data/stage1/duke_eive_mabberly_wfo_union.parquet` and `.csv`:
  - Row count equals the documented 34,399 WFO taxa.
  - Column audit confirms `datasets`, `dataset_count`, `in_*` flags, and `representative_status` exist with expected types.
  - Pairwise overlaps reproduce the published numbers (Duke ∩ EIVE = 1,677; Duke ∩ Mabberly = 105; EIVE ∩ Mabberly = 2; zero triple overlap).
  - Spot-check that taxa unique to each source exhibit the correct `datasets` flag and that the table matches the "Sample Rows" list.
  - Scan for blank `wfo_taxon_id` or null canonical names; none should appear.

#### Expected Results

- Row count: **34,399** WFO taxa
- Duke ∩ EIVE overlap: **1,677** taxa
- Duke ∩ Mabberly overlap: **105** taxa
- EIVE ∩ Mabberly overlap: **2** taxa
- Triple overlap: **0** taxa
- `representative_status` contains only valid WorldFlora values; no unexpected fallback strings.
- Any discrepancy triggers reruns of the upstream enrichment or documentation updates.

#### Verification Results (2025-10-26)

**Status**: ✓ PASSED

- Total WFO taxa: 34,399 ✓
- Duke ∩ EIVE: 1,677 ✓
- Duke ∩ Mabberly: 105 ✓
- EIVE ∩ Mabberly: 2 ✓
- Triple overlap: 0 ✓
- Null WFO IDs: 0 ✓
- Null canonical names: 0 ✓

All metrics match Dataset_Construction.md. Union artefacts validated.

### Master Union and Stage 1 Shortlist

#### Objectives

- Regenerate the master presence table and shortlist filters that combine Duke, EIVE, TRY Enhanced, and AusTraits coverage.
- Reapply trait-count thresholds (>= 3 numeric traits per source) and confirm shortlist membership flags.
- Cross-check every summary figure reported in the documentation.

#### Build Command

Run the Python/DuckDB block under **Stage 1 Dataset Construction → Master Taxon Union**; this produces:

- `data/stage1/master_taxa_union.parquet`
- `data/stage1/stage1_shortlist_candidates.parquet` (and `.csv`)

#### Verification Steps

- Ensure all contributing enrichments (`tryenhanced_worldflora_enriched.parquet`, `try_selected_traits_worldflora_enriched.parquet`, `austraits_taxa_worldflora_enriched.parquet`) remain validated per earlier sections.
- Inspect `master_taxa_union.parquet`:
  - Row count equals the union of WFO IDs across sources.
  - `source_count` aligns with `in_duke`, `in_eive`, `in_try_enhanced`, `in_austraits` flags.
  - No duplicate `wfo_taxon_id` rows; canonical names populated.
- Inspect `stage1_shortlist_candidates.parquet`:
  - Row count = **24,542** taxa (after promoting identifiers to the accepted WFO concepts).
  - Trait thresholds (EIVE ≥ 3, TRY Enhanced ≥ 3, AusTraits ≥ 3) produce: **12,610** via EIVE, **12,658** via TRY Enhanced, **3,849** via AusTraits.
  - Intersection tallies: **104** taxa meet all three conditions; **3,038** meet EIVE ∩ TRY only; **27** meet EIVE ∩ AusTraits only; **1,302** meet TRY ∩ AusTraits only; **9,441** are EIVE-only; **8,214** TRY-only; **2,416** AusTraits-only.
  - Confirm the helper column `legacy_wfo_ids` lists the historical identifiers for taxa whose accepted concept changed.
  - Verify edge cases: taxa exactly at threshold, taxa excluded for insufficient traits, and presence flags for Duke overlap.
- Recreate the AusTraits trait-depth distribution to confirm the stepwise counts (1 through 8 traits) align with the listed table.

#### Expected Results

- All shortlist metrics mirror the coverage summary in `Dataset_Construction.md`.
- Any deviation is annotated with its source (upstream data refresh vs. pipeline change) before updating published numbers.
- Intermediate DuckDB logs stored for traceability.

#### Verification Results (2025-10-26)

**Status**: ✓ PASSED

- Shortlist total: 24,542 ✓
- Qualified via EIVE ≥3: 12,610 ✓
- Qualified via TRY ≥3: 12,658 ✓
- Qualified via AusTraits ≥3: 3,849 ✓
- EIVE ∩ TRY ∩ AusTraits: 104 ✓
- EIVE ∩ TRY only: 3,038 ✓
- EIVE ∩ AusTraits only: 27 ✓
- TRY ∩ AusTraits only: 1,302 ✓
- EIVE only: 9,441 ✓
- TRY only: 8,214 ✓
- AusTraits only: 2,416 ✓
- Null WFO IDs: 0 ✓
- Null canonical names: 0 ✓

All shortlist metrics verified against Dataset_Construction.md. Trait qualification thresholds and overlaps confirmed.

### Modelling Shortlist (EIVE Complete · TRY Numeric Depth)

#### Objectives

- Validate the “tight” modelling roster that requires complete EIVE coverage plus at least eight distinct TRY numeric traits (deduplicated across enhanced and raw feeds).
- Confirm trait deduplication logic and ensure no unintended trait labels contribute to counts.
- Align all reported totals and trait-count distributions with the documentation.

#### Build Command

Execute the Python/DuckDB script under **Dataset_Construction.md → Modelling Shortlist** to regenerate:

- `data/stage1/stage1_modelling_shortlist.parquet`
- `data/stage1/stage1_modelling_shortlist.csv`

#### Verification Steps

- Reconfirm source readiness:
  - `eive_worldflora_enriched.parquet` passes the five-index completeness checks.
  - `tryenhanced_worldflora_enriched.parquet` and `try_selected_traits_worldflora_enriched.parquet` pass Stage 1 trait validations.
- Validate `eive_complete`:
  - Count species meeting all five `EIVEres-*` numeric checks; cross-verify a few positive and negative examples.
- Validate TRY trait aggregation:
  - Recompute per-species counts for enhanced traits (`leaf_area`, `leaf_mass_per_area`, etc.) and raw traits (`specific_leaf_area`, `leaf_thickness`, `leaf_dry_matter_content`).
  - Ensure deduplication merges SLA with LMA and LDMC labels so each trait contributes at most once.
  - Confirm `total_try_numeric_traits` equals the union count and never includes null placeholders.
- Validate shortlist output:
  - Total shortlisted taxa = **1,273**.
  - Source composition: **22** taxa with ≥8 traits solely from TRY Enhanced, **1,251** combining Enhanced and Raw, **0** from Raw alone.
  - Trait-count distribution: **684** taxa with 8 traits, **588** with 9 traits, **1** with 10 traits; inspect any taxa exceeding this range.
  - Spot-check canonical species to ensure counts reflect actual data (e.g., verify a borderline species with exactly eight traits).
- Confirm exported parquet/csv sorting by `canonical_name`, schema alignment with expectations, and absence of blank `wfo_taxon_id`.

#### Expected Results

- Regenerated shortlist mirrors all figures and tables under "Modelling Shortlist" in `Dataset_Construction.md`.
- Any mismatch is investigated (pipeline vs. source data) and annotated before documentation updates.
- Logs retained for the rerun; temporary DuckDB tables dropped after verification.

#### Verification Results (2025-10-26)

**Status**: ✓ PASSED

- Modelling shortlist total: 1,273 ✓
- Species with 8 traits: 684 ✓
- Species with 9 traits: 588 ✓
- Species with 10 traits: 1 ✓
- TRY Enhanced only (≥8 traits): 22 ✓
- Enhanced + Raw: 1,251 ✓
- Raw only: 0 ✓
- Null WFO IDs: 0 ✓
- Null canonical names: 0 ✓

Modelling shortlist verified. Trait deduplication logic confirmed. All species meet EIVE completeness and TRY ≥8 numeric traits threshold.

### GBIF Occurrence Coverage Checks (Shortlist · Modelling)

#### Objectives

- Produce reproducible GBIF occurrence tallies that align with Stage 1 canonical names, avoiding the WFO identifier drift present in the GBIF export.
- Attach those counts to the **24 542**-taxon shortlist and the modelling shortlist, then quantify how many taxa meet the ≥30-occurrence readiness threshold.
- Transparently flag taxa with low or zero GBIF coverage for potential follow-up sourcing.

#### Build Command

```
cd /home/olier/ellenberg
conda run -n AI --no-capture-output python src/Stage_1/Data_Extraction/rebuild_shortlists.py
```

#### Verification Steps

- Spot-check the revised WFO mapping for species that previously collided (e.g., *Abies alba*, *Carduus crispus*) to confirm `wfo_taxon_id` now holds the accepted identifier and `legacy_wfo_ids` preserves the historical value.
- Recounted shortlist coverage:
  - 24 542 taxa total; `gbif_occurrence_count` buckets are 6 129 (zero), 6 733 (1–29), and 11 680 (≥30).
  - Among the ≥30 subset: median ≈ 360, 90th percentile ≈ 6 193, maximum 167 396.
  - `gbif_georeferenced_count` mirrors the totals: 11 679 taxa with ≥30 coordinate-bearing records, 6 731 with 1–29, 6 132 with none.
- Recounted modelling shortlist coverage:
  - 1 273 taxa total; buckets are 150 (zero), 39 (1–29), and 1 084 (≥30).
  - Among the ≥30 subset: median ≈ 4 368, 90th percentile ≈ 30 051, maximum 167 562.
- Investigate at least one zero-occurrence species (e.g., *Aster scaber*) in `gbif_occurrence_counts_by_wfo.*` to confirm GBIF still lacks species-level matches (genus-level only).

#### Expected Results

- The augmented parquet files (`stage1_shortlist_with_gbif*.parquet`, `stage1_modelling_shortlist_with_gbif*.parquet`) now include both GBIF totals (`gbif_occurrence_count`, `gbif_georeferenced_count`) and `legacy_wfo_ids` for provenance.
- High-coverage species will remain available for downstream modelling filters; low-coverage or zero-coverage taxa surface for potential alternative sourcing.
- Any drift in counts during future reruns (e.g., after a fresh GBIF export) should be noted in the documentation together with the rerun date.

#### Verification Results (2025-10-26)

**Status**: ✓ PASSED

Shortlist GBIF coverage (24,542 taxa):
- Zero occurrences: 6,129 ✓
- 1-29 occurrences: 6,733 ✓
- ≥30 occurrences: 11,680 ✓
- Georeferenced ≥30: 11,679 ✓

Modelling GBIF coverage (1,273 taxa):
- Zero occurrences: 150 ✓
- 1-29 occurrences: 39 ✓
- ≥30 occurrences: 1,084 ✓
- Median (≥30 subset): 4,368 ✓
- 90th percentile (≥30 subset): 30,051 ✓
- Maximum: 167,562 ✓

GBIF occurrence tallies verified. High-coverage taxa available for modelling. Low-coverage taxa flagged for alternative sourcing.

## Stage 1 Shortlisting — Verification Checklist

1. **Source health check** — rerun the Stage 1 verification suite across all enriched inputs and review `data/stage1/gbif_occurrence_counts_by_wfo.parquet` for unexpected outliers.
2. **Canonical name guard** — sample shortlist rows to confirm `canonical_name` matches the accepted WFO name and that `legacy_wfo_ids` retains the historical identifier(s).
3. **Trait thresholds** — recompute numeric trait counts (EIVE, TRY Enhanced, AusTraits) to confirm the `qualifies_via_*` flags still align with the ≥3 threshold and that modelling ≥8 logic yields 1 273 taxa.
4. **GBIF integration** — verify the ≥30-occurrence buckets (totals and georeferenced) match the refreshed figures and investigate any species that remain at zero to ensure GBIF truly lacks species-level records.
5. **Coverage reconciliations** — compare all headline figures (shortlist size, qualifiers, overlap counts, GBIF tallies, modelling composition) to the published tables; note any drift beyond rounding.
6. **Sampling edge cases** — spot-check species in zero-coverage, borderline (1–29), and modelling cohorts to verify trait counts and dataset flags align with source parquets.
7. **Regression guardrails** — capture the DuckDB queries into a Make target (e.g., `make shortlist-qa`) so future reruns execute the same battery and archive the QA output alongside the artefacts.

---

## Verification Summary

**Last Verified**: 2025-10-26
**Verification Script**: `src/Stage_1/verification/verify_shortlisting.py`
**Data Snapshot**: Stage 1 enriched datasets (2025-10-14)

| Section | Status | Key Metrics |
|---------|--------|-------------|
| Duke·EIVE·Mabberly Union | ✓ PASSED | 34,399 taxa; overlaps verified |
| Master Union & Shortlist | ✓ PASSED | 24,542 shortlist taxa; trait thresholds confirmed |
| Modelling Shortlist | ✓ PASSED | 1,273 taxa; EIVE complete + TRY ≥8 traits |
| GBIF Coverage | ✓ PASSED | 11,680 shortlist (≥30); 1,084 modelling (≥30) |

**Overall Status**: ✅ ALL VERIFICATIONS PASSED

All shortlisting artefacts align with Dataset_Construction.md. Trait qualification logic, overlap calculations, and GBIF occurrence tallies confirmed. Pipeline ready for downstream Stage 2 modelling.
