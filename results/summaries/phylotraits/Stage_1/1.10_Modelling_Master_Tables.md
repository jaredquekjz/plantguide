# Stage 1.10 — Modelling Master Tables (Canonical)

**Date:** 2025-10-29
**Status:** Canonical reproduction documentation aligned with Stage 2 usage

---

## Overview

This stage builds the TWO master tables used in Stage 2 XGBoost modeling:

1. **Tier 1 (1,084 species):** For hyperparameter tuning with strong GBIF coverage
2. **Tier 2 (11,680 species):** For production CV and imputation

Both tables share the same feature structure (741 columns) but differ in:
- Species coverage (1,084 vs 11,680)
- Phylo predictor context (Tier 1 phylogeny vs Tier 2 global phylogeny)
- EIVE completeness (~100% vs ~53%)

**Key addition:** Full environmental quantiles (q05/q50/q95/iqr) added to capture ecological plasticity and niche breadth.

---

## 1. Feature Inventory (741 Features)

| Feature Group | Count | Description |
|--------------|-------|-------------|
| **Identifiers** | 2 | wfo_taxon_id, wfo_scientific_name |
| **Log traits** | 6 | logLA, logNmass, logLDMC, logSLA, logH, logSM |
| **Phylo eigenvectors** | 92 | phylo_ev1...phylo_ev92 (PCoA on VCV matrix) |
| **EIVE indicators** | 5 | EIVEres-L/T/M/N/R (observed values) |
| **Phylo predictors** | 5 | p_phylo_T/M/L/N/R (Shipley Part II predictors) |
| **Categorical traits** | 7 | woodiness, growth_form, habitat, leaf, phenology, pathway, mycorrhiza |
| **Environmental quantiles** | 624 | WorldClim (252) + SoilGrids (168) + Agroclim (204) |
| **TOTAL** | **741** | Unified structure across both tiers |

### Environmental Quantiles Rationale

**Full quantiles (q05, q50, q95, iqr) included despite Stage 1 rejection:**

- **Stage 1 result:** Perm 4 (full quantiles) was 1.2% worse than Perm 2 (q50 only) for trait imputation
- **Stage 2 hypothesis:** EIVE indicators represent environmental adaptation - variability features may capture:
  - Ecological plasticity (wide tolerance ranges)
  - Extreme environment adaptation (cold hardiness, drought resistance)
  - Niche breadth complementary to median conditions
- **Cost:** Acceptable storage overhead for potential explanatory gains
- **Flexibility:** Models can test with/without variability features

---

## 2. Tier 1 Master Table (1,084 Species)

**Purpose:** Hyperparameter tuning with robust GBIF georeferencing

### 2.1 Build Process

**Step 1: Base dataset with traits + phylo eigenvectors + EIVE + q50 quantiles**

Input: Stage 1.7d production imputation output
```
model_data/outputs/perm2_production/perm2_11680_complete_imputed_20251028.csv
```

Filter: GBIF ≥30 occurrences (from Stage 1.3 modelling shortlist)
```
data/stage1/stage1_modelling_shortlist_with_gbif_ge30.csv
```

**Step 2: Add full environmental quantiles**

Script: `src/Stage_1/update_modelling_dataset_with_full_quantiles.py`

Adds 468 additional quantile columns (q05/q95/iqr for all 156 environmental variables)

**Step 3: Add context-matched phylo predictors**

Script: Merge `model_data/outputs/p_phylo_1084_tier1_20251029.csv`

Phylo calculated on 1,075-species tree (see 1.9)

### 2.2 Output

**Files:**
```
model_data/inputs/modelling_master_1084_20251029.csv
model_data/inputs/modelling_master_1084_20251029.parquet
```

**Dimensions:** 1,084 species × 741 features

**Coverage:**
| Feature Group | Coverage |
|--------------|----------|
| Traits (log) | 100% (1,084 / 1,084) |
| Phylo eigenvectors | 99.4% (1,078 / 1,084) — six species rely on proxy fallback |
| Phylo predictors (p_phylo) | 94.6% (1,026 / 1,084) — limited by phylogeny coverage |
| EIVE indicators | 99.8% (1,082 / 1,084) — nitrogen & reaction missing for two species |
| Environmental quantiles (full) | 100% (1,084 / 1,084) |
| Categorical traits | 29-79% |

**GBIF characteristics:**
- Median: 4,370 occurrences
- Minimum: 30 occurrences
- Strong environmental data extraction quality

### 2.3 Usage in Stage 2

**Feature table generation:** Stage 2 XGBoost driver (`src/Stage_2/xgb_kfold.py`) assembles axis-specific feature tables automatically during Tier 1 grid search.

**Per-axis feature tables:**
```
model_data/inputs/stage2_features/L_features_1084_tier1_20251029.csv
model_data/inputs/stage2_features/T_features_1084_tier1_20251029.csv
model_data/inputs/stage2_features/M_features_1084_tier1_20251029.csv
model_data/inputs/stage2_features/N_features_1084_tier1_20251029.csv
model_data/inputs/stage2_features/R_features_1084_tier1_20251029.csv
```

Each contains:
- All 741 features EXCEPT target axis EIVE (removed)
- Species with observed EIVE for that axis only (~900 per axis)

**Models:**
```
model_data/outputs/stage2_xgb/{L,T,M,N,R}_1084_tier1_20251029/
```

**Performance:** R² 0.530-0.809, with phylo ranking #1-19

---

## 3. Tier 2 Master Table (11,680 Species)

**Purpose:** Production CV and imputation at encyclopedia scale

### 3.1 Build Process

**Step 1: Base dataset with traits + phylo eigenvectors + EIVE + q50 quantiles**

Input: Stage 1.7d production imputation output
```
model_data/outputs/perm2_production/perm2_11680_complete_imputed_20251028.csv
```

All 11,680 species (no filtering)

**Step 2: Add full environmental quantiles**

Script: `src/Stage_1/update_production_dataset_with_full_quantiles.py`

Adds 468 additional quantile columns (q05/q95/iqr for all 156 environmental variables)

**Step 3: Add context-matched phylo predictors**

Script: `src/Stage_1/compute_phylo_predictor.R --tier tier2` → outputs `model_data/outputs/p_phylo_11680_20251028.csv`

Merged directly into the master table so Stage 2 receives five Shipley Part II predictors alongside the base features.

### 3.2 Output

**Files:**
```
model_data/outputs/perm2_production/perm2_11680_complete_final_20251028.csv
model_data/outputs/perm2_production/perm2_11680_complete_final_20251028.parquet
```

**Dimensions:** 11,680 species × 741 features

**Coverage:**
| Feature Group | Coverage |
|--------------|----------|
| Traits (log) | 100% (11,680 / 11,680) |
| Phylo eigenvectors | 99.6% (11,638 / 11,680) |
| Phylo predictors (p_phylo) | 94.0% (10,977 / 11,680) |
| EIVE indicators | 52.8% (6,165 / 11,680) |
| Environmental quantiles (full) | 100% (11,680 / 11,680) |
| Categorical traits | 29-79% |

**EIVE missingness patterns:**
- Complete (all 5 axes): 5,924 species (50.7%)
- Partial (1-4 axes): 337 species (2.9%)
- None (0 axes): 5,419 species (46.4%)

### 3.3 Usage in Stage 2

**Feature table generation:** `src/Stage_2/build_tier2_features.py`

**Per-axis feature tables (initial):**
```
model_data/inputs/stage2_features/L_features_11680_20251029.csv  (11,680 species, includes p_phylo)
model_data/inputs/stage2_features/T_features_11680_20251029.csv
model_data/inputs/stage2_features/M_features_11680_20251029.csv
model_data/inputs/stage2_features/N_features_11680_20251029.csv
model_data/inputs/stage2_features/R_features_11680_20251029.csv
```

**Context-matched phylo options:** Stage 2 can still recompute per-axis predictors for CV-specific folds when required:
- `src/Stage_2/calculate_tier2_cv_phylo.R`
- `src/Stage_2/update_tier2_features_with_cv_phylo.py`

**No-EIVE variants:**

Script: `src/Stage_2/build_tier2_no_eive_features.py`

Removes all cross-axis EIVE predictors for species with no observed EIVE:
```
model_data/inputs/stage2_features/L_features_11680_no_eive_20251029.csv
model_data/inputs/stage2_features/T_features_11680_no_eive_20251029.csv
model_data/inputs/stage2_features/M_features_11680_no_eive_20251029.csv
model_data/inputs/stage2_features/N_features_11680_no_eive_20251029.csv
model_data/inputs/stage2_features/R_features_11680_no_eive_20251029.csv
```

**Models (to be retrained):**
```
model_data/outputs/stage2_xgb/{L,T,M,N,R}_11680_production_corrected_20251029/  (full models)
model_data/outputs/stage2_xgb/{L,T,M,N,R}_11680_no_eive_20251029/  (no-EIVE models)
```

**Expected performance:**
- Full models: R² 0.506-0.823 (CV on ~6,200 species per axis)
- No-EIVE models: R² 0.448-0.807 (avg -7.5% drop)

---

## 4. Verification (2025-10-30)

Verification script: `src/Stage_1/verification/verify_modelling_master_tables.py`

- **File inventory:** Confirmed Tier 1 & Tier 2 parquet/CSV outputs plus the modelling shortlist are present.
- **Tier 1 (1,084 × 741):**
  - Log traits complete (100%).
  - EIVE coverage: 1,082 species (99.8%) have all five indicators; only N and R are missing for two species.
  - Phylo eigenvectors available for 1,078 species (six rely on proxy fallbacks); 92 columns present.
  - Shipley phylo predictors present for 1,026 species (94.6%).
  - Environmental quantiles: 156 base variables with all four summaries (q05/q50/q95/iqr), 624 columns total.
  - Species roster matches the 1,084-species GBIF modelling shortlist exactly.
- **Tier 2 (11,680 × 741):**
  - Log traits complete (100%).
  - EIVE coverage mirrors Stage 1 shortlist stats (6,165 species with observations, 5,924 with all five axes).
  - Phylo eigenvectors populated for 11,638 species (42 rely on proxies); Shipley predictors present for 10,977 species (94.0%).
  - Environmental quantiles cover 156 base variables across q05/q50/q95/iqr (624 columns).
  - Tier 2 contains every Tier 1 species (superset check passed).

---

## 5. Canonical Reproduction Path

### Tier 1 (Start to Finish)

```bash
# 1. Build Tier 1 phylo predictors (1,075-species tree)
env R_LIBS_USER="/home/olier/ellenberg/.Rlib" \
  /usr/bin/Rscript src/Stage_1/compute_phylo_predictor.R \
    --tier tier1 \
    --roster model_data/inputs/modelling_master_1084_tier1_20251029.parquet \
    --tree data/stage1/phlogeny/mixgb_tree_11676_species_20251027.nwk \
    --output model_data/outputs/p_phylo_1084_tier1_20251029.csv

# 2. Add full quantiles to 1,084-species dataset
conda run -n AI python src/Stage_1/update_modelling_dataset_with_full_quantiles.py

# 3. Merge phylo predictors & build Tier 1 feature tables
# Stage 2's training driver (`src/Stage_2/xgb_kfold.py`) assembles axis-specific
# feature tables automatically when rerunning Tier 1 grid search.

# 5. Run Tier 1 grid search
bash src/Stage_2/run_tier1_grid_search_all_axes.sh
```

### Tier 2 (Start to Finish)

```bash
# 1. Add full quantiles to 11,680-species dataset
conda run -n AI python src/Stage_1/update_production_dataset_with_full_quantiles.py

# 2. Build Tier 2 feature tables (without phylo)
conda run -n AI python src/Stage_2/build_tier2_features.py

# 3. Calculate context-matched phylo per axis
env R_LIBS_USER="/home/olier/ellenberg/.Rlib" \
  /usr/bin/Rscript src/Stage_2/calculate_tier2_cv_phylo.R

# 4. Merge context-matched phylo into feature tables
conda run -n AI python src/Stage_2/update_tier2_features_with_cv_phylo.py

# 5. Build no-EIVE feature variants
conda run -n AI python src/Stage_2/build_tier2_no_eive_features.py

# 6. Train Tier 2 full models
bash src/Stage_2/run_tier2_production_corrected_all_axes.sh

# 7. Train Tier 2 no-EIVE models
bash src/Stage_2/run_tier2_no_eive_all_axes.sh
```

---

## 5. Key Design Decisions

### Why Two Tiers?

**Tier 1 (1,084 species):**
- Fast hyperparameter tuning (24 minutes for 45 models)
- Strong GBIF coverage reduces environmental extraction noise
- European-biased but sufficient for hyperparameter optimization

**Tier 2 (11,680 species):**
- Maximum phylogenetic and geographic diversity
- Essential for globally-distributed species without observed EIVE
- 5.7× more training data for robust learning

### Why Context-Matched Phylo?

**Problem:** Phylo calculated on full 10,977-species tree collapsed to ranks #45-#149 in CV models trained on ~6,200-species subsets.

**Solution:** Calculate phylo within the same phylogenetic context as training data.

**Result:** Phylo importance restored to ranks #1-19.

### Why Full Quantiles?

**Hypothesis:** EIVE adaptation involves:
- Tolerance to extremes (q05, q95)
- Niche breadth (iqr)
- Not just median conditions (q50)

**Trade-off:** 1.2% worse for trait imputation but potentially valuable for EIVE prediction.

---

## 6. Files Summary

| File | Species | Features | Phylo Context | Use |
|------|---------|----------|---------------|-----|
| `modelling_master_1084_20251029.csv` | 1,084 | 741 | 1,075-tree | Tier 1 tuning |
| `perm2_11680_complete_final_20251028.csv` | 11,680 | 736* | None (added later) | Tier 2 base |
| `{L,T,M,N,R}_features_1084_tier1_20251029.csv` | ~900 | 736** | 1,075-tree | Tier 1 models |
| `{L,T,M,N,R}_features_11680_corrected_20251029.csv` | 11,680 | 741 | Axis-specific | Tier 2 full models |
| `{L,T,M,N,R}_features_11680_no_eive_20251029.csv` | 11,680 | 737*** | Axis-specific | Tier 2 no-EIVE models |

*No phylo predictors yet (added per-axis)
**Target axis EIVE removed
***Cross-axis EIVE removed (4 columns)

---

## 7. Related Documentation

- **Phylo predictors:** `1.9_Phylogenetic_Predictors_CANON.md`
- **Trait imputation:** `1.7d_XGBoost_Production_Imputation.md`
- **Stage 2 usage:** `Stage_2/2.0_Modelling_Overview.md`
- **Model paths:** `Stage_2/MODEL_PATHS_REFERENCE_20251029.md`

---

**Status:** Canonical master tables built and integrated into Stage 2 modeling
