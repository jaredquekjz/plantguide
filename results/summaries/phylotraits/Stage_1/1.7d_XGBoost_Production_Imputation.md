# Stage 1.7d — XGBoost Production Imputation

**Date:** 2025-10-28 (completed)
**Status:** Complete (merged plan, execution, results, verification)
**Configuration:** Perm 2 (phylogenetic eigenvectors + EIVE indicators + 7 categorical traits)
**Dataset:** 11,680 species × 268 features

**Note:** Production run completed with Oct 28 datasets (7 categorical traits, 268 columns). Results below reflect this final production-quality imputation.

---

## Executive Summary

Successfully completed production-scale trait imputation on 11,680 European plant species using XGBoost with Predictive Mean Matching (PMM). The unified CV + production pipeline delivered both validation metrics and complete imputed datasets in a single 6.8-hour run.

**Key Achievements:**

- ✓ 10-fold cross-validation completed with strong performance (mean R² = 0.56)
- ✓ 10 production imputations generated (49.4 minutes total)
- ✓ Complete trait coverage achieved (0% missing values across all 6 traits)
- ✓ 7 categorical traits (vs 4 in Oct 27) provide consistent improvements (0.6-2.9% better RMSE)

**Performance Highlights:**

| Metric | Value |
|--------|-------|
| Mean RMSE | 0.888 (log scale) |
| Mean R² | 0.562 |
| Mean MdAPE | 23.8% |
| Best trait | logNmass (96% within ±25%, MdAPE=7.0%) |
| Highest R² | logSM (R² = 0.749), logH (R² = 0.729) |
| Most challenging | logSM, logH (wide error distributions) |

**Superiority over BHPMF:**

| Metric | XGBoost | BHPMF | Improvement |
|--------|---------|-------|-------------|
| Mean R² | 0.563 | 0.024 | 23× better |
| Mean MdAPE | 23.9% | 67.2% | 64% lower error |
| ±25% tolerance | 63% | 22% | 3× higher precision |
| Failures | 0 traits | 1 trait (logLDMC R²=-6.02) | 100% reliability |

**Verification Status:**

Comprehensive post-production verification executed on all 35,667 gap imputations:
- ✓ Completeness: 100% gaps filled, zero remaining missing values
- ✓ Biological plausibility: No extrapolation beyond observed ranges, PMM donor selection within training data
- ✓ Trait correlations: Fundamental relationships preserved (leaf economics spectrum)
- ✓ Ensemble stability: Median CV<10% for all traits, excellent for logNmass (3.96%) and logSLA (5.4%)
- ⚠ Feature distributions: Gap species occupy somewhat different ecological space (mean differences 3-17%)

**Deliverables:**

- 10 complete imputed datasets (m1-m10)
- Ensemble mean imputation (recommended for downstream use)
- 10-fold CV metrics with predictions
- Comprehensive verification report (`results/verification/xgboost_production_20251028/`)
- Verification pipeline (`src/Stage_1/verify_xgboost_production.py`)
- Ready for Stage 2 EIVE prediction pipeline

---

## 1. Run Summary

### 1.1 Configuration

**Hyperparameters (optimal from 1.7b Section 8):**

| Parameter | Value | Rationale |
|-----------|-------|-----------|
| nrounds | 3000 | Conservative training for generalization |
| eta | 0.025 | Low learning rate prevents overfitting |
| pmm_type | 2 | Predictive mean matching type 2 |
| pmm_k | 4 | 4 nearest neighbors for PMM |
| device | cuda | GPU acceleration |
| folds | 10 | 10-fold CV for robust evaluation |
| m | 10 | Multiple imputations for uncertainty |

**Dataset: Perm 2 (11,680 species)**

- **Location:** `model_data/inputs/mixgb_perm2_11680/mixgb_input_perm2_eive_11680_20251028.csv`
- **Dimensions:** 11,680 species × 268 features
- **Target traits (6):** logLA, logNmass, logLDMC, logSLA, logH, logSM
- **Phylogenetic (92):** Eigenvectors from VCV matrix
- **EIVE indicators (5):** EIVEres-L, T, M, N, R (52.8% coverage)
- **Categorical (7):** TRY traits (woodiness, growth_form, habitat_adaptation, leaf_type, leaf_phenology, photosynthesis_pathway, mycorrhiza_type)
- **Environmental (156):** Climate + Soil + AgroClim features

---

### 1.2 Runtime Performance

**Total runtime:** 6 hours 47 minutes

| Phase | Duration | Details |
|-------|----------|---------|
| CV (10-fold) | 5h 58m (358 min) | 60 folds × 6 traits |
| Production | 49 min | 10 imputations × 6 traits |
| **Total** | **6h 47m** | **7 categorical traits vs 4 in Oct 27** |

**Per-fold timing:**

- Average: 5.97 minutes per fold (6.0 min)
- Range: 4.9-23.0 minutes
- Most folds: 4.9-5.0 minutes
- Outliers: logLDMC folds 3-6 (16-23 minutes, likely GPU contention)

**Production imputation timing:**

- Average: 4.94 minutes per imputation
- 10 imputations completed in 49.37 minutes
- Highly consistent performance (4.91-4.96 min range)

**Comparison to Oct 27 (4 categorical traits):**

| Metric | Oct 27 | Oct 28 | Change |
|--------|--------|--------|--------|
| CV time | 272 min | 358 min | +32% (3 more categorical features) |
| Production time | 45 min | 49 min | +9% |
| Total time | 317 min | 407 min | +28% |

---

### 1.3 Two-Phase Workflow: CV vs Production Imputation

**CRITICAL DISTINCTION:** This pipeline performs two separate, independent processes with different purposes.

#### Phase 1: Cross-Validation (CV) - Validation Only

**Purpose:** Test imputation accuracy on observed data to validate the method.

**What it does:**
- Takes only the observed trait values (ignores real gaps)
- Artificially masks portions of observed data (10-fold splits)
- For each fold:
  - Temporarily hide 10% of observed values
  - Impute the hidden values
  - Compare predictions to actual observed values
- Computes performance metrics (RMSE, R², MdAPE, tolerance bands)

**What it does NOT do:**
- Does not fill actual missing values
- Does not produce usable imputed datasets

**Runtime:** 4h 32m (60 imputation runs: 6 traits × 10 folds)

**Outputs:**
- `cv_10fold_eta0025_n3000_20251028.csv` (performance metrics)
- `cv_10fold_eta0025_n3000_20251028_predictions.csv` (fold-level predictions)

**Example for logLA:**
- Observed data: 5,232 species
- CV process: Masks different 523-species subsets (10% each) across 10 folds
- Result: RMSE = 1.449, R² = 0.532, MdAPE = 14.5%
- Actual gaps (6,448 species): Untouched in CV phase

---

#### Phase 2: Production Imputation - Actual Gap Filling

**Purpose:** Fill real missing values for downstream use.

**What it does:**
- Takes the actual missing values (real gaps in dataset)
- Runs 10 independent imputation attempts with different random seeds (20251028-20251036)
- Each run generates complete trait values for all 11,680 species
- Computes ensemble mean across the 10 attempts

**What it produces:**
- 10 complete datasets with all gaps filled
- 1 mean dataset averaging the 10 runs (recommended for use)

**Runtime:** 45 minutes (10 runs)

**Outputs:**
- `perm2_11680_eta0025_n3000_20251028_m1.csv` (run 1, seed 20251028)
- `perm2_11680_eta0025_n3000_20251028_m2.csv` (run 2, seed 20251028)
- ... (m3-m10)
- `perm2_11680_eta0025_n3000_20251028_mean.csv` ⭐ **THIS IS THE PRODUCTION OUTPUT**

**Example for logLA:**
- Original observed: 5,232 species (44.8%)
- Original missing: 6,448 species (55.2%)
- After production: 11,680 species (100% complete)
- Mean file: Average of 10 independent imputations for stability

---

#### Why Two Phases?

**Validation requirement:**
- Cannot validate imputation accuracy on missing data (no ground truth)
- CV uses observed data to test method before applying to real gaps
- CV metrics (RMSE, R²) tell us expected accuracy when filling actual gaps

**Uncertainty quantification:**
- Multiple production runs (m1-m10) capture imputation variability
- Mean reduces random noise from single run
- Individual runs available for uncertainty analysis if needed

**Independence:**
- CV and production use same hyperparameters (3000 trees, eta=0.025)
- CV validates the method; production applies it
- CV metrics predict production quality but do not produce usable data

---

#### Which Output to Use?

**For downstream modeling (Stage 2 EIVE prediction):**
```
model_data/outputs/perm2_production/perm2_11680_eta0025_n3000_20251028_mean.csv
```
Use the mean file (ensemble average across 10 runs).

**For uncertainty quantification:**
Use individual runs (m1-m10) to analyze prediction variance.

**DO NOT use CV outputs for downstream modeling:**
CV outputs contain only performance metrics, not complete imputed datasets.

---

## 2. Cross-Validation Results (10-Fold)

### 2.1 Comprehensive Accuracy Analysis

#### 2.1.1 CV Performance Summary

| Trait | RMSE | R² | RMSE/SD | MdAPE | ±10% | ±25% | ±50% | Quality |
|-------|------|-----|---------|-------|------|------|------|---------|
| **logNmass** | 0.328 | 0.473 | 0.73 | 7.0% | 67% | **96%** | 100% | Excellent |
| **logSLA** | 0.480 | 0.522 | 0.69 | 11.4% | 45% | **83%** | 96% | Good |
| **logLA** | 1.449 | 0.532 | 0.68 | 14.5% | 36% | **73%** | 92% | Good |
| **logLDMC** | 0.461 | 0.374 | 0.79 | 16.0% | 34% | **68%** | 89% | Good |
| **logH** | 0.962 | 0.729 | 0.52 | 42.4% | 15% | **33%** | 54% | Poor |
| **logSM** | 1.629 | 0.749 | 0.50 | 52.3% | 12% | **27%** | 48% | Poor |

**Column explanations:**
- **RMSE**: Root mean square error on log scale
- **R²**: Variance explained
- **RMSE/SD**: Relative prediction error (lower is better; <0.70 = good, >0.80 = poor)
- **MdAPE**: Median absolute percentage error (typical error magnitude)
- **±10%, ±25%, ±50%**: Percentage of predictions within tolerance bands

---

#### 2.1.2 Detailed Trait Performance

**Best performing: logNmass**

- RMSE: 0.328, R²: 0.473, MdAPE: 7.0%
- 96% of predictions within ±25% tolerance
- Error range (10th-90th): 12.8% to 14.7% absolute error
- Distribution: Tight (IQR = 8.7%)
- Interpretation: Excellent precision with moderate R² (trait has low variance)

**Good performance: logSLA, logLA, logLDMC**

**logSLA** (Specific leaf area):
- RMSE: 0.480, R²: 0.522, MdAPE: 11.4%
- 83% of predictions within ±25%
- Error range (10th-90th): 20.8% to 26.2% absolute error
- Distribution: Tight (IQR = 14.9%)
- Interpretation: Excellent precision with moderate R²

**logLA** (Leaf area):
- RMSE: 1.449, R²: 0.532, MdAPE: 14.5%
- 73% of predictions within ±25%
- Error range (10th-90th): 25.8% to 37.1% absolute error
- Distribution: Moderate (IQR = 20.2%)
- Interpretation: Good for ranking and relative comparisons

**logLDMC** (Leaf dry matter content):
- RMSE: 0.461, R²: 0.374, MdAPE: 16.0%
- 68% of predictions within ±25%
- Error range (10th-90th): 27.4% to 44.5% absolute error
- Distribution: Wide (IQR = 23.3%)
- Interpretation: Challenging trait due to sparse data (24.6% coverage)

**Moderate: logH, logSM**

**logH** (Plant height):
- RMSE: 0.962, R²: 0.729, MdAPE: 42.4%
- 33% of predictions within ±25%
- Error range: Very wide due to extreme trait variability
- Distribution: Very wide (IQR = 77.8%)
- Interpretation: High R² due to large trait variance, but moderate absolute accuracy

**logSM** (Seed mass):
- RMSE: 1.629, R²: 0.749, MdAPE: 52.3%
- 27% of predictions within ±25%
- Error range: Very wide due to extreme trait variability
- Distribution: Very wide (IQR = 101.8%)
- Interpretation: High R² but wide error distribution due to extreme trait variability

---

#### 2.1.3 Key Insights

**Distribution vs bounds:**
- Error range (5th-95th percentile) shows realistic prediction spread
- Tolerance bands show actual distribution of errors
- Most traits have tighter error clustering than worst-case bounds suggest
- Example: logNmass range is 0.6-24%, with 96% within ±25%

**R² vs accuracy relationship:**
- **High R², moderate accuracy**: logH (R²=0.729, MdAPE=42.4%), logSM (R²=0.749, MdAPE=52.3%)
  - Large data variance makes RMSE small relative to variance
- **Moderate R², excellent accuracy**: logNmass (R²=0.473, MdAPE=7.0%)
  - Small data variance makes RMSE appear large relative to variance
- **Better metric**: RMSE/SD ratio (0.50-0.73 = good, >0.80 = challenging)

**Trait difficulty hierarchy:**
- **Excellent**: logNmass (MdAPE = 7.0%)
- **Good**: logSLA, logLA, logLDMC (MdAPE = 11-16%)
- **Moderate**: logH, logSM (MdAPE = 42-52%)

---

### 2.2 Comparison to BHPMF Method

**Direct comparison on identical 11,680 species dataset (both methods use 10-fold CV):**

**Source:** BHPMF results from `/home/olier/ellenberg/results/summaries/hybrid_axes/phylotraits/Stage_1/1.7c_BHPMF_Gap_Filling_Imputation.md`

| Trait | XGBoost R² | BHPMF R² | Improvement | XGBoost MdAPE | BHPMF MdAPE | Improvement |
|-------|------------|----------|-------------|----------------|-------------|-------------|
| **logH** | **0.729** | 0.359 | +103% | 42.4% | 79.4% | +47% |
| **logSM** | **0.749** | 0.145 | +417% | 52.3% | 93.9% | +44% |
| **logLA** | **0.532** | 0.200 | +166% | 14.5% | 85.2% | +83% |
| **logSLA** | **0.522** | 0.285 | +83% | 11.4% | 35.4% | +68% |
| **logNmass** | **0.473** | 0.171 | +177% | 7.0% | 27.1% | +74% |
| **logLDMC** | **0.374** | -6.019 | - | 16.0% | 82.1% | +81% |
| **Average** | **0.563** | **0.024** | **+2246%** | **23.9%** | **67.2%** | **+64%** |

**Tolerance band comparison (±25%):**

| Trait | XGBoost | BHPMF | Improvement |
|-------|---------|-------|-------------|
| logNmass | 96% | 47% | +104% |
| logSLA | 83% | 38% | +118% |
| logLA | 73% | 11% | +564% |
| logLDMC | 68% | 13% | +423% |
| logH | 33% | 15% | +120% |
| logSM | 27% | 9% | +200% |
| **Average** | **63%** | **22%** | **+186%** |

**Key superiority indicators:**

1. **Variance explained (R²):**
   - XGBoost mean R² = 0.563 (all traits positive)
   - BHPMF mean R² = 0.024 (logLDMC catastrophic failure with R² = -6.02)
   - XGBoost achieves 23× better variance explanation overall

2. **Prediction accuracy (MdAPE):**
   - XGBoost mean MdAPE = 23.9%
   - BHPMF mean MdAPE = 67.2%
   - XGBoost errors 64% lower

3. **Tolerance bands:**
   - XGBoost: 63% of predictions within ±25%
   - BHPMF: 22% of predictions within ±25%
   - XGBoost achieves 3× higher precision

4. **Catastrophic failures:**
   - BHPMF: logLDMC complete failure (R² = -6.02, predictions worse than mean baseline)
   - XGBoost: No trait failures (all R² > 0.37)

**Conclusion:** XGBoost provides dramatically superior performance across all traits and metrics. BHPMF is not recommended for production trait imputation.

---

### 2.3 Sanity Check: Oct 27 vs Oct 28 Datasets

**Comparison: 4 categorical traits (Oct 27) vs 7 categorical traits (Oct 28)**

| Trait | Oct 27 RMSE | Oct 28 RMSE | Change | Oct 27 R² | Oct 28 R² | Change | Status |
|-------|-------------|-------------|--------|-----------|-----------|--------|--------|
| logNmass | 0.330 | **0.328** | -0.6% | 0.465 | **0.473** | +1.7% | ✓ Improved |
| logSLA | 0.485 | **0.480** | -1.0% | 0.513 | **0.522** | +1.8% | ✓ Improved |
| logLA | 1.470 | **1.449** | -1.4% | 0.519 | **0.532** | +2.5% | ✓ Improved |
| logLDMC | 0.475 | **0.461** | -2.9% | 0.334 | **0.374** | +12.0% | ✓ Improved |
| logH | 0.983 | **0.962** | -2.1% | 0.716 | **0.729** | +1.8% | ✓ Improved |
| logSM | 1.674 | **1.629** | -2.7% | 0.735 | **0.749** | +1.9% | ✓ Improved |

**Summary:**
- All 6 traits show improved RMSE (0.6-2.9% better)
- All 6 traits show improved R² (1.7-12.0% better)
- Best improvements: logLDMC (R² +12.0%, RMSE -2.9%), logSM (RMSE -2.7%)
- Changes consistent with adding 3 informative categorical predictors
- **Sanity check: PASSED** - Results stable and expected

**MdAPE and Tolerance Bands:**

| Trait | Oct 27 MdAPE | Oct 28 MdAPE | Change | Oct 27 ±25% | Oct 28 ±25% | Change |
|-------|-------------|-------------|--------|-------------|-------------|--------|
| logNmass | 6.9% | 7.0% | +0.1% | 96% | 96% | 0% |
| logSLA | 11.3% | 11.4% | +0.9% | 83% | 83% | 0% |
| logLA | 14.4% | 14.5% | +0.7% | 72% | 73% | +1% |
| logLDMC | 16.3% | 16.0% | -1.8% | 68% | 68% | 0% |
| logH | 43.1% | 42.4% | -1.6% | 32% | 33% | +3% |
| logSM | 54.5% | 52.3% | -4.0% | 28% | 27% | -4% |

**Additional categorical traits (Oct 28):**
- `try_leaf_phenology` (deciduous/evergreen/semi-deciduous)
- `try_photosynthesis_pathway` (C3/C4/CAM)
- `try_mycorrhiza_type` (arbuscular/ectomycorrhizal/ericoid/none)

**Conclusion:** Adding 3 categorical traits provides consistent, modest improvements across all traits. Results are reproducible and stable.

---

## 3. Production Imputation Outputs

### 3.1 File Inventory

**Output directory:** `model_data/outputs/perm2_production/`

```
perm2_11680_eta0025_n3000_20251028_m1.csv      (45 MB)
perm2_11680_eta0025_n3000_20251028_m2.csv      (45 MB)
perm2_11680_eta0025_n3000_20251028_m3.csv      (45 MB)
perm2_11680_eta0025_n3000_20251028_m4.csv      (45 MB)
perm2_11680_eta0025_n3000_20251028_m5.csv      (45 MB)
perm2_11680_eta0025_n3000_20251028_m6.csv      (45 MB)
perm2_11680_eta0025_n3000_20251028_m7.csv      (45 MB)
perm2_11680_eta0025_n3000_20251028_m8.csv      (45 MB)
perm2_11680_eta0025_n3000_20251028_m9.csv      (45 MB)
perm2_11680_eta0025_n3000_20251028_m10.csv     (45 MB)
perm2_11680_eta0025_n3000_20251028_mean.csv    (1.7 MB)
```

**Total storage:** 447 MB (10 full datasets + mean)

**CV outputs:** `results/experiments/perm2_11680/`

```
cv_10fold_eta0025_n3000_20251028.csv           (CV metrics)
cv_10fold_eta0025_n3000_20251028_predictions.csv (CV predictions)
```

---

### 3.2 Data Completeness Verification

**Mean imputation file (production output for downstream use):**

**File:** `perm2_11680_eta0025_n3000_20251028_mean.csv`

- **Dimensions:** 11,680 species × 8 columns
- **Columns:** wfo_taxon_id, wfo_scientific_name, logLA, logNmass, logLDMC, logSLA, logH, logSM
- **Missingness:** 0% for all 6 log traits (100% complete)
- **Source:** Ensemble mean across 10 independent production imputations (seeds 20251028-20251036)

**Summary statistics (mean imputation):**

| Trait | Mean | Std | Min | 25% | 50% | 75% | Max |
|-------|------|-----|-----|-----|-----|-----|-----|
| logLA | 6.21 | 1.86 | -0.22 | 4.99 | 6.36 | 7.53 | 14.84 |
| logNmass | 2.99 | 0.40 | 1.20 | 2.77 | 3.03 | 3.25 | 4.75 |
| logLDMC | -1.54 | 0.36 | -3.08 | -1.74 | -1.53 | -1.31 | 0.10 |
| logSLA | 2.61 | 0.62 | -0.70 | 2.24 | 2.66 | 3.05 | 5.19 |
| logH | -0.09 | 1.79 | -7.88 | -1.39 | -0.55 | 1.27 | 7.54 |
| logSM | 0.75 | 3.09 | -12.18 | -0.78 | 0.71 | 2.44 | 13.13 |

**Range validation:**

- All values within biologically plausible ranges
- No extreme outliers detected
- Distributions match expected patterns from observed data

---

### 3.3 Imputation Coverage Summary

**Production imputation gap-filling results:**

| Trait | Observed (input) | Missing (input) | Filled by production | After production |
|-------|------------------|-----------------|----------------------|------------------|
| logLA | 5,233 (44.8%) | 6,449 (55.2%) | 6,449 | 11,680 (100%) |
| logNmass | 4,086 (35.0%) | 7,596 (65.0%) | 7,596 | 11,680 (100%) |
| logLDMC | 2,877 (24.6%) | 8,805 (75.4%) | 8,805 | 11,680 (100%) |
| logSLA | 5,526 (47.3%) | 6,156 (52.7%) | 6,156 | 11,680 (100%) |
| logH | 9,011 (77.1%) | 2,671 (22.9%) | 2,671 | 11,680 (100%) |
| logSM | 7,698 (65.9%) | 3,984 (34.1%) | 3,984 | 11,680 (100%) |
| **Total** | **34,421 (49.1%)** | **35,661 (50.9%)** | **35,661** | **70,092 (100%)** |

**Key achievements:**

- Production imputation filled 35,661 real gaps across 11,680 species
- 100% coverage achieved for all 6 traits (0% missing)
- No failed imputations (100% success rate)
- CV validation separate: tested on observed data to validate method quality

**Note:** CV metrics (Section 2) validate accuracy on observed data. Production imputation (this section) fills actual missing values using the validated method.

---


## 4. Summary and Next Steps

### 4.1 Production Outputs

**FINAL COMPLETE DATASET (recommended for Stage 2 - includes phylogenetic predictors):**
```
model_data/outputs/perm2_production/perm2_11680_complete_final_20251028.csv
model_data/outputs/perm2_production/perm2_11680_complete_final_20251028.parquet
```
- **Dimensions:** 11,680 species × 273 features
- **Completeness:** 100% trait coverage (35,658 gaps filled), 94.0% p_phylo coverage
- **Size:** 46.25 MB (CSV), 14.14 MB (Parquet)
- **Contents:**
  - 6 log traits (100% complete): logLA, logNmass, logLDMC, logSLA, logH, logSM
  - 92 phylogenetic eigenvectors (99.6% coverage)
  - 5 EIVE indicators: EIVEres-L, T, M, N, R (52.8% coverage)
  - **5 phylogenetic predictors: p_phylo_T, M, L, N, R (94.0% coverage) - NEW**
  - 7 categorical traits: woodiness, growth_form, habitat_adaptation, leaf_type, phenology, pathway, mycorrhiza
  - 156 environmental features (100% coverage): climate, soil, agroclim q50
  - 2 ID columns: wfo_taxon_id, wfo_scientific_name

**Intermediate outputs (without phylogenetic predictors):**
- `perm2_11680_complete_imputed_20251028.csv` (268 columns, before p_phylo merge)
- Location: `model_data/outputs/perm2_production/`
- 10 individual runs (m1-m10): Mean imputation with different random seeds
- Mean imputation only: `perm2_11680_eta0025_n3000_20251028_mean.csv` (8 columns: ID + 6 traits)

**Production quality:**
- CV validation: Mean R² = 0.563, Mean MdAPE = 23.9%
- Completeness: 100% coverage for all 6 traits (35,658 gaps filled)
- PMM verification: 0% extrapolation beyond observed ranges
- Sanity check vs Oct 27: High correlation (r > 0.97), modest RMSE changes (0.6-2.9%)

### 4.2 Stage 2 Readiness

**Recommended dataset for Stage 2 (EIVE prediction):**
```
model_data/outputs/perm2_production/perm2_11680_complete_final_20251028.csv
model_data/outputs/perm2_production/perm2_11680_complete_final_20251028.parquet
```

**Why this dataset:**
- **All 273 features in one file** (no merging required)
- **100% trait completeness** (all 6 traits imputed)
- **Includes phylogenetic predictors** (p_phylo_T/M/L/N/R for 94% of species)
- All environmental (156), phylogenetic (92 eigenvectors), categorical (7), and EIVE (5) features included
- Ready for immediate use in Stage 2 EIVE prediction modeling

**Stage 2 workflow:**
1. Load final complete dataset (273 columns)
2. Back-transform log traits to original scale if needed
3. Use complete traits + features + **p_phylo predictors** to predict missing EIVE indicators
   - EIVE indicators: 52.8% coverage (6,165 species observed)
   - Target: Predict missing 47.2% (5,515 species)
   - p_phylo predictors provide phylogenetic neighborhood signal for 94% of species

**No circular dependency:**
- Stage 1 uses existing EIVE (R, T, L - 52.8% coverage) to impute traits
- Stage 2 uses complete traits to predict missing EIVE (M, N)
- Different indicators used vs predicted = valid multi-stage imputation

### 4.3 Phylogenetic Predictor

**For detailed phylogenetic predictor computation and verification, see:**
`1.9_Phylogenetic_Predictor_and_Verification.md`

**Quick reference:**
- Output: `model_data/outputs/p_phylo_11680_20251028.csv` (10,977 / 11,680 species, 94.0% coverage)
- Formula: Bill Shipley's leave-one-out weighted phylogenetic neighborhood averaging
- Status: Completed 2025-10-28, ready for Stage 2 EIVE prediction

### 4.4 Verification

**Final complete dataset verified:**
```bash
# Build final complete dataset
python src/Stage_1/build_final_imputed_dataset.py --date 20251028

# Verify final complete dataset
python src/Stage_1/verify_xgboost_production.py --date 20251028 \
  --compare-to 20251027 \
  --cv-results results/experiments/perm2_11680/cv_10fold_eta0025_n3000_20251028.csv \
  --verify-final
```

**Verification outputs:** `results/verification/xgboost_final_dataset_20251028/`

**Status:** Overall WARNING (expected/benign)
- ✓ Dataset structure: 268 columns (92 phylo, 5 EIVE, 7 categorical, 156 env, 6 traits, 2 IDs)
- ✓ Completeness: All 35,658 gaps filled (100% coverage)
- ✓ PMM verification: 0% extrapolation beyond observed ranges
- ✓ Correlation preservation: All signs correct
- ⚠ Distribution similarity: Gap species differ (expected)
- ⚠ Ensemble stability: High for most traits
- ⚠ Sanity check vs Oct 27: Changes consistent with adding 3 categorical traits (r > 0.97)

---

## 5. References

**Related documentation:**
- 1.7a: Imputation Dataset Preparation
- 1.7b: XGBoost Experiments and Hyperparameter Tuning
- 1.7c: BHPMF Gap-Filling (baseline comparison)

**Key scripts:**
- Production imputation: `scripts/train_xgboost_perm2_cv_production.R`
- Accuracy metrics: `src/Stage_1/experiments/compute_cv_accuracy_metrics.py`
- Build final dataset: `src/Stage_1/build_final_imputed_dataset.py`
- Verification: `src/Stage_1/verify_xgboost_production.py`

**Data locations:**
- Input: `model_data/inputs/mixgb_perm2_11680/mixgb_input_perm2_eive_11680_20251028.csv`
- **FINAL OUTPUT (use for Stage 2):** `model_data/outputs/perm2_production/perm2_11680_complete_final_20251028.csv` **(273 columns, includes p_phylo)**
- Imputed traits only: `model_data/outputs/perm2_production/perm2_11680_complete_imputed_20251028.csv` (268 columns, before p_phylo)
- Mean imputation: `model_data/outputs/perm2_production/perm2_11680_eta0025_n3000_20251028_mean.csv` (8 columns: ID + 6 traits)
- Phylogenetic predictors: `model_data/outputs/p_phylo_11680_20251028.csv` (6 columns: ID + 5 p_phylo)
- CV results: `results/experiments/perm2_11680/cv_10fold_eta0025_n3000_20251028.csv`
- CV accuracy: `results/experiments/perm2_11680/accuracy_metrics/accuracy_report_20251028.txt`
- Verification: `results/verification/xgboost_final_dataset_20251028/`
