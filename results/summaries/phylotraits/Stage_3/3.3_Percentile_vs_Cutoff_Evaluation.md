# Stage 3.3: Percentile-Based vs. Arbitrary Cutoff Evaluation

**Date:** 2025-11-03
**Status:** Evaluation complete
**Question:** Should Stage 3 CSR classification use percentile-based approach (like Stage 4) instead of arbitrary cutoffs?

---

## Executive Summary

**Recommendation: Adopt percentile-based classification with climate stratification**

**Key finding:** Current arbitrary cutoffs (C â‰¥ 60 = "Very High") correspond to inconsistent percentile ranks:
- C â‰¥ 60 â†’ 90th percentile (13.9% of plants)
- S â‰¥ 60 â†’ 75th percentile (30.1% of plants)
- R â‰¥ 60 â†’ 88th percentile (16.0% of plants)

The same numeric threshold (60) means "very rare" for C-strategists but "common" for S-strategists. This inconsistency undermines interpretability and cross-strategy comparisons.

---

## Current Approach: Arbitrary Cutoffs (Shipley 2025)

### Implementation

**Ecosystem Service Ratings:**
```r
# NPP rating (Herbaceous)
if (C >= 60) return("Very High")  # 90th percentile
if (C >= 50) return("High")       # 78th percentile
if (S >= 60) return("Low")        # 75th percentile
return("Moderate")

# Nutrient Loss rating
if (R >= 60) return("Very High")  # 88th percentile
if (R >= 50) return("High")       # 76th percentile
if (C >= 60) return("Very Low")   # 90th percentile
return("Moderate")
```

### Empirical Distributions (11,650 plants)

| Strategy | Mean | Median | Std | p50 Cutoff | p75 Cutoff | p90 Cutoff |
|----------|------|--------|-----|------------|------------|------------|
| **C** | 31.1% | 25.9% | 25.1 | 25.9 | 47.1 | 66.7 |
| **S** | 38.9% | 36.3% | 33.2 | 36.3 | 66.4 | 88.1 |
| **R** | 30.0% | 26.0% | 27.2 | 26.0 | 49.5 | 69.2 |

**Key observation:** S-strategists are overrepresented (mean 38.9% vs. 31.1% for C, 30.0% for R). This reflects European flora's stress-tolerance bias (harsh winters, nutrient-poor soils).

### Problems with Arbitrary Cutoffs

**1. Inconsistent Percentile Mapping**

| Cutoff | C Percentile | S Percentile | R Percentile |
|--------|--------------|--------------|--------------|
| â‰¥ 60 | **90th** (rare) | **75th** (common) | **88th** (rare) |
| â‰¥ 50 | 78th | 62nd | 76th |
| â‰¥ 40 | 68th | 48th | 66th |

**Interpretation problem:** A plant with S=60 is at 75th percentile (upper-middle), but a plant with C=60 is at 90th percentile (very rare). Both are labeled "Very High" but have different ecological meanings.

**2. Climate Bias Not Accounted For**

Current cutoffs are global (Pierce et al. 2016 StrateFy calibration), but:
- **Tropical plants:** High C (fast growth), low S (no winter stress)
- **Boreal plants:** Low C (short season), high S (cold tolerance)

A C=60 plant is *exceptionally competitive* in boreal zones but *moderately competitive* in tropics. Fixed cutoffs cannot capture this context.

**3. Loss of Comparative Information**

User sees: "This plant has Very High NPP (C=63)"

**What they don't know:**
- Is C=63 typical for this climate zone?
- Is C=63 typical for this plant family?
- How does C=63 compare to other garden candidates?

Percentile-based approach answers these questions directly.

---

## Proposed Approach: Percentile-Based Classification

### Methodology (Aligned with Stage 4 Framework)

**Step 1: Climate-Stratified Calibration**

Use KÃ¶ppen-Geiger tiers (already implemented in Stage 4):

| Tier | KÃ¶ppen Codes | Plant Count | % of Dataset |
|------|--------------|-------------|--------------|
| 1 | Tropical (Af, Am, Aw) | 1,633 | 14.0% |
| 2 | Mediterranean (Csa, Csb, Csc) | 4,036 | 34.6% |
| 3 | Humid Temperate (Cfa, Cfb, etc.) | 8,619 | 73.8% |
| 4 | Continental (Dfa, Dfb, etc.) | 4,367 | 37.4% |
| 5 | Boreal/Polar (ET, EF) | 1,059 | 9.1% |
| 6 | Arid (BWh, BWk, etc.) | 2,759 | 23.6% |

**Step 2: Compute Tier-Specific Percentiles**

For each tier:
```python
# Example: Tier 3 (Humid Temperate) - 8,619 plants
tier_3_plants = plants[plants['tier_3_humid_temperate'] == True]

C_percentiles = np.percentile(tier_3_plants['C'], [1, 5, 10, ..., 95, 99])
S_percentiles = np.percentile(tier_3_plants['S'], [1, 5, 10, ..., 95, 99])
R_percentiles = np.percentile(tier_3_plants['R'], [1, 5, 10, ..., 95, 99])

# Store for interpolation:
# tier_3_calibration = {
#   'C': {'p01': 0.2, 'p05': 1.5, ..., 'p99': 85.3},
#   'S': {'p01': 0.0, 'p05': 0.0, ..., 'p99': 98.7},
#   'R': {'p01': 0.0, 'p05': 0.1, ..., 'p99': 83.1}
# }
```

**Step 3: Convert Plant CSR to Percentiles**

```python
def classify_plant_csr(plant_id, user_climate_tier):
    """
    Convert plant's raw C/S/R scores to percentile rankings.

    Args:
        plant_id: WFO taxon ID
        user_climate_tier: User's KÃ¶ppen tier (1-6)

    Returns:
        {
            'C_percentile': 87.3,  # This plant's C is at 87.3rd percentile
            'S_percentile': 12.5,  # This plant's S is at 12.5th percentile
            'R_percentile': 45.2,  # This plant's R is at 45.2nd percentile
            'strategy_classification': 'C-dominant',
            'strategy_interpretation': 'Highly competitive for this climate'
        }
    """
    # Load plant's raw C/S/R
    plant = plants[plants['wfo_taxon_id'] == plant_id].iloc[0]
    C_raw = plant['C']
    S_raw = plant['S']
    R_raw = plant['R']

    # Load tier-specific calibration
    tier_calibration = load_calibration(user_climate_tier)

    # Convert to percentiles via interpolation
    C_percentile = raw_to_percentile(C_raw, tier_calibration['C'])
    S_percentile = raw_to_percentile(S_raw, tier_calibration['S'])
    R_percentile = raw_to_percentile(R_raw, tier_calibration['R'])

    # Classify strategy
    dominant_strategy = max([
        ('C', C_percentile),
        ('S', S_percentile),
        ('R', R_percentile)
    ], key=lambda x: x[1])

    return {
        'C_percentile': C_percentile,
        'S_percentile': S_percentile,
        'R_percentile': R_percentile,
        'strategy_classification': f'{dominant_strategy[0]}-dominant',
        'strategy_interpretation': interpret_percentile(dominant_strategy[1])
    }

def interpret_percentile(percentile):
    """Consistent interpretation across all strategies."""
    if percentile >= 95: return "Exceptionally high"
    if percentile >= 90: return "Very high"
    if percentile >= 75: return "High"
    if percentile >= 60: return "Above average"
    if percentile >= 40: return "Average"
    if percentile >= 25: return "Below average"
    if percentile >= 10: return "Low"
    return "Very low"
```

### Benefits

**1. Consistent Interpretation Across Strategies**

| Percentile | All Strategies (C/S/R) |
|------------|------------------------|
| â‰¥ 95 | "Exceptionally high" (top 5%) |
| â‰¥ 90 | "Very high" (top 10%) |
| â‰¥ 75 | "High" (top quartile) |
| â‰¥ 60 | "Above average" |
| 40-60 | "Average" |
| 25-40 | "Below average" |
| 10-25 | "Low" |
| < 10 | "Very low" (bottom 10%) |

**Example:**
- Plant with C=60 (90th percentile) â†’ "Very high competitiveness"
- Plant with S=60 (75th percentile) â†’ "High stress-tolerance"

Now the labels match the statistical rarity.

**2. Climate-Appropriate Comparisons**

**Example 1: Competitive plant in different climates**

```
Plant: Quercus robur (English Oak)
C=45, S=35, R=20

User in UK (Tier 3: Humid Temperate):
  C_percentile = 68th â†’ "Above average competitiveness"
  S_percentile = 42nd â†’ "Average stress-tolerance"
  Interpretation: "Good moderate-competition plant for UK gardens"

User in Norway (Tier 5: Boreal):
  C_percentile = 92nd â†’ "Very high competitiveness"
  S_percentile = 15th â†’ "Low stress-tolerance"
  Interpretation: "Exceptionally competitive but poor cold tolerance"
```

**3. Enhanced User Communication**

**Before (arbitrary cutoffs):**
```
NPP Rating: Very High
(Based on C â‰¥ 60)
```

**After (percentile-based):**
```
NPP Rating: Very High (90th percentile)

Interpretation: This plant's competitiveness (C=63) ranks at the
90th percentile for Humid Temperate climates. It outcompetes 90%
of plants in similar conditions.

Strategy Profile:
  â€¢ Competitiveness (C): 90th percentile (Very High â–“â–“â–“â–“â–“â–“â–“â–“â–“â–‘)
  â€¢ Stress-tolerance (S): 15th percentile (Low â–“â–“â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘)
  â€¢ Ruderalism (R): 32nd percentile (Below Average â–“â–“â–“â–‘â–‘â–‘â–‘â–‘â–‘â–‘)

Ecological Context:
This is a C-dominant species (Competitor) - typical of resource-rich,
stable habitats. High NPP, fast growth, good for biomass production.

Compared to climate peers: Exceptionally competitive (top 10%).
```

**4. Enables Quantitative Recommendations**

```python
# Recommendation engine example:
user_climate = 'tier_3_humid_temperate'
user_plants = ['wfo-0001234567', 'wfo-0001234568']  # User's current guild

# Analyze CSR balance
guild_csr_percentiles = [classify_plant_csr(p, user_climate) for p in user_plants]

mean_C = np.mean([p['C_percentile'] for p in guild_csr_percentiles])
mean_S = np.mean([p['S_percentile'] for p in guild_csr_percentiles])
mean_R = np.mean([p['R_percentile'] for p in guild_csr_percentiles])

if mean_C > 75 and mean_R < 25:
    print("âš  Guild heavily C-dominant (high competition, low disturbance tolerance)")
    print("ðŸ’¡ Recommendation: Add R-strategist (>75th R percentile) for resilience:")

    # Find R-dominant plants compatible with user's climate
    candidates = plants[
        (plants[f'tier_{user_climate}'] == True) &
        (plants['R_percentile'] > 75) &
        (plants['climate_compatible_with_guild'] == True)
    ].head(10)

    for plant in candidates:
        print(f"  â€¢ {plant['wfo_scientific_name']} (R: {plant['R_percentile']:.0f}th %ile)")
```

---

## Implementation Roadmap

### Phase 1: Calibration (Data Preparation)

**Input:** `model_data/outputs/perm2_production/perm2_11680_with_koppen_tiers_20251103.parquet`
**Script:** `src/Stage_3/calibrate_csr_percentiles.py`

```python
# Pseudocode
for tier in ['tier_1_tropical', ..., 'tier_6_arid']:
    tier_plants = plants[plants[tier] == True]

    # Compute percentiles for C, S, R
    C_percentiles = compute_percentiles(tier_plants['C'], [1,5,10,...,95,99])
    S_percentiles = compute_percentiles(tier_plants['S'], [1,5,10,...,95,99])
    R_percentiles = compute_percentiles(tier_plants['R'], [1,5,10,...,95,99])

    calibration[tier] = {
        'C': C_percentiles,
        'S': S_percentiles,
        'R': R_percentiles,
        'n_plants': len(tier_plants)
    }

# Save calibration file
save_json(calibration, 'data/stage3/csr_percentile_calibration_by_tier.json')
```

**Output:** `data/stage3/csr_percentile_calibration_by_tier.json`

**Runtime:** < 1 minute (simple percentile computation on existing data)

### Phase 2: Integration (Add Percentile Columns)

**Script:** `src/Stage_3/add_csr_percentiles_to_master.py`

```python
# For each plant, compute percentiles in ALL tiers it belongs to
for plant_id in plants['wfo_taxon_id']:
    plant = plants[plants['wfo_taxon_id'] == plant_id].iloc[0]

    # Get tiers this plant belongs to
    plant_tiers = [t for t in tiers if plant[t] == True]

    # Compute percentiles in each tier
    for tier in plant_tiers:
        tier_cal = calibration[tier]

        C_pct = raw_to_percentile(plant['C'], tier_cal['C'])
        S_pct = raw_to_percentile(plant['S'], tier_cal['S'])
        R_pct = raw_to_percentile(plant['R'], tier_cal['R'])

        # Store tier-specific percentiles
        plants.loc[plant_id, f'C_percentile_{tier}'] = C_pct
        plants.loc[plant_id, f'S_percentile_{tier}'] = S_pct
        plants.loc[plant_id, f'R_percentile_{tier}'] = R_pct

# Save enriched dataset
save_parquet(plants, 'model_data/outputs/perm2_production/perm2_11680_with_csr_percentiles.parquet')
```

**Output:** `model_data/outputs/perm2_production/perm2_11680_with_csr_percentiles.parquet`
**New columns:** 36 total (6 tiers Ã— 3 strategies Ã— 2 values = raw + percentile)

**Runtime:** < 5 minutes

### Phase 3: Update Ecosystem Services (Use Percentiles)

**Script:** `src/Stage_3_CSR/calculate_csr_ecoservices_percentile.R`

**Key changes:**
```r
# OLD (arbitrary cutoffs):
if (C >= 60) return("Very High")
if (C >= 50) return("High")

# NEW (percentile-based):
C_percentile <- get_percentile(C, user_climate_tier, 'C')
if (C_percentile >= 90) return("Very High")
if (C_percentile >= 75) return("High")
if (C_percentile >= 60) return("Above Average")
if (C_percentile >= 40) return("Average")
return("Below Average")
```

**Runtime:** ~3 minutes (same as current pipeline)

### Phase 4: Frontend Integration

**API endpoint update:**
```json
GET /api/v1/plant/{plant_id}/csr?user_lat={lat}&user_lon={lon}

Response:
{
  "plant_id": "wfo-0001234567",
  "scientific_name": "Quercus robur",
  "user_climate_tier": "tier_3_humid_temperate",
  "csr_raw": {
    "C": 45.2,
    "S": 35.1,
    "R": 19.7
  },
  "csr_percentiles": {
    "C": 68.3,
    "S": 42.1,
    "R": 15.8
  },
  "csr_classifications": {
    "C": "Above average",
    "S": "Average",
    "R": "Low"
  },
  "strategy_summary": {
    "dominant": "C",
    "interpretation": "C-dominant competitor - high NPP, good biomass production"
  },
  "ecosystem_services": {
    "npp_rating": "High",
    "npp_percentile_basis": "C at 68th percentile",
    ...
  }
}
```

---

## Comparison Summary

| Aspect | Arbitrary Cutoffs (Current) | Percentile-Based (Proposed) |
|--------|---------------------------|----------------------------|
| **Interpretability** | âŒ Inconsistent (Câ‰¥60 = 90th %ile, Sâ‰¥60 = 75th %ile) | âœ… Consistent (90th %ile always "Very High") |
| **Climate Context** | âŒ Global cutoffs ignore regional bias | âœ… Tier-specific percentiles account for climate |
| **User Communication** | âŒ "Very High" is vague | âœ… "90th percentile" is precise |
| **Cross-Strategy Comparison** | âŒ Cannot compare C=60 vs S=60 fairly | âœ… 90th %ile C vs 75th %ile S directly comparable |
| **Recommendation Engine** | âŒ Cannot quantify "add R-strategist" | âœ… Can target "add plant with R > 75th %ile" |
| **Scientific Rigor** | âš  Shipley's expert judgment (defensible) | âœ… Empirically calibrated from 11,650 plants |
| **Implementation Cost** | âœ… Already implemented | âš  ~1 day development + testing |
| **Backward Compatibility** | âœ… Current system works | âš  API changes required |

---

## Risks and Mitigations

### Risk 1: Percentiles Change with Dataset Updates

**Problem:** If new plants are added (e.g., expand to 20,000 species), percentile calibrations shift.

**Mitigation:**
- Version calibration files (`csr_percentile_calibration_v1.json`)
- Document calibration date and plant count in metadata
- Recalibrate annually or when dataset grows >10%

### Risk 2: Users Misinterpret Percentiles

**Problem:** "90th percentile" requires statistical literacy.

**Mitigation:**
- Always pair percentile with qualitative label:
  - âœ… "Very High (90th percentile)"
  - âŒ "90th percentile" alone
- Add tooltips/help text explaining interpretation
- Visualize with progress bars or icons

### Risk 3: Climate Tier Assignment Errors

**Problem:** If KÃ¶ppen labeling is wrong, percentiles are meaningless.

**Mitigation:**
- Already verified with `verify_koppen_labelling.py` (28/28 tests pass)
- Multi-assignment approach reduces single-zone errors
- Fallback to global percentiles if tier data missing

---

## Recommendation

**Adopt percentile-based classification with climate stratification.**

**Justification:**
1. **Fixes inconsistency:** Arbitrary cutoffs map to different percentiles across strategies (60 = 90th for C, 75th for S)
2. **Enables climate context:** KÃ¶ppen tiers already implemented in Stage 4
3. **Improves user communication:** "90th percentile" is more informative than "Very High"
4. **Supports recommendation engine:** Quantitative targets ("add R > 75th %ile")
5. **Low implementation cost:** ~1 day (calibration script + integration)

**Backward compatibility:**
- Keep raw C/S/R scores unchanged (StrateFy output preserved)
- Add percentile columns alongside existing ratings
- API can return both formats during transition period

---

## Next Steps

1. **Implement calibration script** (`src/Stage_3/calibrate_csr_percentiles.py`)
2. **Add percentile columns** to master dataset
3. **Update ecosystem services logic** to use percentiles
4. **Test with sample queries** (verify percentiles match expectations)
5. **Update documentation** (Stage 3 methodology)
6. **Deploy API changes** (with backward-compatible v1 endpoint)

**Estimated timeline:** 1-2 days development + testing

---

## References

**Stage 3 (Current):**
- Pierce et al. (2016) "A global method for calculating plant CSR strategies..." *Functional Ecology* 31:444-457
- Shipley (2025) Parts I & II - Ecosystem services framework

**Stage 4 (Percentile Framework):**
- Document 4.4: Unified Percentile Framework
- KÃ¶ppen-Geiger climate classification via `kgcpy`
- Monte Carlo calibration methodology (100K guilds)

**Statistical Methods:**
- Efron & Tibshirani (1993) "An Introduction to the Bootstrap" - Percentile confidence intervals
